IS_DEPLOYED="1.76.0",VERSION_NUMBER=IS_DEPLOYED||"-1",DEPLOYED_STATIC_ROOT="",IS_ROLL20=!1,IMGUR_CLIENT_ID=`abdea4de492d3b0`,HASH_PART_SEP=",",HASH_LIST_SEP="_",HASH_SUB_LIST_SEP="~",HASH_SUB_KV_SEP=":",HASH_START="#",HASH_SUBCLASS="sub:",HASH_BLANK="blankhash",HASH_SUB_NONE="null",STR_VOID_LINK="javascript:void(0)",STR_APOSTROPHE="\u2019",HTML_NO_INFO="<i>No information available.</i>",HTML_NO_IMAGES="<i>No images available.</i>",ID_SEARCH_BAR="filter-search-input-group",ID_RESET_BUTTON="reset",FLTR_ID="filterId",CLSS_NON_STANDARD_SOURCE="spicy-sauce",CLSS_HOMEBREW_SOURCE="refreshing-brew",CLSS_SUBCLASS_FEATURE="subclass-feature",CLSS_HASH_FEATURE_KEY="f",CLSS_HASH_FEATURE=`${CLSS_HASH_FEATURE_KEY}:`,MON_HASH_SCALED="scaled",ATB_DATA_LIST_SEP="||",ATB_DATA_PART_SEP="::",ATB_DATA_SC="data-subclass",ATB_DATA_SRC="data-source",STR_CANTRIP="Cantrip",STR_NONE="None",STR_ANY="Any",STR_SPECIAL="Special",RNG_SPECIAL="special",RNG_POINT="point",RNG_LINE="line",RNG_CUBE="cube",RNG_CONE="cone",RNG_RADIUS="radius",RNG_SPHERE="sphere",RNG_HEMISPHERE="hemisphere",RNG_CYLINDER="cylinder",RNG_SELF="self",RNG_SIGHT="sight",RNG_UNLIMITED="unlimited",RNG_UNLIMITED_SAME_PLANE="plane",RNG_TOUCH="touch",UNT_FEET="feet",UNT_MILES="miles",HOMEBREW_STORAGE="HOMEBREW_STORAGE",HOMEBREW_META_STORAGE="HOMEBREW_META_STORAGE",EXCLUDES_STORAGE="EXCLUDES_STORAGE",DMSCREEN_STORAGE="DMSCREEN_STORAGE",ROLLER_MACRO_STORAGE="ROLLER_MACRO_STORAGE",ENCOUNTER_STORAGE="ENCOUNTER_STORAGE",POINTBUY_STORAGE="POINTBUY_STORAGE",JSON_HOMEBREW_INDEX=`homebrew/index.json`,String.prototype.uppercaseFirst=String.prototype.uppercaseFirst||function(){const e=this.toString();return 0===e.length?e:1===e.length?e.charAt(0).toUpperCase():e.charAt(0).toUpperCase()+e.slice(1)},String.prototype.lowercaseFirst=String.prototype.lowercaseFirst||function(){const e=this.toString();return 0===e.length?e:1===e.length?e.charAt(0).toLowerCase():e.charAt(0).toLowerCase()+e.slice(1)},String.prototype.toTitleCase=String.prototype.toTitleCase||function(){let e;e=this.replace(/([^\W_]+[^\s-/]*) */g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}),StrUtil._TITLE_LOWER_WORDS_RE||(StrUtil._TITLE_LOWER_WORDS_RE=StrUtil.TITLE_LOWER_WORDS.map(e=>new RegExp(`\\s${e}\\s`,"g")));for(let t=0;t<StrUtil.TITLE_LOWER_WORDS.length;t++)e=e.replace(StrUtil._TITLE_LOWER_WORDS_RE[t],e=>e.toLowerCase());StrUtil._TITLE_UPPER_WORDS_RE||(StrUtil._TITLE_UPPER_WORDS_RE=StrUtil.TITLE_UPPER_WORDS.map(e=>new RegExp(`\\b${e}\\b`,"g")));for(let t=0;t<StrUtil.TITLE_UPPER_WORDS.length;t++)e=e.replace(StrUtil._TITLE_UPPER_WORDS_RE[t],StrUtil.TITLE_UPPER_WORDS[t].toUpperCase());return e},String.prototype.toSentenceCase=String.prototype.toSentenceCase||function(){const e=[],t=/([^.!?]+)([.!?]\s*|$)/gi;let n;do n=t.exec(this),n&&e.push(n[0].toLowerCase().uppercaseFirst());while(n);return e.join("")},String.prototype.toSpellCase=String.prototype.toSpellCase||function(){return this.toLowerCase().replace(/(^|of )(bigby|otiluke|mordenkainen|evard|hadar|agatys|abi-dalzim|aganazzar|drawmij|leomund|maximilian|melf|nystul|otto|rary|snilloc|tasha|tenser|jim)('s|$| )/g,(...e)=>`${e[1]}${e[2].toTitleCase()}${e[3]}`)},String.prototype.toCamelCase=String.prototype.toCamelCase||function(){return this.split(" ").map((e,t)=>0===t?e.toLowerCase():`${e.charAt(0).toUpperCase()}${e.slice(1).toLowerCase()}`).join("")},String.prototype.escapeQuotes=String.prototype.escapeQuotes||function(){return this.replace(/'/g,`&singlequot;`).replace(/"/g,`&quot;`)},String.prototype.unescapeQuotes=String.prototype.unescapeQuotes||function(){return this.replace(/&singlequot;/g,`'`).replace(/&quot;/g,`"`)},String.prototype.distance=String.prototype.distance||function(e){var t=Math.min;let o,a,r=this;if(!r)return e?e.length:0;if(!e)return r.length;const s=r.length,_=e.length,n=s+_,d=Array(s+2),l={};for(o=0;o<s+2;o++)d[o]=Array(_+2);for(d[0][0]=n,o=0;o<=s;o++)d[o+1][1]=o,d[o+1][0]=n,l[r[o]]=0;for(a=0;a<=_;a++)d[1][a+1]=a,d[0][a+1]=n,l[e[a]]=0;for(o=1;o<=s;o++){let n=0;for(a=1;a<=_;a++){const i=l[e[a-1]],s=n;r[o-1]===e[a-1]?(d[o+1][a+1]=d[o][a],n=a):d[o+1][a+1]=t(d[o][a],t(d[o+1][a],d[o][a+1]))+1,d[o+1][a+1]=t(d[o+1][a+1],d[i]?d[i][s]+(o-i-1)+1+(a-s-1):1/0)}l[r[o-1]]=o}return d[s+1][_+1]},String.prototype.isNumeric=String.prototype.isNumeric||function(){return!isNaN(parseFloat(this))&&isFinite(this)},String.prototype.last=String.prototype.last||function(){return this[this.length-1]},Array.prototype.joinConjunct=Array.prototype.joinConjunct||function(e,t,n){if(0===this.length)return"";if(1===this.length)return this[0];if(2===this.length)return this.join(t);else{let o="";for(let a=0;a<this.length;++a)o+=this[a],a<this.length-2?o+=e:a==this.length-2&&(o+=`${!n&&2<this.length?e.trim():""}${t}`);return o}},Array.prototype.peek=Array.prototype.peek||function(){return this.slice(-1)[0]},StrUtil={COMMAS_NOT_IN_PARENTHESES_REGEX:/,\s?(?![^(]*\))/g,COMMA_SPACE_NOT_IN_PARENTHESES_REGEX:/, (?![^(]*\))/g,uppercaseFirst:function(e){return e.uppercaseFirst()},TITLE_LOWER_WORDS:["A","An","The","And","But","Or","For","Nor","As","At","By","For","From","In","Into","Near","Of","On","Onto","To","With"],TITLE_UPPER_WORDS:["Id","Tv"],padNumber:(e,t,n)=>(e+"").padStart(t,n),elipsisTruncate(e,t=5,n=0,o=20){var a=Math.max;if(o>=e.length)return e;o=a(t+n+3,o);let r="",s=o-(3+t+n);for(let a=0;a<e.length-n;++a){const n=e[a];a<t?r+=n:0<s--&&(r+=n)}return 0>s&&(r+="..."),r+=e.substring(e.length-n,e.length),r},toTitleCase(e){return e.toTitleCase()}},RegExp.escape=function(e){return e.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&")},Parser={},Parser._parse_aToB=function(e,t,n){if(void 0===t||null===t)throw new Error("undefined or null object passed to parser");return"string"==typeof t&&(t=t.trim()),void 0===e[t]?n||t:e[t]},Parser._parse_bToA=function(e,t){if(void 0===t||null===t)throw new Error("undefined or null object passed to parser");for(const n in"string"==typeof t&&(t=t.trim()),e)if(e.hasOwnProperty(n)&&e[n]===t)return n;return t},Parser.attrChooseToFull=function(e){if(1===e.length)return`${Parser.attAbvToFull(e[0])} modifier`;else{const t=[];for(let n=0;n<e.length;++n)t.push(Parser.attAbvToFull(e[n]));return`${t.join(" or ")} modifier (your choice)`}},Parser.numberToText=function(e){var n=Math.abs;function t(e){const o=n(e);switch(o){case 0:return"zero";case 1:return"one";case 2:return"two";case 3:return"three";case 4:return"four";case 5:return"five";case 6:return"six";case 7:return"seven";case 8:return"eight";case 9:return"nine";case 10:return"ten";case 11:return"eleven";case 12:return"twelve";case 13:return"thirteen";case 14:return"fourteen";case 15:return"fifteen";case 16:return"sixteen";case 17:return"seventeen";case 18:return"eighteen";case 19:return"nineteen";case 20:return"twenty";case 30:return"thirty";case 40:return"forty";case 50:return"fiddy";case 60:return"sixty";case 70:return"seventy";case 80:return"eighty";case 90:return"ninety";default:{const e=o+"";return`${t(+`${e[0]}0`)}-${t(+e[1])}`}}}return 100<=n(e)?e:`${0>e?"negative ":""}${t(e)}`},Parser.attAbvToFull=function(e){return Parser._parse_aToB(Parser.ATB_ABV_TO_FULL,e)},Parser.attFullToAbv=function(e){return Parser._parse_bToA(Parser.ATB_ABV_TO_FULL,e)},Parser.sizeAbvToFull=function(e){return Parser._parse_aToB(Parser.SIZE_ABV_TO_FULL,e)},Parser.getAbilityModNumber=function(e){return Math.floor((e-10)/2)},Parser.getAbilityModifier=function(e){let t=Parser.getAbilityModNumber(e);return 0<=t&&(t="+"+t),t},Parser.getSpeedString=e=>{function t(t){function i(e){a.push(`${"walk"===t?"":`${t} `}${n(e)} ft.${o(e)}`)}(e.speed[t]||"walk"===t)&&i(e.speed[t]||0),e.speed.alternate&&e.speed.alternate[t]&&e.speed.alternate[t].forEach(i)}function n(e){return e.number||e}function o(e){return e.condition?` ${Renderer.get().render(e.condition)}`:""}const a=[];if("object"==typeof e.speed){let n=", ";return t("walk"),t("burrow"),t("climb"),t("fly"),t("swim"),e.speed.choose&&(n="; ",a.push(`${e.speed.choose.from.sort().joinConjunct(", "," or ")} ${e.speed.choose.amount} ft.${e.speed.choose.note?` ${e.speed.choose.note}`:""}`)),a.join(n)}return e.speed+("Varies"===e.speed?"":" ft. ")},Parser._addCommas=function(e){return(e+"").replace(/(\d)(?=(\d{3})+$)/g,"$1,")},Parser.crToXp=function(e){if(e.xp)return Parser._addCommas(e.xp);const t=e.cr||e;return"Unknown"===t||null==t?"Unknown":"0"===t?"0 or 10":"1/8"===t?"25":"1/4"===t?"50":"1/2"===t?"100":Parser._addCommas(Parser.XP_CHART[parseInt(t)-1])},Parser.crToXpNumber=function(e){if(e.xp)return e.xp;const t=e.cr||e;return"Unknown"===t||null==t?null:Parser.XP_CHART_ALT[t]},LEVEL_TO_XP_EASY=[0,25,50,75,125,250,300,350,450,550,600,800,1e3,1100,1250,1400,1600,2e3,2100,2400,2800],LEVEL_TO_XP_MEDIUM=[0,50,100,150,250,500,600,750,900,1100,1200,1600,2e3,2200,2500,2800,3200,3900,4100,4900,5700],LEVEL_TO_XP_HARD=[0,75,150,225,375,750,900,1100,1400,1600,1900,2400,3e3,3400,3800,4300,4800,5900,6300,7300,8500],LEVEL_TO_XP_DEADLY=[0,100,200,400,500,1100,1400,1700,2100,2400,2800,3600,4500,5100,5700,6400,7200,8800,9500,10900,12700],LEVEL_TO_XP_DAILY=[0,300,600,1200,1700,3500,4e3,5e3,6e3,7500,9e3,10500,11500,13500,15e3,18e3,2e4,25e3,27e3,3e4,4e4],Parser.CRS=["0","1/8","1/4","1/2","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30"],Parser.levelToXpThreshold=function(e){return[LEVEL_TO_XP_EASY[e],LEVEL_TO_XP_MEDIUM[e],LEVEL_TO_XP_HARD[e],LEVEL_TO_XP_DEADLY[e]]},Parser.isValidCr=function(e){return Parser.CRS.includes(e)},Parser.crToNumber=function(e){if("Unknown"===e||null==e)return 100;if(e.cr)return Parser.crToNumber(e.cr);const t=e.trim().split("/");return 1===t.length?+t[0]:2===t.length?+t[0]/+t[1]:0},Parser._greatestCommonDivisor=function(e,t){var n=Number.EPSILON;return t<n?e:Parser._greatestCommonDivisor(t,Math.floor(e%t))},Parser.numberToCr=function(e,t){var n=Math.pow,o=Math.floor;if(t&&"string"==typeof e&&Parser.CRS.includes(e))return e;const a=e.toString().length-2;let i=n(10,a),r=e*i;const s=Parser._greatestCommonDivisor(r,i);return r=o(r/s),i=o(i/s),1===i?r+"":`${o(r)}/${o(i)}`},Parser.crToPb=function(e){var t=Math.ceil;return"Unknown"===e||null==e?0:(e=e.cr||e,5>Parser.crToNumber(e)?2:t(e/4)+1)},Parser.SKILL_TO_ATB_ABV={athletics:"str",acrobatics:"dex","sleight of hand":"dex",stealth:"dex",arcana:"int",history:"int",investigation:"int",nature:"int",religion:"int","animal handling":"wis",insight:"wis",medicine:"wis",perception:"wis",survival:"wis",deception:"cha",intimidation:"cha",performance:"cha",persuasion:"cha"},Parser.skillToAbilityAbv=function(e){return Parser._parse_aToB(Parser.SKILL_TO_ATB_ABV,e)},Parser.SKILL_TO_SHORT={athletics:"ath",acrobatics:"acro","sleight of hand":"soh",stealth:"slth",arcana:"arc",history:"hist",investigation:"invn",nature:"natr",religion:"reli","animal handling":"hndl",insight:"ins",medicine:"med",perception:"perp",survival:"surv",deception:"decp",intimidation:"intm",performance:"perf",persuasion:"pers"},Parser.skillToShort=function(e){return Parser._parse_aToB(Parser.SKILL_TO_SHORT,e)},Parser.dragonColorToFull=function(e){return Parser._parse_aToB(Parser.DRAGON_COLOR_TO_FULL,e)},Parser.DRAGON_COLOR_TO_FULL={B:"black",U:"blue",G:"green",R:"red",W:"white",A:"brass",Z:"bronze",C:"copper",O:"gold",S:"silver"},Parser.acToFull=function(e){if("string"==typeof e)return e;const t=Renderer.get();let n="";for(let o=0;o<e.length;++o){const a=e[o],i=e[o+1];a.ac?(0==o&&a.braces&&(n+="("),n+=a.ac,a.from&&(n+=` (${a.from.map(e=>t.render(e)).join(", ")})`),a.condition&&(n+=` ${t.render(a.condition)}`),a.braces&&(n+=")")):n+=a,i&&(i.braces?n+=" (":n+=", ")}return n.trim()},MONSTER_COUNT_TO_XP_MULTIPLIER=[1,1.5,2,2,2,2,2.5,2.5,2.5,2.5,3,3,3,3,4],Parser.numMonstersToXpMult=function(e,t=3){const n=(()=>e>=MONSTER_COUNT_TO_XP_MULTIPLIER.length?4:MONSTER_COUNT_TO_XP_MULTIPLIER[e-1])();return 3>t?3<=n?n+1:n+.5:5<t?4===n?3:n-.5:n},Parser.armorFullToAbv=function(e){return Parser._parse_bToA(Parser.ARMOR_ABV_TO_FULL,e)},Parser._getSourceStringFromSource=function(e){return e&&e.source?e.source:e},Parser.hasSourceFull=function(e){return!!Parser.SOURCE_JSON_TO_FULL[e]},Parser.hasSourceAbv=function(e){return!!Parser.SOURCE_JSON_TO_ABV[e]},Parser.sourceJsonToFull=function(e){return e=Parser._getSourceStringFromSource(e),Parser.hasSourceFull(e)?Parser._parse_aToB(Parser.SOURCE_JSON_TO_FULL,e).replace(/'/g,STR_APOSTROPHE):BrewUtil.hasSourceJson(e)?BrewUtil.sourceJsonToFull(e).replace(/'/g,STR_APOSTROPHE):Parser._parse_aToB(Parser.SOURCE_JSON_TO_FULL,e).replace(/'/g,STR_APOSTROPHE)},Parser.sourceJsonToFullCompactPrefix=function(e){return Parser.sourceJsonToFull(e).replace(UA_PREFIX,UA_PREFIX_SHORT).replace(AL_PREFIX,AL_PREFIX_SHORT).replace(PS_PREFIX,PS_PREFIX_SHORT)},Parser.sourceJsonToAbv=function(e){return e=Parser._getSourceStringFromSource(e),Parser.hasSourceAbv(e)?Parser._parse_aToB(Parser.SOURCE_JSON_TO_ABV,e):BrewUtil.hasSourceJson(e)?BrewUtil.sourceJsonToAbv(e):Parser._parse_aToB(Parser.SOURCE_JSON_TO_ABV,e)},Parser.sourceJsonToColor=function(e){return`source${Parser.sourceJsonToAbv(e)}`},Parser.stringToSlug=function(e){return e.trim().toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"-")},Parser.stringToCasedSlug=function(e){return e.replace(/[^\w ]+/g,"").replace(/ +/g,"-")},Parser.itemTypeToAbv=function(e){return Parser._parse_aToB(Parser.ITEM_TYPE_JSON_TO_ABV,e)},Parser.itemValueToFull=function(e,t){return e.value?e.value:e.valueMult?t?`×${e.valueMult}`:`base value ×${e.valueMult}`:""},Parser.itemWeightToFull=function(e,t){return e.weight?`${e.weight}${1===+e.weight?" lb.":" lbs."}${e.weightNote?` ${e.weightNote}`:""}`:e.weightMult?t?`×${e.weightMult}`:`base weight ×${e.weightMult}`:""},Parser._coinValueToNumberMultipliers={cp:.01,sp:.1,ep:.5,gp:1,pp:10},Parser._decimalSeparator=.1.toLocaleString().substring(1,2),Parser._numberCleanRegexp="."===Parser._decimalSeparator?new RegExp(/[\s,]*/g,"g"):new RegExp(/[\s.]*/g,"g"),Parser._costSplitRegexp="."===Parser._decimalSeparator?new RegExp(/(\d+(\.\d+)?)([csegp]p)/):new RegExp(/(\d+(,\d+)?)([csegp]p)/),Parser.coinValueToNumber=function(e){if(!e)return 0;if("Varies"===e)return 0;e=e.replace(Parser._numberCleanRegexp,"").toLowerCase();const t=Parser._costSplitRegexp.exec(e);if(!t)throw new Error(`Badly formatted value ${e}`);return+t[1]*Parser._coinValueToNumberMultipliers[t[3]]},Parser.weightValueToNumber=function(e){if(!e)return 0;if(+e)return+e;throw new Error(`Badly formatted value ${e}`)},Parser.dmgTypeToFull=function(e){return Parser._parse_aToB(Parser.DMGTYPE_JSON_TO_FULL,e)},Parser.skillToExplanation=function(e){const t=MiscUtil.getProperty(BrewUtil.homebrewMeta,"skills",e);return t?t:Parser._parse_aToB(Parser.SKILL_JSON_TO_FULL,e)},Parser.actionToExplanation=function(e){const t=MiscUtil.getProperty(BrewUtil.homebrewMeta,"actions",e);return t?t:Parser._parse_aToB(Parser.ACTION_JSON_TO_FULL,e,["No explanation available."])},Parser.senseToExplanation=function(e){e=e.toLowerCase();const t=MiscUtil.getProperty(BrewUtil.homebrewMeta,"senses",e);return t?t:Parser._parse_aToB(Parser.SENSE_JSON_TO_FULL,e,["No explanation available."])},Parser.numberToString=function(e){var n=Math.floor;function t(e){return 10>e?Parser.NUMBERS_ONES[e]:10<=e&&20>e?Parser.NUMBERS_TEENS[e-10]:Parser.NUMBERS_TENS[n(e/10)]+" "+Parser.NUMBERS_ONES[e%10]}return 0===e?"zero":function(e){return 99<e?Parser.NUMBERS_ONES[n(e/100)]+" hundred "+t(e%100):t(e)}(e)},Parser.spSchoolAndSubschoolsAbvsToFull=function(e,t){return t&&t.length?`${Parser.spSchoolAbvToFull(e)} (${t.map(e=>Parser.spSchoolAbvToFull(e)).join(", ")})`:Parser.spSchoolAbvToFull(e)},Parser.spSchoolAbvToFull=function(e){const t=Parser._parse_aToB(Parser.SP_SCHOOL_ABV_TO_FULL,e);return Parser.SP_SCHOOL_ABV_TO_FULL[e]?t:BrewUtil.homebrewMeta&&BrewUtil.homebrewMeta.spellSchools&&BrewUtil.homebrewMeta.spellSchools[e]?BrewUtil.homebrewMeta.spellSchools[e].full:t},Parser.spSchoolAndSubschoolsAbvsShort=function(e,t){return t&&t.length?`${Parser.spSchoolAbvToShort(e)} (${t.map(e=>Parser.spSchoolAbvToShort(e)).join(", ")})`:Parser.spSchoolAbvToShort(e)},Parser.spSchoolAbvToShort=function(e){const t=Parser._parse_aToB(Parser.SP_SCHOOL_ABV_TO_SHORT,e);return Parser.SP_SCHOOL_ABV_TO_SHORT[e]?t:BrewUtil.homebrewMeta&&BrewUtil.homebrewMeta.spellSchools&&BrewUtil.homebrewMeta.spellSchools[e]?BrewUtil.homebrewMeta.spellSchools[e].short:t},Parser.getOrdinalForm=function(e){const t=e%10,n=e%100;return 1==t&&11!==n?`${e}st`:2==t&&12!==n?`${e}nd`:3==t&&13!==n?`${e}rd`:`${e}th`},Parser.spLevelToFull=function(e){return 0===e?STR_CANTRIP:Parser.getOrdinalForm(e)},Parser.getArticle=function(e){return /^[aeiou]/.test(e)?"an":"a"},Parser.spLevelToFullLevelText=function(e,t){return`${Parser.spLevelToFull(e)}${0===e?"s":`${t?"-":" "}level`}`},Parser.spMetaToFull=function(e){return e&&e.ritual?" (ritual)":e&&e.technomagic?" (technomagic)":""},Parser.spLevelSchoolMetaToFull=function(e,t,n,o){const a=0===e?Parser.spLevelToFull(e).toLowerCase():Parser.spLevelToFull(e)+"-level";let i=0===e?`${Parser.spSchoolAndSubschoolsAbvsToFull(t,o)} ${a}`:`${a} ${Parser.spSchoolAndSubschoolsAbvsToFull(t,o).toLowerCase()}`;return i+Parser.spMetaToFull(n)},Parser.spTimeListToFull=function(e){return e.map(e=>`${Parser.getTimeToFull(e)}${e.condition?`, ${Renderer.get().render(e.condition)}`:""}`).join(" or ")},Parser.getTimeToFull=function(e){return`${e.number} ${"bonus"===e.unit?"bonus action":e.unit}${1<e.number?"s":""}`},Parser.spRangeToFull=function(e){function t(){const t=e.distance;switch(t.type){case RNG_SELF:return"Self";case RNG_SIGHT:return"Sight";case RNG_UNLIMITED:return"Unlimited";case RNG_UNLIMITED_SAME_PLANE:return"Unlimited on the same plane";case RNG_TOUCH:return"Touch";case UNT_FEET:case UNT_MILES:default:return`${t.amount} ${1===t.amount?Parser.getSingletonUnit(t.type):t.type}`;}}function n(){const t=e.distance;return`Self (${t.amount}-${Parser.getSingletonUnit(t.type)}${function(){switch(e.type){case RNG_SPHERE:return" radius";case RNG_HEMISPHERE:return`-radius ${e.type}`;case RNG_CYLINDER:return"-radius";default:return` ${e.type}`;}}()}${e.type===RNG_CYLINDER?`, ${t.amountSecondary}-${Parser.getSingletonUnit(t.typeSecondary)}-high cylinder`:""})`}switch(e.type){case RNG_SPECIAL:return"Special";case RNG_POINT:return t();case RNG_LINE:case RNG_CUBE:case RNG_CONE:case RNG_RADIUS:case RNG_SPHERE:case RNG_HEMISPHERE:case RNG_CYLINDER:return n();}},Parser.getSingletonUnit=function(e){switch(e){case UNT_FEET:return"foot";case UNT_MILES:return"mile";default:{const t=MiscUtil.getProperty(BrewUtil.homebrewMeta,"spellDistanceUnits",e,"singular");return t?t:"s"===e.charAt(e.length-1)?e.slice(0,-1):e}}},Parser.spComponentsToFull=function(e){const t=e.components;if(!t)return"None";const n=[];return t.v&&n.push("V"),t.s&&n.push("S"),t.m&&n.push(`M${!0===t.m?"":` (${t.m.text||t.m})`}`),t.r&&n.push(`R (${e.level} gp)`),n.join(", ")},Parser.spDurationToFull=function(e){return e.map(e=>{switch(e.type){case"special":return"Special";case"instant":return`Instantaneous${e.condition?` (${e.condition})`:""}`;case"timed":return`${e.concentration?"Concentration, ":""}${e.concentration?"u":e.duration.upTo?"U":""}${e.concentration||e.duration.upTo?"p to ":""}${e.duration.amount} ${1===e.duration.amount?e.duration.type:`${e.duration.type}s`}`;case"permanent":return e.ends?`Until ${e.ends.map(e=>"dispel"===e?"dispelled":"trigger"===e?"triggered":"discharge"===e?"discharged":void 0).join(" or ")}`:"Permanent";}}).join(" or ")+(1<e.length?" (see below)":"")},Parser.spClassesToFull=function(e,t){const n=Parser.spSubclassesToFull(e,t);return Parser.spMainClassesToFull(e,t)+(n?", "+n:"")},Parser.spMainClassesToFull=function(e,t){return(e.fromClassList||[]).sort((e,t)=>SortUtil.ascSort(e.name,t.name)).map(e=>t?e.name:`<a title="Source: ${Parser.sourceJsonToFull(e.source)}" href="${UrlUtil.PG_CLASSES}#${UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_CLASSES](e)}">${e.name}</a>`).join(", ")},Parser.spSubclassesToFull=function(e,t){return e.fromSubclass?e.fromSubclass.sort((e,t)=>{const n=SortUtil.ascSort(e.class.name,t.class.name);return n||SortUtil.ascSort(e.subclass.name,t.subclass.name)}).map(e=>Parser._spSubclassItem(e,t)).join(", "):""},Parser._spSubclassItem=function(e,t,n){const o=e.class,a=e.subclass,i=`${a.name}${a.subSubclass?` (${a.subSubclass})`:""}`;if(t)return i;const r=`<a href="${UrlUtil.PG_CLASSES}#${UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_CLASSES](o)}" title="Source: ${Parser.sourceJsonToFull(o.source)}">${o.name}</a>`,s=n?MiscUtil.getProperty(n,o.source,o.name,a.source,a.name):null;return s?`<a class="italic" href="${UrlUtil.PG_CLASSES}#${UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_CLASSES](o)}${HASH_PART_SEP}${HASH_SUBCLASS}${UrlUtil.encodeForHash(s)}${HASH_SUB_LIST_SEP}${UrlUtil.encodeForHash(a.source)}" title="Source: ${Parser.sourceJsonToFull(e.subclass.source)}">${i}</a> ${r}`:`<span class="italic" title="Source: ${Parser.sourceJsonToFull(e.subclass.source)}">${i}</span> ${r}`},Parser.SPELL_ATTACK_TYPE_TO_FULL={},Parser.SPELL_ATTACK_TYPE_TO_FULL.M="Melee",Parser.SPELL_ATTACK_TYPE_TO_FULL.R="Ranged",Parser.SPELL_ATTACK_TYPE_TO_FULL.O="Other/Unknown",Parser.spAttackTypeToFull=function(e){return Parser._parse_aToB(Parser.SPELL_ATTACK_TYPE_TO_FULL,e)},Parser.SPELL_AREA_TYPE_TO_FULL={ST:"Single Target",MT:"Multiple Targets",C:"Cube",N:"Cone",Y:"Cylinder",S:"Sphere",R:"Circle",Q:"Square",L:"Line",H:"Hemisphere",W:"Wall"},Parser.spAreaTypeToFull=function(e){return Parser._parse_aToB(Parser.SPELL_AREA_TYPE_TO_FULL,e)},Parser.monTypeToFullObj=function(e){const t={type:"",tags:[],asText:""};if("string"==typeof e)return t.type=e,t.asText=e,t;const n=[];if(e.tags)for(const o of e.tags)"string"==typeof o?(t.tags.push(o),n.push(o)):(t.tags.push(o.tag),n.push(`${o.prefix} ${o.tag}`));return t.type=e.type,e.swarmSize?(t.tags.push("swarm"),t.asText=`swarm of ${Parser.sizeAbvToFull(e.swarmSize).toLowerCase()} ${Parser.monTypeToPlural(e.type)}`):t.asText=`${e.type}`,n.length&&(t.asText+=` (${n.join(", ")})`),t},Parser.monTypeToPlural=function(e){return Parser._parse_aToB(Parser.MON_TYPE_TO_PLURAL,e)},Parser.monCrToFull=function(e,t){if("string"==typeof e||!e)return`${e||"Unknown"} (${null==t?Parser.crToXp(e):Parser._addCommas(t)} XP)`;else{const t=[Parser.monCrToFull(e.cr,e.xp)];return e.lair&&t.push(`${Parser.monCrToFull(e.lair)} when encountered in lair`),e.coven&&t.push(`${Parser.monCrToFull(e.coven)} when part of a coven`),t.join(" or ")}},Parser.monImmResToFull=function(e){var n=Math.max;function t(e,o=0){if(a=n(a,o),"string"==typeof e)return e;if(e.special)return e.special;else{let n=e.preNote?`${e.preNote} `:"";const i=e.immune?"immune":e.resist?"resist":e.vulnerable?"vulnerable":null;if(i){const r=e[i].map(e=>t(e,o+1));n+=o?r.join(a?"; ":", "):r.joinConjunct(", "," and ")}return e.note&&(n+=` ${e.note}`),n}}const o=e.length;let a=0;return 1===o&&(e[0].immune||e[0].resist)?e.map(e=>t(e,-1)).join(a?"; ":", "):function(e){if(1>=e.length)return e.join("");let t="";for(let n=0;n<e.length-1;++n){const o=e[n],a=e[n+1];t+=o,t+=o.includes(",")||a.includes(",")?"; ":", "}return t+=e.last(),t}(e.map(e=>t(e)))},Parser.monCondImmToFull=function(e){function t(e){return Renderer.get().render(`{@condition ${e}}`)}return e.map(e=>e.special?e.special:e.conditionImmune?`${e.preNote?`${e.preNote} `:""}${e.conditionImmune.map(t).join(", ")}${e.note?` ${e.note}`:""}`:t(e)).join(", ")},Parser.MON_SENSE_TAG_TO_FULL={B:"blindsight",D:"darkvision",SD:"superior darkvision",T:"tremorsense",U:"truesight"},Parser.monSenseTagToFull=function(e){return Parser._parse_aToB(Parser.MON_SENSE_TAG_TO_FULL,e)},Parser.MON_SPELLCASTING_TAG_TO_FULL={P:"Psionics",I:"Innate",F:"Form Only",S:"Shared",CB:"Class, Bard",CC:"Class, Cleric",CD:"Class, Druid",CP:"Class, Paladin",CR:"Class, Ranger",CS:"Class, Sorcerer",CL:"Class, Warlock",CW:"Class, Wizard"},Parser.monSpellcastingTagToFull=function(e){return Parser._parse_aToB(Parser.MON_SPELLCASTING_TAG_TO_FULL,e)},Parser.MON_MISC_TAG_TO_FULL={AOE:"Has Areas of Effect",MW:"Has Melee Weapon Attacks",RW:"Has Ranged Weapon Attacks",RNG:"Has Ranged Weapons",RCH:"Has Reach Attacks",THW:"Has Thrown Weapons"},Parser.monMiscTagToFull=function(e){return Parser._parse_aToB(Parser.MON_MISC_TAG_TO_FULL,e)},Parser.ENVIRONMENTS=["arctic","coastal","desert","forest","grassland","hill","mountain","swamp","underdark","underwater","urban"],Parser.PSI_ABV_TYPE_TALENT="T",Parser.PSI_ABV_TYPE_DISCIPLINE="D",Parser.PSI_ORDER_NONE="None",Parser.psiTypeToFull=e=>e===Parser.PSI_ABV_TYPE_TALENT?"Talent":e===Parser.PSI_ABV_TYPE_DISCIPLINE?"Discipline":e,Parser.psiOrderToFull=e=>void 0===e?Parser.PSI_ORDER_NONE:e,Parser.levelToFull=function(e){return isNaN(e)?"":"2"===e?e+"nd":"3"===e?e+"rd":"1"===e?e+"st":e+"th"},Parser.prereqSpellToFull=function(e){if("eldritch blast"===e)return Renderer.get().render(`{@spell ${e}} cantrip`);return"hex/curse"===e?Renderer.get().render("{@spell hex} spell or a warlock feature that curses"):e?Renderer.get().render(`{@spell ${e}}`):STR_NONE},Parser.prereqPactToFull=function(e){return"Chain"===e?"Pact of the Chain":"Tome"===e?"Pact of the Tome":"Blade"===e?"Pact of the Blade":e},Parser.prereqPatronToShort=function(e){if(e===STR_ANY)return STR_ANY;const t=/^The (.*?)$/.exec(e);return t?t[1]:e},Parser.OPT_FEATURE_TYPE_TO_FULL={AI:"Artificer Infusion",ED:"Elemental Discipline",EI:"Eldritch Invocation",MM:"Metamagic","MV:B":"Maneuver, Battlemaster","MV:C2-UA":"Maneuver, Cavalier V2 (UA)","AS:V1-UA":"Arcane Shot, V1 (UA)","AS:V2-UA":"Arcane Shot, V2 (UA)",AS:"Arcane Shot",OTH:"Other","FS:F":"Fighting Style; Fighter","FS:B":"Fighting Style; Bard","FS:P":"Fighting Style; Paladin","FS:R":"Fighting Style; Ranger",PB:"Pact Boon","SHP:H":"Ship Upgrade, Hull","SHP:M":"Ship Upgrade, Movement","SHP:W":"Ship Upgrade, Weapon","SHP:F":"Ship Upgrade, Figurehead","SHP:O":"Ship Upgrade, Miscellaneous"},Parser.optFeatureTypeToFull=function(e){return Parser.OPT_FEATURE_TYPE_TO_FULL[e]?Parser.OPT_FEATURE_TYPE_TO_FULL[e]:BrewUtil.homebrewMeta&&BrewUtil.homebrewMeta.optionalFeatureTypes&&BrewUtil.homebrewMeta.optionalFeatureTypes[e]?BrewUtil.homebrewMeta.optionalFeatureTypes[e]:e},Parser.alignmentAbvToFull=function(e){return"object"==typeof e?null==e.special?`${e.alignment.map(e=>Parser.alignmentAbvToFull(e)).join(" ")}${e.chance?` (${e.chance}%)`:""}`:e.special:(e=e.toUpperCase(),"L"===e?"Lawful":"N"===e?"Neutral":"NX"===e?"Neutral (Law/Chaos axis)":"NY"===e?"Neutral (Good/Evil axis)":"C"===e?"Chaotic":"G"===e?"Good":"E"===e?"Evil":"U"===e?"Unaligned":"A"===e?"Any alignment":e)},Parser.alignmentListToFull=function(e){if(e.some(e=>"string"!=typeof e)){if(e.some(e=>"string"==typeof e))throw new Error(`Mixed alignment types: ${JSON.stringify(e)}`);return e.map(e=>null!=e.special||null!=e.chance?Parser.alignmentAbvToFull(e):Parser.alignmentListToFull(e.alignment)).join(" or ")}if(1===e.length)return Parser.alignmentAbvToFull(e[0]);if(2===e.length)return e.map(e=>Parser.alignmentAbvToFull(e)).join(" ");if(3===e.length&&e.includes("NX")&&e.includes("NY")&&e.includes("N"))return"Any Neutral Alignment";if(5===e.length){if(!e.includes("G"))return"Any Non-Good Alignment";if(!e.includes("E"))return"Any Non-Evil Alignment";if(!e.includes("L"))return"Any Non-Lawful Alignment";if(!e.includes("C"))return"Any Non-Chaotic Alignment"}if(4===e.length){if(!e.includes("L")&&!e.includes("NX"))return"Any Chaotic Alignment";if(!e.includes("G")&&!e.includes("NY"))return"Any Evil Alignment";if(!e.includes("C")&&!e.includes("NX"))return"Any Lawful Alignment";if(!e.includes("E")&&!e.includes("NY"))return"Any Good Alignment"}throw new Error(`Unmapped alignment: ${JSON.stringify(e)}`)},Parser.CAT_ID_CREATURE=1,Parser.CAT_ID_SPELL=2,Parser.CAT_ID_BACKGROUND=3,Parser.CAT_ID_ITEM=4,Parser.CAT_ID_CLASS=5,Parser.CAT_ID_CONDITION=6,Parser.CAT_ID_FEAT=7,Parser.CAT_ID_ELDRITCH_INVOCATION=8,Parser.CAT_ID_PSIONIC=9,Parser.CAT_ID_RACE=10,Parser.CAT_ID_OTHER_REWARD=11,Parser.CAT_ID_VARIANT_OPTIONAL_RULE=12,Parser.CAT_ID_ADVENTURE=13,Parser.CAT_ID_DEITY=14,Parser.CAT_ID_OBJECT=15,Parser.CAT_ID_TRAP=16,Parser.CAT_ID_HAZARD=17,Parser.CAT_ID_QUICKREF=18,Parser.CAT_ID_CULT=19,Parser.CAT_ID_BOON=20,Parser.CAT_ID_DISEASE=21,Parser.CAT_ID_METAMAGIC=22,Parser.CAT_ID_MANEUVER_BATTLEMASTER=23,Parser.CAT_ID_TABLE=24,Parser.CAT_ID_TABLE_GROUP=25,Parser.CAT_ID_MANEUVER_CAVALIER=26,Parser.CAT_ID_ARCANE_SHOT=27,Parser.CAT_ID_OPTIONAL_FEATURE_OTHER=28,Parser.CAT_ID_FIGHTING_STYLE=29,Parser.CAT_ID_CLASS_FEATURE=30,Parser.CAT_ID_SHIP=31,Parser.CAT_ID_PACT_BOON=32,Parser.CAT_ID_ELEMENTAL_DISCIPLINE=33,Parser.CAT_ID_ARTIFICER_INFUSION=34,Parser.CAT_ID_SHIP_UPGRADE=35,Parser.CAT_ID_TO_FULL={},Parser.CAT_ID_TO_FULL[Parser.CAT_ID_CREATURE]="Bestiary",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_SPELL]="Spell",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_BACKGROUND]="Background",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_ITEM]="Item",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_CLASS]="Class",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_CONDITION]="Condition",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_FEAT]="Feat",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_ELDRITCH_INVOCATION]="Eldritch Invocation",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_PSIONIC]="Psionic",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_RACE]="Race",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_OTHER_REWARD]="Other Reward",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_VARIANT_OPTIONAL_RULE]="Variant/Optional Rule",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_ADVENTURE]="Adventure",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_DEITY]="Deity",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_OBJECT]="Object",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_TRAP]="Trap",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_HAZARD]="Hazard",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_QUICKREF]="Quick Reference",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_CULT]="Cult",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_BOON]="Boon",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_DISEASE]="Disease",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_METAMAGIC]="Metamagic",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_MANEUVER_BATTLEMASTER]="Maneuver; Battlemaster",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_TABLE]="Table",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_TABLE_GROUP]="Table",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_MANEUVER_CAVALIER]="Maneuver; Cavalier",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_ARCANE_SHOT]="Arcane Shot",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_OPTIONAL_FEATURE_OTHER]="Optional Feature",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_FIGHTING_STYLE]="Fighting Style",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_CLASS_FEATURE]="Class Feature",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_SHIP]="Ship",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_PACT_BOON]="Pact Boon",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_ELEMENTAL_DISCIPLINE]="Elemental Discipline",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_ARTIFICER_INFUSION]="Infusion",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_SHIP_UPGRADE]="Ship Upgrade",Parser.pageCategoryToFull=function(e){return Parser._parse_aToB(Parser.CAT_ID_TO_FULL,e)},Parser.CAT_ID_TO_PROP={},Parser.CAT_ID_TO_PROP[Parser.CAT_ID_CREATURE]="monster",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_SPELL]="spell",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_BACKGROUND]="background",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_ITEM]="item",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_CLASS]="class",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_CONDITION]="condition",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_FEAT]="feat",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_PSIONIC]="psionic",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_RACE]="race",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_OTHER_REWARD]="reward",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_VARIANT_OPTIONAL_RULE]="variantrule",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_ADVENTURE]="adventure",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_DEITY]="deity",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_OBJECT]="object",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_TRAP]="trap",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_HAZARD]="hazard",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_CULT]="cult",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_BOON]="boon",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_DISEASE]="condition",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_TABLE]="table",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_TABLE_GROUP]="tableGroup",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_ELDRITCH_INVOCATION]="optionalfeature",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_MANEUVER_CAVALIER]="optionalfeature",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_ARCANE_SHOT]="optionalfeature",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_OPTIONAL_FEATURE_OTHER]="optionalfeature",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_FIGHTING_STYLE]="optionalfeature",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_METAMAGIC]="optionalfeature",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_MANEUVER_BATTLEMASTER]="optionalfeature",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_PACT_BOON]="optionalfeature",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_ELEMENTAL_DISCIPLINE]="optionalfeature",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_ARTIFICER_INFUSION]="optionalfeature",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_SHIP_UPGRADE]="optionalfeature",Parser.pageCategoryToProp=function(e){return Parser._parse_aToB(Parser.CAT_ID_TO_PROP,e)},Parser.ABIL_ABVS=["str","dex","con","int","wis","cha"],Parser.spSubclassesToCurrentAndLegacyFull=function(e,t){function n(e){return"Favored Soul"===e?"Divine Soul":"Undying Light"===e?"Celestial":"Deep Stalker"===e?"Gloom Stalker":e}const o=[[],[]];if(!e.fromSubclass)return o;const a=new Set,i=[];return e.fromSubclass.sort((e,t)=>{const n=SortUtil.ascSort(e.subclass.name,t.subclass.name);return n||SortUtil.ascSort(e.class.name,t.class.name)}).forEach(e=>{const r=e.subclass.name,s=e.subclass.source,_=Parser._spSubclassItem(e,!1,t);if(SourceUtil.hasBeenReprinted(r,s))o[1].push(_);else if(Parser.sourceJsonToFull(s).startsWith(UA_PREFIX)||Parser.sourceJsonToFull(s).startsWith(PS_PREFIX)){const e=n(r.split("(")[0].trim().split(/v\d+/)[0].trim());i.push({name:e,ele:_})}else o[0].push(_),a.add(r)}),i.forEach(e=>{a.has(e.name)?o[1].push(e.ele):o[0].push(e.ele)}),[o[0].join(", "),o[1].join(", ")]},Parser.attackTypeToFull=function(e){return Parser._parse_aToB(Parser.ATK_TYPE_TO_FULL,e)},Parser.trapHazTypeToFull=function(e){return Parser._parse_aToB(Parser.TRAP_HAZARD_TYPE_TO_FULL,e)},Parser.TRAP_HAZARD_TYPE_TO_FULL={MECH:"Mechanical trap",MAG:"Magical trap",SMPL:"Simple trap",CMPX:"Complex trap",HAZ:"Hazard",WTH:"Weather",ENV:"Environmental Hazard",WLD:"Wilderness Hazard",GEN:"Generic"},Parser.tierToFullLevel=function(e){return Parser._parse_aToB(Parser.TIER_TO_FULL_LEVEL,e)},Parser.TIER_TO_FULL_LEVEL={},Parser.TIER_TO_FULL_LEVEL[1]="level 1\u20144",Parser.TIER_TO_FULL_LEVEL[2]="level 5\u201410",Parser.TIER_TO_FULL_LEVEL[3]="level 11\u201416",Parser.TIER_TO_FULL_LEVEL[4]="level 17\u201420",Parser.threatToFull=function(e){return Parser._parse_aToB(Parser.THREAT_TO_FULL,e)},Parser.THREAT_TO_FULL={},Parser.THREAT_TO_FULL[1]="moderate",Parser.THREAT_TO_FULL[2]="dangerous",Parser.THREAT_TO_FULL[3]="deadly",Parser.trapInitToFull=function(e){return Parser._parse_aToB(Parser.TRAP_INIT_TO_FULL,e)},Parser.TRAP_INIT_TO_FULL={},Parser.TRAP_INIT_TO_FULL[1]="initiative count 10",Parser.TRAP_INIT_TO_FULL[2]="initiative count 20",Parser.TRAP_INIT_TO_FULL[3]="initiative count 20 and initiative count 10",Parser.ATK_TYPE_TO_FULL={},Parser.ATK_TYPE_TO_FULL.MW="Melee Weapon Attack",Parser.ATK_TYPE_TO_FULL.RW="Ranged Weapon Attack",Parser.bookOrdinalToAbv=(e,t)=>{if(e===void 0)return"";switch(e.type){case"part":return`${t?" ":""}Part ${e.identifier}${t?"":" \u2014 "}`;case"chapter":return`${t?" ":""}Ch. ${e.identifier}${t?"":": "}`;case"episode":return`${t?" ":""}Ep. ${e.identifier}${t?"":": "}`;case"appendix":return`${t?" ":""}App. ${e.identifier}${t?"":": "}`;case"level":return`${t?" ":""}Level ${e.identifier}${t?"":": "}`;default:throw new Error(`Unhandled ordinal type "${e.type}"`);}},Parser.nameToTokenName=function(e){return e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/Æ/g,"AE").replace(/æ/g,"ae").replace(/"/g,"")},SKL_ABV_ABJ="A",SKL_ABV_EVO="V",SKL_ABV_ENC="E",SKL_ABV_ILL="I",SKL_ABV_DIV="D",SKL_ABV_NEC="N",SKL_ABV_TRA="T",SKL_ABV_CON="C",SKL_ABV_PSI="P",SKL_ABJ="Abjuration",SKL_EVO="Evocation",SKL_ENC="Enchantment",SKL_ILL="Illusion",SKL_DIV="Divination",SKL_NEC="Necromancy",SKL_TRA="Transmutation",SKL_CON="Conjuration",SKL_PSI="Psionic",Parser.SP_SCHOOL_ABV_TO_FULL={},Parser.SP_SCHOOL_ABV_TO_FULL[SKL_ABV_ABJ]=SKL_ABJ,Parser.SP_SCHOOL_ABV_TO_FULL[SKL_ABV_EVO]=SKL_EVO,Parser.SP_SCHOOL_ABV_TO_FULL[SKL_ABV_ENC]=SKL_ENC,Parser.SP_SCHOOL_ABV_TO_FULL[SKL_ABV_ILL]=SKL_ILL,Parser.SP_SCHOOL_ABV_TO_FULL[SKL_ABV_DIV]=SKL_DIV,Parser.SP_SCHOOL_ABV_TO_FULL[SKL_ABV_NEC]=SKL_NEC,Parser.SP_SCHOOL_ABV_TO_FULL[SKL_ABV_TRA]=SKL_TRA,Parser.SP_SCHOOL_ABV_TO_FULL[SKL_ABV_CON]=SKL_CON,Parser.SP_SCHOOL_ABV_TO_FULL[SKL_ABV_PSI]=SKL_PSI,Parser.SP_SCHOOL_ABV_TO_SHORT={},Parser.SP_SCHOOL_ABV_TO_SHORT[SKL_ABV_ABJ]="Abj.",Parser.SP_SCHOOL_ABV_TO_SHORT[SKL_ABV_EVO]="Evoc.",Parser.SP_SCHOOL_ABV_TO_SHORT[SKL_ABV_ENC]="Ench.",Parser.SP_SCHOOL_ABV_TO_SHORT[SKL_ABV_ILL]="Illu.",Parser.SP_SCHOOL_ABV_TO_SHORT[SKL_ABV_DIV]="Divin.",Parser.SP_SCHOOL_ABV_TO_SHORT[SKL_ABV_NEC]="Necro.",Parser.SP_SCHOOL_ABV_TO_SHORT[SKL_ABV_TRA]="Trans.",Parser.SP_SCHOOL_ABV_TO_SHORT[SKL_ABV_CON]="Conj.",Parser.SP_SCHOOL_ABV_TO_SHORT[SKL_ABV_PSI]="Psi.",Parser.ATB_ABV_TO_FULL={str:"Strength",dex:"Dexterity",con:"Constitution",int:"Intelligence",wis:"Wisdom",cha:"Charisma"},TP_ABERRATION="aberration",TP_BEAST="beast",TP_CELESTIAL="celestial",TP_CONSTRUCT="construct",TP_DRAGON="dragon",TP_ELEMENTAL="elemental",TP_FEY="fey",TP_FIEND="fiend",TP_GIANT="giant",TP_HUMANOID="humanoid",TP_MONSTROSITY="monstrosity",TP_OOZE="ooze",TP_PLANT="plant",TP_UNDEAD="undead",Parser.MON_TYPES=[TP_ABERRATION,TP_BEAST,TP_CELESTIAL,TP_CONSTRUCT,TP_DRAGON,TP_ELEMENTAL,TP_FEY,TP_FIEND,TP_GIANT,TP_HUMANOID,TP_MONSTROSITY,TP_OOZE,TP_PLANT,TP_UNDEAD],Parser.MON_TYPE_TO_PLURAL={},Parser.MON_TYPE_TO_PLURAL[TP_ABERRATION]="aberrations",Parser.MON_TYPE_TO_PLURAL[TP_BEAST]="beasts",Parser.MON_TYPE_TO_PLURAL[TP_CELESTIAL]="celestials",Parser.MON_TYPE_TO_PLURAL[TP_CONSTRUCT]="constructs",Parser.MON_TYPE_TO_PLURAL[TP_DRAGON]="dragons",Parser.MON_TYPE_TO_PLURAL[TP_ELEMENTAL]="elementals",Parser.MON_TYPE_TO_PLURAL[TP_FEY]="fey",Parser.MON_TYPE_TO_PLURAL[TP_FIEND]="fiends",Parser.MON_TYPE_TO_PLURAL[TP_GIANT]="giants",Parser.MON_TYPE_TO_PLURAL[TP_HUMANOID]="humanoids",Parser.MON_TYPE_TO_PLURAL[TP_MONSTROSITY]="monstrosities",Parser.MON_TYPE_TO_PLURAL[TP_OOZE]="oozes",Parser.MON_TYPE_TO_PLURAL[TP_PLANT]="plants",Parser.MON_TYPE_TO_PLURAL[TP_UNDEAD]="undead",SZ_FINE="F",SZ_DIMINUTIVE="D",SZ_TINY="T",SZ_SMALL="S",SZ_MEDIUM="M",SZ_LARGE="L",SZ_HUGE="H",SZ_GARGANTUAN="G",SZ_COLOSSAL="C",SZ_VARIES="V",Parser.SIZE_ABVS=[SZ_TINY,SZ_SMALL,SZ_MEDIUM,SZ_LARGE,SZ_HUGE,SZ_GARGANTUAN,SZ_VARIES],Parser.SIZE_ABV_TO_FULL={},Parser.SIZE_ABV_TO_FULL[SZ_FINE]="Fine",Parser.SIZE_ABV_TO_FULL[SZ_DIMINUTIVE]="Diminutive",Parser.SIZE_ABV_TO_FULL[SZ_TINY]="Tiny",Parser.SIZE_ABV_TO_FULL[SZ_SMALL]="Small",Parser.SIZE_ABV_TO_FULL[SZ_MEDIUM]="Medium",Parser.SIZE_ABV_TO_FULL[SZ_LARGE]="Large",Parser.SIZE_ABV_TO_FULL[SZ_HUGE]="Huge",Parser.SIZE_ABV_TO_FULL[SZ_GARGANTUAN]="Gargantuan",Parser.SIZE_ABV_TO_FULL[SZ_COLOSSAL]="Colossal",Parser.SIZE_ABV_TO_FULL[SZ_VARIES]="Varies",Parser.XP_CHART=[200,450,700,1100,1800,2300,2900,3900,5e3,5900,7200,8400,1e4,11500,13e3,15e3,18e3,2e4,22e3,25e3,3e4,41e3,5e4,62e3,75e3,9e4,105e3,12e4,135e3,155e3],Parser.XP_CHART_ALT={0:10,"1/8":25,"1/4":50,"1/2":100,1:200,2:450,3:700,4:1100,5:1800,6:2300,7:2900,8:3900,9:5e3,10:5900,11:7200,12:8400,13:1e4,14:11500,15:13e3,16:15e3,17:18e3,18:2e4,19:22e3,20:25e3,21:3e4,22:41e3,23:5e4,24:62e3,25:75e3,26:9e4,27:105e3,28:12e4,29:135e3,30:155e3},Parser.ARMOR_ABV_TO_FULL={"l.":"light","m.":"medium","h.":"heavy"},SRC_CoS="CoS",SRC_DMG="DMG",SRC_EEPC="EEPC",SRC_EET="EET",SRC_HotDQ="HotDQ",SRC_LMoP="LMoP",SRC_Mag="Mag",SRC_MM="MM",SRC_OotA="OotA",SRC_PHB="PHB",SRC_PotA="PotA",SRC_RoT="RoT",SRC_RoTOS="RoTOS",SRC_SCAG="SCAG",SRC_SKT="SKT",SRC_ToA="ToA",SRC_ToD="ToD",SRC_TTP="TTP",SRC_TYP="TftYP",SRC_TYP_AtG="TftYP-AtG",SRC_TYP_DiT="TftYP-DiT",SRC_TYP_TFoF="TftYP-TFoF",SRC_TYP_THSoT="TftYP-THSoT",SRC_TYP_TSC="TftYP-TSC",SRC_TYP_ToH="TftYP-ToH",SRC_TYP_WPM="TftYP-WPM",SRC_VGM="VGM",SRC_XGE="XGE",SRC_OGA="OGA",SRC_MTF="MTF",SRC_WDH="WDH",SRC_WDMM="WDMM",SRC_GGR="GGR",SRC_KKW="KKW",SRC_LLK="LLK",SRC_GoS="GoS",SRC_AI="AI",SRC_AL="AL",SRC_SCREEN="Screen",SRC_ALCoS="ALCurseOfStrahd",SRC_ALEE="ALElementalEvil",SRC_ALRoD="ALRageOfDemons",SRC_PS_PREFIX="PS",SRC_PSA=SRC_PS_PREFIX+"A",SRC_PSI=SRC_PS_PREFIX+"I",SRC_PSK=SRC_PS_PREFIX+"K",SRC_PSZ=SRC_PS_PREFIX+"Z",SRC_PSX=SRC_PS_PREFIX+"X",SRC_PSD=SRC_PS_PREFIX+"D",SRC_UA_PREFIX="UA",SRC_UAA=SRC_UA_PREFIX+"Artificer",SRC_UAEAG=SRC_UA_PREFIX+"EladrinAndGith",SRC_UAEBB=SRC_UA_PREFIX+"Eberron",SRC_UAFFR=SRC_UA_PREFIX+"FeatsForRaces",SRC_UAFFS=SRC_UA_PREFIX+"FeatsForSkills",SRC_UAFO=SRC_UA_PREFIX+"FiendishOptions",SRC_UAFT=SRC_UA_PREFIX+"Feats",SRC_UAGH=SRC_UA_PREFIX+"GothicHeroes",SRC_UAMDM=SRC_UA_PREFIX+"ModernMagic",SRC_UASSP=SRC_UA_PREFIX+"StarterSpells",SRC_UATMC=SRC_UA_PREFIX+"TheMysticClass",SRC_UATOBM=SRC_UA_PREFIX+"ThatOldBlackMagic",SRC_UATRR=SRC_UA_PREFIX+"TheRangerRevised",SRC_UAWA=SRC_UA_PREFIX+"WaterborneAdventures",SRC_UAVR=SRC_UA_PREFIX+"VariantRules",SRC_UALDR=SRC_UA_PREFIX+"LightDarkUnderdark",SRC_UARAR=SRC_UA_PREFIX+"RangerAndRogue",SRC_UAATOSC=SRC_UA_PREFIX+"ATrioOfSubclasses",SRC_UABPP=SRC_UA_PREFIX+"BarbarianPrimalPaths",SRC_UARSC=SRC_UA_PREFIX+"RevisedSubclasses",SRC_UAKOO=SRC_UA_PREFIX+"KitsOfOld",SRC_UABBC=SRC_UA_PREFIX+"BardBardColleges",SRC_UACDD=SRC_UA_PREFIX+"ClericDivineDomains",SRC_UAD=SRC_UA_PREFIX+"Druid",SRC_UARCO=SRC_UA_PREFIX+"RevisedClassOptions",SRC_UAF=SRC_UA_PREFIX+"Fighter",SRC_UAM=SRC_UA_PREFIX+"Monk",SRC_UAP=SRC_UA_PREFIX+"Paladin",SRC_UAMC=SRC_UA_PREFIX+"ModifyingClasses",SRC_UAS=SRC_UA_PREFIX+"Sorcerer",SRC_UAWAW=SRC_UA_PREFIX+"WarlockAndWizard",SRC_UATF=SRC_UA_PREFIX+"TheFaithful",SRC_UAWR=SRC_UA_PREFIX+"WizardRevisited",SRC_UAESR=SRC_UA_PREFIX+"ElfSubraces",SRC_UAMAC=SRC_UA_PREFIX+"MassCombat",SRC_UA3PE=SRC_UA_PREFIX+"ThreePillarExperience",SRC_UAGHI=SRC_UA_PREFIX+"GreyhawkInitiative",SRC_UATSC=SRC_UA_PREFIX+"ThreeSubclasses",SRC_UAOD=SRC_UA_PREFIX+"OrderDomain",SRC_UACAM=SRC_UA_PREFIX+"CentaursMinotaurs",SRC_UAGSS=SRC_UA_PREFIX+"GiantSoulSorcerer",SRC_UARoE=SRC_UA_PREFIX+"RacesOfEberron",SRC_UARoR=SRC_UA_PREFIX+"RacesOfRavnica",SRC_UAWGE=SRC_UA_PREFIX+"WGE",SRC_UAOSS=SRC_UA_PREFIX+"OfShipsAndSea",SRC_UASIK=SRC_UA_PREFIX+"Sidekicks",SRC_UAAR=SRC_UA_PREFIX+"ArtificerRevisited",SRC_3PP_SUFFIX=" 3pp",SRC_STREAM="Stream",SRC_TWITTER="Twitter",AL_PREFIX="Adventurers League: ",AL_PREFIX_SHORT="AL: ",PS_PREFIX="Plane Shift: ",PS_PREFIX_SHORT="PS: ",UA_PREFIX="Unearthed Arcana: ",UA_PREFIX_SHORT="UA: ",TftYP_NAME="Tales from the Yawning Portal",Parser.SOURCE_JSON_TO_FULL={},Parser.SOURCE_JSON_TO_FULL[SRC_CoS]="Curse of Strahd",Parser.SOURCE_JSON_TO_FULL[SRC_DMG]="Dungeon Master's Guide",Parser.SOURCE_JSON_TO_FULL[SRC_EEPC]="Elemental Evil Player's Companion",Parser.SOURCE_JSON_TO_FULL[SRC_EET]="Elemental Evil: Trinkets",Parser.SOURCE_JSON_TO_FULL[SRC_HotDQ]="Hoard of the Dragon Queen",Parser.SOURCE_JSON_TO_FULL[SRC_LMoP]="Lost Mine of Phandelver",Parser.SOURCE_JSON_TO_FULL[SRC_Mag]="Dragon Magazine",Parser.SOURCE_JSON_TO_FULL[SRC_MM]="Monster Manual",Parser.SOURCE_JSON_TO_FULL[SRC_OotA]="Out of the Abyss",Parser.SOURCE_JSON_TO_FULL[SRC_PHB]="Player's Handbook",Parser.SOURCE_JSON_TO_FULL[SRC_PotA]="Princes of the Apocalypse",Parser.SOURCE_JSON_TO_FULL[SRC_RoT]="The Rise of Tiamat",Parser.SOURCE_JSON_TO_FULL[SRC_RoTOS]="The Rise of Tiamat Online Supplement",Parser.SOURCE_JSON_TO_FULL[SRC_SCAG]="Sword Coast Adventurer's Guide",Parser.SOURCE_JSON_TO_FULL[SRC_SKT]="Storm King's Thunder",Parser.SOURCE_JSON_TO_FULL[SRC_ToA]="Tomb of Annihilation",Parser.SOURCE_JSON_TO_FULL[SRC_ToD]="Tyranny of Dragons",Parser.SOURCE_JSON_TO_FULL[SRC_TTP]="The Tortle Package",Parser.SOURCE_JSON_TO_FULL[SRC_TYP]=TftYP_NAME,Parser.SOURCE_JSON_TO_FULL[SRC_TYP_AtG]=TftYP_NAME,Parser.SOURCE_JSON_TO_FULL[SRC_TYP_DiT]=TftYP_NAME,Parser.SOURCE_JSON_TO_FULL[SRC_TYP_TFoF]=TftYP_NAME,Parser.SOURCE_JSON_TO_FULL[SRC_TYP_THSoT]=TftYP_NAME,Parser.SOURCE_JSON_TO_FULL[SRC_TYP_TSC]=TftYP_NAME,Parser.SOURCE_JSON_TO_FULL[SRC_TYP_ToH]=TftYP_NAME,Parser.SOURCE_JSON_TO_FULL[SRC_TYP_WPM]=TftYP_NAME,Parser.SOURCE_JSON_TO_FULL[SRC_VGM]="Volo's Guide to Monsters",Parser.SOURCE_JSON_TO_FULL[SRC_XGE]="Xanathar's Guide to Everything",Parser.SOURCE_JSON_TO_FULL[SRC_OGA]="One Grung Above",Parser.SOURCE_JSON_TO_FULL[SRC_MTF]="Mordenkainen's Tome of Foes",Parser.SOURCE_JSON_TO_FULL[SRC_WDH]="Waterdeep: Dragon Heist",Parser.SOURCE_JSON_TO_FULL[SRC_WDMM]="Waterdeep: Dungeon of the Mad Mage",Parser.SOURCE_JSON_TO_FULL[SRC_GGR]="Guildmasters' Guide to Ravnica",Parser.SOURCE_JSON_TO_FULL[SRC_KKW]="Krenko's Way",Parser.SOURCE_JSON_TO_FULL[SRC_LLK]="Lost Laboratory of Kwalish",Parser.SOURCE_JSON_TO_FULL[SRC_GoS]="Ghosts of Saltmarsh",Parser.SOURCE_JSON_TO_FULL[SRC_AI]="Acquisitions Incorporated",Parser.SOURCE_JSON_TO_FULL[SRC_AL]="Adventurers' League",Parser.SOURCE_JSON_TO_FULL[SRC_SCREEN]="Dungeon Master's Screen",Parser.SOURCE_JSON_TO_FULL[SRC_ALCoS]=AL_PREFIX+"Curse of Strahd",Parser.SOURCE_JSON_TO_FULL[SRC_ALEE]=AL_PREFIX+"Elemental Evil",Parser.SOURCE_JSON_TO_FULL[SRC_ALRoD]=AL_PREFIX+"Rage of Demons",Parser.SOURCE_JSON_TO_FULL[SRC_PSA]=PS_PREFIX+"Amonkhet",Parser.SOURCE_JSON_TO_FULL[SRC_PSI]=PS_PREFIX+"Innistrad",Parser.SOURCE_JSON_TO_FULL[SRC_PSK]=PS_PREFIX+"Kaladesh",Parser.SOURCE_JSON_TO_FULL[SRC_PSZ]=PS_PREFIX+"Zendikar",Parser.SOURCE_JSON_TO_FULL[SRC_PSX]=PS_PREFIX+"Ixalan",Parser.SOURCE_JSON_TO_FULL[SRC_PSD]=PS_PREFIX+"Dominaria",Parser.SOURCE_JSON_TO_FULL[SRC_UAA]=UA_PREFIX+"Artificer",Parser.SOURCE_JSON_TO_FULL[SRC_UAEAG]=UA_PREFIX+"Eladrin and Gith",Parser.SOURCE_JSON_TO_FULL[SRC_UAEBB]=UA_PREFIX+"Eberron",Parser.SOURCE_JSON_TO_FULL[SRC_UAFFR]=UA_PREFIX+"Feats for Races",Parser.SOURCE_JSON_TO_FULL[SRC_UAFFS]=UA_PREFIX+"Feats for Skills",Parser.SOURCE_JSON_TO_FULL[SRC_UAFO]=UA_PREFIX+"Fiendish Options",Parser.SOURCE_JSON_TO_FULL[SRC_UAFT]=UA_PREFIX+"Feats",Parser.SOURCE_JSON_TO_FULL[SRC_UAGH]=UA_PREFIX+"Gothic Heroes",Parser.SOURCE_JSON_TO_FULL[SRC_UAMDM]=UA_PREFIX+"Modern Magic",Parser.SOURCE_JSON_TO_FULL[SRC_UASSP]=UA_PREFIX+"Starter Spells",Parser.SOURCE_JSON_TO_FULL[SRC_UATMC]=UA_PREFIX+"The Mystic Class",Parser.SOURCE_JSON_TO_FULL[SRC_UATOBM]=UA_PREFIX+"That Old Black Magic",Parser.SOURCE_JSON_TO_FULL[SRC_UATRR]=UA_PREFIX+"The Ranger, Revised",Parser.SOURCE_JSON_TO_FULL[SRC_UAWA]=UA_PREFIX+"Waterborne Adventures",Parser.SOURCE_JSON_TO_FULL[SRC_UAVR]=UA_PREFIX+"Variant Rules",Parser.SOURCE_JSON_TO_FULL[SRC_UALDR]=UA_PREFIX+"Light, Dark, Underdark!",Parser.SOURCE_JSON_TO_FULL[SRC_UARAR]=UA_PREFIX+"Ranger and Rogue",Parser.SOURCE_JSON_TO_FULL[SRC_UAATOSC]=UA_PREFIX+"A Trio of Subclasses",Parser.SOURCE_JSON_TO_FULL[SRC_UABPP]=UA_PREFIX+"Barbarian Primal Paths",Parser.SOURCE_JSON_TO_FULL[SRC_UARSC]=UA_PREFIX+"Revised Subclasses",Parser.SOURCE_JSON_TO_FULL[SRC_UAKOO]=UA_PREFIX+"Kits of Old",Parser.SOURCE_JSON_TO_FULL[SRC_UABBC]=UA_PREFIX+"Bard: Bard Colleges",Parser.SOURCE_JSON_TO_FULL[SRC_UACDD]=UA_PREFIX+"Cleric: Divine Domains",Parser.SOURCE_JSON_TO_FULL[SRC_UAD]=UA_PREFIX+"Druid",Parser.SOURCE_JSON_TO_FULL[SRC_UARCO]=UA_PREFIX+"Revised Class Options",Parser.SOURCE_JSON_TO_FULL[SRC_UAF]=UA_PREFIX+"Fighter",Parser.SOURCE_JSON_TO_FULL[SRC_UAM]=UA_PREFIX+"Monk",Parser.SOURCE_JSON_TO_FULL[SRC_UAP]=UA_PREFIX+"Paladin",Parser.SOURCE_JSON_TO_FULL[SRC_UAMC]=UA_PREFIX+"Modifying Classes",Parser.SOURCE_JSON_TO_FULL[SRC_UAS]=UA_PREFIX+"Sorcerer",Parser.SOURCE_JSON_TO_FULL[SRC_UAWAW]=UA_PREFIX+"Warlock and Wizard",Parser.SOURCE_JSON_TO_FULL[SRC_UATF]=UA_PREFIX+"The Faithful",Parser.SOURCE_JSON_TO_FULL[SRC_UAWR]=UA_PREFIX+"Wizard Revisited",Parser.SOURCE_JSON_TO_FULL[SRC_UAESR]=UA_PREFIX+"Elf Subraces",Parser.SOURCE_JSON_TO_FULL[SRC_UAMAC]=UA_PREFIX+"Mass Combat",Parser.SOURCE_JSON_TO_FULL[SRC_UA3PE]=UA_PREFIX+"Three-Pillar Experience",Parser.SOURCE_JSON_TO_FULL[SRC_UAGHI]=UA_PREFIX+"Greyhawk Initiative",Parser.SOURCE_JSON_TO_FULL[SRC_UATSC]=UA_PREFIX+"Three Subclasses",Parser.SOURCE_JSON_TO_FULL[SRC_UAOD]=UA_PREFIX+"Order Domain",Parser.SOURCE_JSON_TO_FULL[SRC_UACAM]=UA_PREFIX+"Centaurs and Minotaurs",Parser.SOURCE_JSON_TO_FULL[SRC_UAGSS]=UA_PREFIX+"Giant Soul Sorcerer",Parser.SOURCE_JSON_TO_FULL[SRC_UARoE]=UA_PREFIX+"Races of Eberron",Parser.SOURCE_JSON_TO_FULL[SRC_UARoR]=UA_PREFIX+"Races of Ravnica",Parser.SOURCE_JSON_TO_FULL[SRC_UAWGE]="Wayfinder's Guide to Eberron",Parser.SOURCE_JSON_TO_FULL[SRC_UAOSS]=UA_PREFIX+"Of Ships and the Sea",Parser.SOURCE_JSON_TO_FULL[SRC_UASIK]=UA_PREFIX+"Sidekicks",Parser.SOURCE_JSON_TO_FULL[SRC_UAAR]=UA_PREFIX+"Artificer Revisited",Parser.SOURCE_JSON_TO_FULL[SRC_STREAM]="Livestream",Parser.SOURCE_JSON_TO_FULL[SRC_TWITTER]="Twitter",Parser.SOURCE_JSON_TO_ABV={},Parser.SOURCE_JSON_TO_ABV[SRC_CoS]="CoS",Parser.SOURCE_JSON_TO_ABV[SRC_DMG]="DMG",Parser.SOURCE_JSON_TO_ABV[SRC_EEPC]="EEPC",Parser.SOURCE_JSON_TO_ABV[SRC_EET]="EET",Parser.SOURCE_JSON_TO_ABV[SRC_HotDQ]="HotDQ",Parser.SOURCE_JSON_TO_ABV[SRC_LMoP]="LMoP",Parser.SOURCE_JSON_TO_ABV[SRC_Mag]="Mag",Parser.SOURCE_JSON_TO_ABV[SRC_MM]="MM",Parser.SOURCE_JSON_TO_ABV[SRC_OotA]="OotA",Parser.SOURCE_JSON_TO_ABV[SRC_PHB]="PHB",Parser.SOURCE_JSON_TO_ABV[SRC_PotA]="PotA",Parser.SOURCE_JSON_TO_ABV[SRC_RoT]="RoT",Parser.SOURCE_JSON_TO_ABV[SRC_RoTOS]="RoTOS",Parser.SOURCE_JSON_TO_ABV[SRC_SCAG]="SCAG",Parser.SOURCE_JSON_TO_ABV[SRC_SKT]="SKT",Parser.SOURCE_JSON_TO_ABV[SRC_ToA]="ToA",Parser.SOURCE_JSON_TO_ABV[SRC_ToD]="ToD",Parser.SOURCE_JSON_TO_ABV[SRC_TTP]="TTP",Parser.SOURCE_JSON_TO_ABV[SRC_TYP]="TftYP",Parser.SOURCE_JSON_TO_ABV[SRC_TYP_AtG]="TftYP",Parser.SOURCE_JSON_TO_ABV[SRC_TYP_DiT]="TftYP",Parser.SOURCE_JSON_TO_ABV[SRC_TYP_TFoF]="TftYP",Parser.SOURCE_JSON_TO_ABV[SRC_TYP_THSoT]="TftYP",Parser.SOURCE_JSON_TO_ABV[SRC_TYP_TSC]="TftYP",Parser.SOURCE_JSON_TO_ABV[SRC_TYP_ToH]="TftYP",Parser.SOURCE_JSON_TO_ABV[SRC_TYP_WPM]="TftYP",Parser.SOURCE_JSON_TO_ABV[SRC_VGM]="VGM",Parser.SOURCE_JSON_TO_ABV[SRC_XGE]="XGE",Parser.SOURCE_JSON_TO_ABV[SRC_OGA]="OGA",Parser.SOURCE_JSON_TO_ABV[SRC_MTF]="MTF",Parser.SOURCE_JSON_TO_ABV[SRC_WDH]="WDH",Parser.SOURCE_JSON_TO_ABV[SRC_WDMM]="WDMM",Parser.SOURCE_JSON_TO_ABV[SRC_GGR]="GGR",Parser.SOURCE_JSON_TO_ABV[SRC_KKW]="KKW",Parser.SOURCE_JSON_TO_ABV[SRC_LLK]="LLK",Parser.SOURCE_JSON_TO_ABV[SRC_GoS]="GoS",Parser.SOURCE_JSON_TO_ABV[SRC_AI]="AI",Parser.SOURCE_JSON_TO_ABV[SRC_AL]="AL",Parser.SOURCE_JSON_TO_ABV[SRC_SCREEN]="Screen",Parser.SOURCE_JSON_TO_ABV[SRC_ALCoS]="ALCoS",Parser.SOURCE_JSON_TO_ABV[SRC_ALEE]="ALEE",Parser.SOURCE_JSON_TO_ABV[SRC_ALRoD]="ALRoD",Parser.SOURCE_JSON_TO_ABV[SRC_PSA]="PSA",Parser.SOURCE_JSON_TO_ABV[SRC_PSI]="PSI",Parser.SOURCE_JSON_TO_ABV[SRC_PSK]="PSK",Parser.SOURCE_JSON_TO_ABV[SRC_PSZ]="PSZ",Parser.SOURCE_JSON_TO_ABV[SRC_PSX]="PSX",Parser.SOURCE_JSON_TO_ABV[SRC_PSD]="PSD",Parser.SOURCE_JSON_TO_ABV[SRC_UAA]="UAA",Parser.SOURCE_JSON_TO_ABV[SRC_UAEAG]="UAEaG",Parser.SOURCE_JSON_TO_ABV[SRC_UAEBB]="UAEB",Parser.SOURCE_JSON_TO_ABV[SRC_UAFFR]="UAFFR",Parser.SOURCE_JSON_TO_ABV[SRC_UAFFS]="UAFFS",Parser.SOURCE_JSON_TO_ABV[SRC_UAFO]="UAFO",Parser.SOURCE_JSON_TO_ABV[SRC_UAFT]="UAFT",Parser.SOURCE_JSON_TO_ABV[SRC_UAGH]="UAGH",Parser.SOURCE_JSON_TO_ABV[SRC_UAMDM]="UAMM",Parser.SOURCE_JSON_TO_ABV[SRC_UASSP]="UASS",Parser.SOURCE_JSON_TO_ABV[SRC_UATMC]="UAM",Parser.SOURCE_JSON_TO_ABV[SRC_UATOBM]="UAOBM",Parser.SOURCE_JSON_TO_ABV[SRC_UATRR]="UATRR",Parser.SOURCE_JSON_TO_ABV[SRC_UAWA]="UAWA",Parser.SOURCE_JSON_TO_ABV[SRC_UAVR]="UAVR",Parser.SOURCE_JSON_TO_ABV[SRC_UALDR]="UALDU",Parser.SOURCE_JSON_TO_ABV[SRC_UARAR]="UARAR",Parser.SOURCE_JSON_TO_ABV[SRC_UAATOSC]="UAATOSC",Parser.SOURCE_JSON_TO_ABV[SRC_UABPP]="UABPP",Parser.SOURCE_JSON_TO_ABV[SRC_UARSC]="UARSC",Parser.SOURCE_JSON_TO_ABV[SRC_UAKOO]="UAKoO",Parser.SOURCE_JSON_TO_ABV[SRC_UABBC]="UABBC",Parser.SOURCE_JSON_TO_ABV[SRC_UACDD]="UACDD",Parser.SOURCE_JSON_TO_ABV[SRC_UAD]="UAD",Parser.SOURCE_JSON_TO_ABV[SRC_UARCO]="UARCO",Parser.SOURCE_JSON_TO_ABV[SRC_UAF]="UAF",Parser.SOURCE_JSON_TO_ABV[SRC_UAM]="UAM",Parser.SOURCE_JSON_TO_ABV[SRC_UAP]="UAP",Parser.SOURCE_JSON_TO_ABV[SRC_UAMC]="UAMC",Parser.SOURCE_JSON_TO_ABV[SRC_UAS]="UAS",Parser.SOURCE_JSON_TO_ABV[SRC_UAWAW]="UAWAW",Parser.SOURCE_JSON_TO_ABV[SRC_UATF]="UATF",Parser.SOURCE_JSON_TO_ABV[SRC_UAWR]="UAWR",Parser.SOURCE_JSON_TO_ABV[SRC_UAESR]="UAESR",Parser.SOURCE_JSON_TO_ABV[SRC_UAMAC]="UAMAC",Parser.SOURCE_JSON_TO_ABV[SRC_UA3PE]="UA3PE",Parser.SOURCE_JSON_TO_ABV[SRC_UAGHI]="UAGHI",Parser.SOURCE_JSON_TO_ABV[SRC_UATSC]="UATSC",Parser.SOURCE_JSON_TO_ABV[SRC_UAOD]="UAOD",Parser.SOURCE_JSON_TO_ABV[SRC_UACAM]="UACAM",Parser.SOURCE_JSON_TO_ABV[SRC_UAGSS]="UAGSS",Parser.SOURCE_JSON_TO_ABV[SRC_UARoE]="UARoE",Parser.SOURCE_JSON_TO_ABV[SRC_UARoR]="UARoR",Parser.SOURCE_JSON_TO_ABV[SRC_UAWGE]="WGE",Parser.SOURCE_JSON_TO_ABV[SRC_UAOSS]="UAOSS",Parser.SOURCE_JSON_TO_ABV[SRC_UASIK]="UASIK",Parser.SOURCE_JSON_TO_ABV[SRC_UAAR]="UAAR",Parser.SOURCE_JSON_TO_ABV[SRC_STREAM]="Stream",Parser.SOURCE_JSON_TO_ABV[SRC_TWITTER]="Twitter",Parser.ITEM_TYPE_JSON_TO_ABV={A:"Ammunition",AF:"Ammunition",AT:"Artisan Tool",EM:"Eldritch Machine",EXP:"Explosive",G:"Adventuring Gear",GS:"Gaming Set",HA:"Heavy Armor",INS:"Instrument",LA:"Light Armor",M:"Melee Weapon",MA:"Medium Armor",MNT:"Mount",GV:"Generic Variant",P:"Potion",R:"Ranged Weapon",RD:"Rod",RG:"Ring",S:"Shield",SC:"Scroll",SCF:"Spellcasting Focus",OTH:"Other",T:"Tool",TAH:"Tack and Harness",TG:"Trade Good",VEH:"Vehicle (land)",SHP:"Vehicle (water)",AIR:"Vehicle (air)",WD:"Wand"},Parser.DMGTYPE_JSON_TO_FULL={A:"acid",B:"bludgeoning",C:"cold",F:"fire",O:"force",L:"lightning",N:"necrotic",P:"piercing",I:"poison",Y:"psychic",R:"radiant",S:"slashing",T:"thunder"},Parser.DMG_TYPES=["acid","bludgeoning","cold","fire","force","lightning","necrotic","piercing","poison","psychic","radiant","slashing","thunder"],Parser.CONDITIONS=["blinded","charmed","deafened","exhaustion","frightened","grappled","incapacitated","invisible","paralyzed","petrified","poisoned","prone","restrained","stunned","unconscious"],Parser.SKILL_JSON_TO_FULL={Acrobatics:["Your Dexterity (Acrobatics) check covers your attempt to stay on your feet in a tricky situation, such as when you're trying to run across a sheet of ice, balance on a tightrope, or stay upright on a rocking ship's deck. The DM might also call for a Dexterity (Acrobatics) check to see if you can perform acrobatic stunts, including dives, rolls, somersaults, and flips."],"Animal Handling":["When there is any question whether you can calm down a domesticated animal, keep a mount from getting spooked, or intuit an animal's intentions, the DM might call for a Wisdom (Animal Handling) check. You also make a Wisdom (Animal Handling) check to control your mount when you attempt a risky maneuver."],Arcana:["Your Intelligence (Arcana) check measures your ability to recall lore about spells, magic items, eldritch symbols, magical traditions, the planes of existence, and the inhabitants of those planes."],Athletics:["Your Strength (Athletics) check covers difficult situations you encounter while climbing, jumping, or swimming. Examples include the following activities:",{type:"list",items:["You attempt to climb a sheer or slippery cliff, avoid hazards while scaling a wall, or cling to a surface while something is trying to knock you off.","You try to jump an unusually long distance or pull off a stunt mid jump.","You struggle to swim or stay afloat in treacherous currents, storm-tossed waves, or areas of thick seaweed. Or another creature tries to push or pull you underwater or otherwise interfere with your swimming."]}],Deception:["Your Charisma (Deception) check determines whether you can convincingly hide the truth, either verbally or through your actions. This deception can encompass everything from misleading others through ambiguity to telling outright lies. Typical situations include trying to fast-talk a guard, con a merchant, earn money through gambling, pass yourself off in a disguise, dull someone's suspicions with false assurances, or maintain a straight face while telling a blatant lie."],History:["Your Intelligence (History) check measures your ability to recall lore about historical events, legendary people, ancient kingdoms, past disputes, recent wars, and lost civilizations."],Insight:["Your Wisdom (Insight) check decides whether you can determine the true intentions of a creature, such as when searching out a lie or predicting someone's next move. Doing so involves gleaning clues from body language, speech habits, and changes in mannerisms."],Intimidation:["When you attempt to influence someone through overt threats, hostile actions, and physical violence, the DM might ask you to make a Charisma (Intimidation) check. Examples include trying to pry information out of a prisoner, convincing street thugs to back down from a confrontation, or using the edge of a broken bottle to convince a sneering vizier to reconsider a decision."],Investigation:["When you look around for clues and make deductions based on those clues, you make an Intelligence (Investigation) check. You might deduce the location of a hidden object, discern from the appearance of a wound what kind of weapon dealt it, or determine the weakest point in a tunnel that could cause it to collapse. Poring through ancient scrolls in search of a hidden fragment of knowledge might also call for an Intelligence (Investigation) check."],Medicine:["A Wisdom (Medicine) check lets you try to stabilize a dying companion or diagnose an illness."],Nature:["Your Intelligence (Nature) check measures your ability to recall lore about terrain, plants and animals, the weather, and natural cycles."],Perception:["Your Wisdom (Perception) check lets you spot, hear, or otherwise detect the presence of something. It measures your general awareness of your surroundings and the keenness of your senses.","For example, you might try to hear a conversation through a closed door, eavesdrop under an open window, or hear monsters moving stealthily in the forest. Or you might try to spot things that are obscured or easy to miss, whether they are orcs lying in ambush on a road, thugs hiding in the shadows of an alley, or candlelight under a closed secret door."],Performance:["Your Charisma (Performance) check determines how well you can delight an audience with music, dance, acting, storytelling, or some other form of entertainment."],Persuasion:["When you attempt to influence someone or a group of people with tact, social graces, or good nature, the DM might ask you to make a Charisma (Persuasion) check. Typically, you use persuasion when acting in good faith, to foster friendships, make cordial requests, or exhibit proper etiquette. Examples of persuading others include convincing a chamberlain to let your party see the king, negotiating peace between warring tribes, or inspiring a crowd of townsfolk."],Religion:["Your Intelligence (Religion) check measures your ability to recall lore about deities, rites and prayers, religious hierarchies, holy symbols, and the practices of secret cults."],"Sleight of Hand":["Whenever you attempt an act of legerdemain or manual trickery, such as planting something on someone else or concealing an object on your person, make a Dexterity (Sleight of Hand) check. The DM might also call for a Dexterity (Sleight of Hand) check to determine whether you can lift a coin purse off another person or slip something out of another person's pocket."],Stealth:["Make a Dexterity (Stealth) check when you attempt to conceal yourself from enemies, slink past guards, slip away without being noticed, or sneak up on someone without being seen or heard."],Survival:["The DM might ask you to make a Wisdom (Survival) check to follow tracks, hunt wild game, guide your group through frozen wastelands, identify signs that owlbears live nearby, predict the weather, or avoid quicksand and other natural hazards."]},Parser.ACTION_JSON_TO_FULL={Attack:["The most common action to take in combat is the Attack action, whether you are swinging a sword, firing an arrow from a bow, or brawling with your fists.","With this action, you make one melee or ranged attack. See the \"{@book Making an Attack|phb|9|making an attack}\" section for the rules that govern attacks.","Certain features, such as the Extra Attack feature of the fighter, allow you to make more than one attack with this action."],Dash:["When you take the Dash action, you gain extra movement for the current turn. The increase equals your speed, after applying any modifiers. With a speed of 30 feet, for example, you can move up to 60 feet on your turn if you dash.","Any increase or decrease to your speed changes this additional movement by the same amount. If your speed of 30 feet is reduced to 15 feet, for instance, you can move up to 30 feet this turn if you dash."],Disengage:["If you take the Disengage action, your movement doesn't provoke opportunity attacks for the rest of the turn."],Dodge:["When you take the Dodge action, you focus entirely on avoiding attacks. Until the start of your next turn, any attack roll made against you has disadvantage if you can see the attacker, and you make Dexterity saving throws with advantage. You lose this benefit if you are incapacitated (as explained in the appendix) or if your speed drops to 0."],Help:["You can lend your aid to another creature in the completion of a task. When you take the Help action, the creature you aid gains advantage on the next ability check it makes to perform the task you are helping with, provided that it makes the check before the start of your next turn.","Alternatively, you can aid a friendly creature in attacking a creature within 5 feet of you. You feint, distract the target, or in some other way team up to make your ally's attack more effective. If your ally attacks the target before your next turn, the first attack roll is made with advantage."],Hide:["When you take the Hide action, you make a Dexterity (Stealth) check in an attempt to hide, following the rules in chapter 7 for hiding. If you succeed, you gain certain benefits, as described in the \"{@book Unseen Attackers and Targets|PHB|9|unseen attackers and targets}\" section in the Player's Handbook."],Ready:["Sometimes you want to get the jump on a foe or wait for a particular circumstance before you act. To do so, you can take the Ready action on your turn so that you can act later in the round using your reaction.","First, you decide what perceivable circumstance will trigger your reaction. Then, you choose the action you will take in response to that trigger, or you choose to move up to your speed in response to it. Examples include \"If the cultist steps on the trapdoor, I'll pull the lever that opens it,\" and \"If the goblin steps next to me, I move away.\"","When the trigger occurs, you can either take your reaction right after the trigger finishes or ignore the trigger. Remember that you can take only one reaction per round.","When you ready a spell, you cast it as normal but hold its energy, which you release with your reaction when the trigger occurs. To be readied, a spell must have a casting time of 1 action, and holding onto the spell's magic requires concentration (explained in chapter 10). If your concentration is broken, the spell dissipates without taking effect. For example, if you are concentrating on the web spell and ready magic missile, your web spell ends, and if you take damage before you release magic missile with your reaction, your concentration might be broken.","You have until the start of your next turn to use a readied action."],Search:["When you take the Search action, you devote your attention to finding something. Depending on the nature of your search, the DM might have you make a Wisdom ({@skill Perception}) check or an Intelligence ({@skill Investigation}) check."],"Use an Object":["You normally interact with an object while doing something else, such as when you draw a sword as part of an attack. When an object requires your action for its use, you take the Use an Object action. This action is also useful when you want to interact with more than one object on your turn."]},Parser.SENSE_JSON_TO_FULL={blindsight:["A creature with blindsight can perceive its surroundings without relying on sight, within a specific radius. Creatures without eyes, such as oozes, and creatures with echolocation or heightened senses, such as bats and true dragons, have this sense."],darkvision:["Many creatures in fantasy gaming worlds, especially those that dwell underground, have darkvision. Within a specified range, a creature with darkvision can see in dim light as if it were bright light and in darkness as if it were dim light, so areas of darkness are only lightly obscured as far as that creature is concerned. However, the creature can't discern color in that darkness, only shades of gray."],tremorsense:["A creature with tremorsense can detect and pinpoint the origin of vibrations within a specific radius, provided that the creature and the source of the vibrations are in contact with the same ground or substance. Tremorsense can't be used to detect flying or incorporeal creatures. Many burrowing creatures, such as ankhegs and umber hulks, have this special sense."],truesight:["A creature with truesight can, out to a specific range, see in normal and magical darkness, see invisible creatures and objects, automatically detect visual illusions and succeed on saving throws against them, and perceives the original form of a shapechanger or a creature that is transformed by magic. Furthermore, the creature can see into the Ethereal Plane."]},Parser.NUMBERS_ONES=["","one","two","three","four","five","six","seven","eight","nine"],Parser.NUMBERS_TENS=["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"],Parser.NUMBERS_TEENS=["ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"],SourceUtil={hasBeenReprinted(e,t){return e!==void 0&&null!==e&&t!==void 0&&null!==t&&("Sun Soul"===e&&t===SRC_SCAG||"Mastermind"===e&&t===SRC_SCAG||"Swashbuckler"===e&&t===SRC_SCAG||"Storm"===e&&t===SRC_SCAG||"Deep Stalker Conclave"===e&&t===SRC_UATRR)},isNonstandardSource(e){return e!==void 0&&null!==e&&!BrewUtil.hasSourceJson(e)&&(SourceUtil._isNonstandardSourceWiz(e)||SourceUtil._isNonstandardSource3pp(e))},_isNonstandardSourceWiz(e){return e.startsWith(SRC_UA_PREFIX)||e.startsWith(SRC_PS_PREFIX)||e===SRC_OGA||e===SRC_Mag||e===SRC_STREAM||e===SRC_TWITTER},_isNonstandardSource3pp(e){return e.endsWith(SRC_3PP_SUFFIX)},getFilterGroup(e){return BrewUtil.hasSourceJson(e.item)?2:+SourceUtil.isNonstandardSource(e.item)}},Math.sum=Math.sum||function(...e){return e.reduce((e,t)=>e+t,0)},Math.mean=Math.mean||function(...e){return Math.sum(...e)/e.length},Math.meanAbsoluteDeviation=Math.meanAbsoluteDeviation||function(...e){var t=Math.mean;const n=t(...e);return t(...e.map(e=>Math.abs(e-n)))},Math.seed=Math.seed||function(e){var t=Math.floor;return function(){var n=Math.sin;return e=1e4*n(e),e-t(e)}};function xor(e,t){return!e!=!t}function implies(e,t){return!e||t}function noModifierKeys(t){return!t.ctrlKey&&!t.altKey&&!t.metaKey}function isObject(e){const t=typeof e;return("function"==t||"object"==t)&&!!e}function isString(e){return"string"==typeof e}function isNumber(e){return"[object Number]"===toString.call(e)}function isEmpty(e){return!(null!=e)||(Array.isArray(e)||isString(e)?0===e.length:0===Object.keys(e).length)}JqueryUtil={initEnhancements(){JqueryUtil.addSelectors(),window.$$=function(e,...t){const n=[];let o=0;const a=e=>e instanceof $?(n.push(e),`<${e.tag()} data-r=true></${e.tag()}>`):e instanceof HTMLElement?a($(e)):e,i=e.reduce((e,n)=>{const i=o++;return null==t[i]?`${e}${n}`:t[i]instanceof Array?`${e}${t[i].map(e=>a(e)).join("")}${n}`:`${e}${a(t[i])}${n}`}),r=$(i);return r.find(`[data-r=true]`).replaceWith(e=>n[e]),r},$.fn.extend({disableSpellcheck:function(){return this.attr("autocomplete","off").attr("autocapitalize","off").attr("spellcheck","false"),this},tag:function(){return this.prop("tagName").toLowerCase()}}),$.event.special.destroyed={remove:function(e){e.handler&&e.handler()}}},addSelectors(){$.expr[":"].textEquals=(e,t,n)=>{const o=n[3],a=$(e).text().toLowerCase().trim().match(`^${RegExp.escape(o.toLowerCase().trim())}$`);return a&&0<a.length},$.expr[":"].containsInsensitive=(e,t,n)=>{const o=n[3],a=$(e).contents().filter((t,n)=>3===n.nodeType)[0];if(!a)return!1;const i=a.nodeValue.toLowerCase().trim().match(`${RegExp.escape(o.toLowerCase().trim())}`);return i&&0<i.length}},showCopiedEffect(e,t="Copied!",n){const o=$(`<div class="copied-tip"><span>${t}</span></div>`).appendTo($(`body`)),a=o.width()/2,i=$(window).scrollTop(),r=e.offset(),s={top:"-=8",opacity:0};n&&(s.left=`${.5<Math.random()?"-":"+"}=${~~(17*Math.random())}`);const _=Math.random(),d=n?250+200*_:250;o.css({top:n?r.top-5-i:r.top-17-i,left:r.left-a+e.width()/2}).animate(s,{easing:"linear",duration:d,complete:()=>o.remove(),progress:(e,t)=>{if(n){s.top=`${0<.5-t?"-":"+"}=40`,o.css("transform",`rotate(${.5<_?"-":""}${500*_*t}deg)`)}}})},_dropdownInit:!1,bindDropdownButton(e){JqueryUtil._dropdownInit||(JqueryUtil._dropdownInit=!0,document.addEventListener("click",()=>[...document.querySelectorAll(`.open`)].filter(e=>!(e.className||"").split(" ").includes(`dropdown--navbar`)).forEach(e=>e.classList.remove("open")))),e.click(()=>setTimeout(()=>e.parent().addClass("open"),1))},_activeToast:[],doToast(e){"string"==typeof e&&(e={content:e,type:"info"}),e.type=e.type||"info";const t=e=>{e.removeClass("toast--animate"),setTimeout(()=>e.remove(),85),JqueryUtil._activeToast.splice(JqueryUtil._activeToast.indexOf(e),1)},n=$(`<button class="btn toast__btn-close"><span class="glyphicon glyphicon-remove"/></button>`).click(()=>t(o)),o=$$`
				<div class="toast alert-${e.type}">
					<div class="toast__wrp-content">${e.content}</div>
					<div class="toast__wrp-control">${n}</div>
				</div>
			`.prependTo($(`body`)).data("pos",0);setTimeout(()=>o.addClass(`toast--animate`),5),setTimeout(()=>t(o),5e3),JqueryUtil._activeToast.length&&JqueryUtil._activeToast.forEach(e=>{const n=e.data("pos");e.data("pos",n+1),2===n&&t(e)}),JqueryUtil._activeToast.push(o)}},"undefined"!=typeof window&&window.addEventListener("load",JqueryUtil.initEnhancements),ObjUtil={mergeWith(e,t,n,o={depth:1}){if(!e||!t||"function"!=typeof n)throw new Error("Must include a source, target and a fnMerge to handle merging");const a=function(i,r,s=1){if(!(s>o.depth)&&i&&r)for(let o of Object.keys(i))r[o]=n(i[o],r[o],e,t),a(e[o],r[o],s+1)};a(e,t,1)},async pForEachDeep(e,t,n={depth:1/0,callEachLevel:!1}){const o=async function(e,a,i=0){if((n.callEachLevel||"object"!=typeof e||n.depth===i)&&(await t(e,a,i)),n.depth!==i&&"object"==typeof e)for(const t of Object.keys(e))a.push(t),await o(e[t],a,i+1);a.pop()};await o(e,[])}},MiscUtil={copy(e){return JSON.parse(JSON.stringify(e))},async pCopyTextToClipboard(e){function t(){const t=$(`<textarea id="copy-temp" style="position: fixed; top: -1000px; left: -1000px; width: 1px; height: 1px;">${e}</textarea>`);$(`body`).append(t),t.select(),document.execCommand("Copy"),t.remove()}if(navigator&&navigator.permissions)try{const n=await navigator.permissions.query({name:"clipboard-write"});"granted"===n.state||"prompt"===n.state?await navigator.clipboard.writeText(e):t()}catch(n){t()}else t()},checkProperty(e,...t){for(let n=0;n<t.length;++n)if(e=e[t[n]],null==e)return!1;return!0},getProperty(e,...t){for(let n=0;n<t.length;++n)if(e=e[t[n]],null==e)return e;return e},clearSelection(){document.getSelection?(document.getSelection().removeAllRanges(),document.getSelection().addRange(document.createRange())):window.getSelection?window.getSelection().removeAllRanges?(window.getSelection().removeAllRanges(),window.getSelection().addRange(document.createRange())):window.getSelection().empty&&window.getSelection().empty():document.selection&&document.selection.empty()},randomColor(){let e,t,n;const o=RollerUtil.randomise(30,0)/30,a=~~(6*o),i=6*o-a,s=1-i;switch(a%6){case 0:e=1,t=i,n=0;break;case 1:e=s,t=1,n=0;break;case 2:e=0,t=1,n=i;break;case 3:e=0,t=s,n=1;break;case 4:e=i,t=0,n=1;break;case 5:e=1,t=0,n=s;}return`#${("00"+(~~(255*e)).toString(16)).slice(-2)}${("00"+(~~(255*t)).toString(16)).slice(-2)}${("00"+(~~(255*n)).toString(16)).slice(-2)}`},scrollPageTop(){document.body.scrollTop=document.documentElement.scrollTop=0},isInInput(e){return"INPUT"===e.target.nodeName||"TEXTAREA"===e.target.nodeName},expEval(e){return new Function(`return ${e.replace(/[^-()\d/*+.]/g,"")}`)()},parseNumberRange(e,t=Number.MIN_SAFE_INTEGER,n=Number.MAX_SAFE_INTEGER){function o(e){throw new Error(`Could not parse range input "${e}"`)}function a(){throw new Error(`Number was out of range! Range was ${t}-${n} (inclusive).`)}function i(e){return e<t||e>n}function r(e,t){e.add(t)}function s(e,t,n){for(let o=t;o<=n;++o)e.add(o)}for(;;)if(e&&e.trim()){const t=e.replace(/\s*/g,"");if(/^((\d+-\d+|\d+),)*(\d+-\d+|\d+)$/.exec(t)){const e=t.split(","),n=new Set;for(const t of e)if(t.includes("-")){const e=t.split("-"),_=+e[0],d=+e[1];(isNaN(_)||isNaN(d)||0===_||0===d||_>d)&&o(),(i(_)||i(d))&&a(),_===d?r(n,_):s(n,_,d)}else{const e=+t;isNaN(e)||0==e?o():(i(e)&&a(),r(n,e))}return n}o()}else return null},MONTH_NAMES:["January","February","March","April","May","June","July","August","September","October","November","December"],dateToStr(e,t){const n=MiscUtil.MONTH_NAMES[e.getMonth()];return`${t?n.substring(0,3):n} ${e.getDate()}, ${e.getFullYear()}`},findCommonPrefix(e){var t=Math.min;let n=null;return e.forEach(e=>{if(null==n)n=e;else{const o=t(e.length,n.length);for(let t=0;t<o;++t){const o=n[t],a=e[t];if(o!==a){n=n.substring(0,t);break}}}}),n},calculateBlendedColor(e,t,n){const o=CryptUtil.hex2Dec(e),a=CryptUtil.hex2Dec(n);return((o-(1-t)*a)/t).toString(16)},debounce(e,t,n){let o;return function(){const a=this,i=arguments,r=n&&!o;clearTimeout(o),o=setTimeout(function(){o=null,n||e.apply(a,i)},t),r&&e.apply(a,i)}},pDelay(e){return new Promise(t=>setTimeout(()=>t(),e))}},ContextUtil={_ctxInit:{},_ctxClick:{},_ctxOpenRefsNextId:1,_ctxOpenRefs:{},_handlePreInitContextMenu:e=>{if(!ContextUtil._ctxInit[e]){ContextUtil._ctxInit[e]=!0;const t=`click.${e}`;$("body").off(t).on(t,t=>{null!=$(t.target).data("ctx-id")||(Object.entries(ContextUtil._ctxOpenRefs[e]||{}).forEach(([t,n])=>{n(!1),delete ContextUtil._ctxOpenRefs[e][t]}),$(`#${e}`).hide())})}},_getMenuPosition:(e,t,n,o)=>{const a=$(window)[n](),i=$(window)[o](),r=$(`#${e}`)[n]();let s=t+i;return t+r>a&&r<t&&(s-=r),s},_lastMenuId:1,getNextGenericMenuId(){return`contextMenu_${ContextUtil._lastMenuId++}`},doInitContextMenu:(e,t,n)=>{ContextUtil._ctxClick[e]=t,ContextUtil._handlePreInitContextMenu(e);let o=`<ul id="${e}" class="dropdown-menu" role="menu">`,a=0;n.forEach(e=>{null===e?o+=`<li class="divider"/>`:e.disabled?o+=`<li class="disabled"><a href="${STR_VOID_LINK}">${e.text}</a></li>`:(o+=`<li><a data-ctx-id="${a}" href="${STR_VOID_LINK}">${e}</a></li>`,a++)}),o+=`</ul>`,$(`#${e}`).remove(),$("body").append(o)},doTeardownContextMenu(e){delete ContextUtil._ctxInit[e],delete ContextUtil._ctxClick[e],delete ContextUtil._ctxOpenRefs[e],$(`#${e}`).remove()},handleOpenContextMenu:(t,n,o,a)=>{if(t.ctrlKey)return;t.preventDefault(),t.stopPropagation();const i=ContextUtil._ctxOpenRefsNextId++;(ContextUtil._ctxOpenRefs[o]=ContextUtil._ctxOpenRefs[o]||{})[i]=a||(()=>{});const r=$(`#${o}`).show().css({position:"absolute",left:ContextUtil._getMenuPosition(o,t.clientX,"width","scrollLeft"),top:ContextUtil._getMenuPosition(o,t.clientY,"height","scrollTop")}).off("click").on("click","a",function(a){r.hide(),ContextUtil._ctxOpenRefs[o][i]&&ContextUtil._ctxOpenRefs[o][i](!0),delete ContextUtil._ctxOpenRefs[o][i];const e=$(t.target).closest(`li.row`),s=$(a.target),_=+s.data("ctx-id");ContextUtil._ctxClick[o](a,n,e,s,isNaN(_)?null:_)})}},SearchUtil={removeStemmer(e){const t=elasticlunr.Pipeline.getRegisteredFunction("stemmer");e.pipeline.remove(t)}},ListUtil={SUB_HASH_PREFIX:"sublistselected",_first:!0,bindEscapeKey(e,t,n){(!e._isBoundEscape||n)&&(n&&t.off("keydown.search5e"),e._isBoundEscape=!0,t.on("keydown.search5e",n=>{27===n.which&&setTimeout(()=>{t.blur(),e.search()},0)}))},search:e=>{!e.sortFunction&&e.valueNames&&e.valueNames.includes("name")&&(e.sortFunction=SortUtil.listSort);const t=new List("listcontainer",e);t.sort("name");const n=$("#search");$("#reset").click(function(){$("#filtertools").find("select").val("All"),n.val(""),t.search(),t.sort("name"),t.filter()}),ListUtil.bindEscapeKey(t,n);const o=$("#listcontainer");if(o.data("lists")?o.data("lists").push(t):o.data("lists",[t]),ListUtil._first){ListUtil._first=!1;const e=$(`header div p`);e.html(`${e.html()} Press J/K to navigate rows.`);const t=()=>{const e=History.getSelectedListElementWithIndex();if(e&&e.$el&&e.$el.length){const t=e.$el.parent(),n=e.$el.parent().parent(),o=n.scrollTop(),a=n.height(),i=t.position().top,r=t.height();0>i?t[0].scrollIntoView():i+r>a&&n.scrollTop(o+(i-a+r))}};$(window).on("keypress",n=>{if(noModifierKeys(n)&&("k"===n.key||"j"===n.key)){if(MiscUtil.isInInput(n))return;const e=History.getSelectedListElementWithIndex();if(e)if("k"===n.key){const n=e.$el.parent().prev().find("a").attr("href");if(void 0!==n)window.location.hash=n,t();else{const n=o.data("lists");for(let o=e.x;0<=--o;){const e=n[o];if(e.visibleItems.length){const n=$(e.visibleItems[e.visibleItems.length-1].elm).find("a").attr("href");return void(n&&(window.location.hash=n,t()))}}}const a=e.$el.closest(`ul`).parent().prev(`li`).find(`ul li`).last().find("a").attr("href");a&&(window.location.hash=a)}else if("j"===n.key){const n=e.$el.parent().next().find("a").attr("href");if(void 0!==n)window.location.hash=n,t();else{const n=o.data("lists");for(let o=e.x;++o<n.length;){const e=n[o];if(e.visibleItems.length){const n=$(e.visibleItems[0].elm).find("a").attr("href");return void(n&&(window.location.hash=n,t()))}}}const a=e.$el.closest(`ul`).parent().next(`li`).find(`ul li`).first().find("a").attr("href");a&&(window.location.hash=a)}}})}return t},_lastSelected:null,toggleSelected:(e,t)=>{function n(){ListUtil._primaryLists.forEach(e=>ListUtil.deslectAll(e)),$(t).addClass("list-multi-selected")}function o(e){let t,n,o,a;outer:for(t=0;t<ListUtil._primaryLists.length;++t){const i=ListUtil._primaryLists[t];for(n=0;n<i.visibleItems.length;++n){const t=i.visibleItems[n];if(e===t.elm.getAttribute("filterid")){o=i,a=t;break outer}}}return o&&a?{ixList:t,list:o,ixItem:n,listItem:a}:null}const a=$(t).attr("filterid");if(e.shiftKey&&ListUtil._lastSelected){e.preventDefault();const t=o(ListUtil._lastSelected);if(!t)n(),ListUtil._lastSelected=a;else{ListUtil._primaryLists.forEach(e=>ListUtil.deslectAll(e));const e=o(a),[n,r]=[t,e].sort((e,t)=>e.ixList<t.ixList?-1:e.ixList>t.ixList?1:e.ixItem<t.ixItem?-1:e.ixItem>t.ixItem?1:0);for(let e=n.ixList;e<=r.ixList;++e){const t=ListUtil._primaryLists[e],o=e<r.ixList&&e>n.ixList?0:r.ixList===e&&n.ixList<r.ixList?0:n.ixItem,a=r.ixList>e?t.visibleItems.length-1:r.ixItem;for(let e=o;e<=a;++e)$(t.visibleItems[e].elm).addClass("list-multi-selected")}}}else n(),ListUtil._lastSelected=a},updateSelected:()=>{ListUtil.toggleSelected({},History.getSelectedListElement().parent())},initContextMenu:(e,...t)=>{ContextUtil.doInitContextMenu("list",e,t)},initSubContextMenu:(e,...t)=>{ContextUtil.doInitContextMenu("listSub",e,t)},openContextMenu:(e,t)=>{const n=ListUtil._primaryLists.map(e=>ListUtil.getSelectedCount(e)).reduce((e,t)=>e+t,0);1===n&&ListUtil._primaryLists.forEach(e=>ListUtil.deslectAll(e)),(0===n||1===n)&&$(t).addClass("list-multi-selected"),ContextUtil.handleOpenContextMenu(e,t,"list")},openSubContextMenu:(e,t)=>{ContextUtil.handleOpenContextMenu(e,t,"listSub")},$sublistContainer:null,sublist:null,$sublist:null,_sublistChangeFn:null,_pUidHandler:null,_allItems:null,_primaryLists:[],_pinned:{},initSublist:e=>{ListUtil._allItems=e.itemList,ListUtil._getSublistRow=e.getSublistRow,ListUtil._sublistChangeFn=e.onUpdate,ListUtil._primaryLists=e.primaryLists,ListUtil._pUidHandler=e.uidHandler,ListUtil._uidUnpackFn=e.uidUnpacker,delete e.itemList,delete e.getSublistRow,delete e.onUpdate,delete e.primaryLists,delete e.uidHandler,ListUtil.$sublistContainer=$("#sublistcontainer");const t=new List("sublistcontainer",e);return ListUtil.sublist=t,ListUtil.$sublist=$(`ul.${e.listClass}`),ListUtil.$sublistContainer.hasClass(`sublist--resizable`)&&ListUtil._pBindSublistResizeHandlers(ListUtil.$sublistContainer),t},__mouseMoveId:1,async _pBindSublistResizeHandlers(e){function t(t){const n=t.clientY-a;a=t.clientY,e.css("height",parseInt(e.css("height"))+n)}const n=ListUtil.__mouseMoveId++,o=$(document);let a;e.on("mousedown",i=>{1===i.which&&i.target===e[0]&&(i.preventDefault(),i.offsetY>e.height()-3&&(a=i.clientY,o.on(`mousemove.sublist_resize-${n}`,t)))}),o.on("mouseup",t=>{1===t.which&&($(document).off(`mousemove.sublist_resize-${n}`),StorageUtil.pSetForPage("SUBLIST_RESIZE",e.css("height")))});const i=await StorageUtil.pGetForPage("SUBLIST_RESIZE");i&&e.css("height",i)},setOptions:e=>{e.itemList!==void 0&&(ListUtil._allItems=e.itemList),e.getSublistRow!==void 0&&(ListUtil._getSublistRow=e.getSublistRow),e.onUpdate!==void 0&&(ListUtil._sublistChangeFn=e.onUpdate),e.primaryLists!==void 0&&(ListUtil._primaryLists=e.primaryLists),e.uidHandler!==void 0&&(ListUtil._pUidHandler=e.uidHandler),e.uidUnpacker!==void 0&&(ListUtil._uidUnpackFn=e.uidUnpacker)},getOrTabRightButton:(e,t)=>{let n=$(`#${e}`);return n.length||(n=$(`<button class="stat-tab btn btn-default" id="${e}"><span class="glyphicon glyphicon-${t}"></span></button>`).appendTo($(`#tabs-right`))),n},bindPinButton:()=>{ListUtil.getOrTabRightButton(`btn-pin`,`pushpin`).off("click").on("click",()=>{ListUtil.isSublisted(History.lastLoadedId)?ListUtil.pDoSublistRemove(History.lastLoadedId):ListUtil.pDoSublistAdd(History.lastLoadedId,!0)}).attr("title","Pin (Toggle)")},genericAddButtonHandler(e,t={}){e.shiftKey?ListUtil.pDoSublistAdd(History.lastLoadedId,!0,t.shiftCount||20):ListUtil.pDoSublistAdd(History.lastLoadedId,!0)},bindAddButton:(e,t={})=>{ListUtil.getOrTabRightButton(`btn-sublist-add`,`plus`).off("click").attr("title",`Add (SHIFT for ${t.shiftCount||20})`).on("click",e?e():ListUtil.genericAddButtonHandler)},genericSubtractButtonHandler(e,t={}){e.shiftKey?ListUtil.pDoSublistSubtract(History.lastLoadedId,t.shiftCount||20):ListUtil.pDoSublistSubtract(History.lastLoadedId)},bindSubtractButton:(e,t={})=>{ListUtil.getOrTabRightButton(`btn-sublist-subtract`,`minus`).off("click").attr("title",`Subtract (SHIFT for ${t.shiftCount||20})`).on("click",e?e():ListUtil.genericSubtractButtonHandler)},bindDownloadButton:()=>{const e=ListUtil.getOrTabRightButton(`btn-sublist-download`,`download`);e.off("click").on("click",async t=>{if(t.shiftKey){const t=JSON.stringify(ListUtil.getExportableSublist()),n=[window.location.href,UrlUtil.packSubHash(ListUtil.SUB_HASH_PREFIX,[t],{isEncodeBoth:!0})];await MiscUtil.pCopyTextToClipboard(n.join(HASH_PART_SEP)),JqueryUtil.showCopiedEffect(e)}else DataUtil.userDownload(ListUtil._getDownloadName(),JSON.stringify(ListUtil.getExportableSublist(),null,"\t"))}).attr("title","Download List (SHIFT for Link)")},doJsonLoad(e,t,n){const o=()=>{ListUtil._pLoadSavedSublist(e.items,t).then(()=>{ListUtil._pFinaliseSublist()})};n?n(e,o):o()},bindUploadButton:e=>{const t=ListUtil.getOrTabRightButton(`btn-sublist-upload`,`upload`);t.off("click").on("click",t=>{function n(t,n){const o=t.target,i=new FileReader;i.onload=()=>{const t=i.result,o=JSON.parse(t);a.remove(),ListUtil.doJsonLoad(o,n,e)},i.readAsText(o.files[0])}const o=t.shiftKey,a=$(`<input type="file" accept=".json" style="position: fixed; top: -100px; left: -100px; display: none;">`).on("change",e=>{n(e,o)}).appendTo($(`body`));a.click()}).attr("title","Upload List (SHIFT for Add Only)")},setFromSubHashes:(e,t)=>{function n(e){ListUtil._pLoadSavedSublist(e.items,!1).then(async()=>{await ListUtil._pFinaliseSublist();const[e,...t]=History._getHashParts(),n=[];Object.keys(o).filter(e=>e!==ListUtil.SUB_HASH_PREFIX).forEach(e=>{n.push(`${e}${HASH_SUB_KV_SEP}${o[e].join(HASH_SUB_LIST_SEP)}`)}),History.setSuppressHistory(!0),window.location.hash=`#${e}${n.length?`${HASH_PART_SEP}${n.join(HASH_PART_SEP)}`:""}`})}const o={};e.forEach(e=>Object.assign(o,UrlUtil.unpackSubHash(e,!0)));const a=o[ListUtil.SUB_HASH_PREFIX];if(a){const e=JSON.parse(a);t?t(e,()=>n(e)):n(e)}},_getPinnedCount(e,t){const n=ListUtil._pinned[e];return n?t&&t.uid?n[t.uid]:n._:null},_setPinnedCount(e,t,n){const o=ListUtil._pinned[e],a=n&&n.uid?n.uid:"_";o?o[a]=t:(ListUtil._pinned[e]={})[a]=t},_deletePinnedCount(e,t){const n=ListUtil._pinned[e];n&&(t&&t.uid?delete n[t.uid]:delete n._)},async pDoSublistAdd(e,t,n,o){if(null==e)return JqueryUtil.doToast({content:"Please first view something from the list.",type:"danger"});const a=ListUtil._getPinnedCount(e,o)||0;if(n=n||1,ListUtil._setPinnedCount(e,a+n,o),0!==a)ListUtil._setViewCount(e,a+n,o),t&&(await ListUtil._pFinaliseSublist());else{const a=ListUtil._getSublistRow(ListUtil._allItems[e],e,n,o);if(a instanceof Promise)return a.then(async e=>{ListUtil.$sublist.append(e),t&&(await ListUtil._pFinaliseSublist())});ListUtil.$sublist.append(a),t&&(await ListUtil._pFinaliseSublist())}},async pDoSublistSubtract(e,t,n){const o=ListUtil._getPinnedCount(e,n);t=t||1,o>t?(ListUtil._setPinnedCount(e,o-t,n),ListUtil._setViewCount(e,o-t,n),ListUtil.sublist.reIndex(),await ListUtil._pSaveSublist(),ListUtil._handleCallUpdateFn()):o&&(await ListUtil.pDoSublistRemove(e,n))},getSublisted(){const e=MiscUtil.copy(ListUtil._pinned),t={};return Object.keys(e).filter(t=>Object.keys(e[t]).length).forEach(n=>t[n]=e[n]),t},getSublistedIds(){return Object.keys(ListUtil._pinned).filter(e=>Object.keys(ListUtil._pinned[e]).length).map(e=>+e)},_setViewCount:(e,t,n)=>{const o=$(ListUtil.sublist.get(n&&n.uid?"uid":"id",n&&n.uid?n.uid:e)[0].elm).find(".count");o.find("input").length?o.find("input").val(t):o.text(t)},async _pFinaliseSublist(e){ListUtil.sublist.reIndex(),ListUtil._updateSublistVisibility(),e||(await ListUtil._pSaveSublist()),ListUtil._handleCallUpdateFn()},getExportableSublist:()=>{const e=new Set,t=ListUtil.sublist.items.map(t=>{const n=$(t.elm);return e.add(ListUtil._allItems[+n.attr(FLTR_ID)].source),{h:n.find(`a`).prop("hash").slice(1).split(HASH_PART_SEP)[0],c:n.find(".count").first().text()||void 0,uid:n.find(`.uid`).text()||void 0}});return{items:t,sources:Array.from(e)}},async _pSaveSublist(){await StorageUtil.pSetForPage("sublist",ListUtil.getExportableSublist())},_updateSublistVisibility:()=>{ListUtil.sublist.items.length?ListUtil.$sublistContainer.addClass("sublist--visible"):ListUtil.$sublistContainer.removeClass("sublist--visible")},async pDoSublistRemove(e,t){ListUtil._deletePinnedCount(e,t),t&&t.uid?ListUtil.sublist.remove("uid",t.uid):ListUtil.sublist.remove("id",e),ListUtil._updateSublistVisibility(),await ListUtil._pSaveSublist(),ListUtil._handleCallUpdateFn()},async pDoSublistRemoveAll(e){ListUtil._pinned={},ListUtil.sublist.clear(),ListUtil._updateSublistVisibility(),e||(await ListUtil._pSaveSublist()),ListUtil._handleCallUpdateFn()},isSublisted:(e,t)=>ListUtil._getPinnedCount(e,t),deslectAll:e=>{e.items.forEach(e=>e.elm.className=e.elm.className.replace(/list-multi-selected/g,""))},forEachSelected:(e,t)=>{e.items.filter(e=>e.elm.className.includes("list-multi-selected")).map(e=>(e.elm.className=e.elm.className.replace(/list-multi-selected/g,""),e.elm.getAttribute(FLTR_ID))).forEach(e=>t(e))},mapSelected(e,t){return e.items.filter(e=>e.elm.className.includes("list-multi-selected")).map(e=>(e.elm.className=e.elm.className.replace(/list-multi-selected/g,""),e.elm.getAttribute(FLTR_ID))).map(e=>t(e))},getSelectedCount:e=>e.items.filter(e=>e.elm.className.includes("list-multi-selected")).length,isAnySelected:e=>!!e.items.find(e=>e.elm.className.includes("list-multi-selected")),_handleCallUpdateFn:()=>{ListUtil._sublistChangeFn&&ListUtil._sublistChangeFn()},_hasLoadedState:!1,async pLoadState(){if(!ListUtil._hasLoadedState){ListUtil._hasLoadedState=!0;try{const e=await StorageUtil.pGetForPage("sublist");e&&e.items&&ListUtil._pLoadSavedSublist(e.items)}catch(t){setTimeout(()=>{throw t}),await StorageUtil.pRemoveForPage("sublist")}}},async _pLoadSavedSublist(e,t){t||(await ListUtil.pDoSublistRemoveAll(!0));const n=e.map(e=>{const t=History._getListElem(e.h),n=t?t.attr("id"):null;if(null!=n){const t={index:n,addCount:+e.c};return ListUtil._uidUnpackFn&&e.uid&&(t.data=ListUtil._uidUnpackFn(e.uid)),t}return null}).filter(e=>e),o=n.map(e=>ListUtil.pDoSublistAdd(e.index,!1,e.addCount,e.data));return Promise.all(o).then(async()=>{await ListUtil._pFinaliseSublist(!0)})},async pGetSelectedSources(){let e;try{e=await StorageUtil.pGetForPage("sublist")}catch(t){setTimeout(()=>{throw t})}if(e&&e.sources)return e.sources},initGenericPinnable:()=>{ListUtil.initContextMenu(ListUtil.handleGenericContextMenuClick,"Popout","Pin"),ListUtil.initSubContextMenu(ListUtil.handleGenericSubContextMenuClick,"Popout","Unpin","Clear Pins",null,"Feeling Lucky?",null,"Download JSON")},handleGenericContextMenuClick:(e,t,n,o)=>{const a=+n.attr(FLTR_ID);switch(+o.data("ctx-id")){case 0:Renderer.hover.doPopout(n,ListUtil._allItems,a,e.clientX);break;case 1:Promise.all(ListUtil._primaryLists.map(e=>Promise.all(ListUtil.mapSelected(e,e=>ListUtil.isSublisted(e)?Promise.resolve():ListUtil.pDoSublistAdd(e))))).then(async()=>ListUtil._pFinaliseSublist());}},_isRolling:!1,_rollSubListed(){function e(e,t){const n=[RollerUtil.rollOnArray(e)];for(let o,a=0;a<t;++a){for(o=RollerUtil.rollOnArray(e);o===n.last();)o=RollerUtil.rollOnArray(e);n.push(o)}return n}const t=RollerUtil.randomise(125,75),n=[0,1,1,1,1,1,1.5,1.5,1.5,2,2,2,2.5,3,4,-1].map(e=>e*t).slice(0,-RollerUtil.randomise(4,1));if(!ListUtil._isRolling){ListUtil._isRolling=!0;const t=ListUtil.sublist.items.map(e=>$(e.elm).find(`a`));if(1>=t.length)return JqueryUtil.doToast({content:"Not enough entries to roll!",type:"danger"}),ListUtil._isRolling=!1;const o=e(t,n.length);let a=0;n.map((e,t)=>{a+=e,setTimeout(()=>{o[t][0].click(),t===n.length-1&&(ListUtil._isRolling=!1)},a)})}},handleGenericSubContextMenuClick:(e,t,n,o)=>{const a=+n.attr(FLTR_ID);switch(+o.data("ctx-id")){case 0:Renderer.hover.doPopout(n,ListUtil._allItems,a,e.clientX);break;case 1:ListUtil.pDoSublistRemove(a);break;case 2:ListUtil.pDoSublistRemoveAll();break;case 3:ListUtil._rollSubListed();break;case 4:ListUtil._handleJsonDownload();}},initGenericAddable:()=>{ListUtil.initContextMenu(ListUtil.handleGenericMultiContextMenuClick,"Popout","Add"),ListUtil.initSubContextMenu(ListUtil.handleGenericMultiSubContextMenuClick,"Popout","Remove","Clear List",null,"Feeling Lucky?",null,"Download JSON")},handleGenericMultiContextMenuClick:(e,t,n,o)=>{const a=+n.attr(FLTR_ID);switch(+o.data("ctx-id")){case 0:Renderer.hover.doPopout(n,ListUtil._allItems,a,e.clientX);break;case 1:Promise.all(ListUtil._primaryLists.map(e=>Promise.all(ListUtil.mapSelected(e,e=>ListUtil.pDoSublistAdd(e))))).then(async()=>{await ListUtil._pFinaliseSublist(),ListUtil.updateSelected()});}},handleGenericMultiSubContextMenuClick:(e,t,n,o)=>{const a=+n.attr(FLTR_ID),i=n.find(`.uid`).text();switch(+o.data("ctx-id")){case 0:Renderer.hover.doPopout(n,ListUtil._allItems,a,e.clientX);break;case 1:i?ListUtil.pDoSublistRemove(a,{uid:i}):ListUtil.pDoSublistRemove(a);break;case 2:ListUtil.pDoSublistRemoveAll();break;case 3:ListUtil._rollSubListed();break;case 4:ListUtil._handleJsonDownload();}},_getDownloadName(){return`${UrlUtil.getCurrentPage().replace(".html","")}-sublist`},genericPinKeyMapper(e=ListUtil._pUidHandler){return Object.entries(ListUtil.getSublisted()).map(([t,n])=>Object.keys(n).map(n=>{const o=ListUtil._allItems[t];return"_"===n?Promise.resolve(MiscUtil.copy(o)):e(o,n)}).reduce((e,t)=>e.concat(t),[])).reduce((e,t)=>e.concat(t),[])},_handleJsonDownload(){if(ListUtil._pUidHandler){const e=ListUtil.genericPinKeyMapper();Promise.all(e).then(e=>{e.forEach(e=>DataUtil.cleanJson(e)),DataUtil.userDownload(`${ListUtil._getDownloadName()}-data`,e)})}else{const e=ListUtil.getSublistedIds().map(e=>{const t=JSON.parse(JSON.stringify(ListUtil._allItems[e]));return DataUtil.cleanJson(t),t});DataUtil.userDownload(`${ListUtil._getDownloadName()}-data`,e)}},getSearchTermAndReset:(e,...t)=>{let n=null;return e.searched&&(n=$(`#search`).val(),e.search(),t.forEach(e=>e.search())),e.filter(),t.forEach(e=>e.filter()),n},toggleCheckbox(e,t){const n=$(t).find(`input`);n.prop("checked",!n.prop("checked"))},getCompleteFilterSources(e){return e.otherSources?[e.source].concat(e.otherSources.map(e=>new FilterItem({item:e.source,isIgnoreRed:!0}))):e.source},bindShowTableButton(e,t,n,o,a,i){$(`#${e}`).click("click",()=>ListUtil.showTable(t,n,o,a,i))},basicFilterGenerator(){const e=ListUtil.getSublistedIds();if(e.length){const t=new Set(e);return t.has.bind(t)}else{const e=new Set(ListUtil.getVisibleIds());return e.has.bind(e)}},getVisibleIds(){return BrewUtil._lists.map(e=>e.visibleItems.map(e=>+e.elm.getAttribute(FLTR_ID))).reduce((e,t)=>e.concat(t),[])},showTable(e,t,n,o,a){function i(){const e=l.find(`input:checked`).map((t,n)=>$(n).data("name")).get(),t=_.find(`.data-row`).map((t,n)=>$(n)).get().map(e=>e.find(`td:visible`).map((e,t)=>$(t).text()).get());return DataUtil.getCsv(e,t)}const r=$(`<div class="modal__outer dropdown-menu"/>`),s=$(`<div class="modal__wrp">`).appendTo($(`body`)).click(()=>s.remove());r.appendTo(s);const _=$(`<div class="modal__inner"/>`).appendTo(r).click(e=>e.stopPropagation()),d=$(`<div class="split my-3"/>`).appendTo(_),l=$(`<div class="flex" style="align-items: center;"/>`).appendTo(d);Object.values(n).forEach((e,t)=>{const n=$(`<label class="flex-${e.flex||1} px-2 mr-2 no-wrap inline-flex">${e.name} </label>`).appendTo(l),o=$(`<input type="checkbox" class="ml-1" data-name="${e.name}" checked>`).click(()=>{const e=_.find(`.col_${t}`);o.prop("checked")?e.show():e.hide()}).appendTo(n)});const u=$(`<div/>`).appendTo(d),c=$(`<button class="btn btn-primary mr-3">Download CSV</button>`).click(()=>{DataUtil.userDownloadText(`${e}.csv`,i())}).appendTo(u),S=$(`<button class="btn btn-primary">Copy CSV to Clipboard</button>`).click(async()=>{await MiscUtil.pCopyTextToClipboard(i()),JqueryUtil.showCopiedEffect(S)}).appendTo(u);_.append(`<hr>`),"object"==typeof o&&o.generator&&(o=o.generator());let T=`<table class="table-striped stats stats-book stats-book--large" style="width: 100%;"><thead><tr>${Object.values(n).map((e,t)=>`<th class="col_${t} px-2" colspan="${e.flex||1}">${e.name}</th>`).join("")}</tr></thead><tbody>`;const p=JSON.parse(JSON.stringify(t)).filter((e,t)=>o?o(t):e);a&&p.sort(a),p.forEach(e=>{T+=`<tr class="data-row">`,T+=Object.keys(n).map((t,o)=>{const a=n[t];return`<td class="col_${o} px-2" colspan="${a.flex||1}">${!0===a.transform?e[t]:a.transform("_"===t[0]?e:e[t])}</td>`}).join(""),T+=`</tr>`}),T+=`</tbody></table>`,_.append(T)},addListShowHide(){$(`#filter-search-input-group`).find(`#reset`).before(`
			<button class="btn btn-default" id="hidesearch">Hide</button>
		`),$(`#contentwrapper`).prepend("\n\t\t\t<div class=\"col-12\" id=\"showsearch\">\n\t\t\t\t<button class=\"btn btn-block btn-default btn-xs\" type=\"button\">Show Search</button>\n\t\t\t\t<br>\n\t\t\t</div>\n\t\t");const e=$(`#listcontainer`),t=$("div#showsearch"),n=$("button#hidesearch");n.click(function(){e.hide(),t.show(),n.hide()}),t.find("button").click(function(){e.show(),t.hide(),n.show()})}};function getSourceFilter(e={}){const t={header:FilterBox.SOURCE_HEADER,displayFn:e=>Parser.sourceJsonToFullCompactPrefix(e.item||e),selFn:defaultSourceSelFn,groupFn:SourceUtil.getFilterGroup};return Object.assign(t,e),new Filter(t)}function defaultSourceDeselFn(e){return SourceUtil.isNonstandardSource(e)}function defaultSourceSelFn(e){return!defaultSourceDeselFn(e)}function getAsiFilter(e){const t={header:"Ability Bonus",items:["str","dex","con","int","wis","cha"],displayFn:Parser.attAbvToFull,itemSortFn:null};return getFilterWithMergedOptions(t,e)}function getFilterWithMergedOptions(e,t){return t&&Object.assign(e,t),new Filter(e)}async function pInitFilterBox(e){e.$wrpFormTop=$(`#${ID_SEARCH_BAR}`),e.$btnReset=$(`#${ID_RESET_BUTTON}`);const t=new FilterBox(e);return await t.pDoLoadState(),t}UrlUtil={encodeForHash(e){function t(e){return encodeURIComponent(e).toLowerCase()}return e instanceof Array?e.map(e=>t(e)).join(HASH_LIST_SEP):t(e)},autoEncodeHash(e){const t=UrlUtil.getCurrentPage(),n=UrlUtil.URL_TO_HASH_BUILDER[t];if(!n)throw new Error(`No encoder found for page ${t}`);return n(e)},getCurrentPage(){const e=window.location.pathname.split("/");let t=e[e.length-1];return t.toLowerCase().endsWith(".html")||(t+=".html"),t},link(e){function t(t){return e.includes("?")?`${t}&ver=${VERSION_NUMBER}`:`${t}?ver=${VERSION_NUMBER}`}if(!IS_ROLL20&&IS_DEPLOYED)return t(`${DEPLOYED_STATIC_ROOT}${e}`);return IS_DEPLOYED?t(e):e},unpackSubHash(e,t){if(e.includes(HASH_SUB_KV_SEP)){const n=e.split(HASH_SUB_KV_SEP).map(e=>e.trim()),o={};let a=n[0].toLowerCase();t&&(a=decodeURIComponent(a));let i=n[1].toLowerCase();return t&&(i=decodeURIComponent(i)),o[a]=i.split(HASH_SUB_LIST_SEP).map(e=>e.trim()),1===o[a].length&&o[a]===HASH_SUB_NONE&&(o[a]=[]),o}throw new Error(`Baldy formatted subhash ${e}`)},packSubHash(e,t,n){return n=n||{},(n.isEncodeBoth||n.isEncodeKey)&&(e=UrlUtil.pack(e)),(n.isEncodeBoth||n.isEncodeValues)&&(t=t.map(e=>UrlUtil.pack(e))),`${e}${HASH_SUB_KV_SEP}${t.join(HASH_SUB_LIST_SEP)}`},pack(e){return encodeURIComponent(e.toLowerCase())},categoryToPage(e){return UrlUtil.CAT_TO_PAGE[e]},bindLinkExportButton(e){const t=ListUtil.getOrTabRightButton(`btn-link-export`,`magnet`);t.addClass("btn-copy-effect").off("click").on("click",async n=>{let o=window.location.href;const a=e.getSubHashes();if(a.unshift(o),n.shiftKey){const e=JSON.stringify(ListUtil.getExportableSublist()),t=UrlUtil.packSubHash(ListUtil.SUB_HASH_PREFIX,[e],{isEncodeBoth:!0});a.push(t)}await MiscUtil.pCopyTextToClipboard(a.join(HASH_PART_SEP)),JqueryUtil.showCopiedEffect(t)}).attr("title","Get Link to Filters (SHIFT adds List)")},class:{getIndexedEntries(e){const t=[];let n=0;return(e.classFeatures||[]).forEach((o,a)=>{o.filter(e=>!e.gainSubclassFeature&&"Ability Score Improvement"!==e.name).forEach(n=>{const o=Renderer.findName(n);if(!o){if(BrewUtil.hasSourceJson(e.source))return;throw new Error("No name!")}t.push({_type:"classFeature",source:e.source.source||e.source,name:o,hash:`${UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_CLASSES](e)}${HASH_PART_SEP}${CLSS_HASH_FEATURE}${UrlUtil.encodeForHash(`${n.name} ${a+1}`)}`,entry:n,level:a+1})});const i=o.filter(e=>e.gainSubclassFeature);if(1===i.length){const o=`${CLSS_HASH_FEATURE}${UrlUtil.encodeForHash(`${i[0].name} ${a+1}`)}`;e.subclasses.forEach(i=>{const r=(i.subclassFeatures||[])[n]||[];i.source=i.source||e.source;const s=[];r.forEach(t=>{const n=`${UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_CLASSES](e)}${HASH_PART_SEP}${HASH_SUBCLASS}${UrlUtil.encodeForHash(i.name)}${HASH_SUB_LIST_SEP}${UrlUtil.encodeForHash(i.source)}`,r=Renderer.findName(t);if(!r){if(BrewUtil.hasSourceJson(i.source))return;throw new Error("No name!")}const _=`${n}${HASH_PART_SEP}${o}`;if(s.push({_type:"subclassFeature",name:r,subclassShortName:i.shortName,source:i.source.source||i.source,hash:_,entry:t,level:a+1}),t.entries){const e=t.entries.filter(e=>e.name);e.forEach(e=>{const n=a+1;s.find(t=>e.name===t.name&&n===t.level)||s.push({_type:"subclassFeaturePart",name:e.name,subclassShortName:i.shortName,source:i.source.source||i.source,hash:_,entry:t,level:n})})}}),t.push(...s)}),n++}else 1<i.length&&setTimeout(()=>{throw new Error(`Multiple subclass features gained at level ${a+1} for class "${e.name}" from source "${e.source}"!`)})}),t}}},UrlUtil.PG_BESTIARY="bestiary.html",UrlUtil.PG_SPELLS="spells.html",UrlUtil.PG_BACKGROUNDS="backgrounds.html",UrlUtil.PG_ITEMS="items.html",UrlUtil.PG_CLASSES="classes.html",UrlUtil.PG_CONDITIONS_DISEASES="conditionsdiseases.html",UrlUtil.PG_FEATS="feats.html",UrlUtil.PG_OPT_FEATURES="optionalfeatures.html",UrlUtil.PG_PSIONICS="psionics.html",UrlUtil.PG_RACES="races.html",UrlUtil.PG_REWARDS="rewards.html",UrlUtil.PG_VARIATNRULES="variantrules.html",UrlUtil.PG_ADVENTURE="adventure.html",UrlUtil.PG_ADVENTURES="adventures.html",UrlUtil.PG_BOOK="book.html",UrlUtil.PG_BOOKS="books.html",UrlUtil.PG_DEITIES="deities.html",UrlUtil.PG_CULTS_BOONS="cultsboons.html",UrlUtil.PG_OBJECTS="objects.html",UrlUtil.PG_TRAPS_HAZARDS="trapshazards.html",UrlUtil.PG_QUICKREF="quickreference.html",UrlUtil.PG_MAKE_SHAPED="makeshaped.html",UrlUtil.PG_MANAGE_BREW="managebrew.html",UrlUtil.PG_DEMO="demo.html",UrlUtil.PG_TABLES="tables.html",UrlUtil.PG_SHIPS="ships.html",UrlUtil.URL_TO_HASH_BUILDER={},UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_BESTIARY]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_SPELLS]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_BACKGROUNDS]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_ITEMS]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_CLASSES]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_CONDITIONS_DISEASES]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_FEATS]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_OPT_FEATURES]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_PSIONICS]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_RACES]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_REWARDS]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_VARIATNRULES]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_ADVENTURE]=e=>UrlUtil.encodeForHash(e.id),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_BOOK]=e=>UrlUtil.encodeForHash(e.id),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_DEITIES]=e=>UrlUtil.encodeForHash([e.name,e.pantheon,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_CULTS_BOONS]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_OBJECTS]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_TRAPS_HAZARDS]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_TABLES]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_SHIPS]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.CAT_TO_PAGE={},UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_CREATURE]=UrlUtil.PG_BESTIARY,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_SPELL]=UrlUtil.PG_SPELLS,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_BACKGROUND]=UrlUtil.PG_BACKGROUNDS,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_ITEM]=UrlUtil.PG_ITEMS,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_CLASS]=UrlUtil.PG_CLASSES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_CLASS_FEATURE]=UrlUtil.PG_CLASSES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_CONDITION]=UrlUtil.PG_CONDITIONS_DISEASES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_FEAT]=UrlUtil.PG_FEATS,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_ELDRITCH_INVOCATION]=UrlUtil.PG_OPT_FEATURES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_METAMAGIC]=UrlUtil.PG_OPT_FEATURES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_MANEUVER_BATTLEMASTER]=UrlUtil.PG_OPT_FEATURES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_MANEUVER_CAVALIER]=UrlUtil.PG_OPT_FEATURES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_ARCANE_SHOT]=UrlUtil.PG_OPT_FEATURES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_OPTIONAL_FEATURE_OTHER]=UrlUtil.PG_OPT_FEATURES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_FIGHTING_STYLE]=UrlUtil.PG_OPT_FEATURES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_PSIONIC]=UrlUtil.PG_PSIONICS,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_RACE]=UrlUtil.PG_RACES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_OTHER_REWARD]=UrlUtil.PG_REWARDS,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_VARIANT_OPTIONAL_RULE]=UrlUtil.PG_VARIATNRULES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_ADVENTURE]=UrlUtil.PG_ADVENTURE,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_DEITY]=UrlUtil.PG_DEITIES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_OBJECT]=UrlUtil.PG_OBJECTS,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_TRAP]=UrlUtil.PG_TRAPS_HAZARDS,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_HAZARD]=UrlUtil.PG_TRAPS_HAZARDS,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_QUICKREF]=UrlUtil.PG_QUICKREF,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_CULT]=UrlUtil.PG_CULTS_BOONS,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_BOON]=UrlUtil.PG_CULTS_BOONS,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_DISEASE]=UrlUtil.PG_CONDITIONS_DISEASES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_TABLE]=UrlUtil.PG_TABLES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_TABLE_GROUP]=UrlUtil.PG_TABLES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_SHIP]=UrlUtil.PG_SHIPS,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_PACT_BOON]=UrlUtil.PG_OPT_FEATURES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_ELEMENTAL_DISCIPLINE]=UrlUtil.PG_OPT_FEATURES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_ARTIFICER_INFUSION]=UrlUtil.PG_OPT_FEATURES,IS_DEPLOYED||IS_ROLL20||"undefined"==typeof window||window.addEventListener("keypress",t=>{if(noModifierKeys(t)&&"undefined"==typeof d20&&"#"===t.key){const e=window.location.href.split("/");window.prompt("Copy to clipboard: Ctrl+C, Enter",`https://5e.tools/${e[e.length-1]}`)}}),SortUtil={ascSort:(e,t)=>("undefined"!=typeof FilterItem&&(e instanceof FilterItem&&(e=e.item),t instanceof FilterItem&&(t=t.item)),SortUtil._ascSort(e,t)),ascSortLower:(e,t)=>("undefined"!=typeof FilterItem&&(e instanceof FilterItem&&(e=e.item),t instanceof FilterItem&&(t=t.item)),SortUtil._ascSort(e.toLowerCase(),t.toLowerCase())),ascSortNumericalSuffix(e,t){function n(e){const t=e.split(" ");return t.last().isNumeric()?[t.slice(0,-1).join(" "),+t.last().replace(Parser._numberCleanRegexp,"")]:[t.join(" "),0]}"undefined"!=typeof FilterItem&&(e instanceof FilterItem&&(e=e.item),t instanceof FilterItem&&(t=t.item));const[o,i]=n(e.item||e),[r,s]=n(t.item||t),_=SortUtil.ascSort(o,r);return _?_:SortUtil.ascSort(i,s)},_ascSort:(e,t)=>t===e?0:t<e?1:-1,compareNames:(e,t)=>{if(t._values.name.toLowerCase()===e._values.name.toLowerCase())return 0;return t._values.name.toLowerCase()>e._values.name.toLowerCase()?1:t._values.name.toLowerCase()<e._values.name.toLowerCase()?-1:void 0},listSort:(e,t,n)=>{function o(n){const o=e.values()[n].toLowerCase(),a=t.values()[n].toLowerCase();return o===a?0:o>a?1:-1}return"name"===n.valueName?o("name"):function(e,t){const n=o(e);return 0===n?o(t):n}(n.valueName,"name")},monTraitSort:(e,t)=>e||t?e?t?"special equipment"===e.toLowerCase().trim()?-1:"special equipment"===t.toLowerCase().trim()?1:SortUtil.ascSortLower(e,t):1:-1:0,_alignFirst:["L","C"],_alignSecond:["G","E"],alignmentSort:(e,t)=>e===t?0:SortUtil._alignFirst.includes(e)?-1:SortUtil._alignSecond.includes(e)?1:SortUtil._alignFirst.includes(t)?1:SortUtil._alignSecond.includes(t)?-1:0,ascSortCr(e,t){return"undefined"!=typeof FilterItem&&(e instanceof FilterItem&&(e=e.item),t instanceof FilterItem&&(t=t.item)),("Unknown"===e||void 0===e)&&(e="999"),("Unknown"===t||void 0===t)&&(t="999"),SortUtil.ascSort(Parser.crToNumber(e),Parser.crToNumber(t))},ascSortAtts(e,t){const n="special"===e,o="special"===t;return n&&o?0:n?1:o?-1:Parser.ABIL_ABVS.indexOf(e)-Parser.ABIL_ABVS.indexOf(t)},ascSort$Options(e){e.append(e.find("option").remove().sort((e,t)=>{const n=$(e).text(),o=$(t).text();return n>o?1:n<o?-1:0}))},initHandleFilterButtonClicks(e="#filtertools"){$("#filtertools").find("button.sort").click(function(){setTimeout(()=>{SortUtil.handleFilterButtonClick.call(this,e)},1)})},handleFilterButtonClick(e,t=$(this),n){n||(n=t.hasClass("asc")||"asc"===t.attr("data-sortby")?"asc":"desc"),$(e).find(".caret").removeClass("caret"),t.find(".caret_wrp").addClass("caret").toggleClass("caret--reverse","asc"===n)}},DataUtil={_loaded:{},async loadJSON(e,...t){const n=UrlUtil.link(e);if(DataUtil._loaded[e])return DataUtil._loaded[e];const o=await new Promise((o,a)=>{function i(n){const i=new XMLHttpRequest;return i.open("GET",n,!0),i.overrideMimeType("application/json"),i.onload=function(){try{const e=JSON.parse(this.response);DataUtil._loaded[n]=e,o(e,t)}catch(t){a(new Error(`Could not parse JSON from ${n}: ${t.message}`))}},i.onerror=t=>a(new Error(`Error during JSON request: ${t.target.status}`)),i}const r=i(n);n!==e&&(r.onerror=function(){const t=i(e);t.send()}),r.send()});return await DataUtil.pDoMetaMerge(o),o},async pDoMetaMerge(e,t){e._meta&&(e._meta.dependencies&&(await Promise.all(Object.entries(e._meta.dependencies).map(async([n,o])=>{if(!e[n])return;const a=await Promise.all(o.map(async e=>DataUtil.pGetLoadableByMeta(n,e))),i=await Promise.all(a.map(e=>DataUtil.loadJSON(e))),r=i.map(e=>e[n]).flat();await Promise.all(e[n].map(async e=>{if(e._copy)switch(n){case"monster":return Renderer.monster.pMergeCopy(r,e,t);default:throw new Error(`No _copy merge strategy specified for property "${n}"`);}}))})),delete e._meta.dependencies),e._meta.internalCopies&&(Promise.all(e._meta.internalCopies.map(async n=>{e[n]&&(await Promise.all(e[n].map(async o=>{if(o._copy)switch(n){case"monster":return Renderer.monster.pMergeCopy(e[n],o,t);default:throw new Error(`No _copy merge strategy specified for property "${n}"`);}})))})),delete e._meta.internalCopies)),e._meta&&e._meta.otherSources&&(await Promise.all(Object.entries(e._meta.otherSources).map(async([t,n])=>{const o=await Promise.all(Object.entries(n).map(async([e,n])=>({findWith:n,url:await DataUtil.pGetLoadableByMeta(t,e)}))),a=await Promise.all(o.map(async({findWith:e,url:t})=>({findWith:e,sourceData:await DataUtil.loadJSON(t)})));a.forEach(n=>{const o=n.findWith,a=n.sourceData,i=a[t].filter(e=>e.otherSources&&e.otherSources.find(e=>e.source===o));i.length&&(e[t]=(e[t]||[]).concat(i))})})),delete e._meta.otherSources)},async multiLoadJSON(e,t,n){e.length||n([]);const o=await Promise.all(e.map(e=>DataUtil.loadJSON(e.url)));return t&&o.forEach((n,o)=>t(e[o],n)),n(o)},userDownload:function(e,n){"string"!=typeof n&&(n=JSON.stringify(n,null,"\t"));const o=document.createElement("a"),a=new Blob([n],{type:"text/json"});o.href=URL.createObjectURL(a),o.download=`${e}.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o)},getCleanFilename(e){return e.replace(/[^-_a-zA-Z0-9]/g,"_")},getCsv(e,t){function n(e){return`"${e.replace(/"/g,`""`).replace(/ +/g," ").replace(/\n\n+/gi,"\n\n")}"`}function o(e){return e.map(e=>n(e)).join(",")}return`${o(e)}\n${t.map(e=>o(e)).join("\n")}`},userDownloadText(e,t){const n=$(`<a href="data:text/plain;charset=utf-8,${encodeURIComponent(t)}" download="${e}" style="display: none;">DL</a>`);$(`body`).append(n),n[0].click(),n.remove()},pUserUpload(){return new Promise(e=>{const t=$(`<input type="file" accept=".json" style="position: fixed; top: -100px; left: -100px; display: none;">`).on("change",t=>{const n=t.target,o=new FileReader;o.onload=()=>{const t=o.result,n=JSON.parse(t);e(n)},o.readAsText(n.files[0])}).appendTo($(`body`));t.click()})},cleanJson(e){return e.name=e._displayName||e.name,DataUtil.__cleanJsonObject(e),e},__cleanJsonObject(e){return null==e?e:void("object"==typeof e&&(e instanceof Array?e.forEach(e=>DataUtil.__cleanJsonObject(e)):Object.entries(e).forEach(([t,n])=>{t.startsWith("_")||"uniqueId"===t?delete e[t]:DataUtil.__cleanJsonObject(n)})))},async pGetLoadableByMeta(e,t){switch(e){case"monster":{const e=await DataUtil.loadJSON(`data/bestiary/index.json`);if(!e[t])throw new Error(`Bestiary index did not contain source "${t}"`);return`data/bestiary/${e[t]}`}default:throw new Error(`Could not get loadable URL for \`${JSON.stringify({key:e,value:t})}\``);}},class:{loadJSON:function(e=""){return new Promise(t=>{DataUtil.loadJSON(`${e}data/class/index.json`).then(n=>{Promise.all(Object.values(n).map(t=>DataUtil.loadJSON(`${e}data/class/${t}`))).then(e=>{t(e.reduce((e,t)=>({class:e.class.concat(t.class)}),{class:[]}))})})})}},deity:{doPostLoad:function(e){const t=[SRC_PHB,SRC_DMG,SRC_SCAG,SRC_MTF],n={};t.forEach(t=>{n[t]={},e.deity.filter(e=>e.source===t).forEach(e=>n[t][e.reprintAlias||e.name]=e)});const o=[t.last()];[...t].reverse().slice(1).forEach(e=>{o.forEach(t=>{Object.keys(n[e]).forEach(o=>{const a=n[t][o];if(a){const t=n[e][o];t.reprinted=!0,a._isEnhanced||(a.previousVersions=a.previousVersions||[],a.previousVersions.push(t))}})}),o.push(e)}),e.deity.forEach(e=>e._isEnhanced=!0)},loadJSON:async function(e=""){const t=await DataUtil.loadJSON(`${e}data/deities.json`);return DataUtil.deity.doPostLoad(t),t}},brew:{async pLoadTimestamps(){return DataUtil.loadJSON(`https://raw.githubusercontent.com/TheGiddyLimit/homebrew/master/_generated/index-timestamps.json`)},async pLoadCollectionIndex(){return DataUtil.loadJSON(`https://raw.githubusercontent.com/TheGiddyLimit/homebrew/master/collection/index.json`)},getDirUrl(e){return`https://raw.githubusercontent.com/TheGiddyLimit/homebrew/master/_generated/index-dir-${e}.json?t=${new Date().getTime()}`}}},RollerUtil={isCrypto:()=>"undefined"!=typeof window&&"undefined"!=typeof window.crypto,randomise:(e,t=1)=>t>e?0:e===t?e:RollerUtil.isCrypto()?RollerUtil._randomise(t,e+1):RollerUtil.roll(e)+t,rollOnArray(e){return e[RollerUtil.randomise(e.length)-1]},_randomise:(e,t)=>{var n=Math.pow;const o=t-e,a=Math.ceil(Math.log2(o)/8),r=new Uint8Array(a),s=n(n(2,8),a),_=Math.floor(s/o)*o;let d,l;for(;;){for(window.crypto.getRandomValues(r),l=0,d=0;d<a;d++)l<<=8,l+=r[d];if(l<_)return l%=o,e+l}},roll:(e,t=Math.random)=>Math.floor(t()*e),addListRollButton:()=>{const e=$("#listcontainer"),t=$(`<button class="btn btn-default" id="feelinglucky" title="Feeling Lucky?"><span class="glyphicon glyphicon-random"></span></button>`);t.on("click",()=>{if(e.data("lists")){const t=e.data("lists").filter(e=>e.visibleItems.length);if(t.length){const e=RollerUtil.roll(t.length),n=t[e],o=RollerUtil.roll(n.visibleItems.length);window.location.hash=$(n.visibleItems[o].elm).find(`a`).prop("hash")}}}),$(`#filter-search-input-group`).find(`#reset`).before(t)},isRollCol(e){return!("string"!=typeof e)&&(!!/^{@dice [^}]+}$/.test(e.trim())||!!Renderer.dice.parseToTree(e))},_DICE_REGEX_STR:"((([1-9]\\d*)?d([1-9]\\d*)(\\s*?[-+\xD7x*\xF7/]\\s*?(\\d,\\d|\\d)+(\\.\\d+)?)?))+?"},RollerUtil.DICE_REGEX=new RegExp(RollerUtil._DICE_REGEX_STR,"g"),RollerUtil.REGEX_DAMAGE_DICE=/(\d+)( \((?:{@dice |{@damage ))([-+0-9d ]*)(}\) [a-z]+( \([-a-zA-Z0-9 ]+\))?( or [a-z]+( \([-a-zA-Z0-9 ]+\))?)? damage)/gi,RollerUtil.REGEX_DAMAGE_FLAT=/(Hit: |{@h})([0-9]+)( [a-z]+( \([-a-zA-Z0-9 ]+\))?( or [a-z]+( \([-a-zA-Z0-9 ]+\))?)? damage)/gi,StorageUtil={_init:!1,_initAsync:!1,_fakeStorage:{},_fakeStorageAsync:{},getSyncStorage:()=>{if(StorageUtil._init)return StorageUtil.__fakeStorage?StorageUtil._fakeStorage:window.localStorage;StorageUtil._init=!0;try{return window.localStorage}catch(t){return StorageUtil.__fakeStorage=!0,StorageUtil._fakeStorage={isSyncFake:!0,getItem:e=>StorageUtil.__fakeStorage[e],removeItem:e=>{delete StorageUtil.__fakeStorage[e]},setItem:(e,t)=>{StorageUtil.__fakeStorage[e]=t}},StorageUtil._fakeStorage}},async getAsyncStorage(){if(StorageUtil._initAsync)return StorageUtil.__fakeStorageAsync?StorageUtil._fakeStorageAsync:localforage;StorageUtil._initAsync=!0;try{return await localforage.setItem("_storage_check",!0),localforage}catch(t){return StorageUtil.__fakeStorageAsync=!0,StorageUtil._fakeStorageAsync={pIsAsyncFake:!0,async setItem(e,t){StorageUtil.__fakeStorageAsync[e]=t},async getItem(e){return StorageUtil.__fakeStorageAsync[e]},async removeItem(e){delete StorageUtil.__fakeStorageAsync[e]}},StorageUtil._fakeStorageAsync}},syncGet(e){const t=StorageUtil.getSyncStorage().getItem(e);return t&&"undefined"!==t&&"null"!==t?JSON.parse(t):null},syncSet(e,t){StorageUtil.getSyncStorage().setItem(e,JSON.stringify(t)),StorageUtil._syncTrackKey(e)},syncRemove(e){StorageUtil.getSyncStorage().removeItem(e),StorageUtil._syncTrackKey(e,!0)},syncGetForPage(e){return StorageUtil.syncGet(`${e}_${UrlUtil.getCurrentPage()}`)},syncSetForPage(e,t){StorageUtil.syncSet(`${e}_${UrlUtil.getCurrentPage()}`,t)},isSyncFake(){return!!StorageUtil.getSyncStorage().isSyncFake},_syncTrackKey(e,t){const n=StorageUtil.syncGet(StorageUtil._META_KEY)||{};t?delete n[e]:n[e]=1,StorageUtil.getSyncStorage().setItem(StorageUtil._META_KEY,JSON.stringify(n))},syncGetDump(){const e={},t=StorageUtil.syncGet(StorageUtil._META_KEY)||{};return Object.entries(t).filter(([e,t])=>t).forEach(([t])=>e[t]=StorageUtil.syncGet(t)),e},syncSetFromDump(e){Object.entries(e).forEach(([e,t])=>StorageUtil.syncSet(e,t))},async pIsAsyncFake(){const e=await StorageUtil.getAsyncStorage();return!!e.pIsAsyncFake},async pSet(e,t){StorageUtil._pTrackKey(e);const n=await StorageUtil.getAsyncStorage();return n.setItem(e,t)},async pGet(e){const t=await StorageUtil.getAsyncStorage();return t.getItem(e)},async pRemove(e){StorageUtil._pTrackKey(e,!0);const t=await StorageUtil.getAsyncStorage();return t.removeItem(e)},async pGetForPage(e){return StorageUtil.pGet(`${e}_${UrlUtil.getCurrentPage()}`)},async pSetForPage(e,t){return StorageUtil.pSet(`${e}_${UrlUtil.getCurrentPage()}`,t)},async pRemoveForPage(e){return StorageUtil.pRemove(`${e}_${UrlUtil.getCurrentPage()}`)},async _pTrackKey(e,t){const n=await StorageUtil.getAsyncStorage(),o=(await StorageUtil.pGet(StorageUtil._META_KEY))||{};t?delete o[e]:o[e]=1,n.setItem(StorageUtil._META_KEY,o)},async pGetDump(){const e={},t=(await StorageUtil.pGet(StorageUtil._META_KEY))||{};return await Promise.all(Object.entries(t).filter(([e,t])=>t).map(async([t])=>e[t]=await StorageUtil.pGet(t))),e},async pSetFromDump(e){return Promise.all(Object.entries(e).map(([e,t])=>StorageUtil.pSet(e,t)))}},StorageUtil._META_KEY="_STORAGE_META_STORAGE",SessionStorageUtil={_fakeStorage:{},__storage:null,getStorage:()=>{try{return window.sessionStorage}catch(t){return SessionStorageUtil.__storage?SessionStorageUtil.__storage:SessionStorageUtil.__storage={isFake:!0,getItem:e=>SessionStorageUtil._fakeStorage[e],removeItem:e=>{delete SessionStorageUtil._fakeStorage[e]},setItem:(e,t)=>{SessionStorageUtil._fakeStorage[e]=t}}}},isFake(){return SessionStorageUtil.getStorage().isSyncFake},setForPage:(e,t)=>{SessionStorageUtil.set(`${e}_${UrlUtil.getCurrentPage()}`,t)},set(e,t){SessionStorageUtil.getStorage().setItem(e,JSON.stringify(t))},getForPage:e=>SessionStorageUtil.get(`${e}_${UrlUtil.getCurrentPage()}`),get(e){const t=SessionStorageUtil.getStorage().getItem(e);return t&&"undefined"!==t&&"null"!==t?JSON.parse(t):null},removeForPage:e=>{SessionStorageUtil.remove(`${e}_${UrlUtil.getCurrentPage()}`)},remove(e){SessionStorageUtil.getStorage().removeItem(e)}},BrewUtil={homebrew:null,homebrewMeta:null,_lists:null,_sourceCache:null,_filterBox:null,_sourceFilter:null,_pHandleBrew:null,bind(e){e.list?BrewUtil._lists=[e.list]:e.lists&&(BrewUtil._lists=e.lists),e.filterBox&&(BrewUtil._filterBox=e.filterBox),e.sourceFilter&&(BrewUtil._sourceFilter=e.sourceFilter),e.pHandleBrew&&(this._pHandleBrew=e.pHandleBrew)},async pAddBrewData(){if(BrewUtil.homebrew)return BrewUtil.homebrew;else{const e=(await StorageUtil.pGet(HOMEBREW_STORAGE))||{};return BrewUtil.homebrewMeta=StorageUtil.syncGet(HOMEBREW_META_STORAGE)||{sources:[]},BrewUtil.homebrewMeta.sources=BrewUtil.homebrewMeta.sources||[],BrewUtil.homebrew=e,BrewUtil._resetSourceCache(),BrewUtil.homebrew}},async pPurgeBrew(e){JqueryUtil.doToast({content:"Error when loading homebrew! Purged homebrew data. (See the log for more information.)",type:"danger"}),await StorageUtil.pRemove(HOMEBREW_STORAGE),StorageUtil.syncRemove(HOMEBREW_META_STORAGE),BrewUtil.homebrew=null,window.location.hash="",e&&setTimeout(()=>{throw e})},async pAddLocalBrewData(e=async(e,t)=>BrewUtil.pDoHandleBrewJson(e,t,null)){return IS_ROLL20||IS_DEPLOYED?Promise.resolve():DataUtil.loadJSON(`${Renderer.get().baseUrl}${JSON_HOMEBREW_INDEX}`).then(async t=>{if(t.toImport.length){const n=UrlUtil.getCurrentPage(),o=await Promise.all(t.toImport.map(e=>DataUtil.loadJSON(`homebrew/${e}`)));return Promise.all(o.map(t=>e(t,n)))}return Promise.resolve()})},async _pRenderBrewScreen(e,t,n,o,a){const i=UrlUtil.getCurrentPage(),r=o?$(`<h4 class="split"><span>Manage Homebrew</span></h4>`).appendTo(n):$(`<div class="mb-3 text-center"/>`).appendTo(n);n.append(`<hr class="manbrew__hr">`);const s=$(`<div class="manbrew__current_brew"/>`);n.append(s),await BrewUtil._pRenderBrewScreen_pRefreshBrewList(e,t,s);const _=$(`<input multiple type="file" accept=".json" style="display: none;">`).change(n=>{const o=n.target;let a=0;const r=new FileReader;r.onload=async()=>{const _=r.result,d=JSON.parse(_);await DataUtil.pDoMetaMerge(d),await BrewUtil.pDoHandleBrewJson(d,i,BrewUtil._pRenderBrewScreen_pRefreshBrewList.bind(this,e,t,s)),await ExcludeUtil.pSetList(d.blacklist||[]),o.files[a]?r.readAsText(o.files[a++]):$(n.target).val("")},r.readAsText(o.files[a++])}),d=$(`<button class="btn btn-default btn-sm">Load from URL</button>`).click(()=>{const e=window.prompt("Please enter the URL of the homebrew:");if(!e)return;let t;try{t=new URL(e)}catch(t){return void JqueryUtil.doToast({content:`The provided URL does not appear to be valid.`,type:"danger"})}BrewUtil.addBrewRemote(null,t.href).catch(()=>{JqueryUtil.doToast({content:"Could not load homebrew from the provided URL.",type:"danger"})})}),l=$(`<button class="btn btn-info btn-sm">Get Homebrew</button>`).click(async()=>{function n(){switch(i){case UrlUtil.PG_SPELLS:return["spell"];case UrlUtil.PG_CLASSES:return["class","subclass"];case UrlUtil.PG_BESTIARY:return["creature"];case UrlUtil.PG_BACKGROUNDS:return["background"];case UrlUtil.PG_FEATS:return["feat"];case UrlUtil.PG_OPT_FEATURES:return["optionalfeature"];case UrlUtil.PG_RACES:return["race"];case UrlUtil.PG_OBJECTS:return["object"];case UrlUtil.PG_TRAPS_HAZARDS:return["trap","hazard"];case UrlUtil.PG_DEITIES:return["deity"];case UrlUtil.PG_ITEMS:return["item","magicvariant"];case UrlUtil.PG_REWARDS:return["reward"];case UrlUtil.PG_PSIONICS:return["psionic"];case UrlUtil.PG_VARIATNRULES:return["variantrule"];case UrlUtil.PG_CONDITIONS_DISEASES:return["condition","disease"];case UrlUtil.PG_ADVENTURES:return["adventure"];case UrlUtil.PG_BOOKS:return["book"];case UrlUtil.PG_TABLES:return["table"];case UrlUtil.PG_MAKE_SHAPED:return["spell","creature"];case UrlUtil.PG_MANAGE_BREW:case UrlUtil.PG_DEMO:return BrewUtil._DIRS;case UrlUtil.PG_SHIPS:return["ship"];default:throw new Error(`No homebrew directories defined for category ${i}`);}}function o(e,t,n){function o(){return SortUtil.ascSortLower(e._brewName,t._brewName)}function i(n,a){return n(e[a],t[a])||o()}return e=l[e.elm.getAttribute(FLTR_ID)],t=l[t.elm.getAttribute(FLTR_ID)],"name"===n.valueName?o():"author"===n.valueName?i(SortUtil.ascSortLower,"_brewAuthor"):"category"===n.valueName?i(SortUtil.ascSortLower,"_brewCat"):"timestamp"===n.valueName?i(SortUtil.ascSort,"_brewAdded"):void 0}const r=$(`<button class="btn btn-default btn-xs manbrew__load_all" disabled title="(Excluding samples)">Add All</button>`),s=$$`<ul class="list brew-list"><li><section><span style="font-style: italic;">Loading...</span></section></li></ul>`,_=$$`
					<div id="brewlistcontainer" class="listcontainer homebrew-window dropdown-menu">
						<h4><span>Get Homebrew</span></h4>
						<p><i>A list of homebrew available in the public repository. Click a name to load the homebrew, or view the source directly.<br>
						Contributions are welcome; see the <a href="https://github.com/TheGiddyLimit/homebrew/blob/master/README.md" target="_blank" rel="noopener">README</a>, or stop by our <a href="https://discord.gg/nGvRCDs" target="_blank" rel="noopener">Discord</a>.</i></p>
						<hr class="manbrew__hr">
						<div class="manbrew__load_all_wrp">${r}</div>
						<input type="search" class="search manbrew__search form-control" placeholder="Find homebrew..." style="width: 100%">
						<div class="filtertools manbrew__filtertools sortlabel btn-group lst__form-bottom">
							<button class="col-4 sort btn btn-default btn-xs" data-sort="name">Name</button>
							<button class="col-3 sort btn btn-default btn-xs" data-sort="author">Author</button>
							<button class="col-2 sort btn btn-default btn-xs" data-sort="category">Category</button>
							<button class="col-2 sort btn btn-default btn-xs" data-sort="timestamp">Added</button>
							<button class="col-1 sort btn btn-default btn-xs" disabled>Source</button>
						</div>
						${s}
					</div>
				`,d=BrewUtil._pRenderBrewScreen_makeInnerOverlay(e,t,a);d.append(_),_.on("click",e=>e.stopPropagation());let l;const u=await DataUtil.brew.pLoadTimestamps(),c=await DataUtil.brew.pLoadCollectionIndex(),S=(()=>{const e=new Set(n().map(e=>BrewUtil._pRenderBrewScreen_dirToCat(e)));return Object.keys(c).filter(t=>c[t].find(t=>e.has(t)))})();(()=>{const e=n().map(e=>({url:DataUtil.brew.getDirUrl(e),_cat:BrewUtil._pRenderBrewScreen_dirToCat(e)}));S.length&&e.push({url:DataUtil.brew.getDirUrl("collection"),_collection:!0,_cat:"collection"}),DataUtil.multiLoadJSON(e,(e,t)=>{e._collection&&t.filter(e=>"index.json"===e.name||!S.includes(e.name)).forEach(e=>e._brewSkip=!0),t.forEach(t=>t._cat=e._cat)},e=>{let t="";const n=[].concat.apply([],e);n.forEach(e=>{const t=e.name.trim().replace(/\.json$/,""),n=t.split(";").map(e=>e.trim());1<n.length?(e._brewName=n[1],e._brewAuthor=n[0]):(e._brewName=t,e._brewAuthor="")}),n.sort((e,t)=>SortUtil.ascSortLower(e._brewName,t._brewName)),l=n.filter(e=>!e._brewSkip),l.forEach((e,n)=>{e._brewAdded=u[e.path]||0,e._brewCat=BrewUtil._pRenderBrewScreen_getDisplayCat(BrewUtil._pRenderBrewScreen_dirToCat(e._cat)),t+=`
									<li ${FLTR_ID}="${n}" class="not-clickable">
										<section>
											<span class="col-4 name manbrew__load_from_url pl-0 clickable" onclick="BrewUtil.addBrewRemote(this, '${(e.download_url||"").escapeQuotes()}', true)">${e._brewName}</span>
											<span class="col-3 author">${e._brewAuthor}</span>
											<span class="col-2 category text-center">${e._brewCat}</span>
											<span class="col-2 timestamp text-center">${e._brewAdded?MiscUtil.dateToStr(new Date(1e3*e._brewAdded),!0):""}</span>
											<span class="col-1 source manbrew__source text-center pr-0"><a href="${e.download_url}" target="_blank" rel="noopener">View Raw</a></span>
										</section>
									</li>`}),s.empty(),s.append(t);const a=new List("brewlistcontainer",{valueNames:["name","author","category","timestamp"],listClass:"brew-list",sortFunction:o});ListUtil.bindEscapeKey(a,_.find(`.search`),!0),r.prop("disabled",!1).click(()=>_.find(`.manbrew__load_from_url`).filter((t,n)=>!$(n).siblings(`.author`).text().toLowerCase().trim().startsWith("sample -")).click())})})()}),u=$(`<button class="btn ${o?"btn-xs":"btn-sm"} btn-danger">Delete All</button>`).click(async()=>{window.confirm("Are you sure?")&&(await StorageUtil.pSet(HOMEBREW_STORAGE,{}),StorageUtil.syncSet(HOMEBREW_META_STORAGE,{}),window.location.hash="",location.reload())});o&&u.appendTo(r);const c=o?$(`<div class="text-center"/>`).appendTo(n):r;$$`<div ${o?`class="text-center"`:""}>
			${l}
			<label role="button" class="btn btn-default btn-sm btn-file">Upload File${_}</label>
			${d}
			<a href="https://github.com/TheGiddyLimit/homebrew" target="_blank" rel="noopener"><button class="btn btn-default btn-sm btn-file">Browse Source Repository</button></a>
			${o?null:u}
		</div>`.appendTo(c),t.append(n),e.append(t),BrewUtil.addBrewRemote=async(n,o,a)=>{const r=$(n),_=r.html();r.text("Loading..."),a&&(o=o.unescapeQuotes());const d=await DataUtil.loadJSON(`${o}?${new Date().getTime()}`);await BrewUtil.pDoHandleBrewJson(d,i,BrewUtil._pRenderBrewScreen_pRefreshBrewList.bind(this,e,t,s)),r.text("Done!"),setTimeout(()=>r.html(_),500)}},_pRenderBrewScreen_makeInnerOverlay(e,t,n){t.css("background","transparent");const o=$(`<div class="homebrew-overlay"/>`);return o.on("click",()=>{o.remove(),t.css("background",""),n&&n()}),e.append(o),o},async _pRenderBrewScreen_pDeleteSource(e,t,n,o,a,i){if(a&&!window.confirm(`Are you sure you want to remove all homebrew${i?"":` with${o?` source "${Parser.sourceJsonToFull(o)}"`:`out a source`}`}?`))return;const r=new Set(BrewUtil._getActiveVetoolsSources().map(e=>e.json)),s=e=>i||e===o||o===void 0&&!r.has(e)&&!BrewUtil.hasSourceJson(e);await Promise.all(BrewUtil._getBrewCategories().map(async e=>{const t=BrewUtil.homebrew[e],n=BrewUtil._getPDeleteFunction(e),o=[];t.filter(e=>s(e.source)).forEach(e=>o.push(e.uniqueId)),await Promise.all(o.map(async e=>n(e)))})),await StorageUtil.pSet(HOMEBREW_STORAGE,BrewUtil.homebrew),BrewUtil.removeJsonSource(o),UrlUtil.getCurrentPage()===UrlUtil.PG_MAKE_SHAPED&&removeBrewSource(o),BrewUtil._sourceFilter&&BrewUtil._sourceFilter.removeItem(o),BrewUtil._filterBox&&BrewUtil._filterBox.render(),await BrewUtil._pRenderBrewScreen_pRefreshBrewList(e,t,n),window.location.hash="",BrewUtil._filterBox&&BrewUtil._filterBox.fireChangeEvent()},async _pRenderBrewScreen_pRefreshBrewList(e,t,n){function o(o,a,i){function r(){function e(e,t){const n={name:t.name,uniqueId:t.uniqueId,extraInfo:""};switch(e){case"subclass":n.extraInfo=` (${t.class})`;break;case"psionic":n.extraInfo=` (${Parser.psiTypeToFull(t.type)})`;break;case"itemProperty":{t.entries&&(n.name=Renderer.findName(t.entries)),n.name||(n.name=t.abbreviation);break}case"adventureData":case"bookData":{n.name=((BrewUtil.homebrew[{adventureData:"adventure",bookData:"book"}[e]]||[]).find(e=>e.id===t.id)||{}).name||t.id}}return n.name=n.name||`(Unknown)`,n}const t=new Set(BrewUtil._getActiveVetoolsSources().map(e=>e.json));let n="";const a=e=>i||e===o||void 0===o&&!t.has(e)&&!BrewUtil.hasSourceJson(e);BrewUtil._getBrewCategories().forEach(t=>{BrewUtil.homebrew[t].filter(e=>a(e.source)).map(n=>e(t,n)).sort((e,t)=>SortUtil.ascSort(e.name,t.name)).forEach(e=>{n+=`
									<li><section onclick="ListUtil.toggleCheckbox(event, this)">
										<span class="col-6 name">${e.name}</span>
										<span class="col-5 category text-center">${BrewUtil._pRenderBrewScreen_getDisplayCat(t,!0)}${e.extraInfo}</span>
										<span class="col-1 text-center"><input type="checkbox" onclick="event.stopPropagation()"></span>
										<span class="hidden uid">${e.uniqueId}</span>
										<span class="category_raw hidden">${t}</span>
									</section></li>
								`})}),d.empty(),n?d.append(n):d.append(`<h5 class="text-center">No results found.</h5>`)}const s=$(`<h4 class="split"><span>View/Manage ${o?`Source Contents: ${Parser.sourceJsonToFull(o)}`:i?"Entries from All Sources":`Entries with No Source`}</span></h4>`),_=$(`<input type="checkbox">`),d=$$`<ul class="list brew-list"/>`,l=$$`
				<div id="brewlistcontainer" class="listcontainer homebrew-window dropdown-menu">
					${s}
					<input type="search" class="search manbrew__search form-control" placeholder="Search entries..." style="width: 100%">
					<div class="filtertools manbrew__filtertools sortlabel btn-group">
						<button class="col-6 sort btn btn-default btn-xs" data-sort="name">Name</button>
						<button class="col-5 sort btn btn-default btn-xs" data-sort="category">Category</button>
						<label class="col-1 wrp-cb-all">${_}</label>
					</div>
					${d}
				</div>
			`;a.append(l),l.on("click",e=>e.stopPropagation()),r();const u=new List("brewlistcontainer",{valueNames:["name","category","category_raw","uid"],listClass:"brew-list",sortFunction:SortUtil.listSort});ListUtil.bindEscapeKey(u,l.find(`.search`),!0),_.change(function(){const e=this.checked;u.items.forEach(t=>$(t.elm).find(`input`).prop("checked",e))}),$(`<button class="btn btn-danger btn-xs">Delete Selected</button>`).on("click",async()=>{const i=u.items.filter(e=>$(e.elm).find(`input`).prop("checked")).map(e=>e.values());i.length&&window.confirm("Are you sure?")&&(i.length===u.items.length?(await BrewUtil._pRenderBrewScreen_pDeleteSource(e,t,n,o,!1,!1),a.click()):(await Promise.all(i.map(async e=>{const t=BrewUtil._getPDeleteFunction(e.category_raw);await t(e.uid)})),await StorageUtil.pSet(HOMEBREW_STORAGE,BrewUtil.homebrew),r(),await BrewUtil._pRenderBrewScreen_pRefreshBrewList(e,t,n),window.location.hash=""))}).appendTo(s)}if(n.empty(),BrewUtil.homebrew){const a=$(`
					<div id="outerbrewlistcontainer" class="listcontainer">
						<input type="search" class="search manbrew__search form-control" placeholder="Search active homebrew...">
						<div class="filtertools manbrew__filtertools sortlabel btn-group lst__form-bottom">
							<button class="col-5 sort btn btn-default btn-xs" data-sort="source">Source</button>
							<button class="col-4 sort btn btn-default btn-xs" data-sort="authors">Authors</button>
							<button class="col-1 btn btn-default btn-xs" disabled>Origin</button>
							<button class="col-2 btn btn-default btn-xs" disabled>&nbsp;</button>
						</div>
						<ul class="list-display-only brew-list brew-list--target"></ul>
						<ul class="list-display-only brew-list brew-list--groups"></ul>
					</div>
				`).appendTo(n),i=a.find(`ul.brew-list--target`).empty(),r=a.find(`ul.brew-list--groups`).empty(),s=(a,i)=>{const r=$(`<span class="col-2 text-right"/>`).appendTo(i);$(`<button class="btn btn-sm btn-default">View/Manage</button>`).on("click",()=>{const n=BrewUtil._pRenderBrewScreen_makeInnerOverlay(e,t);o(a.json,n,a._all)}).appendTo(r),r.append(" "),$(`<button class="btn btn-danger btn-sm"><span class="glyphicon glyphicon-trash"></span></button>`).on("click",()=>BrewUtil._pRenderBrewScreen_pDeleteSource(e,t,n,a.json,!0,a._all)).appendTo(r)},_=UrlUtil.getCurrentPage(),d=e=>{const t=(()=>{switch(_){case UrlUtil.PG_SPELLS:return["spell"];case UrlUtil.PG_CLASSES:return["class","subclass"];case UrlUtil.PG_BESTIARY:return["monster","legendaryGroup","monsterFluff"];case UrlUtil.PG_BACKGROUNDS:return["background"];case UrlUtil.PG_FEATS:return["feat"];case UrlUtil.PG_OPT_FEATURES:return["optionalfeature"];case UrlUtil.PG_RACES:return["race"];case UrlUtil.PG_OBJECTS:return["object"];case UrlUtil.PG_TRAPS_HAZARDS:return["trap","hazard"];case UrlUtil.PG_DEITIES:return["deity"];case UrlUtil.PG_ITEMS:return["item","baseitem","variant","itemProperty","itemType"];case UrlUtil.PG_REWARDS:return["reward"];case UrlUtil.PG_PSIONICS:return["psionic"];case UrlUtil.PG_VARIATNRULES:return["variantrule"];case UrlUtil.PG_CONDITIONS_DISEASES:return["condition","disease"];case UrlUtil.PG_ADVENTURES:return["adventure","adventureData"];case UrlUtil.PG_BOOKS:return["book","bookData"];case UrlUtil.PG_TABLES:return["table","tableGroup"];case UrlUtil.PG_MAKE_SHAPED:return["spell","creature"];case UrlUtil.PG_MANAGE_BREW:case UrlUtil.PG_DEMO:return BrewUtil._STORABLE;case UrlUtil.PG_SHIPS:return["ship"];default:throw new Error(`No homebrew properties defined for category ${_}`);}})();return!!t.find(t=>!!(BrewUtil.homebrew[t]||[]).some(t=>t.source===e))},l=MiscUtil.copy(BrewUtil.getJsonSources()).filter(e=>d(e.json));l.sort((e,t)=>SortUtil.ascSort(e.full,t.full));const u=BrewUtil._getActiveVetoolsSources();l.concat(u).forEach(e=>{const t=(e.authors?e.authors instanceof Array?e.authors:[]:[]).join(", "),n=e._unknown||e._all,o=$(`<li class="row manbrew__row">
						<span class="col-5 manbrew__col--tall source manbrew__source">${n?"<i>":""}${e.full}${n?"</i>":""}</span>
						<span class="col-4 manbrew__col--tall authors">${t}</span>
						<${e.url?"a":"span"} class="col-1 manbrew__col--tall text-center" ${e.url?`href="${e.url}" target="_blank" rel="noopener"`:""}>${e.url?"View Source":""}</${e.url?"a":"span"}>
					</li>`);s(e,o),i.append(o)});const c=(e,t)=>{const n=$(`<li class="row manbrew__row" style="border-bottom: 0">
						<span class="col-10 manbrew__col--tall source manbrew__source text-right"><i>${e}</i></span>
					</li>`);s({[t]:!0},n),r.append(n)};c("Entries From All Sources","_all"),c("Entries Without Sources","_unknown"),setTimeout(()=>{const e=new List("outerbrewlistcontainer",{valueNames:["source","authors"],listClass:"brew-list--target"});ListUtil.bindEscapeKey(e,a.find(`.search`),!0)},5)}},_pRenderBrewScreen_dirToCat(e){if(!e)return"";if(BrewUtil._STORABLE.includes(e))return e;switch(e){case"creature":return"monster";case"collection":return e;case"magicvariant":return"variant";}throw new Error(`Directory was not mapped to a category: "${e}"`)},_pRenderBrewScreen_getDisplayCat(e,t){return"variantrule"===e?"Variant Rule":"legendaryGroup"===e?"Legendary Group":"optionalfeature"===e?"Optional Feature":"adventure"===e?t?"Adventure Contents/Info":"Adventure":"adventureData"===e?"Adventure Text":"book"===e?t?"Book Contents/Info":"Book":"bookData"===e?"Book Text":"itemProperty"===e?"Item Property":"baseitem"===e?"Base Item":"variant"===e?"Magic Item Variant":"monsterFluff"===e?"Monster Fluff":e.uppercaseFirst()},handleLoadbrewClick:async(e,t,n)=>{const o=$(e);if(!o.hasClass("rd__wrp-loadbrew--ready"))return;const a=o.html(),i=o.attr("title");o.attr("title",""),o.removeClass("rd__wrp-loadbrew--ready").html(`${n}<span class="glyphicon glyphicon-refresh rd__loadbrew-icon rd__loadbrew-icon--active"/>`),t=t.unescapeQuotes();const r=await DataUtil.loadJSON(`${t}?${new Date().getTime()}`);await BrewUtil.pDoHandleBrewJson(r,UrlUtil.getCurrentPage()),o.html(`${n}<span class="glyphicon glyphicon-saved rd__loadbrew-icon"/>`),setTimeout(()=>o.html(a).addClass("rd__wrp-loadbrew--ready").attr("title",i),500)},async _pDoRemove(e,t,n){const o=function(e,t,n){return BrewUtil.homebrew[e].findIndex(e=>n?e.parentUniqueId:e.uniqueId===t)}(e,t,n);~o&&(BrewUtil.homebrew[e].splice(o,1),BrewUtil._lists&&BrewUtil._lists.forEach(e=>e.remove(n?"parentuniqueid":"uniqueid",t)))},_getPDeleteFunction(e){switch(e){case"spell":case"monster":case"monsterFluff":case"background":case"feat":case"optionalfeature":case"race":case"object":case"trap":case"hazard":case"deity":case"item":case"baseitem":case"variant":case"itemType":case"itemProperty":case"reward":case"psionic":case"variantrule":case"legendaryGroup":case"condition":case"disease":case"table":case"tableGroup":case"ship":return BrewUtil._genPDeleteGenericBrew(e);case"subclass":return BrewUtil._pDeleteSubclassBrew;case"class":return BrewUtil._pDeleteClassBrew;case"adventure":case"book":return BrewUtil._genPDeleteGenericBookBrew(e);case"adventureData":case"bookData":return()=>{};default:throw new Error(`No homebrew delete function defined for category ${e}`);}},async _pDeleteClassBrew(e){await BrewUtil._pDoRemove("class",e)},async _pDeleteSubclassBrew(e){let t,n=0;for(;n<BrewUtil.homebrew.subclass.length;++n)if(BrewUtil.homebrew.subclass[n].uniqueId===e){t=BrewUtil.homebrew.subclass[n];break}if(t){const o=t.class;if(BrewUtil.homebrew.subclass.splice(n,1),await StorageUtil.pSet(HOMEBREW_STORAGE,BrewUtil.homebrew),"undefined"!=typeof ClassData){const t=ClassData.classes.find(e=>e.name.toLowerCase()===o.toLowerCase()),n=t.subclasses.findIndex(t=>t.uniqueId===e);~n&&(t.subclasses.splice(n,1),t.subclasses=t.subclasses.sort((e,t)=>SortUtil.ascSort(e.name,t.name)))}}},_genPDeleteGenericBrew(e){return async t=>{await BrewUtil._pDoRemove(e,t)}},_genPDeleteGenericBookBrew(e){return async t=>{await BrewUtil._pDoRemove(e,t),await BrewUtil._pDoRemove(`${e}Data`,t,!0)}},manageBrew:()=>{const e=$(`body`);e.css("overflow","hidden");const t=$(`<div class="homebrew-overlay"/>`);t.on("click",()=>{e.css("overflow",""),t.remove()});const n=$(`<div class="homebrew-window dropdown-menu"/>`);n.on("click",e=>e.stopPropagation()),BrewUtil._pRenderBrewScreen(e,t,n,!0)},async pAddEntry(e,t){return BrewUtil._mutUniqueId(t),(BrewUtil.homebrew[e]=BrewUtil.homebrew[e]||[]).push(t),await StorageUtil.pSet(HOMEBREW_STORAGE,BrewUtil.homebrew),BrewUtil.homebrew[e].length-1},async pRemoveEntry(e,t){const n=(BrewUtil.homebrew[e]=BrewUtil.homebrew[e]||[]).findIndex(e=>e.uniqueId===t.uniqueId);if(~n)return BrewUtil.homebrew[e].splice(n,1),StorageUtil.pSet(HOMEBREW_STORAGE,BrewUtil.homebrew);throw new Error(`Could not find object with ID "${t.uniqueId}" in "${e}" list`)},getEntryIxByName(e,t){return(BrewUtil.homebrew[e]=BrewUtil.homebrew[e]||[]).findIndex(e=>e.name===t.name&&e.source===t.source)},async pUpdateEntryByIx(e,t,n){if(~t&&t<BrewUtil.homebrew[e].length)return BrewUtil._mutUniqueId(n),BrewUtil.homebrew[e].splice(t,1,n),StorageUtil.pSet(HOMEBREW_STORAGE,BrewUtil.homebrew);throw new Error(`Index "${t}" was not valid!`)},_mutUniqueId(e){delete e.uniqueId,e.uniqueId=CryptUtil.md5(JSON.stringify(e))},_DIRS:["spell","class","subclass","creature","background","feat","optionalfeature","race","object","trap","hazard","deity","item","reward","psionic","variantrule","condition","disease","adventure","book","ship","magicvariant"],_STORABLE:["class","subclass","spell","monster","legendaryGroup","monsterFluff","background","feat","optionalfeature","race","deity","item","baseitem","variant","itemProperty","itemType","psionic","reward","object","trap","hazard","variantrule","condition","disease","adventure","adventureData","book","bookData","table","tableGroup","ship"],async pDoHandleBrewJson(e,t,n){async function o(t){if(BrewUtil.homebrew[t]||(BrewUtil.homebrew[t]=[]),IS_DEPLOYED){const n=[],o=BrewUtil.homebrew[t].map(e=>e.uniqueId);return e[t].forEach(e=>{o.find(t=>e.uniqueId===t)||(BrewUtil.homebrew[t].push(e),n.push(e))}),n}else{const n={};BrewUtil.homebrew[t].forEach(e=>{n[e.source]=n[e.source]||{},n[e.source][e.name]=e.uniqueId});const o=BrewUtil._getPDeleteFunction(t);return await Promise.all(e[t].map(async e=>{n[e.source]&&n[e.source][e.name]&&(await o(n[e.source][e.name])),BrewUtil.homebrew[t].push(e)})),e[t]}}function a(){const t=[];return e._meta&&(!BrewUtil.homebrewMeta&&(BrewUtil.homebrewMeta={sources:[]}),Object.keys(e._meta).forEach(n=>{switch(n){case"sources":{const n=BrewUtil.homebrewMeta.sources.map(e=>e.json);e._meta.sources.forEach(e=>{n.find(t=>t===e.json)||(BrewUtil.homebrewMeta.sources.push(e),t.push(e))});break}default:{BrewUtil.homebrewMeta[n]=BrewUtil.homebrewMeta[n]||{},Object.assign(BrewUtil.homebrewMeta[n],e._meta[n]);break}}})),t}e.race&&e.race.length&&(e.race=Renderer.race.mergeSubraces(e.race)),BrewUtil._STORABLE.forEach(function(t){e[t]?e[t].forEach(e=>BrewUtil._mutUniqueId(e)):e[t]=[]});[["adventure","adventureData"],["book","bookData"]].forEach(([t,n])=>{e[t]&&e[n]&&e[t].forEach(t=>{const o=e[n].find(e=>e.id===t.id);o&&(o.parentUniqueId=t.uniqueId)})});let i=e._meta?e._meta.sources:[];const r={};switch(BrewUtil._STORABLE.forEach(t=>r[t]=e[t]),BrewUtil.homebrew=BrewUtil.homebrew||{},i=a(),await Promise.all(BrewUtil._STORABLE.map(async e=>r[e]=await o(e))),await StorageUtil.pSet(HOMEBREW_STORAGE,BrewUtil.homebrew),StorageUtil.syncSet(HOMEBREW_META_STORAGE,BrewUtil.homebrewMeta),BrewUtil._resetSourceCache(),t){case UrlUtil.PG_SPELLS:case UrlUtil.PG_CLASSES:case UrlUtil.PG_BESTIARY:case UrlUtil.PG_BACKGROUNDS:case UrlUtil.PG_FEATS:case UrlUtil.PG_OPT_FEATURES:case UrlUtil.PG_RACES:case UrlUtil.PG_OBJECTS:case UrlUtil.PG_TRAPS_HAZARDS:case UrlUtil.PG_DEITIES:case UrlUtil.PG_ITEMS:case UrlUtil.PG_REWARDS:case UrlUtil.PG_PSIONICS:case UrlUtil.PG_VARIATNRULES:case UrlUtil.PG_CONDITIONS_DISEASES:case UrlUtil.PG_ADVENTURE:case UrlUtil.PG_ADVENTURES:case UrlUtil.PG_BOOK:case UrlUtil.PG_BOOKS:case UrlUtil.PG_MAKE_SHAPED:case UrlUtil.PG_TABLES:case UrlUtil.PG_SHIPS:(BrewUtil._pHandleBrew||handleBrew)(r);break;case UrlUtil.PG_MANAGE_BREW:case UrlUtil.PG_DEMO:case"NO_PAGE":break;default:throw new Error(`No homebrew add function defined for category ${t}`);}if(n&&(await n()),BrewUtil._filterBox&&BrewUtil._sourceFilter){const e=BrewUtil._filterBox.getValues();if(e.Source){const n=JSON.parse(JSON.stringify(e.Source));(n._totals.yes||n._totals.no)&&(t===UrlUtil.PG_CLASSES?n.Core=1:i.forEach(e=>n[e.json]=1),BrewUtil._filterBox.setFromValues({Source:n}))}BrewUtil._filterBox&&BrewUtil._filterBox.fireChangeEvent()}},makeBrewButton:e=>{$(`#${e}`).on("click",()=>BrewUtil.manageBrew())},_getBrewCategories(){return Object.keys(BrewUtil.homebrew).filter(e=>!e.startsWith("_"))},_buildSourceCache(){function e(){BrewUtil.homebrewMeta&&BrewUtil.homebrewMeta.sources&&BrewUtil.homebrewMeta.sources.forEach(e=>BrewUtil._sourceCache[e.json]={...e})}if(!BrewUtil._sourceCache)if(BrewUtil._sourceCache={},!BrewUtil.homebrewMeta){const t=StorageUtil.syncGet(HOMEBREW_META_STORAGE)||{};t.sources=t.sources||[],BrewUtil.homebrewMeta=t,e()}else e()},_resetSourceCache(){BrewUtil._sourceCache=null},removeJsonSource(e){BrewUtil._resetSourceCache();const t=BrewUtil.homebrewMeta.sources.findIndex(t=>t.json===e);~t&&BrewUtil.homebrewMeta.sources.splice(t,1),StorageUtil.syncSet(HOMEBREW_META_STORAGE,BrewUtil.homebrewMeta)},getJsonSources(){return BrewUtil._buildSourceCache(),BrewUtil.homebrewMeta&&BrewUtil.homebrewMeta.sources?BrewUtil.homebrewMeta.sources:[]},hasSourceJson(e){return BrewUtil._buildSourceCache(),!!BrewUtil._sourceCache[e]},sourceJsonToFull(e){return BrewUtil._buildSourceCache(),BrewUtil._sourceCache[e]?BrewUtil._sourceCache[e].full||e:e},sourceJsonToAbv(e){return BrewUtil._buildSourceCache(),BrewUtil._sourceCache[e]?BrewUtil._sourceCache[e].abbreviation||e:e},sourceJsonToSource(e){return BrewUtil._buildSourceCache(),BrewUtil._sourceCache[e]?BrewUtil._sourceCache[e]:null},sourceJsonToStyle(e){if(BrewUtil._buildSourceCache(),BrewUtil._sourceCache[e]&&BrewUtil._sourceCache[e].color){const t=BrewUtil._sourceCache[e].color.trim().replace(/[^0-9a-fA-F]+/g,"").slice(0,8);return t.length?`style="color: #${t};"`:""}return""},addSource(e){BrewUtil._resetSourceCache();const t=BrewUtil.homebrewMeta.sources.some(t=>t.json===e.json);if(t)throw new Error(`Source "${e.json}" already exists!`);(BrewUtil.homebrewMeta.sources=BrewUtil.homebrewMeta.sources||[]).push(e),StorageUtil.syncSet(HOMEBREW_META_STORAGE,BrewUtil.homebrewMeta)},updateSource(e){BrewUtil._resetSourceCache();const t=BrewUtil.homebrewMeta.sources.findIndex(t=>t.json===e.json);if(!~t)throw new Error(`Source "${e.json}" does not exist!`);const n=BrewUtil.homebrewMeta.sources[t].json;BrewUtil.homebrewMeta.sources[t]={...e,json:n},StorageUtil.syncSet(HOMEBREW_META_STORAGE,BrewUtil.homebrewMeta)},_getActiveVetoolsSources(){if(null===BrewUtil.homebrew)throw new Error(`Homebrew was not initialized!`);const e=new Set;return Object.keys(BrewUtil.homebrew).forEach(t=>BrewUtil.homebrew[t].forEach(t=>t.source&&e.add(t.source))),Object.keys(Parser.SOURCE_JSON_TO_FULL).map(e=>({json:e,full:Parser.SOURCE_JSON_TO_FULL[e],abbreviation:Parser.SOURCE_JSON_TO_ABV[e]})).sort((e,t)=>SortUtil.ascSort(e.full,t.full)).filter(t=>e.has(t.json))},async pGetSearchIndex(){BrewUtil._buildSourceCache();const e=new Omnidexer(Omnisearch.highestId+1);if(await BrewUtil.pAddBrewData(),BrewUtil.homebrew){const t=[Omnidexer.TO_INDEX__FROM_INDEX_JSON,Omnidexer.TO_INDEX];t.forEach(t=>{t.filter(e=>(BrewUtil.homebrew[e.listProp]||[]).length).forEach(t=>e.addToIndex(t,BrewUtil.homebrew))})}return Omnidexer.decompressIndex(e.getIndex())},async pGetAdditionalSearchIndices(e,t){BrewUtil._buildSourceCache();const n=new Omnidexer(e+1);if(await BrewUtil.pAddBrewData(),BrewUtil.homebrew){const e=[Omnidexer.TO_INDEX__FROM_INDEX_JSON,Omnidexer.TO_INDEX];await Promise.all(e.map(e=>Promise.all(e.filter(e=>e.additionalIndexes&&(BrewUtil.homebrew[e.listProp]||[]).length).map(e=>Promise.all(Object.entries(e.additionalIndexes).filter(([e])=>e===t).map(async([t,o])=>{const a=await o(n,{[e.listProp]:BrewUtil.homebrew[e.listProp]});a.forEach(e=>n.pushToIndex(e))}))))))}return Omnidexer.decompressIndex(n.getIndex())},async pGetAlternateSearchIndices(e,t){BrewUtil._buildSourceCache();const n=new Omnidexer(e+1);if(await BrewUtil.pAddBrewData(),BrewUtil.homebrew){const e=[Omnidexer.TO_INDEX__FROM_INDEX_JSON,Omnidexer.TO_INDEX];e.forEach(e=>{e.filter(e=>e.alternateIndexes&&(BrewUtil.homebrew[e.listProp]||[]).length).forEach(e=>{Object.entries(e.alternateIndexes).filter(([e])=>e===t).map(async([t,o])=>{n.addToIndex(e,BrewUtil.homebrew,{alt:e.alternateIndexes[t]})})})})}return Omnidexer.decompressIndex(n.getIndex())}},CryptUtil={_md5cycle:(e,t)=>{let n=e[0],o=e[1],i=e[2],r=e[3];n=CryptUtil._ff(n,o,i,r,t[0],7,-680876936),r=CryptUtil._ff(r,n,o,i,t[1],12,-389564586),i=CryptUtil._ff(i,r,n,o,t[2],17,606105819),o=CryptUtil._ff(o,i,r,n,t[3],22,-1044525330),n=CryptUtil._ff(n,o,i,r,t[4],7,-176418897),r=CryptUtil._ff(r,n,o,i,t[5],12,1200080426),i=CryptUtil._ff(i,r,n,o,t[6],17,-1473231341),o=CryptUtil._ff(o,i,r,n,t[7],22,-45705983),n=CryptUtil._ff(n,o,i,r,t[8],7,1770035416),r=CryptUtil._ff(r,n,o,i,t[9],12,-1958414417),i=CryptUtil._ff(i,r,n,o,t[10],17,-42063),o=CryptUtil._ff(o,i,r,n,t[11],22,-1990404162),n=CryptUtil._ff(n,o,i,r,t[12],7,1804603682),r=CryptUtil._ff(r,n,o,i,t[13],12,-40341101),i=CryptUtil._ff(i,r,n,o,t[14],17,-1502002290),o=CryptUtil._ff(o,i,r,n,t[15],22,1236535329),n=CryptUtil._gg(n,o,i,r,t[1],5,-165796510),r=CryptUtil._gg(r,n,o,i,t[6],9,-1069501632),i=CryptUtil._gg(i,r,n,o,t[11],14,643717713),o=CryptUtil._gg(o,i,r,n,t[0],20,-373897302),n=CryptUtil._gg(n,o,i,r,t[5],5,-701558691),r=CryptUtil._gg(r,n,o,i,t[10],9,38016083),i=CryptUtil._gg(i,r,n,o,t[15],14,-660478335),o=CryptUtil._gg(o,i,r,n,t[4],20,-405537848),n=CryptUtil._gg(n,o,i,r,t[9],5,568446438),r=CryptUtil._gg(r,n,o,i,t[14],9,-1019803690),i=CryptUtil._gg(i,r,n,o,t[3],14,-187363961),o=CryptUtil._gg(o,i,r,n,t[8],20,1163531501),n=CryptUtil._gg(n,o,i,r,t[13],5,-1444681467),r=CryptUtil._gg(r,n,o,i,t[2],9,-51403784),i=CryptUtil._gg(i,r,n,o,t[7],14,1735328473),o=CryptUtil._gg(o,i,r,n,t[12],20,-1926607734),n=CryptUtil._hh(n,o,i,r,t[5],4,-378558),r=CryptUtil._hh(r,n,o,i,t[8],11,-2022574463),i=CryptUtil._hh(i,r,n,o,t[11],16,1839030562),o=CryptUtil._hh(o,i,r,n,t[14],23,-35309556),n=CryptUtil._hh(n,o,i,r,t[1],4,-1530992060),r=CryptUtil._hh(r,n,o,i,t[4],11,1272893353),i=CryptUtil._hh(i,r,n,o,t[7],16,-155497632),o=CryptUtil._hh(o,i,r,n,t[10],23,-1094730640),n=CryptUtil._hh(n,o,i,r,t[13],4,681279174),r=CryptUtil._hh(r,n,o,i,t[0],11,-358537222),i=CryptUtil._hh(i,r,n,o,t[3],16,-722521979),o=CryptUtil._hh(o,i,r,n,t[6],23,76029189),n=CryptUtil._hh(n,o,i,r,t[9],4,-640364487),r=CryptUtil._hh(r,n,o,i,t[12],11,-421815835),i=CryptUtil._hh(i,r,n,o,t[15],16,530742520),o=CryptUtil._hh(o,i,r,n,t[2],23,-995338651),n=CryptUtil._ii(n,o,i,r,t[0],6,-198630844),r=CryptUtil._ii(r,n,o,i,t[7],10,1126891415),i=CryptUtil._ii(i,r,n,o,t[14],15,-1416354905),o=CryptUtil._ii(o,i,r,n,t[5],21,-57434055),n=CryptUtil._ii(n,o,i,r,t[12],6,1700485571),r=CryptUtil._ii(r,n,o,i,t[3],10,-1894986606),i=CryptUtil._ii(i,r,n,o,t[10],15,-1051523),o=CryptUtil._ii(o,i,r,n,t[1],21,-2054922799),n=CryptUtil._ii(n,o,i,r,t[8],6,1873313359),r=CryptUtil._ii(r,n,o,i,t[15],10,-30611744),i=CryptUtil._ii(i,r,n,o,t[6],15,-1560198380),o=CryptUtil._ii(o,i,r,n,t[13],21,1309151649),n=CryptUtil._ii(n,o,i,r,t[4],6,-145523070),r=CryptUtil._ii(r,n,o,i,t[11],10,-1120210379),i=CryptUtil._ii(i,r,n,o,t[2],15,718787259),o=CryptUtil._ii(o,i,r,n,t[9],21,-343485551),e[0]=CryptUtil._add32(n,e[0]),e[1]=CryptUtil._add32(o,e[1]),e[2]=CryptUtil._add32(i,e[2]),e[3]=CryptUtil._add32(r,e[3])},_cmn:(e,n,o,a,i,r)=>(n=CryptUtil._add32(CryptUtil._add32(n,e),CryptUtil._add32(a,r)),CryptUtil._add32(n<<i|n>>>32-i,o)),_ff:(e,n,o,a,i,r,s)=>CryptUtil._cmn(n&o|~n&a,e,n,i,r,s),_gg:(e,n,o,a,i,r,s)=>CryptUtil._cmn(n&a|o&~a,e,n,i,r,s),_hh:(e,n,o,a,i,r,s)=>CryptUtil._cmn(n^o^a,e,n,i,r,s),_ii:(e,n,o,a,i,r,s)=>CryptUtil._cmn(o^(n|~a),e,n,i,r,s),_md51:e=>{let t,o=e.length,n=[1732584193,-271733879,-1732584194,271733878];for(t=64;t<=e.length;t+=64)CryptUtil._md5cycle(n,CryptUtil._md5blk(e.substring(t-64,t)));e=e.substring(t-64);let a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;t<e.length;t++)a[t>>2]|=e.charCodeAt(t)<<(t%4<<3);if(a[t>>2]|=128<<(t%4<<3),55<t)for(CryptUtil._md5cycle(n,a),t=0;16>t;t++)a[t]=0;return a[14]=8*o,CryptUtil._md5cycle(n,a),n},_md5blk:e=>{let t=[];for(let n=0;64>n;n+=4)t[n>>2]=e.charCodeAt(n)+(e.charCodeAt(n+1)<<8)+(e.charCodeAt(n+2)<<16)+(e.charCodeAt(n+3)<<24);return t},_hex_chr:["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],_rhex:e=>{let t="";for(let n=0;4>n;n++)t+=CryptUtil._hex_chr[15&e>>8*n+4]+CryptUtil._hex_chr[15&e>>8*n];return t},hex:e=>{for(let t=0;t<e.length;t++)e[t]=CryptUtil._rhex(e[t]);return e.join("")},hex2Dec(e){return parseInt(`0x${e}`)},md5:e=>CryptUtil.hex(CryptUtil._md51(e)),_add32:(e,t)=>4294967295&e+t,hashCode(e){if("string"==typeof e){if(!e)return 0;let t=0;for(let n=0;n<e.length;++n)t=31*t+e.charCodeAt(n);return t}if("number"==typeof e)return e;throw new Error(`No hashCode implementation for ${e}`)},uid(){var e=Math.floor;if(RollerUtil.isCrypto())return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16));else{let t=Date.now();return"undefined"!=typeof performance&&"function"==typeof performance.now&&(t+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){const o=0|(t+16*Math.random())%16;return t=e(t/16),("x"===n?o:8|3&o).toString(16)})}}},CollectionUtil={ObjectSet:class{constructor(){this.map=new Map,this[Symbol.iterator]=this.values}add(e){this.map.set(e._toIdString(),e)}values(){return this.map.values()}},setEq(e,t){if(e.size!==t.size)return!1;for(const n of e)if(!t.has(n))return!1;return!0},setDiff(e,t){return new Set([...e].filter(e=>!t.has(e)))},deepEquals(e,t){if(null===e&&null===t)return!0;if(null===e&&null!==t||null!==e&&null===t)return!1;if(isNaN(e)&&isNaN(t))return!0;if(isNaN(e)&&!isNaN(t)||!isNaN(e)&&isNaN(t))return!1;if(void 0===e&&void 0===t)return!0;if(void 0===e&&void 0!==t||void 0!==e&&void 0===t)return!1;const n=typeof e;if(n!==typeof t)return!1;switch(n){case"object":if(e instanceof Array)return!!(t instanceof Array)&&e.equals(t);else{if(t instanceof Array)return!0;const n=Object.keys(e),o=Object.keys(t);return!!CollectionUtil.setEq(new Set(n),new Set(o))&&n.every(n=>CollectionUtil.deepEquals(e[n],t[n]))}case"string":case"number":case"boolean":return e===t;}}},Array.prototype.last=Array.prototype.last||function(){return this[this.length-1]},Array.prototype.filterIndex=Array.prototype.filterIndex||function(e){const t=[];return this.forEach((n,o)=>{e(n)&&t.push(o)}),t},Array.prototype.equals=Array.prototype.equals||function(e){const t=this;if(!t&&!e)return!0;if(!t&&e||t&&!e)return!1;let n=[];if(!t[0]||!e[0])return!1;if(t.length!==e.length)return!1;let o;for(let a=0;a<t.length;a++)o=typeof t[a]+"~"+t[a],n[o]?n[o]++:n[o]=1;for(let t=0;t<e.length;t++)if(o=typeof e[t]+"~"+e[t],n[o]){if(0===n[o])return!1;n[o]--}else return!1;return!0},Array.prototype.partition=Array.prototype.partition||function(e){return this.reduce(([t,n],o)=>e(o)?[[...t,o],n]:[t,[...n,o]],[[],[]])},Array.prototype.getNext=Array.prototype.getNext||function(e){let t=this.indexOf(e);if(!~t)throw new Error("Value was not in array!");return++t>=this.length&&(t=0),this[t]};function BookModeView(e,t,n,o,a){this.hashKey=e,this.$openBtn=t,this.noneVisibleMsg=n,this.popTblGetNumShown=o,this.active=!1,this._$body=null,this._$wrpBook=null;const i=this;i.$openBtn.on("click",()=>{History.cleanSetHash(`${window.location.hash}${HASH_PART_SEP}${i.hashKey}${HASH_SUB_KV_SEP}true`)}),this.open=()=>{function e(){History.cleanSetHash(window.location.hash.replace(`${i.hashKey}${HASH_SUB_KV_SEP}true`,""))}if(i.active)return;i.active=!0;const t=$(`body`),n=$(`<div class="book-mode"/>`).click(t=>{n[0]!==t.target||e()});i._$body=t,i._$wrpBook=n,t.css("overflow","hidden"),t.addClass("book-mode-active");const o=$(`<table class="stats stats-book stats-book--large" style="font-size: 1.0em; font-family: inherit;"/>`),r=$(`<tr><th class="border close-border" style="width: 100%;"><div/></th></tr>`),s=$(`<span class="spacer-name"/>`),_=$(`<span class="delete-icon glyphicon glyphicon-remove"></span>`).on("click",()=>{e()});r.find(`div`).append(s).append(_),o.append(r);const d=$(`<table class="stats stats-book stats-book--large" style="width: auto; margin: 0 auto; font-family: inherit;"/>`),l=i.popTblGetNumShown(d,s),u=r=>{const s=$(`<tr/>`);s.append($(`<div class="wrp-content" style="${r||a?"":"display: none;"}"/>`).append(d));const _=$(`<tr class="noprint" ${r?`style="display: none;"`:""}><td class="text-center"><span class="initial-message">${i.noneVisibleMsg}</span><br></td></tr>`);_.find(`td`).append($(`<button class="btn btn-default">Close</button>`).on("click",()=>{e()})),o.append(s).append(_).append(Renderer.utils.getBorderTr()),n.append(o),t.append(n)};l instanceof Promise?l.then(e=>u(e)):u(l)},this.teardown=()=>{i.active&&(i._$body.css("overflow",""),i._$body.removeClass("book-mode-active"),i._$wrpBook.remove(),i.active=!1)},this.handleSub=e=>{const t=e.find(e=>e.startsWith(this.hashKey));t&&"true"===UrlUtil.unpackSubHash(t)[this.hashKey][0]?this.open():this.teardown()}}ExcludeUtil={_excludes:null,async pInitialise(){try{ExcludeUtil._excludes=(await StorageUtil.pGet(EXCLUDES_STORAGE))||[]}catch(t){JqueryUtil.doToast({content:"Error when loading content blacklist! Purged blacklist data. (See the log for more information.)",type:"danger"});try{await StorageUtil.pRemove(EXCLUDES_STORAGE)}catch(t){setTimeout(()=>{throw t})}ExcludeUtil._excludes=null,window.location.hash="",setTimeout(()=>{throw t})}},getList(){return ExcludeUtil._excludes||[]},async pSetList(e){ExcludeUtil._excludes=e,await ExcludeUtil._pSave()},_excludeCount:0,isExcluded(e,t,n){if(!ExcludeUtil._excludes||!ExcludeUtil._excludes.length)return!1;n=n.source||n;const o=!!ExcludeUtil._excludes.find(o=>("*"===o.source||o.source===n)&&("*"===o.category||o.category===t)&&("*"===o.name||o.name===e));return o&&++ExcludeUtil._excludeCount,o},checkShowAllExcluded(e,t){(!e.length&&ExcludeUtil._excludeCount||0<e.length&&e.length===ExcludeUtil._excludeCount)&&t.html(`
				<tr><th class="border" colspan="6"></th></tr>
				<tr><td colspan="6" class="initial-message">(Content <a href="blacklist.html">blacklisted</a>)</td></tr>
				<tr><th class="border" colspan="6"></th></tr>
			`)},async pAddExclude(e,t,n){return!ExcludeUtil._excludes.find(o=>o.source===n&&o.category===t&&o.name===e)&&(ExcludeUtil._excludes.push({name:e,category:t,source:n}),await ExcludeUtil._pSave(),!0)},async pRemoveExclude(e,t,n){const o=ExcludeUtil._excludes.findIndex(o=>o.source===n&&o.category===t&&o.name===e);~o&&(ExcludeUtil._excludes.splice(o,1),await ExcludeUtil._pSave())},async _pSave(){StorageUtil.pSet(EXCLUDES_STORAGE,ExcludeUtil._excludes)},async pResetExcludes(){ExcludeUtil._excludes=[],await ExcludeUtil._pSave()}},EncounterUtil={async pGetSavedState(){return(await EncounterUtil._pHasSavedStateLocal())?(await EncounterUtil._hasSavedStateUrl())?{type:"url",data:EncounterUtil._getSavedStateUrl()}:{type:"local",data:await EncounterUtil._pGetSavedStateLocal()}:null},_hasSavedStateUrl(){return window.location.hash.length&&null!=History.getSubHash(EncounterUtil.SUB_HASH_PREFIX)},_getSavedStateUrl(){let e=null;try{e=JSON.parse(decodeURIComponent(History.getSubHash(EncounterUtil.SUB_HASH_PREFIX)))}catch(t){setTimeout(()=>{throw t})}return History.setSubhash(EncounterUtil.SUB_HASH_PREFIX,null),e},async _pHasSavedStateLocal(){return!!StorageUtil.pGet(ENCOUNTER_STORAGE)},async _pGetSavedStateLocal(){try{return await StorageUtil.pGet(ENCOUNTER_STORAGE)}catch(t){JqueryUtil.doToast({content:"Error when loading encounters! Purged encounter data. (See the log for more information.)",type:"danger"}),await StorageUtil.pRemove(ENCOUNTER_STORAGE),setTimeout(()=>{throw t})}},async pDoSaveState(e){StorageUtil.pSet(ENCOUNTER_STORAGE,e)},async pGetAllSaves(){const e=await StorageUtil.pGet(EncounterUtil.SAVED_ENCOUNTER_SAVE_LOCATION);return e||{}}},EncounterUtil.SUB_HASH_PREFIX="encounter",EncounterUtil.SAVED_ENCOUNTER_SAVE_LOCATION="ENCOUNTER_SAVED_STORAGE";class Reactor{constructor(){this.rvents={}}_registerEvent(e){this.rvents[e]=new ReactorEvent(e)}fire(e,t){this.rvents[e]&&this.rvents[e].callbacks.forEach(e=>e(t))}on(e,t){this.rvents[e]||this._registerEvent(e),this.rvents[e]._registerCallback(t)}off(e,t){this.rvents[e]&&this.rvents[e]._unregisterCallback(t)}}class ReactorEvent{constructor(e){this.name=e,this.callbacks=[]}_registerCallback(e){this.callbacks.push(e)}_unregisterCallback(e){const t=this.callbacks.indexOf(e);this.callbacks.splice(t,1)}}ProxyUtil={decorate(e){e.__hooks||(e.__hooks={},e.__hooksAll={},e._getProxy=function(e,t){return new Proxy(e,{set:(e,n,o)=>(e[n]=o,this.__hooksAll[t]&&this.__hooksAll[t].forEach(e=>e(n,o)),this.__hooks[t]&&this.__hooks[t][n]&&this.__hooks[t][n].forEach(e=>e(n,o)),!0),deleteProperty:(e,n)=>(delete e[n],this.__hooksAll[t]&&this.__hooksAll[t].forEach(e=>e(n,null)),this.__hooks[t]&&this.__hooks[t][n]&&this.__hooks[t][n].forEach(e=>e(n,null)),!0)})},e._addHook=function(e,t,n){((this.__hooks[e]=this.__hooks[e]||{})[t]=this.__hooks[e][t]||[]).push(n)},e._addHookAll=function(e,t){(this.__hooksAll[e]=this.__hooksAll[e]||[]).push(t)},e._removeHook=function(e,t,n){if(this.__hooks[e]&&this.__hooks[e][t]){const o=this.__hooks[e][t].findIndex(e=>e===n);~o&&this.__hooks[e][t].splice(o,1)}},e._resetHooks=function(e){delete this.__hooks[e]})}},IS_ROLL20||"undefined"==typeof window||setTimeout(()=>{const e=$(`.cancer__wrp-leaderboard`),t=e.outerWidth(),n=e.outerHeight();e.css({width:t,height:n})},5e3),_Donate={cycleLeader(e){_Donate._cycleMode(e,[{width:970,height:90},{width:970,height:250},{width:320,height:50},{width:728,height:90}])},cycleSide(e){_Donate._cycleMode(e,[{width:300,height:250},{width:300,height:600}])},_cycleMode(e,t){const n=$(e),o=n.data("pos")||0,a=t[o];n.css(a),n.text(`${a.width}*${a.height}`),n.data("pos",(o+1)%t.length)}};;
class UiUtil{static getSearchNoResults(){return`<div class="ui-search__message"><i>No results.</i></div>`}static getSearchLoading(){return`<div class="ui-search__message"><i>\u2022\u2022\u2022</i></div>`}static getSearchEnter(){return`<div class="ui-search__message"><i>Enter a search.</i></div>`}static bindAutoSearch(a,b){UiUtil.bindTypingEnd(a,()=>{b.search()},a=>{13===a.which&&(b.flags.doClickFirst=!0,b.search())},()=>{b.flags.isWait&&(b.flags.isWait=!1,b.showWait())},()=>{a.val()&&a.val().trim().length&&b.search()})}static bindTypingEnd(a,b,c,d,e){let f;a.on("keyup",a=>{clearTimeout(f),f=setTimeout(()=>{b(a)},UiUtil.TYPE_TIMEOUT_MS)}),a.on("keypress",a=>{c&&c(a)}),a.on("keydown",a=>{d&&d(a),clearTimeout(f)}),a.on("click",()=>{e&&e()})}static getShow$Modal(a,b){a=a||{};const c="string"==typeof a?{}:a;"string"==typeof a?(c.title=a,c.cbClose=b):b&&(c.cbClose=b);const d=async(a,...b)=>{c.cbClose&&(await c.cbClose(a,...b)),e.remove()},e=$(`<div class="ui-modal__overlay">`),f=$(`<div class="ui-modal__scroller"/>`).data("close",(...a)=>d(...a)),g=$$`<div class="ui-modal__inner ui-modal__inner--modal dropdown-menu${c.fullWidth?` ui-modal__inner--large`:""}${c.fullHeight?" full-height":""}">${c.title?`<h4>${c.title}</h4>`:""}${f}</div>`.appendTo(e).click(a=>a.stopPropagation());return c.noMinHeight&&g.css("height","initial"),e.click(()=>d(!1)),$(`body`).append(e),f}static addModalSep(a){a.append(`<hr class="ui-modal__row-sep">`)}static $getAddModalRow(a,b="div"){return $(`<${b} class="ui-modal__row"/>`).appendTo(a)}static $getAddModalRowHeader(a,b,c){c=c||{};const d=UiUtil.$getAddModalRow(a,"h5").addClass("bold");return c.$eleRhs?$$`<div class="split flex-v-center full-width pr-1"><span>${b}</span>${c.$eleRhs}</div>`.appendTo(d):d.text(b),c.helpText&&d.attr("title",c.helpText),d}static $getAddModalRowCb(a,b,c,d,e){const f=UiUtil.$getAddModalRow(a,"label").addClass(`ui-modal__row--cb`);e&&f.attr("title",e),f.append(`<span>${b}</span>`);const g=$(`<input type="checkbox">`).appendTo(f).prop("checked",c[d]).on("change",()=>c[d]=g.prop("checked"));return g}static $getAddModalRowSel(a,b,c,d,e,f){f=f||{};const g=UiUtil.$getAddModalRow(a,"label").addClass(`ui-modal__row--sel`);f.helpText&&g.attr("title",f.helpText),g.append(`<span>${b}</span>`);const h=$(`<select class="form-control input-xs width-30">`).appendTo(g);e.forEach((a,b)=>$(`<option value="${b}"/>`).text(f.fnDisplay?f.fnDisplay(a):a).appendTo(h));const i=e.indexOf(c[d]);return h.val(`${~i?i:0}`).change(()=>c[d]=e[h.val()]),h}}UiUtil.SEARCH_RESULTS_CAP=75,UiUtil.TYPE_TIMEOUT_MS=100;class ProfUiUtil{static getProfCycler(a=0){const b=Object.keys(ProfUiUtil.PROF_TO_FULL).length;a=+a||0,a>=b?a=b-1:0>a&&(a=0);const c=$(`<button class="ui-prof__btn-cycle"/>`).click(()=>{c.attr("data-state",++a>=b?a=0:a).attr("title",ProfUiUtil.PROF_TO_FULL[a].name).trigger("change")}).contextmenu(d=>{d.ctrlKey||(d.preventDefault(),c.attr("data-state",0>--a?a=b-1:a).attr("title",ProfUiUtil.PROF_TO_FULL[a].name).trigger("change"))}),d=d=>{a=d,a>b?a=0:0>a&&(a=b-1),c.attr("data-state",a)};return{$ele:c,setState:d,getState:()=>a}}}ProfUiUtil.PROF_TO_FULL={0:{name:"No proficiency",mult:0},1:{name:"Proficiency",mult:1},2:{name:"Expertise",mult:2},3:{name:"Half proficiency",mult:.5}};class TabUiUtil{static decorate(a){a.__tabMetas={},a._getTab=function(b,c,d){d.tabGroup=d.tabGroup||"_default";const e=`activeTab__${d.tabGroup}`;a.__tabMetas[d.tabGroup]||(a.__tabMetas[d.tabGroup]=[]);const f=a.__tabMetas[d.tabGroup];d.stateObj[e]=d.stateObj[e]||0;const g=d.stateObj[e]===b,h=$(`<button class="btn btn-default stat-tab ${g?"stat-tab-sel":""}">${c}</button>`).click(()=>{const a=f[d.stateObj[e]];a.$btnTab.removeClass("stat-tab-sel"),a.$wrpTab.hide(),d.stateObj[e]=b,h.addClass("stat-tab-sel"),i.show(),d.cbTabChange&&d.cbTabChange()}),i=$(`<div class="ui-tab__wrp-tab-body ${d.hasBorder?"ui-tab__wrp-tab-body--border":""}" ${g?`style="display: block;"`:""}/>`),j={ix:b,$btnTab:h,$wrpTab:i};return f[b]=j,j},a._resetTabs=function(b){b=b||"_default",a.__tabMetas[b]=[]}}}class SearchUiUtil{static async pDoGlobalInit(){elasticlunr.clearStopWords(),await Renderer.item.populatePropertyAndTypeReference()}static _isNoHoverCat(a){return SearchUiUtil.NO_HOVER_CATEGORIES.has(a)}static async pGetContentIndices(a){var b=Math.max;a=a||{};const c={},d=Omnidexer.decompressIndex((await DataUtil.loadJSON("search/index.json"))),e={};a.additionalIndices&&(await Promise.all(a.additionalIndices.map(async a=>{e[a]=Omnidexer.decompressIndex((await DataUtil.loadJSON(`search/index-${a}.json`)));const b=e[a].last().id,c=await BrewUtil.pGetAdditionalSearchIndices(b,a);c.length&&(e[a]=e[a].concat(c))})));const f={};a.alternateIndices&&(await Promise.all(a.alternateIndices.map(async a=>{f[a]=Omnidexer.decompressIndex((await DataUtil.loadJSON(`search/index-alt-${a}.json`)));const b=f[a].last().id,c=await BrewUtil.pGetAlternateSearchIndices(b,a);c.length&&(f[a]=f[a].concat(c))})));const g=a=>a.d;c.ALL=elasticlunr(function(){this.addField("n"),this.addField("s"),this.setRef("id")}),SearchUtil.removeStemmer(c.ALL);let h=0;const i=(a,d)=>{SearchUiUtil._isNoHoverCat(a.c)||g(a)||(a.cf=a.c===Parser.CAT_ID_CREATURE?"Creature":Parser.pageCategoryToFull(a.c),d&&(a.cf=`alt_${a.cf}`),!c[a.cf]&&(c[a.cf]=elasticlunr(function(){this.addField("n"),this.addField("s"),this.setRef("id")}),SearchUtil.removeStemmer(c[a.cf])),!d&&c.ALL.addDoc(a),c[a.cf].addDoc(a),h=b(h,a.id))};d.forEach(a=>i(a)),Object.values(e).forEach(a=>a.forEach(a=>i(a))),Object.values(f).forEach(a=>a.forEach(a=>i(a,!0))),Omnisearch.highestId=b(h,Omnisearch.highestId);const j=await BrewUtil.pGetSearchIndex();return j.forEach(a=>{SearchUiUtil._isNoHoverCat(a.c)||g(a)||(a.cf=Parser.pageCategoryToFull(a.c),a.cf=a.c===Parser.CAT_ID_CREATURE?"Creature":Parser.pageCategoryToFull(a.c),c.ALL.addDoc(a),c[a.cf].addDoc(a))}),c}}SearchUiUtil.NO_HOVER_CATEGORIES=new Set([Parser.CAT_ID_ADVENTURE,Parser.CAT_ID_CLASS,Parser.CAT_ID_QUICKREF]);class SearchWidget{constructor(a,b,c){c=c||{},this._indexes=a,this._cat=c.defaultCategory||"ALL",this._cbSearch=b,this._resultFilter=c.resultFilter||null,this._searchOptions=c.searchOptions||null,this._fnTransform=c.fnTransform||null,this._flags={doClickFirst:!1,isWait:!1},this._$selCat=null,this._$iptSearch=null,this._$wrpResults=null,this._$rendered=null}static async pDoGlobalInit(){SearchWidget.CONTENT_INDICES=await SearchUiUtil.pGetContentIndices({additionalIndices:["item"],alternateIndices:["spell"]})}__getSearchOptions(){return this._searchOptions||{fields:{n:{boost:5,expand:!0},s:{expand:!0}},bool:"AND",expand:!0}}static __get$Row(a){return $(`<div class="ui-search__row">
			<span>${a.doc.n}</span>
			<span>${a.doc.s?`<i title="${Parser.sourceJsonToFull(a.doc.s)}">${Parser.sourceJsonToAbv(a.doc.s)}${a.doc.p?` p${a.doc.p}`:""}</i>`:""}</span>
		</div>`)}static __getAllTitle(){return"All Categories"}static __getCatOptionText(a){return a}get $wrpSearch(){return this._$rendered||this._render(),this._$rendered}__showMsgInputRequired(){this._flags.isWait=!0,this._$wrpResults.empty().append(UiUtil.getSearchEnter())}__showMsgWait(){this._$wrpResults.empty().append(UiUtil.getSearchLoading())}__showMsgNoResults(){this._flags.isWait=!0,this._$wrpResults.empty().append(UiUtil.getSearchEnter())}__doSearch(){const a=this._$iptSearch.val().trim(),b=this._indexes[this._cat],c=b.search(a,this.__getSearchOptions()),{toProcess:d,resultCount:e}=(()=>{if(c.length){if(this._resultFilter){const a=c.filter(a=>this._resultFilter(a.doc));return{toProcess:a.slice(0,UiUtil.SEARCH_RESULTS_CAP),resultCount:a.length}}return{toProcess:c.slice(0,UiUtil.SEARCH_RESULTS_CAP),resultCount:c.length}}if(this._resultFilter){const a=Object.values(b.documentStore.docs).filter(a=>this._resultFilter(a)).map(a=>({doc:a}));return{toProcess:a.slice(0,UiUtil.SEARCH_RESULTS_CAP),resultCount:a.length}}return{toProcess:Object.values(b.documentStore.docs).slice(0,UiUtil.SEARCH_RESULTS_CAP).map(a=>({doc:a})),resultCount:Object.values(b.documentStore.docs).length}})();if(this._$wrpResults.empty(),d.length){const a=a=>{if(this._fnTransform)this._cbSearch(this._fnTransform(a.doc));else{const b=UrlUtil.categoryToPage(a.doc.c),c=a.doc.s,d=a.doc.u;this._cbSearch(b,c,d)}};if(this._flags.doClickFirst)return a(d[0]),void(this._flags.doClickFirst=!1);const b=d.slice(0,UiUtil.SEARCH_RESULTS_CAP);if(b.forEach(b=>SearchWidget.__get$Row(b).on("click",()=>a(b)).appendTo(this._$wrpResults)),e>UiUtil.SEARCH_RESULTS_CAP){const a=e-UiUtil.SEARCH_RESULTS_CAP;this._$wrpResults.append(`<div class="ui-search__row ui-search__row--readonly">...${a} more result${1==a?" was":"s were"} hidden. Refine your search!</div>`)}}else a.trim()?this.__showMsgNoResults():this.__showMsgInputRequired()}_render(){if(!this._$rendered){this._$rendered=$(`<div class="ui-search__wrp-output"/>`);const a=$(`<div class="ui-search__wrp-controls"/>`).appendTo(this._$rendered);this._$selCat=$(`<select class="form-control ui-search__sel-category">
				<option value="ALL">${SearchWidget.__getAllTitle()}</option>
				${Object.keys(this._indexes).sort().filter(a=>"ALL"!==a).map(a=>`<option value="${a}">${SearchWidget.__getCatOptionText(a)}</option>`).join("")}
			</select>`).appendTo(a).toggle(1!==Object.keys(this._indexes).length).on("change",()=>{this._cat=this._$selCat.val(),this.__doSearch()}),this._$iptSearch=$(`<input class="ui-search__ipt-search search form-control" autocomplete="off" placeholder="Search...">`).appendTo(a),this._$wrpResults=$(`<div class="ui-search__wrp-results"/>`).appendTo(this._$rendered),UiUtil.bindAutoSearch(this._$iptSearch,{flags:this._flags,search:this.__doSearch.bind(this),showWait:this.__showMsgWait.bind(this)}),this.__doSearch()}}doFocus(){this._$iptSearch.focus()}static addToIndexes(a,b){const c=Object.values(SearchWidget.CONTENT_INDICES.ALL.documentStore.docs).length,d=new Omnidexer(c),e={[a]:[b]};Omnidexer.TO_INDEX__FROM_INDEX_JSON.filter(b=>b.listProp===a).forEach(a=>d.addToIndex(a,e)),Omnidexer.TO_INDEX.filter(b=>b.listProp===a).forEach(a=>d.addToIndex(a,e));const f=Omnidexer.decompressIndex(d.getIndex());f.forEach(a=>{a.cf=a.c===Parser.CAT_ID_CREATURE?"Creature":Parser.pageCategoryToFull(a.c),SearchWidget.CONTENT_INDICES.ALL.addDoc(a),SearchWidget.CONTENT_INDICES[a.cf].addDoc(a)})}}SearchWidget.CONTENT_INDICES={};class InputUiUtil{static pGetUserNumber(a){var b=Math.max;return a=a||{},new Promise(c=>{const d=$(`<input class="form-control mb-2 text-right" type="number" ${a.min?`min="${a.min}"`:""} ${a.max?`max="${a.max}"`:""} ${null==a.default?"":`value="${a.default}"`}>`).keydown(a=>{13===a.which&&f.data("close")(!0),a.stopPropagation()}),e=$(`<button class="btn btn-default">Enter</button>`).click(()=>f.data("close")(!0)),f=UiUtil.getShow$Modal({title:a.title||"Enter a Number",noMinHeight:!0,cbClose:e=>{var f=Math.round,g=Math.min;e||c(null);const h=d.val();if(!h.trim())return null;let i=+h||0;a.min&&(i=b(a.min,i)),a.max&&(i=g(a.max,i)),a.int?c(f(i)):c(i)}});d.appendTo(f),$$`<div class="flex-vh-center">${e}</div>`.appendTo(f),d.focus(),d.select()})}static pGetUserEnum(a){return a=a||{},new Promise(b=>{const c=$(`<select class="form-control mb-2"><option value="-1" disabled>${a.placeholder||"Select..."}</option></select>`);a.values.forEach((a,b)=>$(`<option value="${b}"/>`).text(a).appendTo(c)),null==a.default?c[0].selectedIndex=0:c.val(a.default);const d=$(`<button class="btn btn-default">Confirm</button>`).click(()=>e.data("close")(!0)),e=UiUtil.getShow$Modal({title:a.title||"Select an Option",noMinHeight:!0,cbClose:a=>{a||b(null);const d=+c.val();b(~d?d:null)}});c.appendTo(e),$$`<div class="flex-vh-center">${d}</div>`.appendTo(e),c.focus()})}static pGetUserString(a){return a=a||{},new Promise(b=>{const c=$(`<input class="form-control mb-2" ${null==a.default?"":`value="${a.default}"`}>`).keydown(async b=>{a.autocomplete&&(await MiscUtil.pDelay(17),e.find(`.typeahead.dropdown-menu`).is(":visible"))||(13===b.which&&e.data("close")(!0),b.stopPropagation())});a.autocomplete&&a.autocomplete.length&&c.typeahead({source:a.autocomplete});const d=$(`<button class="btn btn-default">Enter</button>`).click(()=>e.data("close")(!0)),e=UiUtil.getShow$Modal({title:a.title||"Enter Text",noMinHeight:!0,cbClose:a=>{a||b(null);const d=c.val();return d.trim()?void b(d):null}});c.appendTo(e),$$`<div class="flex-vh-center">${d}</div>`.appendTo(e),c.focus(),c.select()})}}class SourceUiUtil{static _getValidOptions(a){if(!a)throw new Error(`No options were specified!`);if(!a.$parent||!a.cbConfirm||!a.cbConfirmExisting||!a.cbCancel)throw new Error(`Missing options!`);return a.mode=a.mode||"add",a}static render(a){a=SourceUiUtil._getValidOptions(a),a.$parent.empty();const b="edit"!==a.mode,c="add"===a.mode;let d=!1;const e=$(`<input class="form-control ui-source__ipt-named">`).change(()=>{!d&&b&&g.val(e.val().replace(/[^-_a-zA-Z]/g,"")),e.removeClass("error-background")});a.source&&e.val(a.source.full);const f=$(`<input class="form-control ui-source__ipt-named">`).change(()=>{f.removeClass("error-background")});a.source&&f.val(a.source.abbreviation);const g=$(`<input class="form-control ui-source__ipt-named" ${b?"":"disabled"}>`).change(()=>{d=!0,g.removeClass("error-background")});a.source&&g.val(a.source.json);const h=$(`<input class="form-control ui-source__ipt-named">`);a.source&&h.val(a.source.url);const i=$(`<input class="form-control ui-source__ipt-named">`);a.source&&i.val((a.source.authors||[]).join(", "));const j=$(`<input class="form-control ui-source__ipt-named">`);a.source&&j.val((a.source.convertedBy||[]).join(", "));const k=$(`<button class="btn btn-default">Confirm</button>`).click(()=>{let c=!1;if([e,f,g].forEach(a=>{const b=a.val();b&&b.trim()||!(c=!0)||a.addClass("error-background")}),!c){const c=g.val().trim();if(b&&BrewUtil.hasSourceJson(c))return g.addClass("error-background"),void JqueryUtil.doToast({content:`The JSON identifier "${c}" already exists!`,type:"danger"});const d={json:c,abbreviation:f.val().trim(),full:e.val().trim(),url:h.val().trim(),authors:i.val().trim().split(",").map(a=>a.trim()).filter(Boolean),convertedBy:j.val().trim().split(",").map(a=>a.trim()).filter(Boolean)};a.cbConfirm(d)}}),l=a.isRequired||!c&&b?null:$(`<button class="btn btn-default mr-2">Cancel</button>`).click(()=>{a.cbCancel()}),m=$(`<button class="btn btn-default">Use an Existing Source</button>`).click(()=>{n.hide(),q.show(),[e,f,g].forEach(a=>a.removeClass("error-background"))}),n=$$`<div class="full-height full-width flex-vh-center"><div>
			<h3 class="text-center">${b?"Add a Homebrew Source":"Edit Homebrew Source"}</h3>
			<div class="row ui-source__row mb-2"><div class="col-12 flex-v-center">
				<span class="mr-2 ui-source__name help" title="The name or title for the homebrew you wish to create. This could be the name of a book or PDF; for example, 'Monster Manual'">Title</span>
				${e}
			</div></div>
			<div class="row ui-source__row mb-2"><div class="col-12 flex-v-center">
				<span class="mr-2 ui-source__name help" title="An abbreviated form of the title. This will be shown in lists on the site, and in the top-right corner of statblocks or data entries; for example, 'MM'">Abbreviation</span>
				${f}
			</div></div>
			<div class="row ui-source__row mb-2"><div class="col-12 flex-v-center">
				<span class="mr-2 ui-source__name help" title="This will be used to identify your homebrew universally, so should be unique to you and you alone">JSON Identifier</span>
				${g}
			</div></div>
			<div class="row ui-source__row mb-2"><div class="col-12 flex-v-center">
				<span class="mr-2 ui-source__name help" title="A link to the original homebrew, e.g. a GM Binder page">Source URL</span>
				${h}
			</div></div>
			<div class="row ui-source__row mb-2"><div class="col-12 flex-v-center">
				<span class="mr-2 ui-source__name help" title="A comma-separated list of authors, e.g. 'John Doe, Joe Bloggs'">Author(s)</span>
				${i}
			</div></div>
			<div class="row ui-source__row mb-2"><div class="col-12 flex-v-center">
				<span class="mr-2 ui-source__name help" title="A comma-separated list of people who converted the homebrew to 5etools' format, e.g. 'John Doe, Joe Bloggs'">Converted By</span>
				${j}
			</div></div>
			<div class="text-center mb-2">${l}${k}</div>
			
			${b&&!c&&BrewUtil.homebrewMeta.sources&&BrewUtil.homebrewMeta.sources.length?$$`<div class="flex-vh-center mb-3 mt-3"><span class="ui-source__divider"/>or<span class="ui-source__divider"/></div>
			<div class="flex-vh-center">${m}</div>`:""}
		</div></div>`.appendTo(a.$parent),o=$$`<select class="form-control input-sm">
			<option disabled>Select</option>
			${(BrewUtil.homebrewMeta.sources||[]).sort((c,a)=>SortUtil.ascSortLower(c.full,a.full)).map(a=>`<option value="${a.json.escapeQuotes()}">${a.full.escapeQuotes()}</option>`)}
		</select>`.change(()=>o.removeClass("error-background"));o[0].selectedIndex=0;const p=$(`<button class="btn btn-default btn-sm">Confirm</button>`).click(()=>{if(0!==o[0].selectedIndex){const b=o.val(),c=BrewUtil.sourceJsonToSource(b);a.cbConfirmExisting(c),o[0].selectedIndex=0,q.hide(),n.show()}else o.addClass("error-background")}),q=$$`<div class="full-height full-width flex-vh-center" style="display: none;"><div>
			<h3 class="text-center">Select a Homebrew Source</h3>
			<div class="row mb-2"><div class="col-12 flex-vh-center">${o}</div></div>
			<div class="row"><div class="col-12 flex-vh-center">${p}</div></div>
		</div></div>`.appendTo(a.$parent)}};
"use strict";"undefined"!=typeof require&&(require("../js/utils.js"),require("../js/render.js"));class Omnidexer{constructor(a=0){this._index=[],this.id=a,this._metaMap={},this._metaIndices={}}getIndex(){return{x:this._index,m:this._metaMap}}static decompressIndex(a){const{x:b,m:c}=a,d=new Set,e={};return Object.keys(c).forEach(a=>{d.add(a),Object.entries(c[a]).forEach(([b,c])=>(e[a]=e[a]||{})[c]=b)}),b.forEach(a=>Object.keys(a).filter(a=>d.has(a)).forEach(b=>a[b]=e[b][a[b]]||a[b])),b}static getProperty(a,b){return b.split(".").reduce((a,b)=>a[b],a)}addToIndex(a,b,c){c=c||{};const d=this._index;let e=this.id;const f=(b,d,f)=>{const g=Omnidexer.getProperty(b,a.source||"source"),h=a.hashBuilder?a.hashBuilder(b,f):UrlUtil.URL_TO_HASH_BUILDER[a.baseUrl](b),i={c:a.category,s:this.getMetaId("s",g),id:e++,u:h,p:Omnidexer.getProperty(b,a.page||"page")};return a.hover&&(i.h=1),c.alt&&c.alt.additionalProperties&&Object.entries(c.alt.additionalProperties).forEach(([a,c])=>i[a]=c(b)),Object.assign(i,d),i},g=(b,e,g)=>{if(!b.noDisplay){const h=f(b,{n:g},e);if(!c.isNoFilter&&(a.include||a.filter&&a.filter(b))&&(a.filter||a.include&&!a.include(b))||a.onlyDeep||d.push(h),a.deepIndex){const c=a.deepIndex(this,{it:b,i:e,parentName:g},b);c.forEach(c=>{const e=f(b,c);a.filter&&a.filter(b)||d.push(e)})}}};Omnidexer.getProperty(b,a.listProp).forEach((b,c)=>{const d=Omnidexer.getProperty(b,a.primary||"name");g(b,c,d),b.alias&&b.alias.forEach(d=>g(b,c,d))}),this.id=e}pushToIndex(a){a.id=this.id++,this._index.push(a)}static arrIncludesOrEquals(a,b){return a instanceof Array?a.includes(b):a===b}getMetaId(a,b){if(this._metaMap[a]=this._metaMap[a]||{},null!=this._metaMap[a][b])return this._metaMap[a][b];else{this._metaIndices[a]=this._metaIndices[a]||0,this._metaMap[a][b]=this._metaIndices[a];const c=this._metaIndices[a];return this._metaIndices[a]++,c}}}Omnidexer.TO_INDEX__FROM_INDEX_JSON=[{category:Parser.CAT_ID_CREATURE,dir:"bestiary",primary:"name",source:"source",listProp:"monster",baseUrl:"bestiary.html",hover:!0},{category:Parser.CAT_ID_SPELL,dir:"spells",primary:"name",source:"source",listProp:"spell",baseUrl:"spells.html",hover:!0,alternateIndexes:{spell:{additionalProperties:{lvl:a=>a.level}}}},{category:Parser.CAT_ID_CLASS,dir:"class",primary:"name",source:"source",listProp:"class",baseUrl:"classes.html",deepIndex:(a,b,c)=>c.subclasses?c.subclasses.map(d=>({n:`${b.parentName}; ${d.name}`,s:a.getMetaId("s",d.source),u:`${UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_CLASSES](c)}${HASH_PART_SEP}${HASH_SUBCLASS}${UrlUtil.encodeForHash(d.name)}${HASH_SUB_LIST_SEP}${UrlUtil.encodeForHash(d.source)}`})):[]},{category:Parser.CAT_ID_CLASS_FEATURE,dir:"class",primary:"name",source:"source",listProp:"class",baseUrl:"classes.html",onlyDeep:!0,hover:!0,deepIndex:(a,b,c)=>{const d=[],e=UrlUtil.class.getIndexedEntries(c);return e.forEach(c=>{switch(c._type){case"classFeature":d.push({n:`${b.parentName} ${c.level}; ${c.name}`,s:c.source,u:c.hash});break;case"subclassFeature":case"subclassFeaturePart":d.push({n:`${c.subclassShortName} ${b.parentName} ${c.level}; ${c.name}`,s:a.getMetaId("s",c.source),u:c.hash});break;default:throw new Error(`Unhandled type "${c._type}"`);}}),d}}],Omnidexer.TO_INDEX=[{category:Parser.CAT_ID_BACKGROUND,file:"backgrounds.json",listProp:"background",baseUrl:"backgrounds.html",hover:!0},{category:Parser.CAT_ID_ITEM,file:"items-base.json",listProp:"baseitem",baseUrl:"items.html",hover:!0},{category:Parser.CAT_ID_CONDITION,file:"conditionsdiseases.json",listProp:"condition",baseUrl:"conditionsdiseases.html",hover:!0},{category:Parser.CAT_ID_FEAT,file:"feats.json",listProp:"feat",baseUrl:"feats.html",hover:!0},{category:Parser.CAT_ID_ELDRITCH_INVOCATION,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"EI")},{category:Parser.CAT_ID_METAMAGIC,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"MM")},{category:Parser.CAT_ID_MANEUVER_BATTLEMASTER,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"MV:B")},{category:Parser.CAT_ID_MANEUVER_CAVALIER,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"MV:C2-UA")},{category:Parser.CAT_ID_ARCANE_SHOT,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"AS:V1-UA")||Omnidexer.arrIncludesOrEquals(a.featureType,"AS:V2-UA")||Omnidexer.arrIncludesOrEquals(a.featureType,"AS")},{category:Parser.CAT_ID_OPTIONAL_FEATURE_OTHER,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"OTH")},{category:Parser.CAT_ID_FIGHTING_STYLE,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"FS:F")||Omnidexer.arrIncludesOrEquals(a.featureType,"FS:B")||Omnidexer.arrIncludesOrEquals(a.featureType,"FS:R")||Omnidexer.arrIncludesOrEquals(a.featureType,"FS:P")},{category:Parser.CAT_ID_PACT_BOON,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"PB")},{category:Parser.CAT_ID_ELEMENTAL_DISCIPLINE,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"ED")},{category:Parser.CAT_ID_ARTIFICER_INFUSION,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"AI")},{category:Parser.CAT_ID_SHIP_UPGRADE,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"SHP:H")||Omnidexer.arrIncludesOrEquals(a.featureType,"SHP:M")||Omnidexer.arrIncludesOrEquals(a.featureType,"SHP:W")||Omnidexer.arrIncludesOrEquals(a.featureType,"SHP:F")},{category:Parser.CAT_ID_ITEM,file:"items.json",listProp:"item",baseUrl:"items.html",hover:!0},{category:Parser.CAT_ID_ITEM,file:"items.json",listProp:"itemGroup",baseUrl:"items.html",hover:!0},{category:Parser.CAT_ID_PSIONIC,file:"psionics.json",listProp:"psionic",baseUrl:"psionics.html",deepIndex:(a,b,c)=>c.modes?c.modes.map(a=>({d:1,n:`${b.parentName}; ${a.name}`})):[],hover:!0},{category:Parser.CAT_ID_RACE,file:"races.json",listProp:"race",baseUrl:"races.html",onlyDeep:!0,deepIndex:(a,b,c)=>{const d=Renderer.race._mergeSubrace(c);return d.map(b=>({n:b.name,s:a.getMetaId("s",b.source),u:UrlUtil.URL_TO_HASH_BUILDER["races.html"](b)}))},hover:!0},{category:Parser.CAT_ID_OTHER_REWARD,file:"rewards.json",listProp:"reward",baseUrl:"rewards.html",hover:!0},{category:Parser.CAT_ID_VARIANT_OPTIONAL_RULE,file:"variantrules.json",listProp:"variantrule",baseUrl:"variantrules.html",deepIndex:(a,b,c)=>{const d=[];c.entries.forEach(a=>{Renderer.getNames(d,a,1)});const e=Renderer.getNumberedNames(c),f=Object.keys(e).filter(a=>d.includes(a));return f.map(a=>{const d=e[a];return{u:`${UrlUtil.encodeForHash([c.name,c.source])}${HASH_PART_SEP}${d}`,d:1,n:`${b.parentName}; ${a}`}})}},{category:Parser.CAT_ID_ADVENTURE,file:"adventures.json",source:"id",listProp:"adventure",baseUrl:"adventure.html"},{category:Parser.CAT_ID_ITEM,file:"magicvariants.json",source:"inherits.source",page:"inherits.page",listProp:"variant",baseUrl:"items.html",hashBuilder:a=>UrlUtil.encodeForHash([a.name,a.inherits.source]),deepIndex:(a,b,c)=>{const d=Renderer.item.modifierPostToPre(c);return d?[{d:1,u:UrlUtil.encodeForHash([d.name,c.inherits.source])}]:[]},additionalIndexes:{item:async(a,b)=>{const c=await(async()=>{if("undefined"!=typeof module)return Renderer.item.getAllIndexableItems(b,require(`../data/items-base.json`));else{const a=await DataUtil.loadJSON(`data/items-base.json`),c={...a,baseitem:[...a.baseitem]},d=await BrewUtil.pAddBrewData();return d.baseitem&&c.baseitem.push(...d.baseitem),Renderer.item.getAllIndexableItems(b,c)}})();return c.map(b=>{const c={c:Parser.CAT_ID_ITEM,u:UrlUtil.encodeForHash([b.name,b.source]),s:a.getMetaId("s",b.source),n:b.name,h:1,p:b.page};return b.genericVariant&&(c.zg={n:a.getMetaId("n",b.genericVariant.name),s:a.getMetaId("s",b.genericVariant.source)}),c})}},hover:!0},{category:Parser.CAT_ID_DEITY,file:"deities.json",postLoad:DataUtil.deity.doPostLoad,listProp:"deity",baseUrl:"deities.html",hover:!0,filter:a=>a.reprinted},{category:Parser.CAT_ID_OBJECT,file:"objects.json",listProp:"object",baseUrl:"objects.html",hover:!0},{category:Parser.CAT_ID_TRAP,file:"trapshazards.json",listProp:"trap",baseUrl:"trapshazards.html",hover:!0},{category:Parser.CAT_ID_HAZARD,file:"trapshazards.json",listProp:"hazard",baseUrl:"trapshazards.html",hover:!0},{category:Parser.CAT_ID_QUICKREF,file:"generated/bookref-quick.json",listProp:"data.bookref-quick",baseUrl:"quickreference.html",hashBuilder:(a,b)=>`bookref-quick,${b}`,onlyDeep:!0,deepIndex:(a,b,c)=>{function d(a,c){return{n:c||a,u:`bookref-quick${HASH_PART_SEP}${b.i}${HASH_PART_SEP}${UrlUtil.encodeForHash(a.toLowerCase())}`,s:void 0}}const e=c.entries.map(a=>({name:a.name,alias:a.alias}));return e.map(b=>{const a=d(b.name);return b.alias?[a,...b.alias.map(c=>d(b.name,c))]:[a]}).reduce((c,a)=>c.concat(a),[])}},{category:Parser.CAT_ID_CULT,file:"cultsboons.json",listProp:"cult",baseUrl:"cultsboons.html",hover:!0},{category:Parser.CAT_ID_BOON,file:"cultsboons.json",listProp:"boon",baseUrl:"cultsboons.html",hover:!0},{category:Parser.CAT_ID_DISEASE,file:"conditionsdiseases.json",listProp:"disease",baseUrl:"conditionsdiseases.html",hover:!0},{category:Parser.CAT_ID_TABLE,file:"generated/gendata-tables.json",listProp:"table",baseUrl:"tables.html",hover:!0},{category:Parser.CAT_ID_TABLE_GROUP,file:"generated/gendata-tables.json",listProp:"tableGroup",baseUrl:"tables.html",hover:!0},{category:Parser.CAT_ID_SHIP,file:"ships.json",listProp:"ship",baseUrl:"ships.html",hover:!0}],"undefined"!=typeof module&&(module.exports.Omnidexer=Omnidexer);;
"use strict";const Omnisearch={_PLACEHOLDER_TEXT:"Search everywhere...",_searchIndex:null,_pLoadSearch:null,_CATEGORY_COUNTS:{},highestId:-1,init:function(){async function a(){function f(){var h=Math.ceil,m=Math.max,p=Math.min;function g(a,b,c){return`onmouseover="Renderer.hover.mouseOver(event, this, '${UrlUtil.categoryToPage(a)}', '${c}', '${b.replace(/'/g,"\\'")}')" ${Renderer.hover._getPreventTouchString()}`}k.empty();const r=b(),s=$(`<button class="btn btn-default btn-xs btn-file ${r?"active":""}" title="Filter Unearthed Arcana and other unofficial source results" tabindex="-1">Include UA, etc</button>`).on("click",()=>{c(!r),a()}),t=d(),u=$(`<button class="btn btn-default btn-xs btn-file ${t?"active":""}" style="margin-left: 6px;" title="Filter blacklisted content results" tabindex="-1">Include Blacklisted</button>`).on("click",()=>{e(!t),a()});k.append($(`<div class="text-right"/>`).append([s,u]));const v=n*o;for(let a=v;a<m(p(q.length,o+v),v);++a){const b=q[a].doc,c=$(`<a href="${UrlUtil.categoryToPage(b.c)}#${b.u}" ${b.h?g(b.c,b.u,b.s):""}>${b.cf}: ${b.n}</a>`).keydown(a=>Omnisearch.handleLinkKeyDown(a,c,k));$$`<p>
						${c}
						${b.s?`<i title="${Parser.sourceJsonToFull(b.s)}">${Parser.sourceJsonToAbv(b.s)}${b.p?` p${b.p}`:""}</i>`:""}
					</p>`.appendTo(k)}if(j.css("display","flex"),q.length>o){const a=$(`<div class="omni__wrp-paginate">`);if(0<n){const b=$(`<span class="omni__paginate-left has-results-left omni__paginate-ctrl"><span class="glyphicon glyphicon-chevron-left"></span></span>`).on("click",()=>{n--,f()});a.append(b)}else a.append(`<span class="omni__paginate-left">`);if(a.append(`<span class="paginate-count">Page ${n+1}/${h(q.length/o)} (${q.length} results)</span>`),q.length-n*o>o){const b=$(`<span class="omni__paginate-right has-results-right omni__paginate-ctrl"><span class="glyphicon glyphicon-chevron-right"></span></span>`).on("click",()=>{n++,f()});a.append(b)}else a.append(`<span class="omni__paginate-right omni__paginate-ctrl">`);k.append(a)}l&&k.find(`a`).first()[0].click()}await Omnisearch.pInit();const h=g.val(),i=elasticlunr.tokenizer(h),m=i.map(a=>{const b=Object.keys(Omnisearch._CATEGORY_COUNTS).map(a=>a.toLowerCase()).find(b=>`in:${b}`===a.toLowerCase().trim()||`in:${b}s`===a.toLowerCase().trim());return{t:a,isCat:!!b,c:b}});let n=0;const p=m.filter(a=>a.isCat);let q;if(1===p.length){const a=m.filter(a=>!a.isCat).map(a=>a.t);q=Omnisearch._searchIndex.search(a.join(" "),{fields:{n:{boost:5,expand:!0},s:{expand:!0}},bool:"AND",expand:!0}).filter(a=>p[0].c&&a.doc.cf.toLowerCase()===p[0].c.toLowerCase())}else q=Omnisearch._searchIndex.search(h,{fields:{n:{boost:5,expand:!0},s:{expand:!0}},bool:"AND",expand:!0});b()||(q=q.filter(a=>a.doc.s&&!SourceUtil._isNonstandardSourceWiz(a.doc.s))),!d()&&ExcludeUtil.getList().length&&(q=q.filter(a=>{if(a.doc.c===Parser.CAT_ID_QUICKREF)return!0;const b=Parser.pageCategoryToProp(a.doc.c),c="variantrule"===b?a.doc.n.split(";")[0]:a.doc.n;return!ExcludeUtil.isExcluded(c,b,a.doc.s)})),q.length?f():(k.empty(),j.hide())}function b(){return t||(t=StorageUtil.syncGet(p)),t!==s}function c(a){t=a?r:s,StorageUtil.syncSet(p,t)}function d(){return u||(u=StorageUtil.syncGet(q)),u===r}function e(a){u=a?r:s,StorageUtil.syncSet(q,u)}if(IS_ROLL20)return;const f=$(`#navbar`),g=$(`<input class="form-control search omni__input" placeholder="${Omnisearch._PLACEHOLDER_TEXT}" title="Disclaimer: unlikely to search everywhere. Use with caution.">`).disableSpellcheck(),h=$(`<button class="btn btn-default omni__submit" tabindex="-1"><span class="glyphicon glyphicon-search"></span></button>`),i=$$`
			<div class="input-group omni__wrp-input">
				${g}
				<div class="input-group-btn">
					${h}
				</div>
			</div>
		`.appendTo(f),j=$(`<div class="omni__wrp-output"/>`).insertAfter(f),k=$(`<div class="omni__output"/>`).appendTo(j);let l=!1;const m=$(`body`);m.on("click",()=>j.hide()),k.on("click",a=>a.stopPropagation()),g.on("keydown",a=>{switch(a.which){case 13:l=!0,h.click();break;case 38:a.preventDefault();break;case 40:a.preventDefault(),k.find(`a`).first().focus();break;case 27:g.val(""),g.blur();}a.stopPropagation()});let n;g.on("keyup",a=>{l=!1;37<=a.which&&40>=a.which||(clearTimeout(n),n=setTimeout(()=>h.click(),100))}),g.on("keydown",()=>clearTimeout(n)),g.on("click",a=>{g.val()&&g.val().trim().length&&h.click(),a.stopPropagation()}),h.on("click",b=>{b.stopPropagation(),a()}),function(){const a=$(window);a.on("scroll",()=>{768>a.width()?(g.attr("placeholder",Omnisearch._PLACEHOLDER_TEXT),i.removeClass("omni__wrp-input--scrolled"),k.removeClass("omni__output--scrolled")):50<a.scrollTop()?(g.attr("placeholder",""),i.addClass("omni__wrp-input--scrolled"),k.addClass("omni__output--scrolled")):(g.attr("placeholder",Omnisearch._PLACEHOLDER_TEXT),i.removeClass("omni__wrp-input--scrolled"),k.removeClass("omni__output--scrolled"))})}();const o=15,p="search-ua-etc",q="search-blacklist",r="SHOW",s="HIDE";let t,u;m.on("keypress",a=>{if(noModifierKeys(a)&&!MiscUtil.isInInput(a)&&("f"===a.key||"F"===a.key)){const b="F"===a.key?g:$(`#${ID_SEARCH_BAR}`).find(`.search`);setTimeout(()=>b.select().focus(),0)}})},async pInit(){Omnisearch._searchIndex||(Omnisearch._pLoadSearch=Omnisearch._pDoSearchLoad(),await Omnisearch._pLoadSearch,Omnisearch._pLoadSearch=null)},_pDoSearchLoad:async function(){if(!Omnisearch._pLoadSearch){const a=Omnidexer.decompressIndex((await DataUtil.loadJSON("search/index.json")));elasticlunr.clearStopWords(),Omnisearch._searchIndex=elasticlunr(function(){this.addField("n"),this.addField("cf"),this.addField("s"),this.setRef("id")}),SearchUtil.removeStemmer(Omnisearch._searchIndex),a.forEach(Omnisearch._addToIndex),Omnisearch.highestId=a.last().id;const b=await BrewUtil.pGetSearchIndex();b.forEach(Omnisearch._addToIndex),b.length&&(Omnisearch.highestId=b.last().id)}},async pAddToIndex(a,...b){if(!b.length)return;await Omnisearch.pInit();const c=new Omnidexer(Omnisearch.highestId+1),d={[a]:b};Omnidexer.TO_INDEX__FROM_INDEX_JSON.filter(b=>b.listProp===a).forEach(a=>c.addToIndex(a,d)),Omnidexer.TO_INDEX.filter(b=>b.listProp===a).forEach(a=>c.addToIndex(a,d));const e=Omnidexer.decompressIndex(c.getIndex());e.forEach(Omnisearch._addToIndex),e.length&&(Omnisearch.highestId=e.last().id)},_addToIndex(a){a.cf=Parser.pageCategoryToFull(a.c),Omnisearch._CATEGORY_COUNTS[a.cf]?Omnisearch._CATEGORY_COUNTS[a.cf]++:Omnisearch._CATEGORY_COUNTS[a.cf]=1,Omnisearch._searchIndex.addDoc(a)},handleLinkKeyDown(a,b,c){switch(a.which){case 37:{if(a.preventDefault(),$(`.has-results-left`).length){const a=b.parent().index()-1;$(`.omni__paginate-left`).click();const d=c.find(`p`);$(d[a]||d[d.length-1]).find(`a`).focus()}break}case 38:{a.preventDefault(),b.parent().prev().find(`a`).length?b.parent().prev().find(`a`).focus():$(`.has-results-left`).length&&($(`.omni__paginate-left`).click(),c.find(`a`).last().focus());break}case 39:{if(a.preventDefault(),$(`.has-results-right`).length){const a=b.parent().index()-1;$(`.omni__paginate-right`).click();const d=c.find(`p`);$(d[a]||d[d.length-1]).find(`a`).focus()}break}case 40:{a.preventDefault(),b.parent().next().find(`a`).length?b.parent().next().find(`a`).focus():$(`.has-results-right`).length&&($(`.omni__paginate-right`).click(),c.find(`a`).first().focus());break}}},addScrollTopFloat(){const a=$(`<div class="bk__to-top"/>`).appendTo($("body")),b=$(`<button class="btn btn-sm btn-default" title="To Top"><span class="glyphicon glyphicon-arrow-up"/></button>`).appendTo(a).click(()=>MiscUtil.scrollPageTop());$(window).on("scroll",()=>{50<$(window).scrollTop()?a.addClass("bk__to-top--scrolled"):a.removeClass("bk__to-top--scrolled")})}};window.addEventListener("load",Omnisearch.init);;
function Renderer(){var e=Math.floor,n=Math.min,t=Math.max;this.wrapperTag="div",this.baseUrl="",this._lazyImages=!1,this._subVariant=!1,this._firstSection=!0,this._headerIndex=1,this._tagExportDict=null,this._roll20Ids=null,this._trackTitles={enabled:!1,titles:{}},this._enumerateTitlesRel={enabled:!1,titles:{}},this.setLazyImages=function(e){return this._lazyImages="undefined"!=typeof IntersectionObserver&&!!e,this},this.setWrapperTag=function(e){return this.wrapperTag=e,this},this.setBaseUrl=function(e){return this.baseUrl=e,this},this.setFirstSection=function(e){return this._firstSection=e,this},this.resetHeaderIndex=function(){return this._headerIndex=1,this._trackTitles.titles={},this._enumerateTitlesRel.titles={},this},this.doExportTags=function(e){return this._tagExportDict=e,this},this.resetExportTags=function(){return this._tagExportDict=null,this},this.setRoll20Ids=function(e){this._roll20Ids=e},this.resetRoll20Ids=function(){this._roll20Ids=null},this.setEnumerateTitlesRel=function(e){return this._enumerateTitlesRel.enabled=e,this},this._getEnumeratedTitleRel=function(e){if(this._enumerateTitlesRel.enabled&&e){const n=e.toLowerCase();return this._enumerateTitlesRel.titles[n]=this._enumerateTitlesRel.titles[n]||0,`data-title-relative-index="${this._enumerateTitlesRel.titles[n]++}"`}return""},this.setTrackTitles=function(e){return this._trackTitles.enabled=e,this},this.getTrackedTitles=function(){return MiscUtil.copy(this._trackTitles.titles)},this._handleTrackTitles=function(e){this._trackTitles.enabled&&(this._trackTitles.titles[this._headerIndex]=e)},this.recursiveRender=function(e,n,t){0===n.length?n[0]="":n.reverse(),t=t||{},t._typeStack=[],t.depth=null==t.depth?0:t.depth,this._recursiveRender(e,n,t),n.reverse()},this._recursiveRender=function(e,n,t,r){if(!t)throw new Error("Missing metadata!");if("section"===e.type&&(t.depth=-1),r=r||{},t._didRenderPrefix=!1,t._didRenderSuffix=!1,"object"==typeof e){const i=null==e.type||"section"===e.type?"entries":e.type;t._typeStack.push(i),"entries"===i?this._renderEntries(e,n,t,r):"options"===i?this._renderOptions(e,n,t,r):"list"===i?this._renderList(e,n,t,r):"table"===i?this._renderTable(e,n,t,r):"tableGroup"===i?this._renderTableGroup(e,n,t,r):"inset"===i?this._renderInset(e,n,t,r):"insetReadaloud"===i?this._renderInsetReadaloud(e,n,t,r):"variant"===i?this._renderVariant(e,n,t,r):"variantSub"===i?this._renderVariantSub(e,n,t,r):"spellcasting"===i?this._renderSpellcasting(e,n,t,r):"quote"===i?this._renderQuote(e,n,t,r):"optfeature"===i?this._renderOptfeature(e,n,t,r):"patron"===i?this._renderPatron(e,n,t,r):"abilityDc"===i?this._renderAbilityDc(e,n,t,r):"abilityAttackMod"===i?this._renderAbilityAttackMod(e,n,t,r):"abilityGeneric"===i?this._renderAbilityGeneric(e,n,t,r):"inline"===i?this._renderInline(e,n,t,r):"inlineBlock"===i?this._renderInlineBlock(e,n,t,r):"bonus"===i?this._renderBonus(e,n,t,r):"bonusSpeed"===i?this._renderBonusSpeed(e,n,t,r):"dice"===i?this._renderDice(e,n,t,r):"link"===i?this._renderLink(e,n,t,r):"actions"===i?this._renderActions(e,n,t,r):"attack"===i?this._renderAttack(e,n,t,r):"item"===i?this._renderItem(e,n,t,r):"itemSub"===i?this._renderItemSub(e,n,t,r):"itemSpell"===i?this._renderItemSpell(e,n,t,r):"dataCreature"===i?this._renderDataCreature(e,n,t,r):"dataSpell"===i?this._renderDataSpell(e,n,t,r):"image"===i?this._renderImage(e,n,t,r):"gallery"===i?this._renderGallery(e,n,t,r):"homebrew"===i?this._renderHomebrew(e,n,t,r):"code"===i?this._renderCode(e,n,t,r):"hr"===i?this._renderHr(e,n,t,r):void 0,t._typeStack.pop()}else"string"==typeof e?(this._renderPrefix(e,n,t,r),this._renderString(e,n,t,r),this._renderSuffix(e,n,t,r)):(this._renderPrefix(e,n,t,r),n[0]+=e,this._renderSuffix(e,n,t,r))},this._adjustDepth=function(e,r){const i=e.depth;return e.depth+=r,e.depth=n(t(-1,e.depth),2),i},this._renderPrefix=function(e,n,t,r){t._didRenderPrefix||null!=r.prefix&&(n[0]+=r.prefix,t._didRenderPrefix=!0)},this._renderSuffix=function(e,n,t,r){t._didRenderSuffix||null!=r.suffix&&(n[0]+=r.suffix,t._didRenderSuffix=!0)},this._renderImage=function(e,n,t,r){"map"===e.imageType&&(n[0]+=`<div class="rd__wrp-map">`),this._renderPrefix(e,n,t,r),n[0]+=`<div class="${t._typeStack.includes("gallery")?"rd__wrp-gallery-image":""}">`;let i;if("internal"===e.href.type){const n=`img/${e.href.path}`;i=""===this.baseUrl?UrlUtil.link(n):`${this.baseUrl}${n}`}else"external"===e.href.type&&(i=e.href.url);const d=this._lazyImages&&null!=e.width&&null!=e.height?`data:image/svg+xml,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="${e.width}" height="${e.height}"><rect width="100%" height="100%" fill="#ccc3"/></svg>`)}`:null;n[0]+=`<div class="rd__wrp-image"><a href="${i}" target="_blank" rel="noopener" ${e.title?`title="${e.title}"`:""}><img class="rd__image" src="${d||i}" ${e.altText?`alt="${e.altText}"`:""} ${d?`data-src="${i}"`:""} ${function(){return e.maxWidth?`style="max-width: ${e.maxWidth}px"`:""}()}></a></div>`,e.title?n[0]+=`<div class="rd__image-title"><div class="rd__image-title-inner">${e.title}</div></div>`:e._galleryTitlePad&&(n[0]+=`<div class="rd__image-title">&nbsp;</div>`),n[0]+=`</div>`,this._renderSuffix(e,n,t,r),"map"===e.imageType&&(n[0]+=`</div>`)},this._renderList_getListCssClasses=function(e){const n=[`rd__list`];return(e.style||e.columns)&&(e.style&&n.push(...e.style.split(" ").map(e=>`rd__${e}`)),e.columns&&n.push(`columns-${e.columns}`)),n.join(" ")},this._renderTableGroup=function(e,n,t){const r=e.tables.length;for(let d=0;d<r;++d)this._recursiveRender(e.tables[d],n,t)},this._renderTable=function(e,n,t){if(e.intro){const r=e.intro.length;for(let d=0;d<r;++d)this._recursiveRender(e.intro[d],n,t,{prefix:"<p>",suffix:"</p>"})}n[0]+=`<table class="${e.style||""} ${!1===e.isStriped?"":"striped-odd"}">`;const d=Renderer.isRollableTable(e);null!=e.caption&&(n[0]+=`<caption>${e.caption}</caption>`);const s=[];let o=[""];o[0]+="<tbody>";const l=e.rows.length;for(let i=0;i<l;++i){o[0]+="<tr>";const n=e.rows[i];let r="row"===n.type?n.row:n;const l=r.length;for(let i=0;i<l;++i){s[i]=s[i]||!1,d&&0==i&&(r=Renderer.getRollableRow(r),s[i]=!0);let l;"cell"===r[i].type?r[i].entry?l=r[i].entry:r[i].roll&&(r[i].roll.entry?l=r[i].roll.entry:null==r[i].roll.exact?r[i].roll.max===Renderer.dice.POS_INFINITE?l=r[i].roll.pad?`${StrUtil.padNumber(r[i].roll.min,2,"0")}+`:`${r[i].roll.min}+`:l=r[i].roll.pad?`${StrUtil.padNumber(r[i].roll.min,2,"0")}-${StrUtil.padNumber(r[i].roll.max,2,"0")}`:`${r[i].roll.min}-${r[i].roll.max}`:l=r[i].roll.pad?StrUtil.padNumber(r[i].roll.exact,2,"0"):r[i].roll.exact):l=r[i],o[0]+=`<td ${this._renderTable_makeTableTdClassText(e,i)} ${this._renderTable_getCellDataStr(r[i])} ${r[i].width?`colspan="${r[i].width}"`:""}>`,"row-indent-first"===n.style&&0==i&&(o[0]+=`<div class="rd__tab-indent"/>`);const u=this._adjustDepth(t,1);this._recursiveRender(l,o,t),t.depth=u,o[0]+="</td>"}o[0]+="</tr>"}if(o[0]+="</tbody>",n[0]+="<thead>",n[0]+="<tr>",e.colLabels){const r=e.colLabels.length;for(let o=0;o<r;++o){const r=e.colLabels[o];n[0]+=`<th ${this._renderTable_getTableThClassText(e,o)} data-isroller="${s[o]}">`,this._recursiveRender(d&&0==o&&!r.includes("@dice")?`{@dice ${r}}`:r,n,t),n[0]+=`</th>`}}if(n[0]+="</tr>",n[0]+="</thead>",n[0]+=o[0],null!=e.footnotes){n[0]+="<tfoot>";const r=e.footnotes.length;for(let d=0;d<r;++d){n[0]+=`<tr><td colspan="99">`;const r=this._adjustDepth(t,1);this._recursiveRender(e.footnotes[d],n,t),t.depth=r,n[0]+="</td></tr>"}n[0]+="</tfoot>"}if(n[0]+="</table>",e.outro){const r=e.outro.length;for(let d=0;d<r;++d)this._recursiveRender(e.outro[d],n,t,{prefix:"<p>",suffix:"</p>"})}},this._renderTable_getCellDataStr=function(e){function n(e){return 0===e?100:e}return e.roll?`data-roll-min="${n(null==e.roll.exact?e.roll.min:e.roll.exact)}" data-roll-max="${n(null==e.roll.exact?e.roll.max:e.roll.exact)}"`:""},this._renderTable_getTableThClassText=function(e,n){return null==e.colStyles||n>=e.colStyles.length?"":`class="${e.colStyles[n]}"`},this._renderTable_makeTableTdClassText=function(e,n){return null==e.rowStyles?this._renderTable_getTableThClassText(e,n):n>=e.rowStyles.length?"":`class="${e.rowStyles[n]}"`},this._renderEntries=function(e,n,t,r){this._renderEntriesSubtypes(e,n,t,r,!0)},this._renderEntriesSubtypes=function(e,n,t,r,i){const d=2<=t.depth,s=!d&&0<e.page?` <span class="rd__title-link">${e.source?`<span class="help--subtle" title="${Parser.sourceJsonToFull(e.source)}">${Parser.sourceJsonToAbv(e.source)}</span> `:""}p${e.page}</span>`:"",o=i&&2>t.depth?t.depth+1:t.depth,l=this._renderEntriesSubtypes_getStyleString(e,t,d),u=this._renderEntriesSubtypes_getDataString(e);null!=e.name&&this._handleTrackTitles(e.name);const p=`rd__h--${t.depth+1}`,c=e.name?`<span class="rd__h ${p}" data-title-index="${this._headerIndex++}" ${this._getEnumeratedTitleRel(e.name)}> <span class="entry-title-inner">${this.render({type:"inline",entries:[e.name]})}${d?".":""}</span>${s}</span> `:"";if(-1===t.depth&&(!this._firstSection&&(n[0]+=`<hr class="rd__hr rd__hr--section">`),this._firstSection=!1),e.entries||e.name){if(n[0]+=`<${this.wrapperTag} ${u} ${l}>${c}`,this._renderEntriesSubtypes_renderPreReqText(e,n,t),e.entries){const r=t.depth,d=e.entries.length;for(let r=0;r<d;++r)t.depth=o,this._recursiveRender(e.entries[r],n,t,{prefix:"<p>",suffix:"</p>"});t.depth=r}n[0]+=`</${this.wrapperTag}>`}},this._renderEntriesSubtypes_getDataString=function(e){let n="";if("optfeature"===e.type||"patron"===e.type){const t=e.source?`title="Source: ${Parser.sourceJsonToFull(e.source)}"`:"";n=null==e.subclass?`${ATB_DATA_SC}="${Renderer.DATA_NONE}" ${ATB_DATA_SRC}="${Renderer.DATA_NONE}" ${t}`:`${ATB_DATA_SC}="${e.subclass.name}" ${ATB_DATA_SRC}="${Parser._getSourceStringFromSource(e.subclass.source)}" ${t}`}return n},this._renderEntriesSubtypes_renderPreReqText=function(e,n,t){e.prerequisite&&(n[0]+=`<span class="prerequisite">Prerequisite: `,this._recursiveRender({type:"inline",entries:[e.prerequisite]},n,t),n[0]+=`</span>`)},this._renderEntriesSubtypes_getStyleString=function(e,n,t){const r=[];return r.push(this._getStyleClass(e.source)),t?this._subVariant?r.push(Renderer.HEAD_2_SUB_VARIANT):r.push(Renderer.HEAD_2):r.push(-1===n.depth?Renderer.HEAD_NEG_1:0===n.depth?Renderer.HEAD_0:Renderer.HEAD_1),("optfeature"===e.type||"patron"===e.type)&&null!=e.subclass&&r.push(CLSS_SUBCLASS_FEATURE),0<r.length?`class="${r.join(" ")}"`:""},this._renderOptions=function(e,n,t,r){e.entries&&(e.entries=e.entries.sort((e,n)=>e.name&&n.name?SortUtil.ascSort(e.name,n.name):e.name?-1:n.name?1:0),this._renderEntriesSubtypes(e,n,t,r,!1))},this._renderList=function(e,n,t,r){if(e.items){e.name&&(n[0]+=`<p class="rd__list-name">${e.name}</p>`);const i=this._renderList_getListCssClasses(e,n,t,r);n[0]+=`<ul ${i?`class="${i}"`:""}>`;const d=e.items.length;for(let r=0;r<d;++r){const i=e.items[r],d=`${this._getStyleClass(i.source)}${"itemSpell"===i.type?" rd__li-spell":""}`;n[0]+=`<li ${d?`class="${d}"`:""}>`;const s=this._adjustDepth(t,1);this._recursiveRender(e.items[r],n,t),t.depth=s,n[0]+="</li>"}n[0]+="</ul>"}},this._renderInset=function(e,n,t){n[0]+=`<${this.wrapperTag} class="rd__b-inset">`,null!=e.name&&(this._handleTrackTitles(e.name),n[0]+=`<span class="rd__h rd__h--2-inset" data-title-index="${this._headerIndex++}" ${this._getEnumeratedTitleRel(e.name)}><span class="entry-title-inner">${e.name}</span></span>`);const r=e.entries.length;for(let d=0;d<r;++d){const r=t.depth;t.depth=2,this._recursiveRender(e.entries[d],n,t,{prefix:"<p>",suffix:"</p>"}),t.depth=r}n[0]+=`</${this.wrapperTag}>`},this._renderInsetReadaloud=function(e,n,t){n[0]+=`<${this.wrapperTag} class="rd__b-inset rd__b-inset--readaloud">`,null!=e.name&&(this._handleTrackTitles(e.name),n[0]+=`<span class="rd__h rd__h--2-inset" data-title-index="${this._headerIndex++}" ${this._getEnumeratedTitleRel(e.name)}><span class="entry-title-inner">${e.name}</span></span>`);const r=e.entries.length;for(let d=0;d<r;++d){const r=t.depth;t.depth=2,this._recursiveRender(e.entries[d],n,t,{prefix:"<p>",suffix:"</p>"}),t.depth=r}n[0]+=`</${this.wrapperTag}>`},this._renderVariant=function(e,n,t){this._handleTrackTitles(e.name),n[0]+=`<${this.wrapperTag} class="rd__b-inset">`,n[0]+=`<span class="rd__h rd__h--2-inset" data-title-index="${this._headerIndex++}" ${this._getEnumeratedTitleRel(e.name)}><span class="entry-title-inner">Variant: ${e.name}</span></span>`;const r=e.entries.length;for(let d=0;d<r;++d){const r=t.depth;t.depth=2,this._recursiveRender(e.entries[d],n,t,{prefix:"<p>",suffix:"</p>"}),t.depth=r}e.variantSource&&(n[0]+=Renderer.utils._getPageTrText(e.variantSource)),n[0]+=`</${this.wrapperTag}>`},this._renderVariantSub=function(e,n,t){this._subVariant=!0;const r=e;r.type="entries";const i=t.depth;t.depth=3,this._recursiveRender(r,n,t,{prefix:"<p>",suffix:"</p>"}),t.depth=i,this._subVariant=!1},this._renderSpellcasting=function(e,n,t){const r=new Set(e.hidden||[]),i=[{type:"entries",name:e.name,entries:e.headerEntries?MiscUtil.copy(e.headerEntries):[]}];if(e.constant||e.will||e.rest||e.daily||e.weekly){const n={type:"list",style:"list-hang-notitle",items:[]};if(e.constant&&!r.has("constant")&&n.items.push({type:"itemSpell",name:`Constant:`,entry:e.constant.join(", ")}),e.will&&!r.has("will")&&n.items.push({type:"itemSpell",name:`At will:`,entry:e.will.join(", ")}),e.rest&&!r.has("rest"))for(let t=9;0<t;t--){const r=e.rest;r[t]&&n.items.push({type:"itemSpell",name:`${t}/rest:`,entry:r[t].join(", ")});const i=`${t}e`;r[i]&&n.items.push({type:"itemSpell",name:`${t}/rest each:`,entry:r[i].join(", ")})}if(e.daily&&!r.has("daily"))for(let t=9;0<t;t--){const r=e.daily;r[t]&&n.items.push({type:"itemSpell",name:`${t}/day:`,entry:r[t].join(", ")});const i=`${t}e`;r[i]&&n.items.push({type:"itemSpell",name:`${t}/day each:`,entry:r[i].join(", ")})}if(e.weekly&&!r.has("weekly"))for(let t=9;0<t;t--){const r=e.weekly;r[t]&&n.items.push({type:"itemSpell",name:`${t}/week:`,entry:r[t].join(", ")});const i=`${t}e`;r[i]&&n.items.push({type:"itemSpell",name:`${t}/week each:`,entry:r[i].join(", ")})}n.items.length&&i[0].entries.push(n)}if(e.spells&&!r.has("spells")){const n={type:"list",style:"list-hang-notitle",items:[]};for(let t=0;10>t;++t){const r=e.spells[t];if(r){let e=`${Parser.spLevelToFull(t)}${0==t?"s":" level"}`,i=` (at will)`;const d=r.slots;0<=d&&(i=0<d?` (${d} slot${1<d?"s":""})`:``),r.lower&&r.lower!==t&&(e=`${Parser.spLevelToFull(r.lower)}-${e}`,0<=d&&(i=0<d?` (${d} ${Parser.spLevelToFull(t)}-level slot${1<d?"s":""})`:``)),n.items.push({type:"itemSpell",name:`${e} ${i}:`,entry:r.spells.join(", ")})}}i[0].entries.push(n)}e.footerEntries&&i.push({type:"entries",entries:e.footerEntries}),this._recursiveRender({type:"entries",entries:i},n,t)},this._renderQuote=function(e,n,t){n[0]+=`<p><i>`;const r=e.entries.length;for(let d=0;d<r;++d)this._recursiveRender(e.entries[d],n,t),n[0]+=d==e.entries.length-1?`</i>`:`<br>`;if(e.by){const r=[""];this._recursiveRender(e.by,r,t),n[0]+=`<span class="rd__quote-by">\u2014 ${r.join("")}${e.from?`, <i>${e.from}</i>`:""}</span>`}n[0]+=`</p>`},this._renderOptfeature=function(e,n,t,r){this._renderEntriesSubtypes(e,n,t,r,!0)},this._renderPatron=function(e,n,t,r){this._renderEntriesSubtypes(e,n,t,r,!1)},this._renderAbilityDc=function(e,n,t,r){this._renderPrefix(e,n,t,r),n[0]+=`<div class='text-center'><b>${e.name} save DC</b> = 8 + your proficiency bonus + your ${Parser.attrChooseToFull(e.attributes)}</div>`,this._renderSuffix(e,n,t,r)},this._renderAbilityAttackMod=function(e,n,t,r){this._renderPrefix(e,n,t,r),n[0]+=`<div class='text-center'><b>${e.name} attack modifier</b> = your proficiency bonus + your ${Parser.attrChooseToFull(e.attributes)}</div>`,this._renderSuffix(e,n,t,r)},this._renderAbilityGeneric=function(e,n,t,r){this._renderPrefix(e,n,t,r),n[0]+=`<div class='text-center'>${e.name?`<b>${e.name}</b>  = `:""}${e.text}${e.attributes?` ${Parser.attrChooseToFull(e.attributes)}`:""}</div>`,this._renderSuffix(e,n,t,r)},this._renderInline=function(e,n,t){if(e.entries){const r=e.entries.length;for(let d=0;d<r;++d)this._recursiveRender(e.entries[d],n,t)}},this._renderInlineBlock=function(e,n,t,r){if(this._renderPrefix(e,n,t,r),e.entries){const r=e.entries.length;for(let d=0;d<r;++d)this._recursiveRender(e.entries[d],n,t)}this._renderSuffix(e,n,t,r)},this._renderBonus=function(e,n){n[0]+=(0>e.value?"":"+")+e.value},this._renderBonusSpeed=function(e,n){n[0]+=(0>e.value?"":"+")+e.value+" ft."},this._renderDice=function(e,n){n[0]+=Renderer.getEntryDice(e,e.name)},this._renderActions=function(e,n,t){this._handleTrackTitles(e.name),n[0]+=`<${this.wrapperTag} class="${Renderer.HEAD_2}"><span class="rd__h rd__h--3" data-title-index="${this._headerIndex++}" ${this._getEnumeratedTitleRel(e.name)}><span class="entry-title-inner">${e.name}.</span></span> `;const r=e.entries.length;for(let d=0;d<r;++d)this._recursiveRender(e.entries[d],n,t,{prefix:"<p>",suffix:"</p>"});n[0]+=`</${this.wrapperTag}>`},this._renderAttack=function(e,n,t,r){this._renderPrefix(e,n,t,r),n[0]+=`<i>${Parser.attackTypeToFull(e.attackType)}:</i> `;const d=e.attackEntries.length;for(let s=0;s<d;++s)this._recursiveRender(e.attackEntries[s],n,t);n[0]+=` <i>Hit:</i> `;const s=e.hitEntries.length;for(let d=0;d<s;++d)this._recursiveRender(e.hitEntries[d],n,t);this._renderSuffix(e,n,t,r)},this._renderItem=function(e,n,t,r){if(this._renderPrefix(e,n,t,r),n[0]+=`<p><span class="bold list-item-title">${this.render(e.name)}</span> `,e.entry)this._recursiveRender(e.entry,n,t);else if(e.entries){const r=e.entries.length;for(let d=0;d<r;++d)this._recursiveRender(e.entries[d],n,t,{prefix:0<d?`<span class="rd__p-cont-indent">`:"",suffix:0<d?"</span>":""})}n[0]+="</p>",this._renderSuffix(e,n,t,r)},this._renderItemSub=function(e,n,t,r){this._renderPrefix(e,n,t,r),this._recursiveRender(e.entry,n,t,{prefix:`<p><span class="italic list-item-title">${e.name}</span> `,suffix:"</p>"}),this._renderSuffix(e,n,t,r)},this._renderItemSpell=function(e,n,t,r){this._renderPrefix(e,n,t,r),this._recursiveRender(e.entry,n,t,{prefix:`<p>${e.name} `,suffix:"</p>"}),this._renderSuffix(e,n,t,r)},this._renderDataCreature=function(e,n,t,r){this._renderPrefix(e,n,t,r),n[0]+=`<table class="rd__b-data">`,n[0]+=`<thead><tr><th class="rd__data-embed-header" colspan="6" onclick="((ele) => {
						$(ele).find('.rd__data-embed-name').toggle(); 
						$(ele).find('.rd__data-embed-toggle').text($(ele).text().includes('+') ? '[\u2013]' : '[+]'); 
						$(ele).closest('table').find('tbody').toggle()
					})(this)"><span style="display: none;" class="rd__data-embed-name">${e.dataCreature.name}</span><span class="rd__data-embed-toggle">[\u2013]</span></th></tr></thead><tbody>`,n[0]+=Renderer.monster.getCompactRenderedString(e.dataCreature,this),n[0]+=`</tbody></table>`,this._renderSuffix(e,n,t,r)},this._renderDataSpell=function(e,n,t,r){this._renderPrefix(e,n,t,r),n[0]+=`<table class="rd__b-data">`,n[0]+=`<thead><tr><th class="rd__data-embed-header" colspan="6" onclick="((ele) => {
						$(ele).find('.rd__data-embed-name').toggle(); 
						$(ele).find('.rd__data-embed-toggle').text($(ele).text().includes('+') ? '[\u2013]' : '[+]'); 
						$(ele).closest('table').find('tbody').toggle()
					})(this)"><span style="display: none;" class="rd__data-embed-name">${e.dataSpell.name}</span><span class="rd__data-embed-toggle">[\u2013]</span></th></tr></thead><tbody>`,n[0]+=Renderer.spell.getCompactRenderedString(e.dataSpell,this),n[0]+=`</tbody></table>`,this._renderSuffix(e,n,t,r)},this._renderGallery=function(e,n,t){n[0]+=`<div class="rd__wrp-gallery">`;const r=e.images.length,d=e.images.find(e=>e.title);for(let s=0;s<r;++s){const r=MiscUtil.copy(e.images[s]);d&&!r.title&&(r._galleryTitlePad=!0),delete r.imageType,this._recursiveRender(r,n,t)}n[0]+=`</div>`},this._renderHomebrew=function(e,n,t,r){if(this._renderPrefix(e,n,t,r),n[0]+=`<div class="homebrew-section">`,e.oldEntries){const t=Renderer.hover.createOnMouseHover(e.oldEntries);let r;r=e.movedTo?"(See moved content)":e.entries?"(See replaced content)":"(See removed content)",n[0]+=`<span class="homebrew-old-content" href="#${window.location.hash}" ${t}>${r}</span>`}if(n[0]+=`<span class="homebrew-notice"></span>`,e.entries){const r=e.entries.length;for(let d=0;d<r;++d)this._recursiveRender(e.entries[d],n,t)}else n[0]+=e.movedTo?`<i>This content has been moved to ${e.movedTo}.</i>`:"<i>This content has been deleted.</i>";n[0]+=`</div>`,this._renderSuffix(e,n,t,r)},this._renderCode=function(e,n){n[0]+=`<button class="btn btn-default btn-xs mb-1" onclick="{const $e = $(this).next('pre'); MiscUtil.pCopyTextToClipboard($e.text());JqueryUtil.showCopiedEffect($e)}">Copy Code</button>
			<pre>${e.preformatted}</pre>
		`},this._renderHr=function(e,n){n[0]+=`<hr class="rd__hr">`},this._getStyleClass=function(e){const n=[];return SourceUtil.isNonstandardSource(e)&&n.push(CLSS_NON_STANDARD_SOURCE),BrewUtil.hasSourceJson(e)&&n.push(CLSS_HOMEBREW_SOURCE),n.join(" ")},this._renderString=function(t,r,i){const d=Renderer.splitByTags(t),s=d.length;for(let o=0;o<s;++o){const t=d[o];if(t)if("@"===t[0]){const[d,s]=Renderer.splitFirstSpace(t);switch(d){case"@b":case"@bold":r[0]+=`<b>`,this._recursiveRender(s,r,i),r[0]+=`</b>`;break;case"@i":case"@italic":r[0]+=`<i>`,this._recursiveRender(s,r,i),r[0]+=`</i>`;break;case"@s":case"@strike":r[0]+=`<s>`,this._recursiveRender(s,r,i),r[0]+=`</s>`;break;case"@note":r[0]+=`<i class="text-muted">`,this._recursiveRender(s,r,i),r[0]+=`</i>`;break;case"@atk":r[0]+=`<i>${Renderer.attackTagToFull(s)}</i>`;break;case"@h":r[0]+=`<i>Hit:</i> `;break;case"@dc":{r[0]+=`DC <span class="rd__dc">${s}</span>`;break}case"@dice":case"@damage":case"@hit":case"@d20":case"@chance":case"@recharge":{const e={type:"dice",rollable:!0},[t,o,l,...u]=s.split("|");switch(o&&(e.displayText=o),l&&(e.name=l),d){case"@dice":{e.toRoll=t,!o&&t.includes(";")&&(e.displayText=t.replace(/;/g,"/")),(!e.displayText&&t.includes("#$")||e.displayText&&e.displayText.includes("#$"))&&(e.displayText=(e.displayText||t).replace(/#\$prompt_number[^$]*\$#/g,"(n)")),this._recursiveRender(e,r,i);break}case"@damage":{e.toRoll=t,e.subType="damage",this._recursiveRender(e,r,i);break}case"@d20":case"@hit":{const d=+t,n=`${0<=d?"+":""}${d}`;e.displayText=e.displayText||n,e.toRoll=`1d20${n}`,e.subType="d20",e.d20mod=n,this._recursiveRender(e,r,i);break}case"@chance":{e.toRoll=`1d100`,e.successThresh=+t,this._recursiveRender(e,r,i);break}case"@recharge":{e.toRoll="1d6";const n=+(t||6);e.successThresh=7-n,e.successMax=6,r[0]+=`(Recharge `,e.displayText=`${n}${6>n?`\u20136`:""}`,this._recursiveRender(e,r,i),r[0]+=`)`;break}}break}case"@scaledice":{const[t,d,o]=s.split("|"),l=MiscUtil.parseNumberRange(d,1,9),u=n(...l),p={},c=/^(\d+)d(\d+)$/i.exec(o),h=()=>{let e=null;const n=[...l].sort(SortUtil.ascSort);for(let t=1;t<n.length;++t){const r=n[t-1],i=n[t];if(null==e)e=i-r;else if(i-r!==e)return null}return e},f=h();l.forEach(n=>{const t=n-u;p[n]=c&&null!=f?t?`${+c[1]*(t/f)}d${c[2]}`:"":t?[...Array(e(t/f))].map(()=>o).join("+"):""});this._recursiveRender({type:"dice",rollable:!0,toRoll:t,displayText:o,prompt:{entry:"Cast at...",options:p}},r,i);break}case"@filter":{const[e,n,...t]=s.split("|"),d={type:"link",text:e,href:{type:"internal",path:`${n}.html`,hash:HASH_BLANK,hashPreEncoded:!0,subhashes:t.map(e=>{const[n,t,r]=e.split("=").map(e=>e.trim()).filter(e=>e),i=n.startsWith("fb")?n:`flst${UrlUtil.encodeForHash(n)}`;let d;if(t.startsWith("[")&&t.endsWith("]")){const[e,n]=t.substring(1,t.length-1).split(";").map(e=>e.trim());d=null==n?[`min=${e}`,`max=${e}`].join(HASH_SUB_LIST_SEP):[e?`min=${e}`:"",n?`max=${n}`:""].filter(Boolean).join(HASH_SUB_LIST_SEP)}else d=t.split(";").map(e=>e.trim()).filter(e=>e).map(e=>{const n=e.split("!");return 2===n.length?`${UrlUtil.encodeForHash(n[1])}=2`:`${UrlUtil.encodeForHash(e)}=1`}).join(HASH_SUB_LIST_SEP);const s={key:i,value:d,preEncoded:!0};return r?[s,{key:`flmt${UrlUtil.encodeForHash(n)}`,value:r,preEncoded:!0}]:s}).flat()}};this._recursiveRender(d,r,i);break}case"@link":{const[e,n]=s.split("|");let t=null==n?e:n;t.startsWith("http")||(t=`http://${t}`);const d={type:"link",href:{type:"external",url:t},text:e};this._recursiveRender(d,r,i);break}case"@5etools":{const[e,n,t]=s.split("|"),d={type:"link",href:{type:"internal",path:n},text:e};t&&(d.hash=t,d.hashPreEncoded=!0),this._recursiveRender(d,r,i);break}case"@footnote":{const[e,n,t]=s.split("|"),d=Renderer.hover.createOnMouseHover([n,t?`{@note ${t}}`:""].filter(Boolean));r[0]+=`<span class="help" ${d}>`,this._recursiveRender(e,r,i),r[0]+=`</span>`;break}case"@homebrew":{const[e,n]=s.split("|"),t=[];e&&n?t.push("<strong>This is a homebrew addition, replacing the following:</strong>"):e?t.push("<strong>This is a homebrew addition.</strong>"):n&&t.push("<strong>The following text has been removed with this homebrew:</strong>"),n&&t.push(n);const d=Renderer.hover.createOnMouseHover(t);r[0]+=`<span class="homebrew-inline" ${d}>`,this._recursiveRender(e||"[...]",r,i),r[0]+=`</span>`;break}case"@skill":case"@action":case"@sense":{const e=(()=>"@skill"===d?Parser.skillToExplanation:"@action"===d?Parser.actionToExplanation:"@sense"===d?Parser.senseToExplanation:void 0)(),[n,t]=s.split("|"),i=Renderer.hover.createOnMouseHover(e(n),n);r[0]+=`<span class="help--hover" ${i}>${t||n}</span>`;break}case"@area":{const[e,n,t,...i]=s.split("|"),d=e.split(">"),o=t||`${n&&n.includes("u")?"A":"a"}rea ${1===d.length?d[0]:d[1]}`;if("undefined"==typeof BookUtil)r[0]+=o;else{const n=BookUtil.curRender.headerMap[e]||{entry:{name:""}},t=Renderer.hover.createOnMouseHoverEntry(n.entry,!0);r[0]+=`<a href="#${BookUtil.curRender.curBookId},${n.chapter},${UrlUtil.encodeForHash(n.entry.name)}" ${t} onclick="BookUtil.handleReNav(this)">${o}</a>`}break}case"@book":case"@adventure":{const e="@book"===d?"book.html":"adventure.html",[n,t,o,l,u]=s.split("|"),p=`${t}${o?`${HASH_PART_SEP}${o}${l?`${HASH_PART_SEP}${UrlUtil.encodeForHash(l)}${null==u?"":`${HASH_PART_SEP}${UrlUtil.encodeForHash(u)}`}`:""}`:""}`;this._recursiveRender({type:"link",href:{type:"internal",path:e,hash:p,hashPreEncoded:!0},text:n},r,i);break}case"@deity":{const[e,n,t,d,...o]=s.split("|"),l=`${e}${n?`${HASH_LIST_SEP}${n}`:""}${t?`${HASH_LIST_SEP}${t}`:""}`,u={type:"link",href:{type:"internal",hash:l},text:d||e};u.href.path="deities.html",n||(u.href.hash+=`${HASH_LIST_SEP}forgotten realms`),t||(u.href.hash+=`${HASH_LIST_SEP}${SRC_PHB}`),u.href.hover={page:UrlUtil.PG_DEITIES,source:t||SRC_PHB},this._recursiveRender(u,r,i);break}case"@loader":{const[e,n]=s.split("|"),t=/^.*?:\/\//.test(n)?n:`https://raw.githubusercontent.com/TheGiddyLimit/homebrew/master/${n}`;r[0]+=`<span onclick="BrewUtil.handleLoadbrewClick(this, '${t.escapeQuotes()}', '${e.escapeQuotes()}')" class="rd__wrp-loadbrew--ready" title="Click to install homebrew">${e}<span class="glyphicon glyphicon-download-alt rd__loadbrew-icon rd__loadbrew-icon"/></span>`;break}default:{const[e,n,t,...o]=s.split("|"),l=`${e}${n?`${HASH_LIST_SEP}${n}`:""}`,u={type:"link",href:{type:"internal",hash:l},text:t||e};switch(d){case"@spell":u.href.path="spells.html",n||(u.href.hash+=HASH_LIST_SEP+SRC_PHB),u.href.hover={page:UrlUtil.PG_SPELLS,source:n||SRC_PHB},this._recursiveRender(u,r,i);break;case"@item":u.href.path="items.html",n||(u.href.hash+=HASH_LIST_SEP+SRC_DMG),u.href.hover={page:UrlUtil.PG_ITEMS,source:n||SRC_DMG},this._recursiveRender(u,r,i);break;case"@class":{if(o.length){const e=1<o.length?`~${o[1].trim()}`:"~phb";u.href.subhashes=[{key:"sub",value:o[0].trim()+e},{key:"sources",value:2}],2<o.length&&u.href.subhashes.push({key:CLSS_HASH_FEATURE_KEY,value:o[2].trim()})}u.href.path="classes.html",n||(u.href.hash+=HASH_LIST_SEP+SRC_PHB),this._recursiveRender(u,r,i);break}case"@creature":if(u.href.path="bestiary.html",n||(u.href.hash+=HASH_LIST_SEP+SRC_MM),u.href.hover={page:UrlUtil.PG_BESTIARY,source:n||SRC_MM},o.length){const n=Parser.crToNumber(o[0]);u.href.hover.prelodId=`${MON_HASH_SCALED}:${n}`,u.href.subhashes=[{key:MON_HASH_SCALED,value:n}],u.text=t||`${e} (CR ${o[0]})`}this._recursiveRender(u,r,i);break;case"@condition":u.href.path="conditionsdiseases.html",n||(u.href.hash+=HASH_LIST_SEP+SRC_PHB),u.href.hover={page:UrlUtil.PG_CONDITIONS_DISEASES,source:n||SRC_PHB},this._recursiveRender(u,r,i);break;case"@disease":u.href.path="conditionsdiseases.html",n||(u.href.hash+=HASH_LIST_SEP+SRC_DMG),u.href.hover={page:UrlUtil.PG_CONDITIONS_DISEASES,source:n||SRC_DMG},this._recursiveRender(u,r,i);break;case"@background":u.href.path="backgrounds.html",n||(u.href.hash+=HASH_LIST_SEP+SRC_PHB),u.href.hover={page:UrlUtil.PG_BACKGROUNDS,source:n||SRC_PHB},this._recursiveRender(u,r,i);break;case"@race":u.href.path="races.html",n||(u.href.hash+=HASH_LIST_SEP+SRC_PHB),u.href.hover={page:UrlUtil.PG_RACES,source:n||SRC_PHB},this._recursiveRender(u,r,i);break;case"@optfeature":u.href.path="optionalfeatures.html",n||(u.href.hash+=HASH_LIST_SEP+SRC_PHB),u.href.hover={page:UrlUtil.PG_OPT_FEATURES,source:n||SRC_PHB},this._recursiveRender(u,r,i);break;case"@reward":u.href.path="rewards.html",n||(u.href.hash+=HASH_LIST_SEP+SRC_DMG),u.href.hover={page:UrlUtil.PG_REWARDS,source:n||SRC_DMG},this._recursiveRender(u,r,i);break;case"@feat":u.href.path="feats.html",n||(u.href.hash+=HASH_LIST_SEP+SRC_PHB),u.href.hover={page:UrlUtil.PG_FEATS,source:n||SRC_PHB},this._recursiveRender(u,r,i);break;case"@psionic":u.href.path="psionics.html",n||(u.href.hash+=HASH_LIST_SEP+SRC_UATMC),u.href.hover={page:UrlUtil.PG_PSIONICS,source:n||SRC_UATMC},this._recursiveRender(u,r,i);break;case"@object":u.href.path="objects.html",n||(u.href.hash+=HASH_LIST_SEP+SRC_DMG),u.href.hover={page:UrlUtil.PG_OBJECTS,source:n||SRC_DMG},this._recursiveRender(u,r,i);break;case"@boon":case"@cult":u.href.path="cultsboons.html",n||(u.href.hash+=HASH_LIST_SEP+SRC_MTF),u.href.hover={page:UrlUtil.PG_CULTS_BOONS,source:n||SRC_MTF},this._recursiveRender(u,r,i);break;case"@trap":case"@hazard":u.href.path="trapshazards.html",n||(u.href.hash+=HASH_LIST_SEP+SRC_DMG),u.href.hover={page:UrlUtil.PG_TRAPS_HAZARDS,source:n||SRC_DMG},this._recursiveRender(u,r,i);break;case"@variantrule":u.href.path="variantrules.html",n||(u.href.hash+=HASH_LIST_SEP+SRC_DMG),u.href.hover={page:UrlUtil.PG_VARIATNRULES,source:n||SRC_DMG},this._recursiveRender(u,r,i);break;case"@table":u.href.path="tables.html",n||(u.href.hash+=HASH_LIST_SEP+SRC_DMG),u.href.hover={page:UrlUtil.PG_TABLES,source:n||SRC_DMG},this._recursiveRender(u,r,i);break;case"@ship":u.href.path=UrlUtil.PG_SHIPS,n||(u.href.hash+=HASH_LIST_SEP+SRC_GoS),u.href.hover={page:UrlUtil.PG_SHIPS,source:n||SRC_GoS},this._recursiveRender(u,r,i);}break}}}else r[0]+=t}},this._renderLink=function(e,n){let t;if("internal"!==e.href.type)"external"===e.href.type&&(t=e.href.url);else if(t=`${this.baseUrl}${e.href.path}#`,null!=e.href.hash&&(t+=e.href.hashPreEncoded?e.href.hash:UrlUtil.encodeForHash(e.href.hash)),null!=e.href.subhashes)for(let n=0;n<e.href.subhashes.length;++n){const r=e.href.subhashes[n];t+=r.preEncoded?`${HASH_PART_SEP}${r.key}${HASH_SUB_KV_SEP}`:`${HASH_PART_SEP}${UrlUtil.encodeForHash(r.key)}${HASH_SUB_KV_SEP}`,t+=null==r.value?r.values.map(e=>UrlUtil.encodeForHash(e)).join(HASH_SUB_LIST_SEP):r.preEncoded?r.value:UrlUtil.encodeForHash(r.value)}if(e.href.hover&&this._roll20Ids){const n=UrlUtil.encodeForHash(e.href.hash),r=this._roll20Ids[n];r&&(t=`http://journal.roll20.net/${r.type}/${r.roll20Id}`)}n[0]+=`<a href="${t}" ${"internal"===e.href.type?"":`target="_blank" rel="noopener"`} ${this._renderLink_getHoverString(e)}>${this.render(e.text)}</a>`},this._renderLink_getHoverString=function(e){if(!e.href.hover)return"";const n=UrlUtil.encodeForHash(e.href.hash).replace(/'/g,"\\'");return this._tagExportDict&&(this._tagExportDict[n]={page:e.href.hover.page,source:e.href.hover.source,hash:n}),`onmouseover="Renderer.hover.mouseOver(event, this, '${e.href.hover.page}', '${e.href.hover.source}', '${n}', false, ${e.href.hover.prelodId?`'${e.href.hover.prelodId}'`:"null"})" ${Renderer.hover._getPreventTouchString()}`},this.render=function(e,n=0){const t=[];return this.recursiveRender(e,t,{depth:n}),t.join("")}}Renderer.applyProperties=function(e,n){const t=Renderer.splitByPropertyInjectors(e),r=t.length;if(1===r)return e;let d="";for(let o=0;o<r;++o){const e=t[o];if(e)if("="===e[0]){const[t,r]=e.substring(1).split("/");let i=n[t];if(r)for(const e of r)"a"===e?i=Renderer.applyProperties._leadingAn.has(i[0].toLowerCase())?"an":"a":"l"===e?i=i.toLowerCase():"t"===e?i=i.toTitleCase():"u"===e?i=i.toUpperCase():void 0;d+=i}else d+=e}return d},Renderer.applyProperties._leadingAn=new Set(["a","e","i","o","u"]),Renderer.attackTagToFull=function(e){function n(e){return`${e.includes("m")?"Melee ":e.includes("r")?"Ranged ":e.includes("g")?"Magical ":e.includes("a")?"Area ":""}${e.includes("w")?"Weapon ":e.includes("s")?"Spell ":""}`}const t=e.toLowerCase().split(",").map(e=>e.trim()).filter(e=>e).map(e=>e.split(""));if(1<t.length){const e=new Set(t.last());for(let n=t.length-2;0<=n;--n)t[n]=t[n].filter(n=>{const t=!e.has(n);return e.add(n),t})}return`${t.map(e=>n(e)).join(" or ")}Attack:`},Renderer.HOVER_TAG_TO_PAGE={spell:UrlUtil.PG_SPELLS,item:UrlUtil.PG_ITEMS,creature:UrlUtil.PG_BESTIARY,condition:UrlUtil.PG_CONDITIONS_DISEASES,disease:UrlUtil.PG_CONDITIONS_DISEASES,background:UrlUtil.PG_BACKGROUNDS,race:UrlUtil.PG_RACES,optfeature:UrlUtil.PG_OPT_FEATURES,feat:UrlUtil.PG_FEATS,reward:UrlUtil.PG_REWARDS,psionic:UrlUtil.PG_PSIONICS,object:UrlUtil.PG_OBJECTS,cult:UrlUtil.PG_CULTS_BOONS,boon:UrlUtil.PG_CULTS_BOONS,trap:UrlUtil.PG_TRAPS_HAZARDS,hazard:UrlUtil.PG_TRAPS_HAZARDS},Renderer.splitFirstSpace=function(e){const n=e.indexOf(" ");return-1===n?[e,""]:[e.substr(0,n),e.substr(n+1)]},Renderer._splitByTagsBase=function(e){return function(n){let t,r,d=0;const s=[];let o="";const l=n.length;for(let u=0;u<l;++u)switch(t=n[u],r=n[u+1],t){case"{":r===e?0<d++?o+="{":(s.push(o),o=""):o+="{";break;case"}":0==d?o+="}":0==--d?(s.push(o),o=""):o+="}";break;default:o+=t;}return o&&s.push(o),s}},Renderer.splitByTags=Renderer._splitByTagsBase("@"),Renderer.splitByPropertyInjectors=Renderer._splitByTagsBase("="),Renderer.getEntryDice=function(e,n){function t(e){let n="";return e.forEach(e=>{n+=`${e.neg?"-":""==n?"":"+"}${e.number||1}d${e.faces}${e.mod?0<e.mod?`+${e.mod}`:e.mod:""}`}),n}function r(e){return`'${JSON.stringify(e).escapeQuotes()}'`}const i=e.displayText?e.displayText:function(){return e.successThresh?`${e.successThresh} percent`:"string"==typeof e.toRoll?e.toRoll:t(e.toRoll)}();if(!0===e.rollable){const d=MiscUtil.copy(e);return"string"!=typeof d.toRoll&&(d.toRoll=t(d.toRoll)),`<span class='roller render-roller' title="${n?`${n.escapeQuotes()}`:""}" onmousedown="event.preventDefault()" onclick="Renderer.dice.rollerClickUseData(event, this)" data-packed-dice=${r(d)}>${i}</span>`}return i},Renderer.getAbilityData=function(e){function n(e,n){MiscUtil.copy(Parser.ABIL_ABVS).sort((n,t)=>SortUtil.ascSort(e[t]||0,e[n]||0)).forEach(r=>t(e,r,n))}function t(e,n,t){if(null!=e[n]){const r=0>e[n],i=`${n.uppercaseFirst()} ${r?"":"+"}${e[n]}`;t?t.push(i):(l.push(i),u.push(i)),d.push(n.uppercaseFirst()),s.push(n),r&&o.push(n)}}function r(e){const n=[];for(let t=0;t<d.length;++t)n.push(d[t].toLowerCase());for(let t=0;t<e.from.length;++t){const r=e.from[t].toLowerCase();n.includes(r)||n.push(r),s.includes(r.toLowerCase)||s.push(r.toLowerCase())}return 6===n.length}const d=[],s=[],o=[],l=[],u=[];return null==e?new Renderer._AbilityData("","",[],[]):(n(e),function(){if(null!=e.choose)for(let t=0;t<e.choose.length;++t){const i=e.choose[t];let d="";if(null!=i.predefined)for(let e=0;e<i.predefined.length;++e){const t=[];n(i.predefined[e],t),d+=t.join(", ")+(e==i.predefined.length-1?"":" or ")}else if(i.weighted){const e=i.weighted,n=[],t=e.weights.filter(e=>0<=e).sort(SortUtil.ascSort).reverse().map(e=>(n.push(`+${e}`),`one ability to increase by ${e}`)),r=[],d=e.weights.filter(e=>0>e).map(e=>-e).sort(SortUtil.ascSort).map(e=>(r.push(`-${e}`),`one ability to decrease by ${e}`)),s=e.from.map(e=>e.uppercaseFirst()),o=6===s.length?`Choose `:`From ${s.joinConjunct(", "," and ")} choose `;l.push(`${o}${t.concat(d).joinConjunct(", "," and ")}`),u.push(`${6===s.length?"Any combination ":""}${n.concat(r).join("/")}${6===s.length?"":` from ${s.join("/")}`}`);continue}else{const e=6===i.from.length,n=r(i);let t=void 0===i.amount?1:i.amount;if(t=(0>t?"":"+")+t,e?d+="any ":n&&(d+="any other "),void 0!==i.count&&1<i.count&&(d+=Parser.numberToText(i.count)+" "),e||n)d+=`unique ${t}`;else for(let e,n=0;n<i.from.length;++n){e="",1<i.from.length&&(n==i.from.length-2?e=" or ":n<i.from.length-2&&(e=", "));let r=" "+t;1<i.from.length&&n!=i.from.length-1&&(r=""),d+=i.from[n].uppercaseFirst()+r+e}}l.push("Choose "+d),u.push(d.uppercaseFirst())}}(),new Renderer._AbilityData(l.join("; "),u.join("; "),s,o))},Renderer._AbilityData=function(e,n,t,r){this.asText=e,this.asTextShort=n,this.asCollection=t,this.areNegative=r},Renderer.utils={getBorderTr:e=>`<tr><th class="border" colspan="6">${e||""}</th></tr>`,getDividerTr:()=>`<tr><td class="divider" colspan="6"><div></div></td></tr>`,getSourceSubText(e){return e.sourceSub?` \u2014 ${e.sourceSub}`:""},getNameTr:(e,n)=>(n=n||{},`<tr>
			<th class="rnd-name name" colspan="6">
				<div class="name-inner">
					<div class="flex-v-center">
						<span class="stats-name copyable" onmousedown="event.preventDefault()" onclick="Renderer.utils._pHandleNameClick(this, '${e.source.escapeQuotes()}')">${n.prefix||""}${e._displayName||e.name}${n.suffix||""}</span>
						${n.pronouncePart||""}
					</div>
					<span class="stats-source ${Parser.sourceJsonToColor(e.source)}" title="${Parser.sourceJsonToFull(e.source)}${Renderer.utils.getSourceSubText(e)}" ${BrewUtil.sourceJsonToStyle(e.source)}>
						${Parser.sourceJsonToAbv(e.source)}${n.isAddPageNum&&0<e.page?` p${e.page}`:""}
					</span>
				</div>
			</th>
		</tr>`),async _pHandleNameClick(e){await MiscUtil.pCopyTextToClipboard($(e).text()),JqueryUtil.showCopiedEffect($(e))},getPageTr:e=>`<td colspan=6>${Renderer.utils._getPageTrText(e)}</td>`,_getPageTrText:e=>{function n(n,t){return e[n]&&e[n].length?`${t} ${e[n].map(e=>e.entry?Renderer.get().render(e.entry):`<i title="${Parser.sourceJsonToFull(e.source)}">${Parser.sourceJsonToAbv(e.source)}</i>${0<e.page?`, page ${e.page}`:""}`).join("; ")}`:""}const t=Renderer.utils.getSourceSubText(e),r=0<e.page?`<b>Source: </b> <i title="${Parser.sourceJsonToFull(e.source)}${t}">${Parser.sourceJsonToAbv(e.source)}${t}</i>, page ${e.page}`:"",i=n("additionalSources","Additional information from"),d=n("otherSources","Also found in"),s=n("externalSources","External sources:");return`${[r,i,d,s].filter(e=>e).join(". ")}${r&&(i||d||s)?".":""}`},getAbilityRoller(e,n){const t=Parser.getAbilityModifier(e[n]);return Renderer.get().render(`{@d20 ${t}|${e[n]} (${t})|${Parser.attAbvToFull(n)}`)},tabButton:(e,n,t)=>({label:e,funcChange:n,funcPopulate:t}),_tabs:{},_curTab:null,_prevTab:null,bindTabButtons:(...e)=>{Renderer.utils._tabs={},Renderer.utils._prevTab=Renderer.utils._curTab,Renderer.utils._curTab=null;const n=$("#pagecontent"),t=$(`#stat-tabs`);t.find(`.stat-tab-gen`).remove();let r=null;const i=e.map((e,t)=>{const i=!Renderer.utils._prevTab&&0===t||Renderer.utils._prevTab&&Renderer.utils._prevTab.label===e.label,d=$(`<span class="stat-tab ${i?`stat-tab-sel`:""} btn btn-default stat-tab-gen">${e.label}</span>`);return e.$t=d,d.click(()=>{const t=Renderer.utils._curTab,r=Renderer.utils._tabs;t&&t.label===e.label||(t&&t.$t.removeClass(`stat-tab-sel`),Renderer.utils._curTab=e,d.addClass(`stat-tab-sel`),t&&(r[t.label].content=n.children().detach()),r[e.label]=e,!r[e.label].content&&e.funcPopulate?e.funcPopulate():n.append(r[e.label].content),e.funcChange&&e.funcChange())}),Renderer.utils._prevTab&&Renderer.utils._prevTab.label===e.label&&(r=d),d});i.reverse().forEach(e=>t.prepend(e)),(r||i[i.length-1]).click()},_pronounceButtonsBound:!1,bindPronounceButtons(){Renderer.utils._pronounceButtonsBound||(Renderer.utils._pronounceButtonsBound=!0,$(`body`).on("click",".btn-name-pronounce",function(){const e=$(this).find(`.name-pronounce`)[0];e.currentTime=0,e.play()}))},getPredefinedFluff(e,n){if(!e.fluff)return null;const t=`_${n}`,r=`_append${n.uppercaseFirst()}`,i={},d=(e,...n)=>{n.forEach(n=>{e[n]&&(i[n]=e[n])})};if(d(e.fluff,"name","type","entries","images"),e.fluff[t]){const r=(BrewUtil.homebrew[n]||[]).find(n=>n.name===e.fluff[t].name&&n.source===e.fluff[t].source);r&&d(r,"name","type","entries","images")}if(e.fluff[r]){const t=(BrewUtil.homebrew[n]||[]).find(n=>n.name===e.fluff[r].name&&n.source===e.fluff[r].source);t&&(t.entries&&(i.entries=MiscUtil.copy(i.entries||[]),i.entries.push(...i.entries)),t.images&&(i.images=MiscUtil.copy(i.images||[]),i.images.push(...t.images)))}return i},buildFluffTab(e,n,t,r,i,d){function s(n){o.setFirstSection(!0);const t=r(n);if(!t)return void u.empty().append(e?HTML_NO_IMAGES:HTML_NO_INFO);if(e)t.images?t.images.forEach(e=>u.append(o.render(e,1))):u.append(HTML_NO_IMAGES);else if(t.entries){const e="section"===t.type?-1:2;"section"!==t.type&&o.setFirstSection(!1),u.append(o.render({type:t.type,entries:t.entries},e))}else u.append(HTML_NO_INFO)}const o=Renderer.get();n.append(Renderer.utils.getBorderTr()),n.append(Renderer.utils.getNameTr(t));const l=$(`<tr class="text"/>`);n.append(l);const u=$(`<td colspan="6" class="text"/>`).appendTo(l);n.append(Renderer.utils.getBorderTr()),d&&d(t.source)||t.fluff?t.fluff?s():DataUtil.loadJSON(i).then(s):(u.empty(),e?u.append(HTML_NO_IMAGES):u.append(HTML_NO_INFO))}},Renderer.feat={getPrerequisiteText:function(e,n,t){n=null!=n&&n,t=null!=t&&t;const r=[];if(null==e)return"";for(let d=0;d<e.length;++d){const t=[],i=e[d];if(i.level&&(n?t.push(`Lvl ${i.level}`):t.push(`${Parser.spLevelToFull(i.level)} level`)),null!=i.race)for(let e=0;e<i.race.length;++e)if(n){const n=i.race[e].name.split("-");let r=[];for(let e=0;e<n.length;++e)r.push(n[e].uppercaseFirst());r=r.join("-"),t.push(r+(null==i.race[e].subrace?"":" ("+i.race[e].subrace+")"))}else{const n=0==e?i.race[e].name.uppercaseFirst():i.race[e].name;t.push(n+(null==i.race[e].subrace?"":" ("+i.race[e].subrace+")"))}if(null!=i.ability){let e=0;for(let r=0;r<i.ability.length;++r)for(const d in i.ability[r])i.ability[r].hasOwnProperty(d)&&(n?t.push(d.uppercaseFirst()+(e==i.ability.length-1?" 13+":"")):t.push(Parser.attAbvToFull(d)+(e==i.ability.length-1?" 13 or higher":"")),e++)}if(null!=i.proficiency)for(let e=0;e<i.proficiency.length;++e)for(const r in i.proficiency[e])i.proficiency[e].hasOwnProperty(r)&&"armor"==r&&(n?t.push("prof "+Parser.armorFullToAbv(i.proficiency[e][r])+" armor"):t.push("Proficiency with "+i.proficiency[e][r]+" armor"));if(i.spellcasting&&(n?t.push("Spellcasting"):t.push("The ability to cast at least one spell")),i.special)if(n)t.push("Special");else{const e=Renderer.get();t.push(e.render(i.special))}r.push(t)}if(t)return r.reduce((e,n)=>e.concat(n),[]);if(n)return r.map(e=>e.join("/")).join("; ");else{const e=r.filter(e=>1<e.length).length&&1<r.length;return r.map(e=>e.joinConjunct(", "," or ")).joinConjunct(e?"; ":", ",e?" and ":", ")}},mergeAbilityIncrease:function(e){function n(){const e=", to a maximum of 20.",n=[];if(!r.choose)Object.keys(r).forEach(t=>n.push(`Increase your ${Parser.attAbvToFull(t)} score by ${r[t]}${e}`));else{const t=r.choose;for(let r=0;r<t.length;++r)if(6===t[r].from.length)t[r].textreference?n.push(`Increase the chosen ability score by ${t[r].amount}${e}`):n.push(`Increase one ability score of your choice by ${t[r].amount}${e}`);else{const i=t[r].from,d=t[r].amount,s=[];for(let e=0;e<i.length;++e)s.push(Parser.attAbvToFull(i[e]));const o=s.joinConjunct(", "," or ");n.push(`Increase your ${o} by ${d}${e}`)}}return n.join(" ")}const t=e.entries,r=e.ability;if(r&&!e._hasMergedAbility){e._hasMergedAbility=!0;const r=t.find(n=>"list"===n.type);r?r.items.unshift(n()):(t.unshift(n()),setTimeout(()=>{throw new Error(`Could not find object of type "list" in "entries" for feat "${e.name}" from source "${e.source}" when merging ability scores! Reformat the feat to include a "list"-type entry.`)},1))}},getCompactRenderedString:e=>{const n=Renderer.get(),t=[],r=Renderer.feat.getPrerequisiteText(e.prerequisite);return Renderer.feat.mergeAbilityIncrease(e),t.push(`
			${Renderer.utils.getNameTr(e,{isAddPageNum:!0})}
			<tr class='text'><td colspan='6' class='text'>
			${r?`<p><i>Prerequisite: ${r}</i></p>`:""}
		`),n.recursiveRender({entries:e.entries},t,{depth:2}),t.push(`</td></tr>`),t.join("")}},Renderer.get=()=>(Renderer.defaultRenderer||(Renderer.defaultRenderer=new Renderer),Renderer.defaultRenderer),Renderer.spell={getCompactRenderedString:e=>{const n=Renderer.get(),t=[];t.push(`
			${Renderer.utils.getNameTr(e,{isAddPageNum:!0})}
			<tr><td colspan="6">
				<table class="summary striped-even">
					<tr>
						<th colspan="1">Level</th>
						<th colspan="1">School</th>
						<th colspan="2">Casting Time</th>
						<th colspan="2">Range</th>
					</tr>	
					<tr>
						<td colspan="1">${Parser.spLevelToFull(e.level)}${Parser.spMetaToFull(e.meta)}</td>
						<td colspan="1">${Parser.spSchoolAndSubschoolsAbvsToFull(e.school,e.subschools)}</td>
						<td colspan="2">${Parser.spTimeListToFull(e.time)}</td>
						<td colspan="2">${Parser.spRangeToFull(e.range)}</td>
					</tr>
					<tr>
						<th colspan="4">Components</th>
						<th colspan="2">Duration</th>
					</tr>	
					<tr>
						<td colspan="4">${Parser.spComponentsToFull(e)}</td>
						<td colspan="2">${Parser.spDurationToFull(e.duration)}</td>
					</tr>
				</table>
			</td></tr>
		`),t.push(`<tr class='text'><td colspan='6' class='text'>`);const r={type:"entries",entries:e.entries};if(n.recursiveRender(r,t,{depth:1}),e.entriesHigherLevel){const r={type:"entries",entries:e.entriesHigherLevel};n.recursiveRender(r,t,{depth:2})}return t.push(`<div><span class="bold">Classes: </span>${Parser.spMainClassesToFull(e.classes)}</div>`),t.push(`</td></tr>`),t.join("")},getRenderedString:(e,n,t)=>{const r=[`
			${Renderer.utils.getBorderTr()}
			${Renderer.utils.getNameTr(e)}
			<tr><td class="levelschoolritual" colspan="6"><span>${Parser.spLevelSchoolMetaToFull(e.level,e.school,e.meta,e.subschools)}</span></td></tr>
			<tr><td class="castingtime" colspan="6"><span class="bold">Casting Time: </span>${Parser.spTimeListToFull(e.time)}</td></tr>
			<tr><td class="range" colspan="6"><span class="bold">Range: </span>${Parser.spRangeToFull(e.range)}</td></tr>
			<tr><td class="components" colspan="6"><span class="bold">Components: </span>${Parser.spComponentsToFull(e)}</td></tr>
			<tr><td class="range" colspan="6"><span class="bold">Duration: </span>${Parser.spDurationToFull(e.duration)}</td></tr>
			${Renderer.utils.getDividerTr()}
		`],i={type:"entries",entries:e.entries};if(r.push(`<tr class='text'><td colspan='6' class='text'>`),n.recursiveRender(i,r,{depth:1}),e.entriesHigherLevel){const t={type:"entries",entries:e.entriesHigherLevel};n.recursiveRender(t,r,{depth:2})}if(r.push(`</td></tr>`),r.push(`<tr class="text"><td class="classes" colspan="6"><span class="bold">Classes: </span>${Parser.spMainClassesToFull(e.classes)}</td></tr>`),e.classes.fromSubclass){const n=Parser.spSubclassesToCurrentAndLegacyFull(e.classes,t);r.push(`<tr class="text"><td colspan="6"><span class="bold">Subclasses: </span>${n[0]}</td></tr>`),n[1]&&r.push(`<tr class="text"><td colspan="6"><section class="text-muted"><span class="bold">Subclasses (legacy): </span>${n[1]}</section></td></tr>`)}return e.races&&r.push(`<tr class="text"><td class="classes" colspan="6"><span class="bold">Races: </span>${e.races.map(e=>n.render(`{@race ${e.name}|${e.source}}`)).join(", ")}</td></tr>`),e.backgrounds&&r.push(`<tr class="text"><td class="classes" colspan="6"><span class="bold">Backgrounds: </span>${e.backgrounds.sort((e,n)=>SortUtil.ascSortLower(e.name,n.name)).map(e=>n.render(`{@background ${e.name}|${e.source}}`)).join(", ")}</td></tr>`),e._scrollNote&&(r.push(`<tr class="text"><td colspan="6"><section class="text-muted">`),n.recursiveRender(`{@italic Note: Both the {@class ${STR_FIGHTER} (${STR_ELD_KNIGHT})} and the {@class ${STR_ROGUE} (${STR_ARC_TCKER})} spell lists include all {@class ${STR_WIZARD}} spells. Spells of 5th level or higher may be cast with the aid of a spell scroll or similar.}`,r,{depth:2}),r.push(`</section></td></tr>`)),r.push(`
			${Renderer.utils.getPageTr(e)}
			${Renderer.utils.getBorderTr()}
		`),r.join("")}},Renderer.condition={getCompactRenderedString:e=>{const n=Renderer.get(),t=[];return t.push(`
			${Renderer.utils.getNameTr(e,{isAddPageNum:!0})}
			<tr class="text"><td colspan="6">
		`),n.recursiveRender({entries:e.entries},t),t.push(`</td></tr>`),t.join("")}},Renderer.background={getCompactRenderedString(e){return`
		${Renderer.utils.getNameTr(e,{isAddPageNum:!0})}
		<tr class="text"><td colspan="6">
		${Renderer.get().render({type:"entries",entries:e.entries})}
		</td></tr>
		`},getSkillSummary(e,n,t){return Renderer.background._summariseProfs(e,n,t,`skill`)},getToolSummary(e,n,t){return Renderer.background._summariseProfs(e,n,t)},getLanguageSummary(e,n,t){return Renderer.background._summariseProfs(e,n,t)},_summariseProfs(e,n,t,r){function d(e){return n?e.toTitleCase():r?`{@${r} ${e.toTitleCase()}}`:e.toTitleCase()}function s(e,n){return e===n?0:"choose"===e?1:"choose"===n?-1:SortUtil.ascSort(e,n)}return e?e.map(e=>{let r=", ";const i=Object.keys(e).sort(s).filter(n=>e[n]).map((s,o)=>{if("choose"===s){r="; ";const i=e[s],l=i.from.map(e=>(t&&!t.includes(e)&&t.push(e),d(e)));return`${n?`${0===o?"C":"c"}hoose `:""}${i.count||1} ${n?`of`:`from`} ${l.joinConjunct(", "," or ")}`}return t&&!t.includes(s)&&t.push(s),d(s)});return i.join(r)}).join("/"):""}},Renderer.optionalfeature={_prereqWeights:{prereqLevel:0,prereqPact:1,prereqPatron:2,prereqSpell:3,prereqFeature:4,prereqItem:5,prereqSpecial:6,[void 0]:7},getPrerequisiteText:(e,n)=>{if(!e)return n?"\u2014":STR_NONE;e.sort((e,n)=>e.type===n.type?SortUtil.ascSortLower(e.name,n.name):Renderer.optionalfeature._prereqWeights[e.type]-Renderer.optionalfeature._prereqWeights[n.type]);const t=e.map(e=>{switch(e.type){case"prereqLevel":return!n&&`${Parser.levelToFull(e.level)} level`;case"prereqPact":return Parser.prereqPactToFull(e.entry);case"prereqPatron":return n?`${Parser.prereqPatronToShort(e.entry)} patron`:`${e.entry} patron`;case"prereqSpell":return n?e.entries.map(e=>e.split("|")[0].toTitleCase()).join("; "):e.entries.map(e=>Parser.prereqSpellToFull(e)).joinConjunct(", "," or ");case"prereqFeature":return n?e.entries.map(e=>e.toTitleCase()).join("; "):e.entries.joinConjunct(", "," or ");case"prereqItem":return n?e.entries.map(e=>e.toTitleCase()).join("; "):e.entries.joinConjunct(", "," or ");case"prereqSpecial":return n?e.entrySummary||Renderer.stripTags(e.entry):Renderer.get().render(e.entry);default:return e;}});return t.filter(Boolean).length?n?t.filter(Boolean).join(", "):`Prerequisites: ${t.join(", ")}`:n?"\u2014":STR_NONE},getListPrerequisiteLevelText(e){return e&&e.some(e=>"prereqLevel"===e.type)?e.find(e=>"prereqLevel"===e.type).level:"\u2014"},getPreviouslyPrintedText(e){return e.data&&e.data.previousVersion?`<tr><td colspan="6"><p>${Renderer.get().render(`{@i An earlier version of this ${Parser.optFeatureTypeToFull(e.featureType)} is available in }${Parser.sourceJsonToFull(e.data.previousVersion.source)} {@i as {@optfeature ${e.data.previousVersion.name}|${e.data.previousVersion.source}}.}`)}</p></td></tr>`:""},getCompactRenderedString:e=>{const n=Renderer.get(),t=[];return t.push(`
			${Renderer.utils.getNameTr(e,{isAddPageNum:!0})}
			<tr class="text"><td colspan="6">
			${e.prerequisite?`<p><i>${Renderer.optionalfeature.getPrerequisiteText(e.prerequisite)}</i></p>`:""}
		`),n.recursiveRender({entries:e.entries},t,{depth:1}),t.push(`</td></tr>`),t.push(Renderer.optionalfeature.getPreviouslyPrintedText(e)),t.join("")}},Renderer.reward={getRenderedString:e=>{const n=Renderer.get(),t=[];return n.recursiveRender({entries:e.entries},t,{depth:1}),`<tr class='text'><td colspan='6'>${t.join("")}</td></tr>`},getCompactRenderedString:e=>`
			${Renderer.utils.getNameTr(e,{isAddPageNum:!0})}
			${Renderer.reward.getRenderedString(e)}
		`},Renderer.race={getCompactRenderedString:e=>{const n=Renderer.get(),t=[],r=Renderer.getAbilityData(e.ability);return t.push(`
			${Renderer.utils.getNameTr(e,{isAddPageNum:!0})}
			<tr><td colspan="6">
				<table class="summary striped-even">
					<tr>
						<th class="col-4 text-center">Ability Scores</th>
						<th class="col-4 text-center">Size</th>
						<th class="col-4 text-center">Speed</th>
					</tr>
					<tr>
						<td class="text-center">${r.asText}</td>
						<td class="text-center">${Parser.sizeAbvToFull(e.size)}</td>
						<td class="text-center">${Parser.getSpeedString(e)}</td>
					</tr>
				</table>
			</td></tr>
			<tr class='text'><td colspan='6'>
		`),n.recursiveRender({type:"entries",entries:e.entries},t,{depth:1}),t.push("</td></tr>"),t.join("")},mergeSubraces:e=>{const n=[];return e.forEach(e=>{Array.prototype.push.apply(n,Renderer.race._mergeSubrace(e))}),n},_mergeSubrace:e=>{if(e.subraces){const n=JSON.parse(JSON.stringify(e.subraces)),t=[];return n.forEach(n=>{const r=JSON.parse(JSON.stringify(e));r._baseName=r.name,r._baseSource=r.source,delete r.subraces,n.name&&(r.name=`${r.name} (${n.name})`,delete n.name),n.ability&&((n.ability.overwrite||!r.ability)&&(r.ability={}),r.ability=Object.assign(r.ability,n.ability),delete r.ability.overwrite,delete n.ability),n.entries&&(n.entries.forEach(n=>{if(n.data&&n.data.overwrite){const e=r.entries.findIndex(e=>e.name.toLowerCase().trim()===n.data.overwrite.toLowerCase().trim());~e?r.entries[e]=n:r.entries.push(n)}else r.entries.push(n)}),delete n.entries),n.traitTags&&(r.traitTags=(r.traitTags||[]).concat(n.traitTags),delete n.traitTags),n.languageTags&&(r.languageTags=(r.languageTags||[]).concat(n.languageTags),delete n.languageTags),Object.assign(r,n),t.push(r)}),t}return[e]}},Renderer.deity={_basePartTranslators:{Alignment:{prop:"alignment",displayFn:e=>e.map(e=>Parser.alignmentAbvToFull(e)).join(" ")},Pantheon:{prop:"pantheon"},Category:{prop:"category"},Domains:{prop:"domains",displayFn:e=>e.join(", ")},Province:{prop:"province"},"Alternate Names":{prop:"altNames",displayFn:e=>e.join(", ")},Symbol:{prop:"symbol"}},getOrderedParts(e,n,t){const r={};Object.entries(Renderer.deity._basePartTranslators).forEach(([n,t])=>{const i=e[t.prop];if(null!=i){const e=t.displayFn?t.displayFn(i):i;r[n]=e}}),e.customProperties&&Object.entries(e.customProperties).forEach(([e,n])=>r[e]=n);const i=Object.keys(r).sort(SortUtil.ascSortLower);return i.map(e=>`${n}<b>${e}: </b>${Renderer.get().render(r[e])}${t}`).join("")},getCompactRenderedString:e=>{const n=Renderer.get();return`
			${Renderer.utils.getNameTr(e,{isAddPageNum:!0,suffix:e.title?`, ${e.title.toTitleCase()}`:""})}
			<tr><td colspan="6">
				<div class="rd__compact-stat">${Renderer.deity.getOrderedParts(e,`<p>`,`</p>`)}</div>
			</td>
			${e.entries?`<tr><td colspan="6"><div class="border"></div></td></tr><tr><td colspan="6">${n.render({entries:e.entries},1)}</td></tr>`:""}
		`}},Renderer.object={getCompactRenderedString:e=>{const n=Renderer.get(),t=12/(!!e.resist+!!e.vulnerable||1);return`
			${Renderer.utils.getNameTr(e,{isAddPageNum:!0})}
			<tr><td colspan="6">
				<table class="summary striped-even">
					<tr>
						<th colspan="3" class="text-center">Type</th>
						<th colspan="2" class="text-center">AC</th>
						<th colspan="2" class="text-center">HP</th>
						<th colspan="5" class="text-center">Damage Imm.</th>
					</tr>
					<tr>
						<td colspan="3" class="text-center">${Parser.sizeAbvToFull(e.size)} object</td>					
						<td colspan="2" class="text-center">${e.ac}</td>
						<td colspan="2" class="text-center">${e.hp}</td>
						<td colspan="5" class="text-center">${e.immune}</td>
					</tr>
					${e.resist||e.vulnerable?`
					<tr>
						${e.resist?`<th colspan="${t}" class="text-center">Damage Res.</th>`:""}
						${e.vulnerable?`<th colspan="${t}" class="text-center">Damage Vuln.</th>`:""}
					</tr>
					<tr>
						${e.resist?`<td colspan="${t}" class="text-center">${e.resist}</td>`:""}
						${e.vulnerable?`<td colspan="${t}" class="text-center">${e.vulnerable}</td>`:""}
					</tr>
					`:""}
				</table>			
			</td></tr>
			<tr class="text"><td colspan="6">
			${e.entries?n.render({entries:e.entries},2):""}
			${e.actionEntries?n.render({entries:e.actionEntries},2):""}
			</td></tr>
		`}},Renderer.traphazard={getSubtitle(e){const n=e.trapHazType||"HAZ";return"GEN"===n?null:"SMPL"===n||"CMPX"===n?`${Parser.trapHazTypeToFull(n)} (${Parser.tierToFullLevel(e.tier)}, ${Parser.threatToFull(e.threat)} threat)`:Parser.trapHazTypeToFull(n)},getSimplePart(e,n){return"SMPL"===n.trapHazType?e.render({entries:[{type:"entries",name:"Trigger",entries:n.trigger},{type:"entries",name:"Effect",entries:n.effect},{type:"entries",name:"Countermeasures",entries:n.countermeasures}]},1):""},getComplexPart(e,n){return"CMPX"===n.trapHazType?e.render({entries:[{type:"entries",name:"Trigger",entries:n.trigger},{type:"entries",name:"Initiative",entries:[`The trap acts on ${Parser.trapInitToFull(n.initiative)}${n.initiativeNote?` (${n.initiativeNote})`:""}.`]},n.eActive?{type:"entries",name:"Active Elements",entries:n.eActive}:null,n.eDynamic?{type:"entries",name:"Dynamic Elements",entries:n.eDynamic}:null,n.eConstant?{type:"entries",name:"Constant Elements",entries:n.eConstant}:null,{type:"entries",name:"Countermeasures",entries:n.countermeasures}].filter(e=>e)},1):""},getCompactRenderedString:e=>{const n=Renderer.get(),t=Renderer.traphazard.getSubtitle(e);return`
			${Renderer.utils.getNameTr(e,{isAddPageNum:!0})}
			${t?`<tr class="text"><td colspan="6"><i>${t}</i>${Renderer.traphazard.getSimplePart(n,e)}${Renderer.traphazard.getComplexPart(n,e)}</td>`:""}
			<tr class="text"><td colspan="6">${n.render({entries:e.entries},2)}</td></tr>
		`},_trapTypes:new Set(["MECH","MAG","SMPL","CMPX"]),isTrap(e){return Renderer.traphazard._trapTypes.has(e)}},Renderer.cultboon={doRenderCultParts(e,n,t){if(e.goal||e.cultists||e.signaturespells){const r={type:"list",style:"list-hang-notitle",items:[]};e.goal&&r.items.push({type:"item",name:"Goals:",entry:e.goal.entry}),e.cultists&&r.items.push({type:"item",name:"Typical Cultists:",entry:e.cultists.entry}),e.signaturespells&&r.items.push({type:"item",name:"Signature Spells:",entry:e.signaturespells.entry}),n.recursiveRender(r,t,{depth:2})}},doRenderBoonParts(e,n,t){const r={type:"list",style:"list-hang-notitle",items:[]};r.items.push({type:"item",name:"Ability Score Adjustment:",entry:e.ability?e.ability.entry:"None"}),r.items.push({type:"item",name:"Signature Spells:",entry:e.signaturespells?e.signaturespells.entry:"None"}),n.recursiveRender(r,t,{depth:1})},getCompactRenderedString:e=>{const n=Renderer.get(),t=[];return"c"===e._type?(Renderer.cultboon.doRenderCultParts(e,n,t),n.recursiveRender({entries:e.entries},t,{depth:2}),`${Renderer.utils.getNameTr(e,{isAddPageNum:!0})}
				<tr id="text"><td class="divider" colspan="6"><div></div></td></tr>
				<tr class='text'><td colspan='6' class='text'>${t.join("")}</td></tr>`):"b"===e._type?(Renderer.cultboon.doRenderBoonParts(e,n,t),n.recursiveRender({entries:e.entries},t,{depth:1}),`${Renderer.utils.getNameTr(e,{isAddPageNum:!0})}
			<tr class='text'><td colspan='6'>${t.join("")}</td></tr>`):void 0}},Renderer.monster={_MERGE_REQUIRES_PRESERVE:{legendaryGroup:!0,environment:!0,soundClip:!0,page:!0,altArt:!0,otherSources:!0,variant:!0,dragonCastingColor:!0},_mergeCache:null,async pMergeCopy(e,n,t){function r(){return e.find(e=>(Renderer.monster._mergeCache[UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_BESTIARY](e)]=e,e.name===n._copy.name&&e.source===n._copy.source))}if(n._copy){const e=UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_BESTIARY](n._copy);Renderer.monster._mergeCache=Renderer.monster._mergeCache||{};const i=Renderer.monster._mergeCache[e]||r();return i?Renderer.monster._pApplyCopy(MiscUtil.copy(i),n,t):void 0}},async _pApplyCopy(copyFrom,copyTo,options={}){var _Mathfloor2=Math.floor;function normaliseMods(e){Object.entries(e._mod).forEach(([n,t])=>{t instanceof Array||(e._mod[n]=[t])})}function doEnsureArray(e,n){e[n]instanceof Array||(e[n]=[e[n]])}function doMod_appendStr(e,n){copyTo[n]=copyTo[n]?`${copyTo[n]}${e.joiner||""}${e.str}`:e.str}function doMod_replaceTxt(e,n){const t=new RegExp(e.replace,`g${e.flags||""}`);copyTo[n]&&copyTo[n].forEach(n=>{n.entries&&(n.entries=JSON.parse(JSON.stringify(n.entries).replace(t,e.with))),n.headerEntries&&(n.headerEntries=JSON.parse(JSON.stringify(n.headerEntries).replace(t,e.with)))})}function doMod_prependArr(e,n){doEnsureArray(e,"items"),copyTo[n]=copyTo[n]?e.items.concat(copyTo[n]):e.items}function doMod_appendArr(e,n){doEnsureArray(e,"items"),copyTo[n]=copyTo[n]?copyTo[n].concat(e.items):e.items}function doMod_replaceArr(e,n,t=!0){if(doEnsureArray(e,"items"),!copyTo[n]){if(t)throw new Error(`Could not find "${n}" array`);return!1}let r;if(e.replace.regex){const t=new RegExp(e.replace.regex,e.replace.flags||"");r=copyTo[n].findIndex(e=>e.name?t.test(e.name):"string"==typeof e&&t.test(e))}else r=copyTo[n].findIndex(n=>n.name?n.name===e.replace:n===e.replace);if(~r)return copyTo[n].splice(r,1,...e.items),!0;if(t)throw new Error(`Could not find "${n}" item with name "${e.replace}" to replace`);return!1}function doMod_replaceOrAppendArr(e,n){const t=doMod_replaceArr(e,n,!1);t||doMod_appendArr(e,n)}function doMod_removeArr(e,n){if(e.names)doEnsureArray(e,"names"),e.names.forEach(e=>{const t=copyTo[n].findIndex(n=>n.name===e);if(~t)copyTo[n].splice(t,1);else throw new Error(`Could not find "${n}" item with name "${e}" to remove`)});else if(e.items)doEnsureArray(e,"items"),e.items.forEach(e=>{const t=copyTo[n].findIndex(n=>n===e);if(~t)copyTo[n].splice(t,1);else throw new Error(`Could not find "${n}" item "${e}" to remove`)});else throw new Error(`One of "names" or "items" must be provided!`)}function doMod_calculateProp(modInfo,prop){copyTo[prop]=copyTo[prop]||{};const toExec=modInfo.formula.replace(/<\$([^$]+)\$>/g,(...e)=>{switch(e[1]){case"prof_bonus":return Parser.crToPb(copyTo.cr);case"dex_mod":return Parser.getAbilityModNumber(copyTo.dex);default:throw new Error(`Unknown variable "${e[1]}"`);}});copyTo[prop][modInfo.prop]=eval(toExec)}function doMod_scalarAddProp(e,n){function t(t){const r=+copyTo[n][t]+e.scalar,i="string"==typeof copyTo[n][t];copyTo[n][t]=i?`${0<=r?"+":""}${r}`:r}copyTo[n]&&("*"===e.prop?Object.keys(copyTo[n]).forEach(e=>t(e)):t(e.prop))}function doMod_scalarMultProp(e,n){function t(t){let r=+copyTo[n][t]*e.scalar;e.floor&&(r=_Mathfloor2(r));const i="string"==typeof copyTo[n][t];copyTo[n][t]=i?`${0<=r?"+":""}${r}`:r}copyTo[n]&&("*"===e.prop?Object.keys(copyTo[n]).forEach(e=>t(e)):t(e.prop))}function doMod_addSenses(e){doEnsureArray(e,"senses"),copyTo.senses=copyTo.senses||[],e.senses.forEach(e=>{let n=!1;for(let t=0;t<copyTo.senses.length;++t){const r=new RegExp(`${e.type} (\\d+)`,"i").exec(copyTo.senses[t]);if(r){n=!0,+r[1]<e.type&&(copyTo.senses[t]=`${e.type} ${e.range} ft.`);break}}n||copyTo.senses.push(`${e.type} ${e.range} ft.`)})}function doMod_addSkills(e){copyTo.skill=copyTo.skill||[],Object.entries(e.skills).forEach(([e,n])=>{const t=n*Parser.crToPb(copyTo.cr)+Parser.getAbilityModNumber(copyTo[Parser.skillToAbilityAbv(e)]),r=0<=t?`+${t}`:`-${t}`;copyTo.skill&&copyTo.skill[e]?+copyTo.skill[e]<t&&(copyTo.skill[e]=r):copyTo.skill[e]=r})}function doMod_addSpells(e){if(!copyTo.spellcasting)throw new Error(`Creature did not have a spellcasting property!`);const n=copyTo.spellcasting[0].spells;Object.keys(e.spells).forEach(t=>{if(!n[t])n[t]=e.spells[t];else{const r=e.spells[t],i=n[t];Object.keys(r).forEach(e=>{if(!i[e])i[e]=r[e];else if("object"!=typeof i[e])i[e]=r[e];else if(i[e]instanceof Array)i[e]=i[e].concat(r[e]).sort(SortUtil.ascSortLower);else throw new Error(`Object at key ${e} not an array!`)})}})}function doMod_replaceSpells(e){if(!copyTo.spellcasting)throw new Error(`Creature did not have a spellcasting property!`);const n=copyTo.spellcasting[0].spells;Object.keys(e.spells).forEach(t=>{if(n[t]){const r=e.spells[t],i=n[t];Object.keys(r).forEach(e=>{if(doEnsureArray(r[e],"with"),i[e])if("object"!=typeof i[e])r[e].replace===i[e]&&(i[e]=r[e].with);else if(i[e]instanceof Array){const n=i[e].indexOf(r[e].replace);~n&&(i[e].splice(n,1,...r[e].with),i[e].sort(SortUtil.ascSortLower))}else throw new Error(`Object at key ${e} not an array!`)})}})}function doMod_scalarAddHit(e,n){copyTo[n]&&(copyTo[n]=JSON.parse(JSON.stringify(copyTo[n]).replace(/{@hit ([-+]?\d+)}/g,(n,t)=>`{@hit ${+t+e.scalar}}`)))}function doMod_scalarAddDc(e,n){copyTo[n]&&(copyTo[n]=JSON.parse(JSON.stringify(copyTo[n]).replace(/{@dc (\d+)}/g,(n,t)=>`{@dc ${+t+e.scalar}}`)))}function doMod_maxSize(e){const n=Parser.SIZE_ABVS.indexOf(copyTo.size),t=Parser.SIZE_ABVS.indexOf(e.max);if(0>n||0>t)throw new Error(`Unhandled size!`);copyTo.size=Parser.SIZE_ABVS[Math.min(n,t)]}function doMod_scalarMultXp(e){function n(n){let t=n*e.scalar;return e.floor&&(t=_Mathfloor2(t)),t}if(copyTo.cr.xp)copyTo.cr.xp=n(copyTo.cr.xp);else{const e=Parser.crToXpNumber(copyTo.cr);copyTo.cr.cr||(copyTo.cr={cr:copyTo.cr}),copyTo.cr.xp=n(e)}}function doMod(e,...n){function t(n){e.forEach(e=>{if("string"==typeof e)switch(e){case"remove":return delete copyTo[n];default:throw new Error(`Unhandled mode: ${e}`);}else switch(e.mode){case"appendStr":return doMod_appendStr(e,n);case"replaceTxt":return doMod_replaceTxt(e,n);case"prependArr":return doMod_prependArr(e,n);case"appendArr":return doMod_appendArr(e,n);case"replaceArr":return doMod_replaceArr(e,n);case"replaceOrAppendArr":return doMod_replaceOrAppendArr(e,n);case"removeArr":return doMod_removeArr(e,n);case"calculateProp":return doMod_calculateProp(e,n);case"scalarAddProp":return doMod_scalarAddProp(e,n);case"scalarMultProp":return doMod_scalarMultProp(e,n);case"addSenses":return doMod_addSenses(e);case"addSkills":return doMod_addSkills(e);case"addSpells":return doMod_addSpells(e);case"replaceSpells":return doMod_replaceSpells(e);case"scalarAddHit":return doMod_scalarAddHit(e,n);case"scalarAddDc":return doMod_scalarAddDc(e,n);case"maxSize":return doMod_maxSize(e);case"scalarMultXp":return doMod_scalarMultXp(e);default:throw new Error(`Unhandled mode: ${e.mode}`);}})}n.forEach(e=>t(e)),n.length||t()}options.doKeepCopy&&(copyTo.__copy=MiscUtil.copy(copyFrom));const copyMeta=copyTo._copy||{};copyMeta._mod&&normaliseMods(copyMeta);let racials=null;if(copyMeta._trait){const e=await DataUtil.loadJSON("data/bestiary/traits.json");if(racials=e.trait.find(e=>e.name.toLowerCase()===copyMeta._trait.name.toLowerCase()&&e.source.toLowerCase()===copyMeta._trait.source.toLowerCase()),!racials)throw new Error(`Could not find traits to apply with name "${copyMeta._trait.name}" and source "${copyMeta._trait.source}"`);racials=MiscUtil.copy(racials),racials.apply._mod&&(normaliseMods(racials.apply),copyMeta._mod?Object.entries(racials.apply._mod).forEach(([e,n])=>{copyMeta._mod[e]=copyMeta._mod[e]?copyMeta._mod[e].concat(n):n}):copyMeta._mod=racials.apply._mod),delete copyMeta._trait}Object.keys(copyFrom).forEach(e=>null===copyTo[e]?delete copyTo[e]:void(null==copyTo[e]&&(Renderer.monster._MERGE_REQUIRES_PRESERVE[e]?copyTo._copy._preserve&&copyTo._copy._preserve[e]&&(copyTo[e]=copyFrom[e]):copyTo[e]=copyFrom[e]))),racials&&racials.apply._root&&Object.entries(racials.apply._root).forEach(([e,n])=>copyTo[e]=n),copyMeta._mod&&(Object.entries(copyMeta._mod).forEach(([k,v])=>{copyMeta._mod[k]=JSON.parse(JSON.stringify(v).replace(/<\$([^$]+)\$>/g,(...m)=>{const parts=m[1].split("__");switch(parts[0]){case"name":return copyTo.name;case"short_name":case"title_name":return copyTo.isNpc?copyTo.name.split(" ")[0]:`${"title_name"===parts[0]?"The ":"the "}${copyTo.name.toLowerCase()}`;case"spell_dc":{if(!Parser.ABIL_ABVS.includes(parts[1]))throw new Error(`Unknown ability score "${parts[1]}"`);return 8+Parser.getAbilityModNumber(+copyTo[parts[1]])+Parser.crToPb(copyTo.cr)}case"to_hit":{if(!Parser.ABIL_ABVS.includes(parts[1]))throw new Error(`Unknown ability score "${parts[1]}"`);const e=Parser.crToPb(copyTo.cr)+Parser.getAbilityModNumber(+copyTo[parts[1]]);return 0<=e?`+${e}`:e}case"damage_mod":{if(!Parser.ABIL_ABVS.includes(parts[1]))throw new Error(`Unknown ability score "${parts[1]}"`);const e=Parser.getAbilityModNumber(+copyTo[parts[1]]);return 0===e?"":0<e?` +${e}`:` ${e}`}case"damage_avg":{const replaced=parts[1].replace(/(str|dex|con|int|wis|cha)/gi,(...e)=>Parser.getAbilityModNumber(+copyTo[e[0]])),clean=replaced.replace(/[^-+/*0-9.,]+/g,"");return _Mathfloor2(eval(clean))}default:return m[0];}}))}),Object.entries(copyMeta._mod).forEach(([e,n])=>{"*"===e?doMod(n,"action","reaction","trait","legendary","variant","spellcasting"):"_"===e?doMod(n):doMod(n,e)})),copyTo._isCopy=!0,delete copyTo._copy},getLegendaryActionIntro:e=>{function n(){if(e.shortName)return e.shortName;const n=e.name.split(",")[0],t=n.replace(/(?:adult|ancient|young) \w+ (dragon|dracolich)/gi,"$1");return e.isNamedCreature?t.split(" ")[0]:t.toLowerCase()}if(e.legendaryHeader)return e.legendaryHeader.map(e=>Renderer.get().render(e)).join("</p><p>");else{const t=e.legendaryActions||3,r=n();return`${e.isNamedCreature?"":"The "}${r} can take ${t} legendary action${1<t?"s":""}, choosing from the options below. Only one legendary action can be used at a time and only at the end of another creature's turn. ${e.isNamedCreature?"":"The "}${r} regains spent legendary actions at the start of its turn.`}},getSave(e,n,t){return"special"===n?e.render(t):e.render(`<span data-mon-save="${n.uppercaseFirst()}|${t}">${n.uppercaseFirst()} {@d20 ${t}|${t}|${Parser.attAbvToFull([n])} save}</span>`)},getDragonCasterVariant(e,n){if(!n.dragonCastingColor||n.spellcasting)return null;const t=Parser.getAbilityModNumber(n.cha),r=Parser.crToPb(n.cr),i=Math.floor(Parser.crToNumber(n.cr)/3),d=function(e,n){return({2:{B:["darkness","Melf's acid arrow","fog cloud","scorching ray"],G:["ray of sickness","charm person","detect thoughts","invisibility","suggestion"],W:["ice knife|XGE","Snilloc's snowball swarm|XGE"],A:["see invisibility","magic mouth","blindness/deafness","sleep","detect thoughts"],Z:["gust of wind","misty step","locate object","blur","witch bolt","thunderwave","shield"],C:["knock","sleep","detect thoughts","blindness/deafness","tasha's hideous laughter"]},3:{U:["wall of sand|XGE","thunder step|XGE","lightning bolt","blink","magic missile","slow"],R:["fireball","scorching ray","haste","erupting earth|XGE","Aganazzar's scorcher|XGE"],O:["slow","slow","fireball","dispel magic","counterspell","Aganazzar's scorcher|XGE","shield"],S:["sleet storm","protection from energy","catnap|XGE","locate object","identify","Leomund's tiny hut"]},4:{B:["vitriolic sphere|XGE","sickening radiance|XGE","Evard's black tentacles","blight","hunger of Hadar"],W:["fire shield","ice storm","sleet storm"],A:["charm monster|XGE","sending","wall of sand|XGE","hypnotic pattern","tongues"],C:["polymorph","greater invisibility","confusion","stinking cloud","major image","charm monster|XGE"]},5:{U:["telekinesis","hold monster","dimension door","wall of stone","wall of force"],G:["cloudkill","charm monster|XGE","modify memory","mislead","hallucinatory terrain","dimension door"],Z:["steel wind strike|XGE","control weather","control winds|XGE","watery sphere|XGE","storm sphere|XGE","tidal wave|XGE"],O:["hold monster","immolation|XGE","wall of fire","greater invisibility","dimension door"],S:["cone of cold","ice storm","teleportation circle","skill empowerment|XGE","creation","Mordenkainen's private sanctum"]},6:{W:["cone of cold","wall of ice"],A:["scrying","Rary's telepathic bond","Otto's irresistible dance","legend lore","hold monster","dream"]},7:{B:["power word pain|XGE","finger of death","disintegrate","hold monster"],U:["chain lightning","forcecage","teleport","etherealness"],G:["project image","mirage arcane","prismatic spray","teleport"],Z:["whirlwind|XGE","chain lightning","scatter|XGE","teleport","disintegrate","lightning bolt"],C:["symbol","simulacrum","reverse gravity","project image","Bigby's hand","mental prison|XGE","seeming"],S:["Otiluke's freezing sphere","prismatic spray","wall of ice","contingency","arcane gate"]},8:{O:["sunburst","delayed blast fireball","antimagic field","teleport","globe of invulnerability","maze"]}}[e]||{})[n]}(i,n.dragonCastingColor),s=0===i?`${1===t?"This":"These"} spells are Cantrips.`:`${1===t?"The":"Each"} spell's level can be no higher than ${Parser.spLevelToFull(i)}.`,o={type:"variant",name:"Dragons as Innate Spellcasters",entries:["Dragons are innately magical creatures that can master a few spells as they age, using this variant.",`A young or older dragon can innately cast a number of spells equal to its Charisma modifier. Each spell can be cast once per day, requiring no material components, and the spell's level can be no higher than one-third the dragon's challenge rating (rounded down). The dragon's bonus to hit with spell attacks is equal to its proficiency bonus + its Charisma bonus. The dragon's spell save DC equals 8 + its proficiency bonus + its Charisma modifier.`,`{@i This dragon can innately cast ${Parser.numberToText(t)} spell${1===t?"":"s"}, once per day${1===t?"":" each"}, requiring no material components. ${s} The dragon's spell save DC is ${r+t+8}, and it has {@hit ${r+t}} to hit with spell attacks. See the {@filter spell page|spells|level=${[...Array(i+1)].map((e,n)=>n).join(";")}} for a list of spells the dragon is capable of casting.${d?` A selection of examples are shown below:`:""}`]};if(d){const e={type:"list",style:"italic",items:d.map(e=>`{@spell ${e}}`)};o.entries.push(e)}return e.render(o)},getCrScaleTarget(e,n,t,r){function i(){d.find(`.mon__cr_slider_wrp`).remove()}const d=$(`body`),s=$(`<div class="mon__cr_slider_wrp ${r?"mon__cr_slider_wrp--compact":""}"/>`),o=$(`<div class="mon__cr_slider"/>`).appendTo(s),l=Parser.CRS.indexOf(n);if(-1===l)throw new Error(`Initial CR ${n} was not valid!`);i();e.off("click.cr-scaler").on("click.cr-scaler",e=>e.stopPropagation()),s.on("click.cr-scaler",e=>e.stopPropagation()),d.off("click.cr-scaler").on("click.cr-scaler",i);const u={labels:Parser.CRS};o.slider({min:0,max:Parser.CRS.length-1,value:l}).slider("pips",u).slider("float",u),o.slider().on("slidechange",()=>{const e=o.slider("value");t(Parser.crToNumber(Parser.CRS[e])),d.off("click.cr-scaler"),i()}),e.after(s)},getCompactRenderedStringSection(e,n,t,r,i){return e[r]?`
		<tr class="mon__stat-header-underline"><td colspan="6"><span class="mon__sect-header-inner">${t}</span></td></tr>
		<tr class="text compact"><td colspan="6">
		${"legendary"===r&&e.legendary?`<p>${Renderer.monster.getLegendaryActionIntro(e)}</p>`:""}
		${e[r].map(e=>e.rendered||n.render(e,i)).join("")}
		</td></tr>
		`:""},getCompactRenderedString:(e,n,t={})=>{n=n||Renderer.get();const r=[],i=100===Parser.crToNumber(e.cr);return r.push(`
			${Renderer.utils.getNameTr(e,{isAddPageNum:!0})}
			<tr><td colspan="6"><i>${Parser.sizeAbvToFull(e.size)}, ${Parser.monTypeToFullObj(e.type).asText}, ${Parser.alignmentListToFull(e.alignment).toLowerCase()}</i></td></tr>
			<tr><td colspan="6"><div class="border"></div></td></tr>
			<tr><td colspan="6">
				<table class="summary-noback" style="position: relative;">
					<tr>
						<th>Armor Class</th>
						<th>Hit Points</th>
						<th>Speed</th>
						${i?"":"<th>Challenge Rating</th>"}
					</tr>
					<tr>
						<td>${Parser.acToFull(e.ac)}</td>					
						<td>${Renderer.monster.getRenderedHp(e.hp)}</td>					
						<td>${Parser.getSpeedString(e)}</td>	
						${i?"":`
						<td>
							${Parser.monCrToFull(e.cr)}
							${t.showScaler&&Parser.isValidCr(e.cr.cr||e.cr)?`
							<button title="Scale Creature By CR (Highly Experimental)" class="mon__btn-scale-cr btn btn-xs btn-default">
								<span class="glyphicon glyphicon-signal"></span>
							</button>
							`:""}
							${t.isScaled?`
							<button title="Reset CR Scaling" class="mon__btn-reset-cr btn btn-xs btn-default">
								<span class="glyphicon glyphicon-refresh"></span>
							</button>
							`:""}
						</td>
						`}					
					</tr>
				</table>			
			</td></tr>
			<tr><td colspan="6"><div class="border"></div></td></tr>
			<tr><td colspan="6">
				<table class="summary striped-even">
					<tr>
						<th class="col-2 text-center">STR</th>
						<th class="col-2 text-center">DEX</th>
						<th class="col-2 text-center">CON</th>
						<th class="col-2 text-center">INT</th>
						<th class="col-2 text-center">WIS</th>
						<th class="col-2 text-center">CHA</th>
					</tr>	
					<tr>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"str")}</td>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"dex")}</td>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"con")}</td>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"int")}</td>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"wis")}</td>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"cha")}</td>
					</tr>
				</table>
			</td></tr>
			<tr><td colspan="6"><div class="border"></div></td></tr>
			<tr><td colspan="6">
				<div class="rd__compact-stat">
					${e.save?`<p><b>Saving Throws:</b> ${Object.keys(e.save).sort(SortUtil.ascSortAtts).map(t=>Renderer.monster.getSave(n,t,e.save[t])).join(", ")}</p>`:""}
					${e.skill?`<p><b>Skills:</b> ${Renderer.monster.getSkillsString(n,e)}</p>`:""}
					<p><b>Senses:</b> ${e.senses?`${Renderer.monster.getRenderedSenses(e.senses)}, `:""}passive Perception ${e.passive}</p>
					<p><b>Languages:</b> ${Renderer.monster.getRenderedLanguages(e.languages)}</p>
					${e.vulnerable?`<p><b>Damage Vuln.:</b> ${Parser.monImmResToFull(e.vulnerable)}</p>`:""}
					${e.resist?`<p><b>Damage Res.:</b> ${Parser.monImmResToFull(e.resist)}</p>`:""}
					${e.immune?`<p><b>Damage Imm.:</b> ${Parser.monImmResToFull(e.immune)}</p>`:""}
					${e.conditionImmune?`<p><b>Condition Imm.:</b> ${Parser.monCondImmToFull(e.conditionImmune)}</p>`:""}
				</div>
			</td></tr>
			${e.trait||e.spellcasting?`<tr><td colspan="6"><div class="border"></div></td></tr>
			<tr class="text compact"><td colspan="6">
			${Renderer.monster.getOrderedTraits(e,n).map(e=>e.rendered||n.render(e,2)).join("")}
			</td></tr>`:""}
			${Renderer.monster.getCompactRenderedStringSection(e,n,"Actions","action",2)}
			${Renderer.monster.getCompactRenderedStringSection(e,n,"Reactions","reaction",2)}
			${Renderer.monster.getCompactRenderedStringSection(e,n,"Legendary Actions","legendary",2)}
			${e.variant||e.dragonCastingColor&&!e.spellcasting?`
			<tr class="text compact"><td colspan="6">
			${e.variant?e.variant.map(e=>e.rendered||n.render(e)).join(""):""}
			${e.dragonCastingColor?Renderer.monster.getDragonCasterVariant(n,e):""}
			</td></tr>
			`:""}
		`),r.join("")},getRenderedHp:e=>{function n(){const n=/^(\d+)d(\d+)([-+]\d+)?$/i.exec(e.formula);if(n){const e=+n[1],t=+n[2],r=n[3]?+n[3]:0;return`Maximum: ${e*t+r}`}return""}if(null!=e.special)return e.special;if(/^\d+d1$/.exec(e.formula))return e.average;else{const t=n(e.formula);return`${t?`<span title="${t}" class="help--subtle">`:""}${e.average}${t?"</span>":""} ${Renderer.get().render(`({@dice ${e.formula}|${e.formula}|Hit Points})`)}`}},getSpellcastingRenderedTraits:(e,n)=>{const t=[];return e.spellcasting.forEach(e=>{e.type=e.type||"spellcasting";const r=[];n.recursiveRender(e,r,{depth:2}),t.push({name:e.name,rendered:r.join("")})}),t},getOrderedTraits:(e,n)=>{let t=e.trait?JSON.parse(JSON.stringify(e.trait)):null;if(e.spellcasting){const r=Renderer.monster.getSpellcastingRenderedTraits(e,n);t=t?t.concat(r):r}return t?t.sort((e,n)=>SortUtil.monTraitSort(e.name,n.name)):void 0},getSkillsString(e,n){function t(e,n){return Renderer.get().render(`{@d20 ${n}|${n}|${e}`)}function r(n,r,i){const d=r.sort(SortUtil.ascSort).map(r=>`<span data-mon-skill="${r.toTitleCase()}|${n[r]}">${e.render(`{@skill ${r.toTitleCase()}}`)} ${t(r.toTitleCase(),n[r])}</span>`);return i?d.joinConjunct(", "," or "):d.join(", ")}const i=r(n.skill,Object.keys(n.skill).filter(e=>"other"!==e&&"special"!==e));if(n.skill.other||n.skill.special){const e=n.skill.other&&n.skill.other.map(e=>{if(e.oneOf)return`plus one of the following: ${r(e.oneOf,Object.keys(e.oneOf),!0)}`;throw new Error(`Unhandled monster "other" skill properties!`)}),t=n.skill.special&&Renderer.get().render(n.skill.special);return[i,e,t].filter(Boolean).join(", ")}return i},getTokenUrl(e){return e.tokenUrl||UrlUtil.link(`img/${Parser.sourceJsonToAbv(e.source)}/${Parser.nameToTokenName(e.name)}.png`)},getFluff(e,n,t){function r(t){if(l)return;l=!0;const r=n[e.legendaryGroup.source][e.legendaryGroup.name],i=(e,n)=>{r[e]&&t.entries.push({type:"section",entries:[{type:"entries",entries:[{type:"entries",name:n,entries:MiscUtil.copy(r[e])}]}]})};i("lairActions","Lair Actions"),i("regionalEffects","Regional Effects")}function i(d){const s=MiscUtil.copy(d.fluff);d.fluff=s;const o=s._appendCopy;if(s._copy){const o=MiscUtil.copy(t.monster.find(e=>s._copy.name===e.name&&s._copy.source===e.source)),l=s.name,u=s.source,p=s.images;delete s._copy,Object.assign(s,o),s.name=l,s.source=u,p&&(s.images=p),s.entries&&e.legendaryGroup&&(n[e.legendaryGroup.source]||{})[e.legendaryGroup.name]&&r(s),i(d)}if(o){const l=MiscUtil.copy(t.monster.find(e=>o.name===e.name&&o.source===e.source));l.images&&(s.images?s.images=s.images.concat(l.images):s.images=l.images),l.entries&&(s.entries?"section"===(l.entries[0]||{}).type?s.entries=s.entries.concat(l.entries):s.entries=s.entries.concat({type:"section",entries:l.entries}):s.entries=l.entries),delete s._appendCopy,s._copy=l._copy,s._appendCopy=l._appendCopy,s.entries&&e.legendaryGroup&&(n[e.legendaryGroup.source]||{})[e.legendaryGroup.name]&&r(s),i(d)}}const d=Renderer.utils.getPredefinedFluff(e,"monsterFluff"),s=d||(t||{monster:[]}).monster.find(n=>n.name===e.name&&n.source===e.source);if(!s)return null;const o=MiscUtil.copy(s);let l=!1;o.entries&&e.legendaryGroup&&(n[e.legendaryGroup.source]||{})[e.legendaryGroup.name]&&r(o);const u={fluff:o};return(u.fluff._copy||u.fluff._appendCopy)&&i(u),u.fluff},getRenderedSenses(e){"string"==typeof e&&(e=[e]);const n=e.join(", ").replace(/(^| )(tremorsense|blindsight|truesight|darkvision)( |$)/gi,(...e)=>`${e[1]}{@sense ${e[2]}}${e[3]}`);return Renderer.get().render(n)},getRenderedLanguages(e){return"string"==typeof e&&(e=[e]),e?e.join(", "):"\u2014"}},Renderer.item={LINK_SPECIFIC_TO_GENERIC_DIRECTION:1,getDamageAndPropertiesText:function(e){function n(n,t){return SortUtil.ascSort(e._allPropertiesPtr[n].name,e._allPropertiesPtr[t].name)}const t=e.type||"";let r="",i="";if(e.weaponCategory)e.dmg1&&(r=Renderer.get().render(e.dmg1)),e.dmgType&&(i=Parser.dmgTypeToFull(e.dmgType));else if("LA"===t||"MA"===t||"HA"===t)r="AC "+e.ac+("LA"===t?" + Dex":"MA"===t?" + Dex (max 2)":"");else if("S"===t)r="AC +"+e.ac;else if("MNT"===t||"VEH"===t||"SHP"===t||"AIR"===t){const n=e.speed,i=e.carryingcapacity;n&&(r+="Speed: "+n),n&&i&&(r+="MNT"===t?", ":"<br>"),i&&(r+="Carrying Capacity: "+i,-1===i.indexOf("ton")&&-1===i.indexOf("passenger")&&(r+=1===+i?" lb.":" lbs.")),("SHP"===t||"AIR"===t)&&(r+=`<br>Crew ${e.crew}, AC ${e.vehAc}, HP ${e.vehHp}${e.vehDmgThresh?`, Damage Threshold ${e.vehDmgThresh}`:""}`)}let d="";if(e.property){const t=e.property.sort(n);for(let n=0;n<t.length;++n){const r=t[n];let i=e._allPropertiesPtr[r].name;"V"===r&&(i=`${i} (${Renderer.get().render(e.dmg2)})`),("T"===r||"A"===r||"AF"===r)&&(i=`${i} (${e.range} ft.)`),"RLD"===r&&(i=`${i} (${e.reload} shots)`),i=(0<n?", ":e.dmg1?"- ":"")+i,d+=i}}else{const n=[];e.range&&n.push(`range ${e.range} ft.`),d+=`${e.dmg1?" - ":""}${n.join(", ")}`}return[r,i,d]},getTypeRarityAndAttunementText(e){const n=["Other"===e.typeText?"":e.typeText.trim(),[e.tier,e.rarity&&Renderer.item.doRenderRarity(e.rarity)?e.rarity:""].map(e=>(e||"").trim()).filter(e=>e).join(", ")].filter(Boolean).join(", ");return e.reqAttune?`${n} ${e.reqAttune}`:n},getCompactRenderedString:function(e){const n=Renderer.get(),t=[];t.push(Renderer.utils.getNameTr(e,{isAddPageNum:!0})),t.push(`<tr><td class="typerarityattunement" colspan="6">${Renderer.item.getTypeRarityAndAttunementText(e)}</td>`);const[r,i,d]=Renderer.item.getDamageAndPropertiesText(e);if(t.push(`<tr>
			<td colspan="2">${[Parser.itemValueToFull(e),Parser.itemWeightToFull(e)].filter(Boolean).join(", ").uppercaseFirst()}</td>
			<td class="text-right" colspan="4">${r} ${i} ${d}</td>
		</tr>`),e.entries&&e.entries.length){t.push(Renderer.utils.getDividerTr()),t.push(`<tr class='text'><td colspan='6' class='text'>`);const r={type:"entries",entries:e.entries};if(n.recursiveRender(r,t,{depth:1}),e.additionalEntries){const r={type:"entries",entries:e.additionalEntries};n.recursiveRender(r,t,{depth:1})}t.push(`</td></tr>`)}return t.join("")},_hiddenRarity:new Set(["None","Unknown","Unknown (Magic)","Varies"]),doRenderRarity(e){return!Renderer.item._hiddenRarity.has(e)},_builtLists:{},_propertyMap:{},_typeMap:{},_additionalEntriesMap:{},_addProperty(e){Renderer.item._propertyMap[e.abbreviation]||(Renderer.item._propertyMap[e.abbreviation]=e.name?MiscUtil.copy(e):{name:e.entries[0].name.toLowerCase(),entries:e.entries})},_addType(e){Renderer.item._typeMap[e.abbreviation]||(Renderer.item._typeMap[e.abbreviation]=e.name?MiscUtil.copy(e):{name:e.entries[0].name.toLowerCase(),entries:e.entries})},_addAdditionalEntries(n){Renderer.item._additionalEntriesMap[n.appliesTo]||(Renderer.item._additionalEntriesMap[n.appliesTo]=MiscUtil.copy(n.entries))},_pAddBrewPropertiesAndTypes(){return new Promise(e=>{BrewUtil.pAddBrewData().then(n=>{(n.itemProperty||[]).forEach(e=>Renderer.item._addProperty(e)),(n.itemType||[]).forEach(e=>Renderer.item._addType(e)),e()}).catch(BrewUtil.pPurgeBrew)})},_addBasePropertiesAndTypes(e){e.itemProperty.forEach(e=>Renderer.item._addProperty(e)),e.itemType.forEach(e=>{if("SHP"===e.abbreviation){const n=MiscUtil.copy(e);n.abbreviation="AIR",Renderer.item._addType(n)}Renderer.item._addType(e)}),e.itemTypeAdditionalEntries.forEach(n=>Renderer.item._addAdditionalEntries(n))},async pBuildList(e){e=e||{},e.isAddGroups=!!e.isAddGroups,e.urls=e.urls||{};const n=e.isBlacklistVariants?"withBlacklist":"withoutBlacklist";if(Renderer.item._builtLists[n]){const t=e.isAddGroups?Renderer.item._builtLists[n]:Renderer.item._builtLists[n].filter(e=>!e._isItemGroup);return e.fnCallback?e.fnCallback(t):t}const t=e.urls.items||`${Renderer.get().baseUrl}data/items.json`,r=e.urls.baseitems||`${Renderer.get().baseUrl}data/items-base.json`,i=e.urls.magicvariants||`${Renderer.get().baseUrl}data/magicvariants.json`,d=await async function(){const e=await DataUtil.loadJSON(t),n=e.item;return e.itemGroup.forEach(e=>e._isItemGroup=!0),[...n,...e.itemGroup]}(),s=await Renderer.item._pGetAndProcBaseItems((await DataUtil.loadJSON(r))),[o,l]=await Renderer.item._pGetAndProcGenericVariants((await DataUtil.loadJSON(i)),!0),u=Renderer.item._createSpecificVariants(s,o,l),p=d.concat(s).concat(u);return Renderer.item._enhanceItems(p),Renderer.item._builtLists[n]=p,e.fnCallback?e.fnCallback(p):p},async _pGetAndProcBaseItems(e){return Renderer.item._addBasePropertiesAndTypes(e),await Renderer.item._pAddBrewPropertiesAndTypes(),e.baseitem},async _pGetAndProcGenericVariants(e,n){return e.variant.forEach(Renderer.item._genericVariants_addInheritedPropertiesToSelf),n?[e.variant.filter(e=>!ExcludeUtil.isExcluded(e.name,"variant",e.source)),e.linkedLootTables]:[e.variant,e.linkedLootTables]},_createSpecificVariants(e,n,t){function r(e,n){return!~n.requires.findIndex(n=>!~Object.keys(n).findIndex(t=>e[t]!==n[t]))}function i(e,n){const t=n.excludes||{};return!!Object.keys(t).find(n=>t[n]instanceof Array?e[n]instanceof Array?e[n].find(e=>t[n].includes(e)):t[n].includes(e[n]):e[n]instanceof Array?e[n].find(e=>t[n]===e):t[n]===e[n])}function d(e,n){const r=n.inherits,d=MiscUtil.copy(e);return e.source!==SRC_PHB&&e.source!==SRC_DMG&&d.entries.unshift(`{@note The base item can be found in ${Parser.sourceJsonToFull(e.source)}.}`),delete d.value,d.category="Specific Variant",Object.keys(r).forEach(n=>{switch(n){case"namePrefix":d.name=`${r.namePrefix}${d.name}`;break;case"nameSuffix":d.name=`${d.name}${r.nameSuffix}`;break;case"entries":{r.entries.forEach((n,t)=>{"string"==typeof n&&(n=Renderer.applyProperties(n,Renderer.item._getInjectableProps(e,r))),d.entries.splice(t,0,n)});break}default:d[n]=r[n];}}),~Renderer.item.LINK_SPECIFIC_TO_GENERIC_DIRECTION&&(n.variants=n.variants||[],n.variants.push({base:e,specificVariant:d})),~Renderer.item.LINK_SPECIFIC_TO_GENERIC_DIRECTION||(d.genericVariant=n),t&&t[d.source]&&t[d.source][d.name]&&(d.lootTables=d.lootTables||[]).push(...t[d.source][d.name]),d}const s=[...n];return e.forEach(e=>{e.category="Basic",null==e.entries&&(e.entries=[]),e.quantity||n.forEach(n=>{r(e,n)||i(e,n)||s.push(d(e,n))})}),s},_enhanceItems(e){return e.forEach(e=>Renderer.item.enhanceItem(e)),e},async pGetGenericAndSpecificVariants(e,n){n=n||{},n.baseItemsUrl=n.baseItemsUrl||`${Renderer.get().baseUrl}data/items-base.json`;const t=await DataUtil.loadJSON(n.baseItemsUrl),r=t.baseitem.concat(n.additionalBaseItems||[]);Renderer.item._addBasePropertiesAndTypes(t),await Renderer.item._pAddBrewPropertiesAndTypes(),e.forEach(Renderer.item._genericVariants_addInheritedPropertiesToSelf);const i=Renderer.item._createSpecificVariants(r,e);return Renderer.item._enhanceItems(i)},_getInjectableProps(e,n){return{baseName:e.name,dmgType:e.dmgType?Parser.dmgTypeToFull(e.dmgType):null,genericBonus:n.genericBonus}},_genericVariants_addInheritedPropertiesToSelf(e){e.tier=e.inherits.tier,e.rarity=e.inherits.rarity,e.source=e.inherits.source,e.page=e.inherits.page,!e.entries&&e.inherits.entries&&(e.entries=MiscUtil.copy(e.inherits.entries.map(n=>"string"==typeof n?Renderer.applyProperties(n,e.inherits):n))),e.requires.armor&&(e.armor=e.requires.armor),e.inherits.resist&&(e.resist=e.inherits.resist),e.inherits.reqAttune&&(e.reqAttune=e.inherits.reqAttune),e.inherits.lootTables&&(e.lootTables=e.inherits.lootTables)},_priceRe:/^(\d+)(\w+)$/,enhanceItem(n){if(n._isEnhanced)return;if(n._isEnhanced=!0,n.noDisplay)return;if("GV"===n.type&&(n.category="Generic Variant"),null==n.category&&(n.category="Other"),null==n.entries&&(n.entries=[]),n.type&&Renderer.item._typeMap[n.type]&&Renderer.item._typeMap[n.type].entries.forEach(t=>!("A"===n.type&&n.ammunition)&&n.entries.push(t)),n.property&&n.property.forEach(e=>{if(!Renderer.item._propertyMap[e])throw new Error(`Item property ${e} not found. You probably meant to load the property/type reference first; see \`Renderer.item.populatePropertyAndTypeReference()\`.`);Renderer.item._propertyMap[e].entries&&Renderer.item._propertyMap[e].entries.forEach(t=>{n.entries.push(t)})}),n.armor?(n.resist&&n.entries.push("You have resistance to "+n.resist+" damage while you wear this armor."),n.armor&&n.stealth&&n.entries.push("The wearer has disadvantage on Stealth (Dexterity) checks."),"HA"===n.type&&n.strength&&n.entries.push("If the wearer has a Strength score lower than "+n.strength+", their speed is reduced by 10 feet.")):n.resist&&("P"===n.type&&n.entries.push("When you drink this potion, you gain resistance to "+n.resist+" damage for 1 hour."),"RG"===n.type&&n.entries.push("You have resistance to "+n.resist+" damage while wearing this ring.")),"SCF"===n.type&&("arcane"===n.scfType&&n.entries.push("An arcane focus is a special item designed to channel the power of arcane spells. A sorcerer, warlock, or wizard can use such an item as a spellcasting focus, using it in place of any material component which does not list a cost."),"druid"===n.scfType&&n.entries.push("A druid can use such a druidic focus as a spellcasting focus, using it in place of any material component that does not have a cost."),"holy"===n.scfType&&(n.entries.push("A holy symbol is a representation of a god or pantheon."),n.entries.push("A cleric or paladin can use a holy symbol as a spellcasting focus, using it in place of any material components which do not list a cost. To use the symbol in this way, the caster must hold it in hand, wear it visibly, or bear it on a shield."))),("T"===n.type||"AT"===n.type||"INS"===n.type||"GS"===n.type)&&(n.additionalEntries=n.additionalEntries||[]).push({type:"hr"},`{@note See the {@5etools Tool Proficiencies|variantrules.html|${UrlUtil.encodeForHash(["Tool Proficiencies","XGE"])}} entry on the Variant and Optional rules page for more information.}`),n.type&&Renderer.item._additionalEntriesMap[n.type]){const e=Renderer.item._additionalEntriesMap[n.type];(n.additionalEntries=n.additionalEntries||[]).push({type:"entries",entries:e})}n.property&&(n._allPropertiesPtr=Renderer.item._propertyMap);const t=[],r=[],i=[];let d=!1;if(n.wondrous&&(t.push("Wondrous Item"),r.push("Wondrous Item"),i.push("Wondrous Item")),n.staff&&(t.push("Staff"),r.push("Staff"),i.push("Staff")),n.firearm&&(t.push("Firearm"),r.push("Firearm"),i.push("Firearm")),n.age&&(t.push(n.age),r.push(n.age),i.push(n.age)),n.weaponCategory&&(t.push(`${n.weaponCategory} Weapon${n.baseItem?` (${Renderer.get().render(`{@item ${n.baseItem}`)})`:""}`),r.push(`${n.weaponCategory} Weapon`),i.push(`${n.weaponCategory} Weapon`),d=!0),n.type){const e=Parser.itemTypeToAbv(n.type);d||!n.baseItem?t.push(e):t.push(`${e} (${Renderer.get().render(`{@item ${n.baseItem}`)})`),r.push(e),i.push(e)}n.poison&&(t.push("Poison"),r.push("Poison"),i.push("Poison")),n.procType=r,n.typeText=t.join(", "),n.typeListText=i.join(", ");let s="No";if(null!=n.reqAttune&&(!0===n.reqAttune?(s="Yes",n.reqAttune="(Requires Attunement)"):"OPTIONAL"===n.reqAttune?(s="Optional",n.reqAttune="(Attunement Optional)"):n.reqAttune.toLowerCase().startsWith("by")?(s="By...",n.reqAttune="(Requires Attunement "+n.reqAttune+")"):(s="Yes",n.reqAttune="(Requires Attunement "+n.reqAttune+")")),n.attunementCategory=s,n._isItemGroup&&n.entries.push("Multiple variants of this item exist, as listed below:",{type:"list",items:n.items.map(e=>"string"==typeof e?`{@item ${e}}`:`{@item ${e.name}|${e.source}}`)}),n.value&&5<n.value.length){const e=Renderer.item._priceRe.exec(n.value);e&&(n.value=`${(+e[1]).toLocaleString()}${e[2]}`)}(function(e){function n(e){return`{@item ${e.name}|${e.source}}`}const t=e.variants;if(t&&t.length){const r=e.entries;r.push({type:"entries",name:"Base items",entries:["This item variant can be applied to the following base items:",{type:"list",items:t.map(({base:e,specificVariant:t})=>`${n(e)} (${n(t)})`)}]})}})(n)},async getItemsFromHomebrew(e){(e.itemProperty||[]).forEach(e=>Renderer.item._addProperty(e)),(e.itemType||[]).forEach(e=>Renderer.item._addType(e));let n=(e.baseitem||[]).concat(e.item||[]);if(Renderer.item._enhanceItems(n),e.variant&&e.variant.length){const t=await Renderer.item.pGetGenericAndSpecificVariants(e.variant,{additionalBaseItems:e.baseitem||[]});n=n.concat(t)}return n},modifierPostToPre(e){const n=/^(.*)(?:,)? (\+\d+)$/.exec(e.name);return n?Object.assign(MiscUtil.copy(e),{name:`${n[2]} ${n[1]}`}):null},_isRefPopulated:!1,populatePropertyAndTypeReference:()=>Renderer.item._isRefPopulated?Promise.resolve():new Promise((e,n)=>{DataUtil.loadJSON(`${Renderer.get().baseUrl}data/items-base.json`).then(t=>{if(Renderer.item._isRefPopulated)e();else try{t.itemProperty.forEach(e=>Renderer.item._addProperty(e)),t.itemType.forEach(e=>Renderer.item._addType(e)),t.itemTypeAdditionalEntries.forEach(n=>Renderer.item._addAdditionalEntries(n)),Renderer.item._pAddBrewPropertiesAndTypes().then(()=>{Renderer.item._isRefPopulated=!0,e()})}catch(t){n(t)}})}),async getAllIndexableItems(e,n){Renderer.item.LINK_SPECIFIC_TO_GENERIC_DIRECTION=-1;const t=await Renderer.item._pGetAndProcBaseItems(n),[r,i]=await Renderer.item._pGetAndProcGenericVariants(e),d=Renderer.item._createSpecificVariants(t,r,i),s=[];return d.forEach(e=>{e.variants&&delete e.variants;const n=Renderer.item.modifierPostToPre(MiscUtil.copy(e));n&&s.push(n)}),d.push(...s),d}},Renderer.psionic={enhanceMode:e=>{function n(e,n){n=null!=n&&n;const t=[],r=function(){const n=[];return e.cost&&n.push(function(){const n=e.cost.min,t=e.cost.max,r=n===t?n:`${n}-${t}`;return`${r} psi`}()),e.concentration&&n.push(function(){return`conc., ${e.concentration.duration} ${e.concentration.unit}.`}()),0===n.length?null:`(${n.join("; ")})`}();return null!==r&&t.push(r),n?`${t.join(" ")}`:`${t.join(" ")}</span>`}e.enhanced||(e.name=`${e.name} ${n(e,!1)}`,e.submodes&&e.submodes.forEach(e=>{e.name=`${e.name} ${n(e,!0)}`}),e.enhanced=!0)},getTalentText:(e,n)=>{const t=[];return n.recursiveRender({entries:e.entries,type:"entries"},t),t.join("")},getDisciplineText:(e,n)=>{const t=[];for(let r=0;r<e.modes.length;++r)t.push(Renderer.psionic.getModeString(e,n,r));return`${Renderer.psionic.getDescriptionString(e,n)}${Renderer.psionic.getFocusString(e,n)}${t.join("")}`},getDescriptionString:(e,n)=>`<p>${n.render({type:"inline",entries:[e.description]})}</p>`,getFocusString:(e,n)=>`<p><span class='psi-focus-title'>Psychic Focus.</span> ${n.render({type:"inline",entries:[e.focus]})}</p>`,getModeString:(e,n,t)=>{const r=e.modes[t];Renderer.psionic.enhanceMode(r,!1);const i=[];n.recursiveRender(r,i,{depth:2});const d=i.join("");if(null==e.modes[t].submodes)return d;const s=function(){const r=e.modes[t].submodes,d={type:"list",style:"list-hang-notitle",items:[]};for(let e=0;e<r.length;++e)d.items.push({type:"item",name:r[e].name,entry:r[e].entries.join("<br>")});const s=[];return n.recursiveRender(d,s,{depth:2}),s.join("")}();return`${d}${s}`},getCompactRenderedString:e=>{const n=Renderer.get(),t="T"===e.type?Parser.psiTypeToFull(e.type):`${e.order} ${Parser.psiTypeToFull(e.type)}`,r="T"===e.type?Renderer.psionic.getTalentText(e,n):Renderer.psionic.getDisciplineText(e,n);return`
			${Renderer.utils.getNameTr(e,{isAddPageNum:!0})}
			<tr class="text"><td colspan="6">
			<p><i>${t}</i></p>
			${r}
			</td></tr>
		`}},Renderer.rule={getCompactRenderedString(e){return`
			<tr><td colspan="6">
			${Renderer.get().setFirstSection(!0).render(e)}
			</td></tr>
		`}},Renderer.variantrule={getCompactRenderedString(e){return`
			<tr><td colspan="6">
			${Renderer.get().setFirstSection(!0).render(e)}
			</td></tr>
		`}},Renderer.table={getCompactRenderedString(e){return e.type=e.type||"table",`
			<tr class="text"><td colspan="6">
			${Renderer.get().setFirstSection(!0).render(e)}
			</td></tr>
		`}},Renderer.ship={getCompactRenderedString(e){return Renderer.ship.getRenderedString(e)},getRenderedString(e){function n(e){return`<tr class="mon__stat-header-underline"><td colspan="6"><span>${e}</span></td></tr>`}function t(e,n){return e.ac||e.hp?`
				<div><b>Armor Class</b> ${e.ac}</div>
				<div><b>Hit Points</b> ${e.hp}${n?` each`:""}${e.dt?` (damage threshold ${e.dt})`:""}${e.hpNote?`; ${e.hpNote}`:""}</div>
			`:""}const r=Renderer.get();return`
			${Renderer.utils.getBorderTr()}
			${Renderer.utils.getNameTr(e)}
			<tr class="text"><td colspan="6"><i>${Parser.sizeAbvToFull(e.size)} vehicle${e.dimensions?`, (${e.dimensions.join(" by ")})`:""}</i><br></td></tr>
			<tr class="text"><td colspan="6">
				<div><b>Creature Capacity</b> ${e.capCrew} crew${e.capPassenger?`, ${e.capPassenger} passengers`:""}</div>
				${e.capCargo?`<div><b>Cargo Capacity</b> ${"string"==typeof e.capCargo?e.capCargo:`${e.capCargo} ton${1===e.capCargo?"":"s"}`}</div>`:""}
				<div><b>Travel Pace</b> ${e.pace} miles per hour (${24*e.pace} miles per day)</div>
			</td></tr>
			<tr><td colspan="6">
				<table class="summary striped-even">
					<tr>
						<th class="col-2 text-center">STR</th>
						<th class="col-2 text-center">DEX</th>
						<th class="col-2 text-center">CON</th>
						<th class="col-2 text-center">INT</th>
						<th class="col-2 text-center">WIS</th>
						<th class="col-2 text-center">CHA</th>
					</tr>	
					<tr>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"str")}</td>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"dex")}</td>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"con")}</td>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"int")}</td>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"wis")}</td>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"cha")}</td>
					</tr>
				</table>
			</td></tr>
			<tr class="text"><td colspan="6">
				${e.immune?`<div><b>Damage Immunities</b> ${Parser.monImmResToFull(e.immune)}</div>`:""}
				${e.conditionImmune?`<div><b>Condition Immunities</b> ${Parser.monCondImmToFull(e.conditionImmune)}</div>`:""}
			</td></tr>
			${e.action?n("Actions"):""}
			${e.action?`<tr><td colspan="6">${function(){return r.render({entries:e.action})}()}</td></tr>`:""}
			${n("Hull")}
			<tr><td colspan="6">
			${t(e.hull)}
			</td></tr>
			${(e.control||[]).map(function(e){return e?`
				<tr class="mon__stat-header-underline"><td colspan="6"><span>Control: ${e.name}</span></td></tr>
				<tr><td colspan="6">
				${t(e)}
				<div>${r.render({entries:e.entries})}</div>
				</td></tr>
			`:""}).join("")}
			${(e.movement||[]).map(function(e){return e?`
				<tr class="mon__stat-header-underline"><td colspan="6"><span>${e.isControl?`Control and `:""}Movement: ${e.name}</span></td></tr>
				<tr><td colspan="6">
				${t(e)}
				${(e.locomotion||[]).map(function(e){const n={type:"list",style:"list-hang-notitle",items:[{type:"item",name:`Locomotion (${e.mode})`,entries:e.entries}]};return`<div>${r.render(n)}</div>`})}
				${(e.speed||[]).map(function(e){const n={type:"list",style:"list-hang-notitle",items:[{type:"item",name:`Speed (${e.mode})`,entries:e.entries}]};return`<div>${r.render(n)}</div>`})}
				</td></tr>
			`:""}).join("")}
			${(e.weapon||[]).map(function(e){return`
				<tr class="mon__stat-header-underline"><td colspan="6"><span>Weapons: ${e.name}${e.count?` (${e.count})`:""}</span></td></tr>
				<tr><td colspan="6">
				${t(e,!!e.count)}
				${r.render({entries:e.entries})}
				</td></tr>
			`}).join("")}
			${(e.other||[]).map(function(e){return`
				<tr class="mon__stat-header-underline"><td colspan="6"><span>${e.name}</span></td></tr>
				<tr><td colspan="6">
				${t(e)}
				${r.render({entries:e.entries})}
				</td></tr>
			`}).join("")}
			${Renderer.utils.getPageTr(e)}
			${Renderer.utils.getBorderTr()}
		`}},Renderer.hover={linkCache:{},_isInit:!1,_active:{},_dmScreen:null,bindDmScreen(e){this._dmScreen=e},_lastMouseHoverId:-1,_mouseHovers:{},createOnMouseHover(e,n="Homebrew"){const t=Renderer.hover._lastMouseHoverId++;return Renderer.hover._mouseHovers[t]={data:{hoverTitle:n},entries:MiscUtil.copy(e)},`onmouseover="Renderer.hover.mouseOverHoverTooltip(event, this, ${t})" ${Renderer.hover._getPreventTouchString()}`},createOnMouseHoverEntry(e,n){const t=Renderer.hover.__initOnMouseHoverEntry(e);return`onmouseover="Renderer.hover.mouseOverHoverTooltip(event, this, ${t}, ${!!n})" ${Renderer.hover._getPreventTouchString()}`},_getPreventTouchString(){return`ontouchstart="Renderer.hover.handleTouchStart(event, this)"`},handleTouchStart(e,n){Renderer.hover._isSmallScreen()||($(n).data("href",$(n).data("href")||$(n).attr("href")),$(n).attr("href",STR_VOID_LINK),setTimeout(()=>{const e=$(n).data("href");e&&($(n).attr("href",e),$(n).data("href",null))},100))},__initOnMouseHoverEntry(e){const n=Renderer.hover._lastMouseHoverId++;return Renderer.hover._mouseHovers[n]={...e,data:{hoverTitle:e.name}},n},__updateOnMouseHoverEntry(e,n){Renderer.hover._mouseHovers[e]={...n,data:{hoverTitle:n.name}}},bindOnMouseHoverEntry(e,n){const t=Renderer.hover.__initOnMouseHoverEntry(e);return(e,r)=>Renderer.hover.mouseOverHoverTooltip(e,r,t,!!n)},_addToCache:(e,n,t,r)=>{e=e.toLowerCase(),n=n.toLowerCase(),t=t.toLowerCase(),((Renderer.hover.linkCache[e]=Renderer.hover.linkCache[e]||[])[n]=Renderer.hover.linkCache[e][n]||[])[t]=r},_getFromCache:(e,n,t)=>(e=e.toLowerCase(),n=n.toLowerCase(),t=t.toLowerCase(),Renderer.hover.linkCache[e][n][t]),_isCached:(e,n,t)=>(e=e.toLowerCase(),n=n.toLowerCase(),t=t.toLowerCase(),Renderer.hover.linkCache[e]&&Renderer.hover.linkCache[e][n]&&Renderer.hover.linkCache[e][n][t]),pCacheAndGet(e,n,t){return new Promise(r=>{Renderer.hover._doFillThenCall(e,n,t,()=>{const i=Renderer.hover._getFromCache(e,n,t);r(i)})})},_doFillThenCall:(e,n,t,r)=>{function i(n,t,r){n[t].forEach(n=>{const i=UrlUtil.URL_TO_HASH_BUILDER[e](n);r&&r(t,n),Renderer.hover._addToCache(e,n.source,i,n)})}function d(e,d,s){Renderer.hover._isCached(e,n,t)?r():BrewUtil.pAddBrewData().then(e=>{e[s]&&i(e,s)}).catch(BrewUtil.pPurgeBrew).then(()=>DataUtil.loadJSON(`${Renderer.get().baseUrl}${d}index.json`)).then(e=>{const t={};Object.entries(e).forEach(([e,n])=>t[e.toLowerCase()]=n);const o=t[n.toLowerCase()];o?DataUtil.loadJSON(`${Renderer.get().baseUrl}${d}${o}`).then(e=>{i(e,s),r()}):r()})}function s(e,n){return new Promise(t=>{BrewUtil.pAddBrewData().then(r=>{e=e instanceof Array?e:[e],e.forEach(e=>{r[e]&&i(r,e,n)}),t()}).catch(BrewUtil.pPurgeBrew)})}function o(e,n,t){n instanceof Array?n.forEach(n=>i(e,n,t)):i(e,n,t),r()}function l(e,i,d,l){Renderer.hover._isCached(e,n,t)?r():s(d,l).then(()=>DataUtil.loadJSON(`${Renderer.get().baseUrl}data/${i}`)).then(e=>o(e,d,l))}function u(e,i,d,l,u){Renderer.hover._isCached(e,n,t)?r():s(d,l).then(()=>DataUtil[u].loadJSON(Renderer.get().baseUrl)).then(e=>o(e,d,l))}function p(e){UrlUtil.class.getIndexedEntries(e).forEach(e=>Renderer.hover._addToCache(UrlUtil.PG_CLASSES,e.source.source||e.source,e.hash,e.entry))}switch(e){case"generic":case"hover":r();break;case UrlUtil.PG_CLASSES:{Renderer.hover._isCached(e,n,t)?r():(async()=>{try{const e=await BrewUtil.pAddBrewData();(e.class||[]).forEach(e=>p(e))}catch(n){BrewUtil.pPurgeBrew(n)}const e=await DataUtil.class.loadJSON();e.class.forEach(e=>p(e)),r()})();break}case UrlUtil.PG_SPELLS:d(e,`data/spells/`,"spell");break;case UrlUtil.PG_BESTIARY:d(e,`data/bestiary/`,"monster");break;case UrlUtil.PG_ITEMS:{Renderer.hover._isCached(e,n,t)?r():Renderer.item.pBuildList({fnCallback:n=>{BrewUtil.pAddBrewData().then(async n=>{const t=await Renderer.item.getItemsFromHomebrew(n);t.length&&t.forEach(n=>{const t=UrlUtil.URL_TO_HASH_BUILDER[e](n);Renderer.hover._addToCache(e,n.source,t,n);const r=Renderer.item.modifierPostToPre(n);r&&Renderer.hover._addToCache(e,n.source,UrlUtil.URL_TO_HASH_BUILDER[e](r),n)})}).catch(BrewUtil.pPurgeBrew).then(()=>{n.forEach(n=>{const t=UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_ITEMS](n);Renderer.hover._addToCache(e,n.source,t,n);const r=Renderer.item.modifierPostToPre(n);r&&Renderer.hover._addToCache(e,n.source,UrlUtil.URL_TO_HASH_BUILDER[e](r),n)}),r()})},isAddGroups:!0,isBlacklistVariants:!0});break}case UrlUtil.PG_BACKGROUNDS:l(e,"backgrounds.json","background");break;case UrlUtil.PG_FEATS:l(e,"feats.json","feat");break;case UrlUtil.PG_OPT_FEATURES:l(e,"optionalfeatures.json","optionalfeature");break;case UrlUtil.PG_PSIONICS:l(e,"psionics.json","psionic");break;case UrlUtil.PG_REWARDS:l(e,"rewards.json","reward");break;case UrlUtil.PG_RACES:{Renderer.hover._isCached(e,n,t)?r():BrewUtil.pAddBrewData().then(e=>{e.race&&i(e,"race")}).catch(BrewUtil.pPurgeBrew).then(()=>{DataUtil.loadJSON(`${Renderer.get().baseUrl}data/races.json`).then(n=>{const t=Renderer.race.mergeSubraces(n.race);t.forEach(n=>{const t=UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_RACES](n);Renderer.hover._addToCache(e,n.source,t,n)}),r()})});break}case UrlUtil.PG_DEITIES:u(e,"deities.json","deity",null,"deity");break;case UrlUtil.PG_OBJECTS:l(e,"objects.json","object");break;case UrlUtil.PG_TRAPS_HAZARDS:l(e,"trapshazards.json",["trap","hazard"]);break;case UrlUtil.PG_VARIATNRULES:l(e,"variantrules.json","variantrule");break;case UrlUtil.PG_CULTS_BOONS:{l(e,"cultsboons.json",["cult","boon"],(e,n)=>n._type="cult"===e?"c":"b");break}case UrlUtil.PG_CONDITIONS_DISEASES:{l(e,"conditionsdiseases.json",["condition","disease"],(e,n)=>n._type="condition"===e?"c":"d");break}case UrlUtil.PG_TABLES:{l(e,"generated/gendata-tables.json",["table","tableGroup"],(e,n)=>n._type="table"===e?"t":"g");break}case UrlUtil.PG_SHIPS:l(e,"ships.json","ship");break;default:throw new Error(`No load function defined for page ${e}`);}},_teardownWindow:e=>{const n=Renderer.hover._active[e];n&&(n.$ele.attr("data-hover-active",!1),n.$hov.remove(),$(document).off(n.mouseUpId),$(document).off(n.mouseMoveId),$(window).off(n.resizeId)),delete Renderer.hover._active[e]},_makeWindow(){var c=Math.max;function e(e,n){(0===e.which||1===e.which)&&e.preventDefault(),I.css({"z-index":201,animation:"initial"}),B.type=n,B.startX=Renderer.hover._getClientX(e),B.startY=Renderer.hover._getClientY(e),B.baseTop=parseFloat(I.css("top")),B.baseLeft=parseFloat(I.css("left")),B.baseHeight=L.height(),B.baseWidth=I.width(),9>n&&(L.css("max-height","initial"),I.css("max-width","initial"))}function n(){I.css("z-index",""),I.parent().append(I)}function t(e,n){return Renderer.hover._getClientX(e)>=n.left&&Renderer.hover._getClientX(e)<=n.left+n.width&&Renderer.hover._getClientY(e)>=n.top&&Renderer.hover._getClientY(e)<=n.top+n.height}function r(e){const n=c(B.startY-Renderer.hover._getClientY(e),80-B.baseHeight);L.css("height",B.baseHeight+n),I.css("top",B.baseTop-n),B.startY=Renderer.hover._getClientY(e),B.baseHeight=L.height(),B.baseTop=parseFloat(I.css("top"))}function i(e){const n=B.startX-Renderer.hover._getClientX(e);I.css("width",B.baseWidth-n),B.startX=Renderer.hover._getClientX(e),B.baseWidth=I.width()}function d(e){const n=B.startY-Renderer.hover._getClientY(e);L.css("height",B.baseHeight-n),B.startY=Renderer.hover._getClientY(e),B.baseHeight=L.height()}function s(e){const n=c(B.startX-Renderer.hover._getClientX(e),150-B.baseWidth);I.css("width",B.baseWidth+n).css("left",B.baseLeft-n),B.startX=Renderer.hover._getClientX(e),B.baseWidth=I.width(),B.baseLeft=parseFloat(I.css("left"))}function o(){const e=parseFloat(I.css("top"));0>e?I.css("top",0):e>=$(window).height()-Renderer.hover._BAR_HEIGHT&&I.css("top",$(window).height()-Renderer.hover._BAR_HEIGHT);const n=parseFloat(I.css("left"));0>n?I.css("left",0):n+I.width()>$(window).width()&&I.css("left",c($(window).width()-I.width(),0))}function l(){Renderer.hover._teardownWindow(h)}function u(){N.attr("data-hover-active",!1),I.remove(),$(document).off(Y),$(document).off(J),$(window).off(K),delete Renderer.hover._active[h]}function p(){Renderer.hover._showInProgress=!1,Renderer.hover._curHovering=null}if(!Renderer.hover._curHovering)return void p();const h=Renderer.hover._curHovering.hoverId,f=Renderer.hover._curHovering.ele;let m=Renderer.hover._curHovering.preLoaded;const g=Renderer.hover._curHovering.cPage,_=Renderer.hover._curHovering.cSource,y=Renderer.hover._curHovering.cHash,v=Renderer.hover._curHovering.permanent,T=Renderer.hover._curHovering.clientX,S=Renderer.hover._curHovering.renderFunction,x=Renderer.hover._curHovering.isBookContent;if(!m&&"hover"!==g&&!Renderer.hover._isCached(g,_,y))return Renderer.hover._showInProgress=!1,void setTimeout(()=>{throw new Error(`Could not load hash ${y} with source ${_} from page ${g}`)},1);const R="hover"===g?{name:_.data.hoverTitle||""}:m||Renderer.hover._getFromCache(g,_,y),C="hover"===g?S(_):S(R);$(f).attr("data-hover-active",!0);const E=$(f).offset(),k=E.top-$(document).scrollTop(),P=E.left-$(document).scrollLeft(),A=k>$(window).height()/2,w=P>$(window).width()/2,I=$(`<div class="hwin" style="right: -600px"/>`),L=$(`<div class="hwin__wrp-table"/>`),G=$(`body`),N=$(f);N.on("mouseleave.hoverwindow",e=>{Renderer.hover._cleanWindows(),"true"===W.attr("data-perm")||e.shiftKey?($(f).attr("data-hover-active",!0),W.attr("data-perm",!0),delete Renderer.hover._active[h]):l()});const j="generic"===g?(m.data||{}).hoverTitle||"":R._displayName||R.name,F=$(`<span class="window-title">${j}</span>`),H=$(`<table class="stats ${x?"stats-book stats-book--hover":""}"/>`);H.append(C),H.off("click",".mon__btn-scale-cr").on("click",".mon__btn-scale-cr",function(e){e.stopPropagation();const n=$(this),t=m&&null!=m._originalCr?m._originalCr:R.cr.cr||R.cr,r=m?m.cr.cr||m.cr:R.cr.cr||R.cr;Renderer.monster.getCrScaleTarget(n,r,e=>{if(Parser.numberToCr(e)===t){const e=Renderer.hover._getFromCache(g,_,y);m=e,H.empty().append(S(e)),F.text(e._displayName||e.name)}else ScaleCreature.scale(R,e).then(e=>{m=e,H.empty().append(S(e)),F.text(e._displayName||e.name)})},!0)}),H.off("click",".mon__btn-reset-cr").on("click",".mon__btn-reset-cr",function(){const e=Renderer.hover._getFromCache(g,_,y);m=e,H.empty().append(S(e)),F.text(e._displayName||e.name)});let B={};const O=$(`<div class="hoverborder__resize-ne"/>`).on("mousedown touchstart",n=>e(n,1)).on("click",n),M=$(`<div class="hoverborder__resize-e"/>`).on("mousedown touchstart",n=>e(n,2)).on("click",n),D=$(`<div class="hoverborder__resize-se"/>`).on("mousedown touchstart",n=>e(n,3)).on("click",n),U=$(`<div class="hoverborder hoverborder--btm ${x?"hoverborder-book":""}"><div class="hoverborder__resize-s"/></div>`).on("mousedown touchstart",n=>e(n,4)).on("click",n),q=$(`<div class="hoverborder__resize-sw"/>`).on("mousedown touchstart",n=>e(n,5)).on("click",n),X=$(`<div class="hoverborder__resize-w"/>`).on("mousedown touchstart",n=>e(n,6)).on("click",n),V=$(`<div class="hoverborder__resize-nw"/>`).on("mousedown touchstart",n=>e(n,7)).on("click",n),z=$(`<div class="hoverborder__resize-n"/>`).on("mousedown touchstart",n=>e(n,8)).on("click",n),W=$(`<div class="hoverborder hoverborder--top ${x?"hoverborder-book":""}" ${v?`data-perm="true"`:""} data-hover-id="${h}"/>`).on("mousedown touchstart",n=>e(n,9)).on("click",n).on("contextmenu",e=>{e.ctrlKey||ContextUtil.handleOpenContextMenu(e,f,"hoverBorder")}),Y=`mouseup.${h} touchend.${h}`,J=`mousemove.${h} touchmove.${h}`,K=`resize.${h}`;$(document).on(Y,e=>{if(B.type){if(9>B.type&&(L.css("max-height",""),I.css("max-width","")),o(),9===B.type){if(e.target.classList.contains("hvr__close")||e.target.classList.contains("hvr__popout"))return e.preventDefault(),B.type=0,void $(e.target).click();if(this._dmScreen){const n=this._dmScreen.getPanelPx(Renderer.hover._getClientX(e),Renderer.hover._getClientY(e));if(!n)return;this._dmScreen.setHoveringPanel(n);const r=n.getAddButtonPos();t(e,r)&&(m&&null!=m._isScaledCr?n.doPopulate_StatsScaledCr(g,_,y,m.cr.cr||m.cr):n.doPopulate_Stats(g,_,y),u()),this._dmScreen.resetHoveringButton()}}B.type=0}}).on(J,e=>{switch(B.type){case 1:r(e),i(e);break;case 2:i(e);break;case 3:d(e),i(e);break;case 4:d(e);break;case 5:d(e),s(e);break;case 6:s(e);break;case 7:r(e),s(e);break;case 8:r(e);break;case 9:{const n=B.startX-Renderer.hover._getClientX(e),r=B.startY-Renderer.hover._getClientY(e);if(I.css("left",B.baseLeft-n).css("top",B.baseTop-r),B.startX=Renderer.hover._getClientX(e),B.startY=Renderer.hover._getClientY(e),B.baseTop=parseFloat(I.css("top")),B.baseLeft=parseFloat(I.css("left")),this._dmScreen){const n=this._dmScreen.getPanelPx(Renderer.hover._getClientX(e),Renderer.hover._getClientY(e));if(!n)return;this._dmScreen.setHoveringPanel(n);const r=n.getAddButtonPos();t(e,r)?this._dmScreen.setHoveringButton(n):this._dmScreen.resetHoveringButton()}break}}}),$(window).on(K,()=>o(!0)),W.attr("data-display-title",!1),W.on("dblclick",()=>{const e=W.attr("data-display-title");W.attr("data-display-title","false"===e),W.attr("data-perm",!0),I.toggleClass("hwin--minified","false"===e),delete Renderer.hover._active[h]}),W.append(F);const Z=$(`<div class="flex" style="margin-left: auto;"/>`).appendTo(W);if(g&&_&&y){$(`<span class="top-border-icon glyphicon glyphicon-new-window" style="margin-right: 2px;" title="Go to Page"></span>`).click(()=>window.location=`${g}#${y}`).appendTo(Z)}const Q=$(`<span class="top-border-icon glyphicon glyphicon-modal-window hvr__popout" style="margin-right: 2px;" title="Open as Popup Window"></span>`).on("click",e=>{e.stopPropagation();const n=H.height(),t=open("",R._displayName||R.name,`width=600,height=${n}location=0,menubar=0,status=0,titlebar=0,toolbar=0`);t.document.write(`
					<!DOCTYPE html>
					<html lang="en" class="${styleSwitcher.getActiveStyleSheet()===StyleSwitcher.STYLE_NIGHT?StyleSwitcher.NIGHT_CLASS:""}"><head>
						<meta name="viewport" content="width=device-width, initial-scale=1">
						<title>${R._displayName||R.name}</title>
						<link rel="stylesheet" href="css/bootstrap.css">
						<link rel="stylesheet" href="css/jquery-ui.css">
						<link rel="stylesheet" href="css/jquery-ui-slider-pips.css">
						<link rel="stylesheet" href="css/style.css">
						<link rel="icon" href="favicon.png">
						<style>
							html, body { width: 100%; height: 100%; }
							body { overflow-y: scroll; }
						</style>
					</head><body>
					<div class="hwin hoverbox--popout" style="max-width: initial; max-height: initial; box-shadow: initial;">
					${H[0].outerHTML}
					</div>
					</body></html>
				`),u()}).appendTo(Z),ee=$(`<span class="delete-icon glyphicon glyphicon-remove hvr__close" title="Close"></span>`).on("click",e=>{e.stopPropagation(),u()}).appendTo(Z);L.append(H),I.append(z).append(O).append(M).append(D).append(q).append(X).append(V).append(W).append(L).append(U),G.append(I),v||(Renderer.hover._active[h]={$hov:I,$ele:N,resizeId:K,mouseUpId:Y,mouseMoveId:J}),A?I.css("top",k-(I.height()+10)):I.css("top",k+$(f).height()+10),w?I.css("left",(T||P)-(I.width()+10)):I.css("left",(T||P+$(f).width())+10),o(!0),$(f).css("cursor",""),p()},getGenericCompactRenderedString(e){return`
			<tr class="text homebrew-hover"><td colspan="6">
			${Renderer.get().setFirstSection(!0).render(e)}
			</td></tr>
		`},_pageToRenderFn(e){return"generic"===e||"hover"===e?Renderer.hover.getGenericCompactRenderedString:e===UrlUtil.PG_CLASSES?Renderer.hover.getGenericCompactRenderedString:e===UrlUtil.PG_SPELLS?Renderer.spell.getCompactRenderedString:e===UrlUtil.PG_ITEMS?Renderer.item.getCompactRenderedString:e===UrlUtil.PG_BESTIARY?e=>Renderer.monster.getCompactRenderedString(e,null,{showScaler:!0,isScaled:null!=e._originalCr}):e===UrlUtil.PG_CONDITIONS_DISEASES?Renderer.condition.getCompactRenderedString:e===UrlUtil.PG_BACKGROUNDS?Renderer.background.getCompactRenderedString:e===UrlUtil.PG_FEATS?Renderer.feat.getCompactRenderedString:e===UrlUtil.PG_OPT_FEATURES?Renderer.optionalfeature.getCompactRenderedString:e===UrlUtil.PG_PSIONICS?Renderer.psionic.getCompactRenderedString:e===UrlUtil.PG_REWARDS?Renderer.reward.getCompactRenderedString:e===UrlUtil.PG_RACES?Renderer.race.getCompactRenderedString:e===UrlUtil.PG_DEITIES?Renderer.deity.getCompactRenderedString:e===UrlUtil.PG_OBJECTS?Renderer.object.getCompactRenderedString:e===UrlUtil.PG_TRAPS_HAZARDS?Renderer.traphazard.getCompactRenderedString:e===UrlUtil.PG_VARIATNRULES?Renderer.variantrule.getCompactRenderedString:e===UrlUtil.PG_CULTS_BOONS?Renderer.cultboon.getCompactRenderedString:e===UrlUtil.PG_TABLES?Renderer.table.getCompactRenderedString:e===UrlUtil.PG_SHIPS?Renderer.ship.getCompactRenderedString:null},mouseOverHoverTooltip(e,n,t,r){const i=Renderer.hover._mouseHovers[t];return null==i?setTimeout(()=>{throw new Error(`No "data" found for hover ID ${t}`)}):void Renderer.hover.show({evt:e,ele:n,page:"hover",source:i,hash:"",isBookContent:r})},mouseOver(e,n,t,r,i,d,s){if(null!=s){const[o,l]=s.split(":");switch(o){case MON_HASH_SCALED:{Renderer.hover.pCacheAndGet(t,r,i).then(s=>{ScaleCreature.scale(s,+l).then(s=>{Renderer.hover.mouseOverPreloaded(e,n,s,t,r,i,d)})});break}}}else Renderer.hover.show({evt:e,ele:n,page:t,source:r,hash:i,isPopout:d})},mouseOverPreloaded(e,n,t,r,i,d,s){Renderer.hover.show({evt:e,ele:n,preLoaded:t,page:r,source:i,hash:d,isPopout:s})},doHover(e,n,t){Renderer.hover.show({evt:e,ele:n,preLoaded:t,page:"generic"})},doOpenWindow(e,n,t){const r={shiftKey:!0,clientX:e.clientX,clientY:e.clientY};Renderer.hover.show({evt:r,ele:n,preLoaded:t,page:"generic"})},_doInit(){Renderer.hover._isInit||(Renderer.hover._isInit=!0,$(`body`).on("click",()=>Renderer.hover._cleanWindows()),ContextUtil.doInitContextMenu("hoverBorder",(e,n,t,r)=>{const i=$(`.hoverborder[data-perm="true"]`);switch(+r.data("ctx-id")){case 0:i.attr("data-display-title","false");break;case 1:i.attr("data-display-title","true");break;case 2:$(`.hvr__close`).click();}},["Maximize All","Minimize All",null,"Close All"]))},_isSmallScreen(){const e=(()=>{let e=100,n=window.top;for(;window.parent!==n;)if(n=window.parent,0>e--)return window;return n})();return 768>=$(e).width()},_BAR_HEIGHT:16,_showInProgress:!1,_hoverId:1,_popoutId:-1,_curHovering:null,show:e=>{const n=e.evt,t=e.ele,r=e.preLoaded,i=e.page,d=e.source,s=e.hash,o=e.isPopout,l=e.isBookContent,u=$(t);if(Renderer.hover._doInit(),Renderer.hover._isSmallScreen()&&!n.shiftKey)return;let p;if(o)p=Renderer.hover._popoutId--,u.attr("data-hover-id",p);else{const e=u.attr("data-hover-id");e?p=+e:(p=Renderer.hover._hoverId++,u.attr("data-hover-id",p))}const c=u.attr("data-hover-active"),h=$(`.hoverborder[data-hover-id="${p}"]`);if(!("true"===c&&h.length)){const e=Renderer.hover._pageToRenderFn(i);if(!e)throw new Error(`No hover render function specified for page ${i}`);Renderer.hover._curHovering={hoverId:p,ele:t,renderFunction:e,preLoaded:r,cPage:i,cSource:d,cHash:s,permanent:n.shiftKey,clientX:Renderer.hover._getClientX(n),isBookContent:l},Renderer.hover._showInProgress||(Renderer.hover._showInProgress=!0,u.css("cursor","wait").off("mouseleave.hoverwindow"),Renderer.hover._cleanWindows(),u.on("mouseleave.hoverwindow",()=>{Renderer.hover._curHovering&&Renderer.hover._curHovering.permanent||(Renderer.hover._curHovering=null)}),Renderer.hover._doFillThenCall(i,d,s,Renderer.hover._makeWindow.bind(Renderer.hover)))}},_cleanWindows:()=>{const e=Object.keys(Renderer.hover._active);e.forEach(e=>Renderer.hover._teardownWindow(e))},bindPopoutButton(e,n){const t=ListUtil.getOrTabRightButton(`btn-popout`,`new-window`).off("click").attr("title","Popout Window (SHIFT for Source Data)"),r=Renderer.hover.__initOnMouseHoverEntry({});t.on("click",n?n(e,t,r):n=>{null!==History.lastLoadedId&&(n.shiftKey?Renderer.hover.handlePopoutCode(n,e,t,r):Renderer.hover.doPopout(t,e,History.lastLoadedId,n.clientX))})},handlePopoutCode(e,n,t,r){const i=n[History.lastLoadedId],d=DataUtil.cleanJson(MiscUtil.copy(i));Renderer.hover.__updateOnMouseHoverEntry(r,{type:"code",name:`${i.name} \u2014 Source Data`,preformatted:JSON.stringify(d,null,"\t")}),t.attr("data-hover-active",!1),Renderer.hover.mouseOverHoverTooltip({shiftKey:!0,clientX:e.clientX},t.get(0),r,!0)},doPopout:(e,n,t,r)=>{e.attr("data-hover-active",!1);const i=n[t];Renderer.hover.mouseOver({shiftKey:!0,clientX:r},e.get(0),UrlUtil.getCurrentPage(),i.source,UrlUtil.autoEncodeHash(i),!0)},doPopoutPreloaded(e,n,t){e.attr("data-hover-active",!1),Renderer.hover.mouseOverPreloaded({shiftKey:!0,clientX:t},e.get(0),n,UrlUtil.getCurrentPage(),n.source,UrlUtil.autoEncodeHash(n),!0)},_getClientX(e){return e.touches&&e.touches.length?e.touches[0].clientX:e.clientX},_getClientY(e){return e.touches&&e.touches.length?e.touches[0].clientY:e.clientY}},Renderer.dice={SYSTEM_USER:{name:"Avandra"},POS_INFINITE:1e20,_$wrpRoll:null,_$minRoll:null,_$iptRoll:null,_$outRoll:null,_$head:null,_hist:[],_histIndex:null,_$lastRolledBy:null,_storage:null,_panel:null,bindDmScreenPanel(e,n){Renderer.dice._panel&&Renderer.dice.unbindDmScreenPanel(),Renderer.dice._showBox(),Renderer.dice._panel=e,e.doPopulate_Rollbox(n)},unbindDmScreenPanel(){Renderer.dice._panel&&($(`body`).append(Renderer.dice._$wrpRoll),Renderer.dice._panel.close$TabContent(),Renderer.dice._panel=null,Renderer.dice._hideBox(),Renderer.dice._$wrpRoll.removeClass("rollbox-panel"))},get$Roller(){return Renderer.dice._$wrpRoll},parseRandomise2(e){if(!e||!e.trim())return null;const n=Renderer.dice._parse2(e);return n?n.evl({}):null},parseAverage(e){if(!e||!e.trim())return null;const n=Renderer.dice._parse2(e);return n?n.avg({}):null},parseToTree(e){return e&&e.trim()?Renderer.dice._parse2(e):null},_showBox:()=>{"flex"!==Renderer.dice._$wrpRoll.css("display")&&(Renderer.dice._$minRoll.hide(),Renderer.dice._$wrpRoll.css("display","flex"),Renderer.dice._$iptRoll.prop("placeholder",`${Renderer.dice._randomPlaceholder()} or "/help"`))},_hideBox:()=>{Renderer.dice._$minRoll.show(),Renderer.dice._$wrpRoll.css("display","")},getNextDice(e){const n=Renderer.dice.DICE.indexOf(e);return~n?Renderer.dice.DICE[n+1]:null},getPreviousDice(e){const n=Renderer.dice.DICE.indexOf(e);return~n?Renderer.dice.DICE[n-1]:null},DICE:[4,6,8,10,12,20,100],_randomPlaceholder:()=>{const e=RollerUtil.randomise(10),n=Renderer.dice.DICE[RollerUtil.randomise(Renderer.dice.DICE.length-1)],t=(RollerUtil.randomise(3)-2)*RollerUtil.randomise(10),r=1<e&&5===RollerUtil.randomise(5),i=r?2===RollerUtil.randomise(2)?"h":"l":"",d=r?RollerUtil.randomise(e-1):null;return`${e}d${n}${r?`d${i}${d}`:""}${0>t?t:0<t?`+${t}`:""}`},async init(){const e=$(`<div class="rollbox"/>`),n=$(`<div class="rollbox-min"><span class="glyphicon glyphicon-chevron-up"></span></div>`).on("click",()=>{Renderer.dice._showBox(),Renderer.dice._$iptRoll.focus()}),t=$(`<div class="head-roll"><span class="hdr-roll">Dice Roller</span><span class="delete-icon glyphicon glyphicon-remove"></span></div>`).on("click",()=>{Renderer.dice._panel||Renderer.dice._hideBox()}),r=$(`<div class="out-roll">`),i=$(`<input class="ipt-roll form-control" autocomplete="off" spellcheck="false">`).on("keypress",n=>{13===n.which&&(Renderer.dice.roll2(i.val(),{user:!0,name:"Anon"}),i.val("")),n.stopPropagation()}).on("keydown",n=>{38===n.which?Renderer.dice._prevHistory():40===n.which&&Renderer.dice._nextHistory()});e.append(t).append(r).append(i),Renderer.dice._$wrpRoll=e,Renderer.dice._$minRoll=n,Renderer.dice._$head=t,Renderer.dice._$outRoll=r,Renderer.dice._$iptRoll=i,$(`body`).append(n).append(e),e.on("click",".out-roll-item-code",e=>Renderer.dice._$iptRoll.val(e.target.innerHTML).focus()),Renderer.dice.storage=(await StorageUtil.pGet(ROLLER_MACRO_STORAGE))||{}},_prevHistory:()=>{Renderer.dice._histIndex--,Renderer.dice._cleanHistoryIndex(),Renderer.dice._$iptRoll.val(Renderer.dice._hist[Renderer.dice._histIndex])},_nextHistory:()=>{Renderer.dice._histIndex++,Renderer.dice._cleanHistoryIndex(),Renderer.dice._$iptRoll.val(Renderer.dice._hist[Renderer.dice._histIndex])},_cleanHistoryIndex:()=>{var e=Math.min,n=Math.max;Renderer.dice._histIndex=Renderer.dice._hist.length?e(Renderer.dice._hist.length,n(Renderer.dice._histIndex,0)):null},_addHistory:e=>{Renderer.dice._hist.push(e),Renderer.dice._histIndex=Renderer.dice._hist.length},_scrollBottom:()=>{Renderer.dice._$outRoll.scrollTop(1e10)},_contextRollLabel:"rollChooser",_contextPromptLabel:"rollPrompt",rollerClickUseData(e,n){const t=$(n),r=t.data("packed-dice");let i=t.attr("title")||null,d=e.shiftKey;const s=r.toRoll.split(";").map(e=>e.trim()).filter(e=>e);(1<s.length?new Promise(t=>{const i=MiscUtil.copy(r);ContextUtil.doInitContextMenu(Renderer.dice._contextRollLabel,(e,n,r,o,l)=>{d=e.shiftKey,i.toRoll=s[l],t(i)},[{text:"Choose Roll",disabled:!0},null,...s.map(e=>`Roll ${e}`)]),ContextUtil.handleOpenContextMenu(e,n,Renderer.dice._contextRollLabel,e=>{e||t()})}):Promise.resolve(r)).then(async t=>{if(!t)return;const s=/#\$prompt_number:?([^$]*)\$#/g,o=[];for(let e;e=s.exec(t.toRoll);){const n=e[1],t={};if(n){const e=n.split(",");e.map(e=>e.trim()).forEach(e=>{const[n,r]=e.split("=").map(e=>e.trim());switch(n){case"min":case"max":t[n]=+r;break;default:t[n]=r;}})}null==t.min&&(t.min=0),null==t.max&&(t.max=Renderer.dice.POS_INFINITE),null==t.default&&(t.default=0);const r=await InputUiUtil.pGetUserNumber(t);if(null==r)return;o.push(r)}const l=MiscUtil.copy(t);s.lastIndex=0,l.toRoll=l.toRoll.replace(s,()=>o.shift()),(r.prompt?new Promise(t=>{const r=Object.keys(l.prompt.options).sort(SortUtil.ascSortLower);ContextUtil.doInitContextMenu(Renderer.dice._contextPromptLabel,(e,n,s,o,u)=>{null==u&&t(),d=e.shiftKey;const p=r[u],c=l.prompt.options[p];c?(i=`${Parser.spLevelToFull(p)}-level cast`,l.toRoll+=`+${c}`,t(l)):(i="",t(l))},[{text:l.prompt.entry,disabled:!0},null,...r.map(e=>`${Parser.spLevelToFull(e)} level`)]),ContextUtil.handleOpenContextMenu(e,n,Renderer.dice._contextPromptLabel,e=>{e||t()})}):Promise.resolve(l)).then(e=>{e&&Renderer.dice.rollerClick({shiftKey:d},n,JSON.stringify(e),i)})})},__rerollNextInlineResult(e){const n=$(e),t=n.next(`.result`),i=Renderer.dice.__rollPackedData(n);t.text(i)},__rollPackedData(e){const n=Renderer.dice._parse2(e.data("packed-dice").toRoll);return n.evl({})},rollerClick:(e,n,t,r)=>{function i(n){const t=s.closest(`table`),r=t.find(`td`).filter((r,i)=>{const e=$(i);return!!e.closest(`table`).is(t)&&n>=+e.data("roll-min")&&n<=+e.data("roll-max")});if(r.length&&r.nextAll().length){const e=r.nextAll().get().map(e=>e.innerHTML.trim()).filter(e=>e).join(" | "),n=$(`<span class="message">${e}</span>`);return n.find(`.render-roller`).each((n,t)=>{const e=$(t),i=Renderer.dice.__rollPackedData(e);e.attr("onclick",`Renderer.dice.__rerollNextInlineResult(this)`),e.after(` (<span class="result">${i}</span>)`)}),n.html()}return`<span class="message">No result found matching roll ${n}?! <span class="help--subtle" title="Bug!">🐛</span></span>`}function d(e=o){s.parent().is("th")&&"true"===s.parent().attr("data-isroller")?Renderer.dice.rollEntry(e,l,i):Renderer.dice.rollEntry(e,l)}const s=$(n),o=JSON.parse(t),l={name:function(){const e=s.closest(`.hwin`);if(e.length)return e.find(`.stats-name`).first().text();const n=s.closest(`.out-roll-wrp`);if(n.length)return n.data("name");let t=document.title.replace("- 5etools","").trim();return"DM Screen"===t?"Dungeon Master":t}(),label:null==r?function(){let e=$(n).closest(`table:not(.stats)`).children(`caption`).text();return e?e.trim():(e=$(n).parent().children(`.list-item-title`).text(),e)?e.trim():(e=$(n).closest(`table.stats`).children(`tbody`).first().children(`tr`).first().find(`th.name .stats-name`).text(),e)?e.trim():(e=$(n).closest(`div`).children(`.rd__h`).first().find(`.entry-title-inner`).text(),e&&(e=e.trim().replace(/[.,:]\s*$/,"")),e)}(n):r};if(!e.shiftKey)d();else if("damage"===o.subType){const e=[];o.toRoll.replace(/(\d+)?d(\d+)/gi,n=>e.push(n)),o.toRoll=`${o.toRoll}${e.length?`+${e.join("+")}`:""}`,d()}else"d20"===o.subType?(o.toRoll=`2d20dl1${o.d20mod}`,d()):(Renderer.dice._showMessage("Rolling twice...",l),d(),d())},roll2(e,n){if(e=e.trim(),!!e)if(n.user&&Renderer.dice._addHistory(e),e.startsWith("/"))Renderer.dice._handleCommand(e,n);else if(e.startsWith("#"))return Renderer.dice._handleSavedRoll(e,n);else{const[t,...r]=e.split(":");r.length&&(e=r.join(":"),n.label=t);const i=Renderer.dice._parse2(e);return Renderer.dice._handleRoll2(i,n)}},rollEntry:(e,n,t)=>{const r=Renderer.dice._parse2(e.toRoll);r.successThresh=e.successThresh,r.successMax=e.successMax,Renderer.dice._handleRoll2(r,n,t)},_handleRoll2(e,n,t){Renderer.dice._showBox(),Renderer.dice._checkHandleName(n.name);const r=Renderer.dice._$lastRolledBy;if(e){const i={},d=e.evl(i),s=i.text.join(""),o=i.allMax.length&&!i.allMax.filter(e=>!e).length,l=i.allMin.length&&!i.allMin.filter(e=>!e).length,u=n.label&&(!n.name||n.label.trim().toLowerCase()!==n.name.trim().toLowerCase())?n.label:null,p=e.successThresh?`<span class="roll">${d>(e.successMax||100)-e.successThresh?"Success!":"Failure"}</span>`:`<span class="roll ${o?"roll-max":l?"roll-min":""}">${d}</span>`,c=`${n.name?`${n.name} \u2014 `:""}${u?`${u}: `:""}${e._asString}`;return r.append(`
				<div class="out-roll-item" title="${c}">
					<div>
						${u?`<span class="roll-label">${u}: </span>`:""}
						${p}
						<span class="all-rolls text-muted">${s}</span>
						${t?`<span class="message">${t(d)}</span>`:""}
					</div>
					<div class="out-roll-item-button-wrp">
						<button title="Copy to input" class="btn btn-xs btn-copy-roll" onclick="Renderer.dice._$iptRoll.val('${e._asString.replace(/\s+/g,"")}')"><span class="glyphicon glyphicon-pencil"></span></button>
					</div>
				</div>`),d}r.append(`<div class="out-roll-item">Invalid input! Try &quot;/help&quot;</div>`);Renderer.dice._scrollBottom()},_showMessage(e,n){Renderer.dice._showBox(),Renderer.dice._checkHandleName(n.name);const t=Renderer.dice._$lastRolledBy;t.append(`<div class="out-roll-item out-roll-item--message">${e}</div>`),Renderer.dice._scrollBottom()},_validCommands:new Set(["/c","/cls","/clear"]),_handleCommand(e,n){function t(){Renderer.dice._showMessage("Invalid input! Try &quot;/help&quot;",Renderer.dice.SYSTEM_USER)}function r(e,n){return e.length===n}async function i(){await StorageUtil.pSet(ROLLER_MACRO_STORAGE,Renderer.dice.storage)}Renderer.dice._showMessage(`<span class="out-roll-item-code">${e}</span>`,n);if("/help"===e||"/h"===e)Renderer.dice._showMessage(`Drop highest (<span class="out-roll-item-code">2d4dh1</span>) and lowest (<span class="out-roll-item-code">4d6dl1</span>) are supported.<br>
				Up and down arrow keys cycle input history.<br>
				Anything before a colon is treated as a label (<span class="out-roll-item-code">Fireball: 8d6</span>)<br>
Use <span class="out-roll-item-code">${"/macro"} list</span> to list saved macros.<br>
				Use <span class="out-roll-item-code">${"/macro"} add myName 1d2+3</span> to add (or update) a macro. Macro names should not contain spaces or hashes.<br>
				Use <span class="out-roll-item-code">${"/macro"} remove myName</span> to remove a macro.<br>
				Use <span class="out-roll-item-code">#myName</span> to roll a macro.<br>
				Use <span class="out-roll-item-code">/clear</span> to clear the roller.`,Renderer.dice.SYSTEM_USER);else if(e.startsWith("/macro")){const[n,d,...s]=e.split(/\s+/);if(!["list","add","remove","clear"].includes(d))t();else switch(d){case"list":r(s,0)?Object.keys(Renderer.dice.storage).forEach(e=>{Renderer.dice._showMessage(`<span class="out-roll-item-code">#${e}</span> \u2014 ${Renderer.dice.storage[e]}`,Renderer.dice.SYSTEM_USER)}):t();break;case"add":{if(r(s,2)){const[e,n]=s;e.includes(" ")||e.includes("#")?t():(Renderer.dice.storage[e]=n,i().then(()=>Renderer.dice._showMessage(`Saved macro <span class="out-roll-item-code">#${e}</span>`,Renderer.dice.SYSTEM_USER)))}else t();break}case"remove":r(s,1)?Renderer.dice.storage[s[0]]?(delete Renderer.dice.storage[s[0]],i().then(()=>Renderer.dice._showMessage(`Removed macro <span class="out-roll-item-code">#${s[0]}</span>`,Renderer.dice.SYSTEM_USER))):Renderer.dice._showMessage(`Macro <span class="out-roll-item-code">#${s[0]}</span> not found`,Renderer.dice.SYSTEM_USER):t();}}else Renderer.dice._validCommands.has(e)?"/c"===e||"/cls"===e||"/clear"===e?(Renderer.dice._$outRoll.empty(),Renderer.dice._$lastRolledBy.empty(),Renderer.dice._$lastRolledBy=null):void 0:t()},_handleSavedRoll(e,n){e=e.replace(/^#/,"");const t=Renderer.dice.storage[e];if(t){n.label=e;const r=Renderer.dice._parse2(t);return Renderer.dice._handleRoll2(r,n)}Renderer.dice._showMessage(`Macro <span class="out-roll-item-code">#${e}</span> not found`,Renderer.dice.SYSTEM_USER)},addRoll:(e,n)=>{n.trim()&&(Renderer.dice._showBox(),Renderer.dice._checkHandleName(e.name),Renderer.dice._$outRoll.prepend(`<div class="out-roll-item" title="${e.name||""}">${n}</div>`),Renderer.dice._scrollBottom())},_checkHandleName:e=>{Renderer.dice._$lastRolledBy&&Renderer.dice._$lastRolledBy.data("name")===e||(Renderer.dice._$outRoll.prepend(`<div class="text-muted out-roll-id">${e}</div>`),Renderer.dice._$lastRolledBy=$(`<div class="out-roll-wrp"/>`).data("name",e),Renderer.dice._$outRoll.prepend(Renderer.dice._$lastRolledBy))},_cleanOperators2(e){var n=Math.max;e=e.toLowerCase().replace(/\s+/g,"").replace(/[×x]/g,"*").replace(/\*\*/g,"^").replace(/÷/g,"/").replace(/,/g,"").replace(/(^|[^\d)])d(\d)/g,(...e)=>`${e[1]}1d${e[2]}`).replace(/dl/g,"l").replace(/dh/g,"h").replace(/\)\(/g,")*(").replace(/(\d)\(/g,"$1*(");let t,r;do t=e.length,e=e.replace(/--/g,"+").replace(/\+\++/g,"+").replace(/-\+/g,"-").replace(/\+-/g,"-"),r=e.length;while(t!==r);return function(e){function t(e){this._=e}function r(){s=0;let t=0;for(let r=0;r<e.length;++r){const i=e[r];"string"==typeof i&&("("===i?t++:")"===i?(s=n(s,t),t--):void 0)}if(0!=t)return null}function i(){let n=0,r=null;for(let d=0;d<e.length;++d){const i=e[d];if("string"==typeof i)switch(i){case"(":r=d,n++;break;case")":if(n===s){let n=[...e.slice(r+1,d)];if(!n.length)return null;let i;if(n.includes("l")||n.includes("h")){if(!n.includes("d"))return null;const e=[];let r=null,d=null,s=[];const o=()=>{if("l"===d||"h"===d){const n=[],t=[],r=[];let d=null,o=n;for(let e=0;e<s.length;++e){const n=s[e];"d"===n?o=t:"l"===n||"h"===n?(d=n,o=r):o.push(n)}e.push(d,"(",...n,",",...t,",",...r,")")}else e.push(...s);r=null,d=null,s=[]};for(let e=0;e<n.length;++e){const i=n[e];if("d"===i){if(null!=d)return null;d="d",s.push("d")}else if("l"===i){if("d"!==d)return null;d="l",s.push("l")}else if("h"===i){if("d"!==d)return null;d="h",s.push("h")}else i instanceof t||i.isNumeric()?(null==r&&(r=e),s.push(i)):(o(),s.push(i))}o(),i=new t(e)}else i=new t(n);e.splice(r,d-r+1,i),r=null}n--;}}return!0}function d(e){if(e instanceof t)o.push("("),e._.forEach(e=>d(e)),o.push(")");else if(e instanceof Array)e.forEach(e=>d(e));else if("string"==typeof e)o.push(e);else throw new Error("Should never occur!")}e=`(${e})`.split("");let s=0;for(r();0<s;){const e=i();if(!e)return null;r()}const o=[];return d(e),o.slice(1,o.length-1).join("")}(e)},_parse2(e){var n=Math.min;const t=function(e){const n={d:{precedence:5,assoc:"R"},"^":{precedence:4,assoc:"R"},"/":{precedence:3,assoc:"L"},"*":{precedence:3,assoc:"L"},"+":{precedence:2,assoc:"L"},"-":{precedence:2,assoc:"L"}};if(e=Renderer.dice._cleanOperators2(e),null==e)return null;e=function(e){for(let n=0;n<e.length;++n)""===e[n]&&e.splice(n,1);return e}(e.split(/([-+*/^()dlh,])/));const t=[];let r="";const i=()=>r+=`${t.pop()} `,d=e=>r+=`${e} `;for(let r=0;r<e.length;++r){const s=e[r];if(s.isNumeric())d(s);else if("l"===s||"h"===s)t.push(s);else if(","===s)for(;t.peek()&&"("!==t.peek();)i();else if(n[s]){const e=s;for(let r=t.last();n[r]&&("L"===n[e].assoc&&n[e].precedence<=n[r].precedence||"R"===n[e].assoc&&n[e].precedence<n[r].precedence);)i(),r=t.last();t.push(e)}else if("("===s)t.push(s),d(s);else if(")"===s){for(;"("!==t.last();)i();d(s),t.pop(),("l"===t.last()||"h"===t.last())&&i()}}for(;0<t.length;)i();return r.trim()}(e);if(null==t)return null;const r=function(e){function t(e){e.text=e.text||[],e.rawText=e.rawText||[],e.allMax=e.allMax||[],e.allMin=e.allMin||[]}function i(e,n){n.pr&&(e.text.push("("),e.rawText.push("("))}function d(e,n){n.pr&&(e.text.push(")"),e.rawText.push(")"))}function s(e){this.type="atom",this.n=e,this.pr=!1,this.evl=n=>(t(n),i(n,this),n.text.push(e),n.rawText.push(e),d(n,this),+e),this.avg=e=>this.evl(e),this._nxt=function*(){yield+e},this.nxt=this._nxt.bind(this)}function o(e,r,s,o){this.type="dice",this.num=e,this.faces=r,this.drop=s,this.dropType=o,this.pr=!1,this.evl=e=>this._get(e,"evl"),this.avg=e=>this._get(e,"avg"),this._nxt=function*(){const t=e.nxt();for(let e,n;!(e=t.next()).done;)for(const t=r.nxt();!(n=t.next()).done;){const t=e.value*n.value;for(let n=e.value;n<=t;++n)yield n}},this.nxt=this._nxt.bind(this),this._get=(l,u)=>{var p=Math.sum;t(l);const c=e[u]({}),h=r[u]({}),f=[...Array(c)].map(()=>"avg"===u?(h+1)/2:RollerUtil.randomise(h)),m=1<f.length?"(":"",g=1<f.length?")":"";if(null!=s){const e=n(s[u]({}),c);f.sort(SortUtil.ascSort).reverse(),"h"===o&&f.reverse();const t=f.slice(0,f.length-e),r=f.slice(f.length-e,f.length);return i(l,this),l.text.push(`${m}${t.length?`[${t.join("]+[")}]`:""}${r.length?`<span style="text-decoration: red line-through;">+[${r.join("]+[")}]</span>`:""}${g}`),l.rawText.push(`${m}${t.length?`[${t.join("]+[")}]`:""}${r.length?`+[${r.join("]+[")}]`:""}${g}`),d(l,this),this._handleMinMax(l,t,h),p(...t)}else{const e=`${m}[${f.join("]+[")}]${g}`;return i(l,this),l.text.push(e),l.rawText.push(e),d(l,this),this._handleMinMax(l,f,h),p(...f)}},this._handleMinMax=(e,n,t)=>{const r=n.filter(e=>e===t),i=n.filter(e=>1===e);e.allMax.push(r.length&&r.length===n.length),e.allMin.push(i.length&&i.length===n.length)}}function l(e,n){this.type="add",this.a=e,this.b=n,this.pr=!1,this.evl=e=>this._get(e,"evl"),this.avg=e=>this._get(e,"avg"),this._nxt=function*(){const t=e.nxt();for(let e,i;!(e=t.next()).done;)for(const t=n.nxt();!(i=t.next()).done;)yield e.value+i.value},this.nxt=this._nxt.bind(this),this._get=(s,o)=>{t(s),i(s,this);const u=e[o](s);s.text.push("+"),s.rawText.push("+");const l=n[o](s);return d(s,this),u+l}}function u(e,n){this.type="sub",this.a=e,this.b=n,this.pr=!1,this.evl=e=>this._get(e,"evl"),this.avg=e=>this._get(e,"avg"),this._nxt=function*(){const t=e.nxt();for(let e,i;!(e=t.next()).done;)for(const t=n.nxt();!(i=t.next()).done;)yield e.value-i.value},this.nxt=this._nxt.bind(this),this._get=(s,o)=>{t(s),i(s,this);const u=e[o](s);s.text.push("-"),s.rawText.push("-");const l=n[o](s);return d(s,this),u-l}}function p(e,n){this.type="mult",this.a=e,this.b=n,this.pr=!1,this.evl=e=>this._get(e,"evl"),this.avg=e=>this._get(e,"avg"),this._nxt=function*(){const t=e.nxt();for(let e,i;!(e=t.next()).done;)for(const t=n.nxt();!(i=t.next()).done;)yield e.value*i.value},this.nxt=this._nxt.bind(this),this._get=(s,o)=>{t(s),i(s,this);const u=e[o](s);s.text.push("\xD7"),s.rawText.push("\xD7");const l=n[o](s);return d(s,this),u*l}}function c(e,n){this.type="div",this.a=e,this.b=n,this.pr=!1,this.evl=e=>this._get(e,"evl"),this.avg=e=>this._get(e,"avg"),this._nxt=function*(){const t=e.nxt();for(let e,i;!(e=t.next()).done;)for(const t=n.nxt();!(i=t.next()).done;)yield e.value/i.value},this.nxt=this._nxt.bind(this),this._get=(s,o)=>{t(s),i(s,this);const u=e[o](s);s.text.push("\xF7"),s.rawText.push("\xF7");const l=n[o](s);return d(s,this),u/l}}function h(r,n){var e=Math.pow;this.type="pow",this.n=r,this.e=n,this.pr=!1,this.evl=e=>this._get(e,"evl"),this.avg=e=>this._get(e,"avg"),this._nxt=function*(){const n=a.nxt();for(let t,i;!(t=n.next()).done;)for(const n=b.nxt();!(i=n.next()).done;)yield e(t.value,i.value)},this.nxt=this._nxt.bind(this),this._get=(s,o)=>{t(s),i(s,this);const l=r[o](s);s.text.push("<sup>"),s.rawText.push("^");const u=n[o](s);return s.text.push("</sup>"),d(s,this),e(l,u)}}function f(e){if(e.evl)return e;else{const n=e.fn(...e.args.map(e=>f(e)));return e.pr&&(n.pr=!0),n}}const m={d:(...e)=>new o(...e),"^":(...e)=>new h(...e),"**":(...e)=>new h(...e),"/":(...e)=>new c(...e),"*":(...e)=>new p(...e),"+":(...e)=>new l(...e),"-":(...e)=>new u(...e)},g={l:{args:3,fn:function(...e){return new o(...e,"l")}},h:{args:3,fn:function(...e){return new o(...e,"h")}}};let _=null;const y=[];let v=!1;const T=e.replace(/[()]/g,(...e)=>")"===e[0]?"(":")").split(" ").reverse();for(let n=0;n<T.length;++n){const e=T[n];if(e.isNumeric()){const n=new s(e);if(v&&(n.pr=!0,v=!1),!y.length)_=n;else{let e=y.peek();for(e.args.unshift(n);y.length&&e.reqArgs===e.args.length;){let n=y.pop();y.peek()&&(e=y.peek(),e.args.unshift(n))}y.length||(_=e)}}else if(m[e]){const n={fn:m[e],reqArgs:2,args:[]};v&&(n.pr=!0,v=!1),y.push(n)}else if(g[e]){const n={fn:g[e].fn,reqArgs:g[e].args,args:[]};v&&(n.pr=!0,v=!1),y.push(n)}else"("===e&&(v=!0)}return null==_?null:f(_)}(t);return null==r?null:(r._asString=e,r)}},IS_ROLL20||"undefined"==typeof window||window.addEventListener("load",Renderer.dice.init),Renderer.getNames=function(e,n,t=-1,r=0){if(!(-1!==t&&r>t))if(n.name&&e.push(Renderer.stripTags(n.name)),n.entries)for(const i of n.entries)Renderer.getNames(e,i,t,r+1);else if(n.items)for(const i of n.items)Renderer.getNames(e,i,t,r+1)},Renderer.getNumberedNames=function(e){const n=new Renderer().setTrackTitles(!0);n.render(e);const t=n.getTrackedTitles(),r={};return Object.entries(t).forEach(([e,n])=>{n=Renderer.stripTags(n),r[n]=+e}),r},Renderer.findName=function(e){function t(e){if(e instanceof Array)for(const r of e){const e=t(r);if(e)return e}else if(e instanceof Object){if(e.name)return e.name;for(const r of Object.values(e)){const e=t(r);if(e)return e}}}return t(e)},Renderer.stripTags=function(e){if(e.includes("{@")){const n=Renderer.splitByTags(e);return n.filter(e=>e).map(e=>{if(e.startsWith("@")){let[n,t]=Renderer.splitFirstSpace(e);switch(t=t.replace(/<\$([^$]+)\$>/gi,""),n){case"@b":case"@bold":case"@i":case"@italic":case"@s":case"@strike":return t.replace(/^{@(i|italic|b|bold|s|strike) (.*?)}$/,"$1");case"@h":return"Hit: ";case"@dc":return`DC ${t}`;case"@atk":return Renderer.attackTagToFull(t);case"@chance":case"@d20":case"@damage":case"@dice":case"@hit":case"@recharge":{const[e,r]=t.split("|");switch(n){case"@damage":case"@dice":return r||e.replace(/;/g,"/");case"@d20":case"@hit":return r||(()=>{const t=+e;if(isNaN(t))throw new Error(`Could not parse "${e}" as a number!`);return`${0<=t?"+":""}${t}`})();case"@recharge":{const n=+(e||6);if(isNaN(n))throw new Error(`Could not parse "${e}" as a number!`);return`(Recharge ${n}${6>n?`\u20136`:""})`}case"@chance":return r||`${e} percent`;}throw new Error(`Unhandled tag: ${n}`)}case"@action":case"@note":case"@sense":case"@skill":return t;case"@5etools":case"@adventure":case"@book":case"@filter":case"@footnote":case"@link":case"@scaledice":case"@loader":{const e=t.split("|");return e[0]}case"@area":case"@background":case"@boon":case"@class":case"@condition":case"@creature":case"@cult":case"@disease":case"@feat":case"@hazard":case"@item":case"@object":case"@optfeature":case"@psionic":case"@race":case"@reward":case"@ship":case"@spell":case"@table":case"@trap":case"@variantrule":{const e=t.split("|");return 3<=e.length?e[2]:e[0]}case"@deity":{const e=t.split("|");return 4<=e.length?e[3]:e[0]}case"@homebrew":{const[e,n]=t.split("|");if(e&&n)return`${e} [this is a homebrew addition, replacing the following: "${n}"]`;if(e)return`${e} [this is a homebrew addition]`;if(n)return`[the following text has been removed due to homebrew: ${n}]`;throw new Error(`Homebrew tag had neither old nor new text!`)}default:throw new Error(`Unhandled tag: "${n}"`);}}else return e}).join("")}return e},Renderer.isRollableTable=function(e){let n=!1;if(e.colLabels&&(n=2<=e.colLabels.length&&RollerUtil.isRollCol(e.colLabels[0]),n)){const t=e.rows.find(e=>{try{return!/\d+([-\u2013]\d+)?/.exec(e[0])}catch(n){return!0}});t&&(n=!1)}return n},Renderer.getRollableRow=function(n,t){n=MiscUtil.copy(n);try{const e=/^(\d+)([-\u2013](\d+))?$/.exec((n[0]+"").trim());if(e)e[1]&&!e[2]?(n[0]={type:"cell",roll:{exact:+e[1]}},"0"===e[1][0]&&(n[0].roll.pad=!0)):(n[0]={type:"cell",roll:{min:+e[1],max:+e[3]}},("0"===e[1][0]||"0"===e[3][0])&&(n[0].roll.pad=!0));else{const e=/^(\d+)\+$/.exec(n[0]);n[0]={type:"cell",roll:{min:+e[1],max:Renderer.dice.POS_INFINITE}}}}catch(r){t&&t(n[0],r)}return n},Renderer.initLazyImageLoaders=function(){const e=$(`img[data-src]`);Renderer._imageObserver&&Renderer._imageObserver.disconnect(),Renderer._imageObserver=new IntersectionObserver(function(e){e.forEach(e=>{if(0<e.intersectionRatio){Renderer._imageObserver.unobserve(e.target);const n=$(e.target);n.attr("src",n.attr("data-src")).removeAttr("data-src")}})},{rootMargin:"150px 0px",threshold:.01}),e.each((e,n)=>Renderer._imageObserver.observe(n))},Renderer._imageObserver=null,Renderer.HEAD_NEG_1="rd__b--0",Renderer.HEAD_0="rd__b--1",Renderer.HEAD_1="rd__b--2",Renderer.HEAD_2="rd__b--3",Renderer.HEAD_2_SUB_VARIANT="rd__b--4",Renderer.DATA_NONE="data-none","undefined"!=typeof module&&(module.exports.Renderer=Renderer,global.Renderer=Renderer);;
"use strict";("undefined"==typeof module?window:global).ScaleCreature={_crRangeToVal(c,d){return Object.keys(d).find(e=>{const[f,a]=d[e];return c>=f&&c<=a})},_acCrRanges:{13:[-1,3],14:[4,4],15:[5,7],16:[8,9],17:[10,12],18:[13,16],19:[17,30]},_crToAc(a){return+this._crRangeToVal(a,this._acCrRanges)},_crHpRanges:{0:[1,6],0.125:[7,35],0.25:[36,49],0.5:[50,70],1:[71,85],2:[86,100],3:[101,115],4:[116,130],5:[131,145],6:[146,160],7:[161,175],8:[176,190],9:[191,205],10:[206,220],11:[221,235],12:[236,250],13:[251,265],14:[266,280],15:[281,295],16:[296,310],17:[311,325],18:[326,340],19:[341,355],20:[356,400],21:[401,445],22:[446,490],23:[491,535],24:[536,580],25:[581,625],26:[626,670],27:[671,715],28:[716,760],29:[761,805],30:[806,850]},_crToEstimatedConModRange:{0:[-1,2],0.125:[-1,1],0.25:[0,2],0.5:[0,2],1:[0,2],2:[0,3],3:[1,3],4:[1,4],5:[2,4],6:[2,5],7:[1,5],8:[1,5],9:[2,5],10:[2,5],11:[2,6],12:[1,5],13:[3,6],14:[3,6],15:[3,6],16:[4,7],17:[3,7],18:[1,7],19:[4,6],20:[5,9],21:[3,8],22:[4,9],23:[5,9],24:[5,9],25:[7,9],26:[7,9],27:[7,9],28:[7,9],29:[7,9],30:[10,10]},_atkCrRanges:{3:[-1,2],4:[3,3],5:[4,4],6:[5,7],7:[8,10],8:[11,15],9:[16,16],10:[17,20],11:[21,23],12:[24,26],13:[27,29],14:[30,30]},_crToAtk(a){return this._crRangeToVal(a,this._atkCrRanges)},_crDprRanges:{0:[0,1],0.125:[2,3],0.25:[4,5],0.5:[6,8],1:[9,14],2:[15,20],3:[21,26],4:[27,32],5:[33,38],6:[39,44],7:[45,50],8:[51,56],9:[57,62],10:[63,68],11:[69,74],12:[75,80],13:[81,86],14:[87,92],15:[93,98],16:[99,104],17:[105,110],18:[111,116],19:[117,122],20:[123,140],21:[141,158],22:[159,176],23:[177,194],24:[195,212],25:[213,230],26:[231,248],27:[249,266],28:[267,284],29:[285,302],30:[303,320]},_crToEstimatedDamageMod:{0:[-1,2],0.125:[0,2],0.25:[0,3],0.5:[0,3],1:[0,3],2:[1,4],3:[1,4],4:[2,4],5:[2,5],6:[2,5],7:[2,5],8:[2,5],9:[2,6],10:[3,6],11:[3,7],12:[2,6],13:[3,7],14:[4,7],15:[3,7],16:[4,8],17:[4,8],18:[3,7],19:[5,8],20:[6,9],21:[5,9],22:[6,10],23:[6,10],24:[6,11],25:[8,11],26:[7,9],27:[7,9],28:[7,9],29:[7,9],30:[9,11]},_dcRanges:{13:[-1,3],14:[4,4],15:[5,7],16:[8,10],17:[11,12],18:[13,16],19:[17,20],20:[21,23],21:[24,26],22:[27,29],23:[30,30]},_crToDc(a){return this._crRangeToVal(a,this._dcRanges)},_casterLevelAndClassCantrips:{bard:[2,2,2,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4],cleric:[3,3,3,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5],druid:[2,2,2,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4],sorcerer:[4,4,4,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6],warlock:[2,2,2,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4],wizard:[3,3,3,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5]},_casterLevelAndClassToCantrips(a,b){return b=(b||"cleric").toLowerCase(),this._casterLevelAndClassCantrips[b][a]},_protectedCantrips:["acid splash","chill touch","eldritch blast","fire bolt","poison spray","produce flame","ray of frost","sacred flame","shocking grasp","thorn whip","vicious mockery"],_crToCasterLevelAvg:{0:2,0.125:2,0.25:2,0.5:2,1:3.5,2:4.25,3:5.75,4:6.75,5:8,6:9.75,7:10.5,8:10.75,9:11.5,10:11.75,11:12,12:13,13:14,14:15,15:16,16:17,17:18,18:19},_crToCasterLevel(a){return 0===a?2:19<=a?20:this._crToCasterLevelAvg[a]},_calcNewAbility(a,b,c){return Math.max(1,2*(c+5)+a[b]%2)},_rng:null,_initRng(a,b){let c=CryptUtil.hashCode(b);c=31*c+CryptUtil.hashCode(a.source),c=31*c+CryptUtil.hashCode(a.name),this._rng=Math.seed(c)},scale(b,c){return this._pInitSpellCache().then(()=>{if(null==c||"Unknown"===c)throw new Error("Attempting to scale unknown CR!");this._initRng(b,c),b=JSON.parse(JSON.stringify(b));const a=b.cr.cr||b.cr,d=Parser.crToNumber(a);if(d===c)throw new Error("Attempting to scale creature to own CR!");if(30<d)throw new Error("Attempting to scale a creature beyond 30 CR!");if(0>d)throw new Error("Attempting to scale a creature below 0 CR!");const e=Parser.crToPb(a),f=Parser.crToPb(c+"");e!==f&&this._applyPb(b,e,f),this._adjustHp(b,d,c),this._adjustAtkBonusAndSaveDc(b,d,c,e,f),this._adjustDpr(b,d,c),this._adjustSpellcasting(b,d,c),this._adjustAc(b,d,c),this._handleUpdateAbilityScoresSkillsSaves(b,f),[`str`,`dex`,`con`,`int`,`wis`,`cha`].forEach(c=>delete b[`${c}Old`]);const g=Parser.numberToCr(c);return b.cr.cr?b.cr.cr=g:b.cr=g,b._displayName=`${b.name} (CR ${g})`,b._isScaledCr=c,b._originalCr=b._originalCr||a,b})},_applyPb(a,b,c){const d=(a,d)=>{const e=+a-(d?2*b:b)+(d?2*c:c);return`${0<=e?"+":""}${e}`};a.save&&Object.keys(a.save).forEach(c=>{const e=a.save[c],f=Parser.getAbilityModNumber(a[c]);if(f===+e)return;a.save[c]=d(e,e-f===2*b)}),a.skill&&Object.keys(a.skill).forEach(c=>{const e=a.skill[c],f=Parser.getAbilityModNumber(a[Parser.skillToAbilityAbv(c)]);if(f===+e)return;a.skill[c]=d(e,e-f===2*b),"perception"===c&&null!=a.passive&&(a.passive=10+ +a.skill[c])});const e=c-b,f=a=>a.replace(/{@hit ([-+]?\d+)}/g,(a,b)=>{return`{@hit ${+b+e}}`}),g=a=>a.replace(/DC (\d+)/g,(a,b)=>`{@dc ${b}}`).replace(/{@dc (\d+)}/g,(a,b)=>{return`DC ${+b+e}`});a.spellcasting&&a.spellcasting.forEach(a=>{if(a.headerEntries){const b=JSON.stringify(a.headerEntries),c=g(f(b));a.headerEntries=JSON.parse(c)}});const h=b=>{a[b]&&a[b].forEach(a=>{const b=JSON.stringify(a.entries),c=g(f(b));a.entries=JSON.parse(c)})};h("trait"),h("action"),h("reaction"),h("legendary"),h("variant")},_acHeavy:{"ring mail":14,"chain mail":16,"splint armor":17,"plate armor":18},_acMedium:{"hide armor":12,"chain shirt":13,"scale mail":14,breastplate:14,"half plate armor":15},_acLight:{"padded armor":11,"leather armor":11,"studded leather armor":12},_acMageArmor:"@spell mage armor",_adjustAc(a,b,c){var d=Math.min;const e=(a,b)=>{const c=[];for(let d=0;3>d;++d)c.push({tag:`${a} +${d+1}|dmg`,mod:b+d+1}),c.push({tag:`+${d+1} ${a}|dmg`,mod:b+d+1});return c},f=a=>Object.keys(a).map(b=>{const c=a[b];return[{tag:`${b}|phb`,mod:c}].concat(e(b,c))}).reduce((c,a)=>c.concat(a),[]),g=(()=>[{tag:"shield|phb",mod:2}].concat(e("shield",2)))(),h=f(this._acHeavy),i=f(this._acMedium),j=f(this._acLight),k=(a,b)=>{const c=b.replace(/( \+\d)?\|.*$/,""),d=a[c],e=/^.*? (\+\d)\|.*$/.exec(b),f=e?+e[1]:0;return[d,f]},l=(a,b)=>a.find(a=>b.includes(`@item ${a}`)),m=(a,b,c)=>{const d=a.replace(`@item ${b}`,`@item ${c}`),e=d.split("|");return 2<e.length?`${e.slice(0,2).join("|")}}`:d},n=()=>!1===a._shieldRequired&&!1===a._shieldDropped,o=a=>{const b=a.from.findIndex(a=>g.find(b=>a._.includes(b.tag)));if(-1===b)throw new Error("Should never occur!");a.from.splice(b,1)},p=a=>{a=a.trim().toLowerCase();const b=[this._acHeavy,this._acMedium,this._acLight,{shield:2}];for(const c of b){const b=Object.keys(c).find(b=>a===b);if(b){const a=c[b];if(10<a)return a-10}}},q=a=>{a=a.trim().toLowerCase();const b=[this._acHeavy,this._acMedium,this._acLight].findIndex(b=>!!Object.keys(b).find(b=>a===b));return 0===b?0:1===b?2:3===b?999:null};a.ac=a.ac.map(e=>{let f=0;const r=()=>{"number"!=typeof e&&(e._enchTotal=e._enchTotal||0,e._gearBonus=0,e._dexCap=999),e.from&&(e.from=e.from.map(a=>{a._&&(a=a._);const b=/@item (\+\d+)([^+\d}]+)/gi.exec(a);if(b){const[c,d,e,f]=b.map(a=>a.trim()),g=(f||"").split("|"),h=1<g.length?g.last():null;a=`{@item ${e} ${d}|dmg|${h||`${d} ${e}`}}`}const c=/@item ([^+\d]+)(\+\d+)\|([^|}]+)/gi.exec(a);if(c){const[b,f,g,h]=c,i=p(f);i&&(e._gearBonus+=i);const j=q(f);null!=j&&(e._dexCap=d(e._dexCap,j));const k=+g;return e._enchTotal+=k,{_:a,name:f.trim(),ench:k,source:h}}else{const b=/@item ([^|}]+)(\|[^|}]+)?(\|[^|}]+)?/gi.exec(a);if(b){const[c,f,g,h]=b,i={_:a,name:f};g&&(i.source=g),h&&(i.display=h);const j=p(f);j&&(e._gearBonus+=j,i._gearBonus=j);const k=q(f);return null!=k&&(e._dexCap=d(e._dexCap,k)),i}return{_:a,name:a}}}));const r=null==a.dexOld?null:(()=>e._gearBonus||0)()+d(Parser.getAbilityModNumber(a.dexOld),(()=>e._dexCap||999)())+10;let s=null==a.dexOld;const t=Parser.getAbilityModNumber(a.dex)-Parser.getAbilityModNumber(a.dexOld||a.dex),u=e.ac||e,v=u-(0==f?(()=>e._enchTotal||0)():0);"number"!=typeof e&&(e._miscOffset=e._miscOffset||(null==r?null:v-r));const w=this._crToAc(b),x=this._crToAc(c),y=null==r?v:r,z=this._getScaledToRatio(y,w,x);let A=z;const B=z-y,C=B-t,D=()=>(a.dexOld=a.dex,a.dex=this._calcNewAbility(a,"dex",Parser.getAbilityModNumber(a.dex)+C),s=!1,!0),E=()=>0<C?s?(D(),z):{ac:z,from:["natural armor"]}:0>C&&s?(D(),z):z,F=()=>!!(e.condition&&e.condition.toLowerCase().includes(this._acMageArmor))&&(s?(e.ac=z,D()):(e.ac=13+Parser.getAbilityModNumber(a.dex),!0)),G=()=>{const b=3;if(e.from){const c=e.from.filter(a=>g.find(b=>a._.includes(`@item ${b.tag}`)));if(c.length){if(1<c.length)throw new Error("AC contained multiple shields!");const d=null==a._shieldRequired?(()=>{const b=b=>{if(!a[b])return!1;for(const c of a[b]){if(c.name&&c.name.toLowerCase().includes("shield"))return!0;if(c.entries&&JSON.stringify(c.entries).match(/shield/i))return!0}};return a._shieldRequired=b("trait")||b("action")||b("reaction")||b("legendary")})():a._shieldRequired;a._shieldDropped=!1;const f=c[0]._,h=e.from.findIndex(a=>a===f);if(!f.endsWith("|shields}")){const b=g.find(a=>f.includes(a.tag));if(A-=b.mod,!d&&B<=-b.mod&&(e.from.splice(h,1),e.ac-=b.mod,a._shieldDropped=!0,e.ac===z))return!0}else if(A-=b,!d&&-3>=B&&(e.from.splice(h,1),e.ac-=b,a._shieldDropped=!0,e.ac===z))return!0}}return!1},H=()=>{const b=21,c=h.map(a=>a.tag),f=a=>14<=a&&a<=b,g=a=>a>b,j=a=>{const b=Object.keys(this._acHeavy).find(b=>this._acHeavy[b]===a);return b?`${b}|phb`:19===a?[`plate armor +1|dmg`,`splint armor +2|dmg`][RollerUtil.roll(1,this._rng)]:20===a?`plate armor +2|dmg`:21===a?`plate armor +3|dmg`:void 0};if(e.from)for(let b=0;b<e.from.length;++b){const h=l(c,e.from[b]._);if(h){if(f(A)){const a=15===A;return a&&A++,e.from[b]._=m(e.from[b]._,h,j(A)),e.ac=z+(a?1:0),!0}if(n()&&f(z)){const a=z+(15===z?1:0);return e.from[b]._=m(e.from[b]._,h,j(a)),e.ac=a,o(e),!0}if(g(A)){return e.from[b]._=m(e.from[b]._,h,j(21)),e.ac=21,!0}else{const[c,f]=k(this._acLight,h);return e.from[b]._=m(e.from[b]._,h,`half plate armor|phb`),e.ac=e.ac-(c+f)+15+d(2,Parser.getAbilityModNumber(a.dex)),!1}}}return!1},I=()=>{const b=i.map(a=>a.tag),c=(b,c)=>{const e=12+(s?-5:Parser.getAbilityModNumber(a.dex)),f=18+(s?2:d(2,Parser.getAbilityModNumber(a.dex)));return c?b<e?-1:b>f?1:0:b>=e&&b<=f},f=(b,c)=>{const e=a=>{switch(a){case 14:return[`scale mail|phb`,`breastplate|phb`][RollerUtil.roll(1,this._rng)];case 16:return[`half plate armor +1|dmg`,`breastplate +2|dmg`,`scale mail +2|dmg`][RollerUtil.roll(2,this._rng)];case 17:return`half plate armor +2|dmg`;case 18:return`half plate armor +3|dmg`;default:{const b=Object.keys(this._acMedium).find(b=>this._acMedium[b]===a);return`${b}|phb`}}};if(s){let f=c.ac,g=f+2,h=f-5;const i=()=>b>=h&&b<=g,j=()=>f+d(2,Parser.getAbilityModNumber(a.dex));for(let c=0;;){if(1e3<c)throw new Error(`Failed to find valid light armor!`);if(i())s=!1,null==a.dexOld&&(a.dexOld=a.dex),b>j()?a.dex+=2:a.dex-=2;else{if(b<h?f-=1:f+=1,12>f||18<f)throw Error("Should never occur!");g=f+2,h=f-5}if(j()===b)break;c++}return e(f)}else{const c=d(Parser.getAbilityModNumber(a.dex),2);return e(b-c)}};if(e.from)for(let g=0;g<e.from.length;++g){const h=l(b,e.from[g]._);if(h){const[b,i]=k(this._acMedium,h),j=b+i;return c(A)?(e.from[g]._=m(e.from[g]._,h,f(A,{tag:h,ac:j})),e.ac=z,!0):n()&&c(z)?(e.from[g]._=m(e.from[g]._,h,f(z,{tag:h,ac:j})),e.ac=z,o(e),!0):s&&-1===c(A,!0)?(e.from[g]._=m(e.from[g]._,h,`studded leather armor|phb`),e.ac=e.ac-j-d(2,Parser.getAbilityModNumber(a.dex))+12+Parser.getAbilityModNumber(a.dex),!1):(e.from[g]._=m(e.from[g]._,h,`ring mail|phb`),e.ac=e.ac-j-d(2,Parser.getAbilityModNumber(a.dex))+14,-1)}}return!1},J=()=>{const b=j.map(a=>a.tag),c=(b,c)=>{const d=11+(s?-5:Parser.getAbilityModNumber(a.dex)),e=15+(s?100:Parser.getAbilityModNumber(a.dex));return c?b<d?-1:b>e?1:0:b>=d&&b<=e},f=(b,c)=>{const d=a=>11===a?[`padded armor|phb`,`leather armor|phb`][RollerUtil.roll(1,this._rng)]:12===a?`studded leather armor|phb`:13===a?[`padded armor +1|dmg`,`leather armor +1|dmg`][RollerUtil.roll(1,this._rng)]:14===a?[`padded armor +2|dmg`,`leather armor +2|dmg`,`studded leather armor +1|dmg`][RollerUtil.roll(2,this._rng)]:15===a?`studded leather armor +2|dmg`:void 0;if(s){let e=c.ac,f=e-5;const g=()=>b>=f,h=()=>e+Parser.getAbilityModNumber(a.dex);for(let c=0;;){if(1e3<c)throw new Error(`Failed to find valid light armor!`);if(g())s=!1,null==a.dexOld&&(a.dexOld=a.dex),b>h()?a.dex+=2:a.dex-=2;else{if(b<f?e-=1:e+=1,11>e||15<e)throw Error("Should never occur!");f=e-5}if(h()===b)break;c++}return d(e)}else{const c=Parser.getAbilityModNumber(a.dex);return d(b-c)}};if(e.from)for(let g=0;g<e.from.length;++g){const h=l(b,e.from[g]._);if(h){const[b,i]=k(this._acLight,h),j=b+i;return c(A)?(e.from[g]._=m(e.from[g]._,h,f(A,{tag:h,ac:j})),e.ac=z,!0):n()&&c(z)?(e.from[g]._=m(e.from[g]._,h,f(z,{tag:h,ac:j})),e.ac=z,o(e),!0):s||-1!==c(A,!0)?(e.from[g]._=m(e.from[g]._,h,`chain shirt|phb`),e.ac=e.ac-j-Parser.getAbilityModNumber(a.dex)+13+d(2,Parser.getAbilityModNumber(a.dex)),-1):1===e.from.length?(e._droppedArmor=!0,-1):(e.from.splice(g,1),e.ac=e.ac-j+10,-1)}}return!1},K=()=>!!(e.from&&e.from.map(a=>a._).includes("natural armor"))&&(s?(e.ac=z,D()):(e.ac=z,!0));if(e.ac&&!e._droppedArmor){const a=[F,G,H,I,J,K];let b=0;for(let c=0;c<a.length;++c){if(b=a[c](),-1===b)return null;if(b)break}return b||(e.ac=z),e}return E()};let s=null;for(;null==s;){if(100<f)throw new Error(`Failed to calculate new AC! Input was:\n${JSON.stringify(e,null,"\t")}`);s=r(),f++}let t=!e._enchTotal;if(e.from&&(e._enchTotal&&e.from.forEach(a=>{if(!t)if(a.ench&&3>a.ench){const b=d(3-a.ench,e._enchTotal);e._enchTotal-=b,a.ench+=b,e.ac+=b,a._=`{@item ${a.name} +${a.ench}|dmg|+${a.ench} ${a.name}}`,0>=e._enchTotal&&(t=!0)}else if(s._gearBonus){const b=d(3,e._enchTotal);e._enchTotal-=b,a._=`{@item ${a.name} +${b}|dmg|+${b} ${a.name}}`,0>=e._enchTotal&&(t=!0)}}),e.from=e.from.map(a=>a._)),!t){const a=d(3,e._enchTotal);e._enchTotal-=a,e.ac+=a+1,(e.from=e.from||[]).unshift(`{@item leather armor +${a}|dmg|+${a} leather armor}`),0<e._enchTotal&&(e.ac+=e._enchTotal)}return null!=e._miscOffset&&(e.ac+=e._miscOffset),["_enchTotal","_gearBonus","_dexCap","_miscOffset"].forEach(a=>delete e[a]),s})},_interpAndTranslateToSpace(a,b,c){let[d,e]=b,[f,g]=c;const j=.1;d-=j,e+=j,f-=j,g+=j;const k=(a-d)/(e-d);return Math.round(k*(g-f)+f)},_getScaledToRatio(a,b,c){return Math.round(a*(c/b))},_adjustHp(a,b,c){var d=Math.ceil,e=Math.floor,f=Math.mean,g=Math.max;if(a.hp.special)return;const h=f(...this._crHpRanges[b]),i=this._crHpRanges[c],j=f(...i),k=this._getScaledToRatio(a.hp.average,h,j),l=(i[1]-i[0])/2,m=[e(k-l),d(k+l)],n=a.hp.formula.replace(/\s*/g,"");a.hp.average=e(g(1,k));const o=n.split(/([-+])/),p=/(\d+)d(\d+)/i.exec(o[0]),q=+p[2],r=(q+1)/2,s=+p[1],t=3===o.length?+`${o[1]}${o[2]}`:0,u=e(t/s);let v=s,w=(()=>{const a=this._crToEstimatedConModRange[c];return a[0]===a[1]?a[0]:this._interpAndTranslateToSpace(u,this._crToEstimatedConModRange[b],a)})();const x=(a=v,b=w)=>a*r+a*b,y=a=>a>=m[0]&&a<=m[1];for(let d=0;!y(x(v));){if(100<d)throw new Error(`Failed to find new HP! Current formula is: ${s}d${w}`);const a=()=>{let a=v,b=x(),c=!1;if(b>m[1]){for(;1<a;)if(a-=1,b-=r,y(x(a))){c=!0;break}}else for(;b<=m[1];)if(a+=1,b+=r,y(x(a))){c=!0;break}return!!c&&(v=a,!0)},b=()=>{w+=(1-2*(d%2))*(d+1)};if(a())break;b(),d++}a.hp.average=e(x(v));const z=v*w;if(a.hp.formula=`${v}d${q}${0==z?"":` ${0<=z?"+":""} ${z}`}`,w!==u){const b=this._calcNewAbility(a,"con",w);if(b!==a.con&&a.save&&a.save.con){const c=Parser.getAbilityModifier(b)-Parser.getAbilityModifier(a.con),d=+a.save.con+c;a.save.con=`${0<=d?"+":""}${d}`}a.con=b}},_getEnchantmentBonus(a){const b=/\+(\d+)/.exec(a);return b?+b[1]:0},_wepThrownFinesse:["dagger","dart"],_wepFinesse:["dagger","dart","rapier","scimitar","shortsword","whip"],_wepThrown:["handaxe","javelin","light hammer","spear","trident","net"],_getModBeingScaled(a,b,c,d,e){const f=()=>{d=d.toLowerCase(),e=e.replace(/{@atk ([A-Za-z,]+)}/gi,(a,b)=>Renderer.attackTagToFull(b)).toLowerCase();const a=e.includes("melee or ranged weapon attack:");if(a){const a=this._wepThrownFinesse.find(a=>e.includes(a));if(a)return"dex";const b=this._wepFinesse.find(a=>e.includes(a));if(b)return"dex";const c=this._wepThrown.find(a=>e.includes(a));return c?"str":null}const b=e.includes("melee weapon attack:");if(b){const a=this._wepFinesse.find(a=>e.includes(a));return a?"dex":"str"}const c=e.includes("ranged weapon attack:");if(c){const a=this._wepThrown.find(a=>e.includes(a));return a?"str":"dex"}};return c&&(a!==b||a!==c)?a===c?"str":b===c?"dex":null:f()},_adjustAtkBonusAndSaveDc(a,b,c,d,e){var f=Math.max;const g=+this._crToAtk(b),h=+this._crToAtk(c),i=Parser.getAbilityModNumber(a.str),j=Parser.getAbilityModNumber(a.dex),k=a=>a+(h-g),l=(b,c)=>{const f=null==c?0:this._getEnchantmentBonus(c);return b.replace(/{@hit ([-+]?\d+)}/g,(g,h)=>{const l=+h,m=l-(f+e),n=null==c?null:this._getModBeingScaled(i,j,m,c,b),o=l+(d-e)-f,p=k(o);if(o===p)return g;if(null!=n){const b=`_${n}TmpMods`;a[b]=a[b]||[],a[b].push(m+(p-e-(o-d)))}return`{@hit ${p+f}}`})},m=this._crToDc(b),n=this._crToDc(c),o=a=>a+(n-m),p=(b,c)=>b.replace(/DC (\d+)/g,(a,b)=>`{@dc ${b}}`).replace(/{@dc (\d+)}/g,(b,g)=>{const h=+g,i=h+d-e,j=f(10,o(i));if(h===j)return b;if(["int","wis","cha"].includes(c)){const b=`${c}Old`;if(null==a[b]){a[b]=a[c];const d=Parser.getAbilityModNumber(a[c]);a[c]=this._calcNewAbility(a,c,d+(j-i))}}return`DC ${j}`});a.spellcasting&&a.spellcasting.forEach(a=>{if(a.headerEntries){const b=JSON.stringify(a.headerEntries),c=l(p(b,a.ability));a.headerEntries=JSON.parse(c)}});const q=b=>{a[b]&&a[b].forEach(a=>{const b=JSON.stringify(a.entries),c=p(l(b,a.name));a.entries=JSON.parse(c)})};q("trait"),q("action"),q("reaction"),q("legendary"),q("variant");const r=b=>{const c=`_${b}TmpMods`;if(a[c]){const d=`_${b}TmpMod`;if(0===a[c].length)throw new Error("Should never occur!");else if(1<a[c].length){const b=a[c][0],e=a[c].find(a=>a!==b);null==e&&(a[d]=a[c][0])}else a[d]=a[c][0];delete a[c]}};r("str"),r("dex")},_adjustDpr(a,b,c){var d=Math.ceil,e=Math.floor,f=Math.mean,g=Math.min,h=Math.max;const i=this._crDprRanges[b],j=this._crDprRanges[c],k=f(...i),l=f(...j),m=a=>(0===b&&(a=g(a,.63)),this._getScaledToRatio(a,k,l)),n=a=>{a=a.replace(/\s*/g,"");const b=a.replace(/d(\d+)/gi,(...a)=>` * ${(+a[1]+1)/2}`);return MiscUtil.expEval(b)},o=(j[1]-j[0])/2;let p=!1,q=[];for(;!p;){q=[];const f=Parser.getAbilityModNumber(a.str),g=Parser.getAbilityModNumber(a.dex),i=a._strTmpMod||f,j=a._dexTmpMod||g,k=k=>{if(a[k]){let l=!0;return a[k].forEach((p,r)=>{const s=JSON.stringify(p.entries);let t=s.replace(RollerUtil.REGEX_DAMAGE_FLAT,(a,b,c,d)=>{const e=m(c);return`${b}${e}${d}`});const u=[],v=this._getEnchantmentBonus(p.name);return t=t.replace(RollerUtil.REGEX_DAMAGE_DICE,(k,q,r,t,w)=>{t=t.replace(/\s+/g,"");const x=n(t),y=m(x),z=[h(0,e(y-o)),d(h(1,y+o))],A=a=>a>=z[0]&&a<=z[1],[B,C]=t.split(/[-+]/),[D,E]=B.split("d").map(a=>+a),F=C?+C-v:null,G=this._getModBeingScaled(f,g,F,p.name,s),H="str"===G?i:"dex"===G?j:null;let I=D,J=E,K=(()=>"str"===G&&null!=a._strTmpMod?a._strTmpMod:"dex"===G&&null!=a._dexTmpMod?a._dexTmpMod:null==F?0-v:this._interpAndTranslateToSpace(F,this._crToEstimatedDamageMod[b],this._crToEstimatedDamageMod[c]))();const L=()=>{if(-5>K)throw new Error(`Ability modifier ${null==G?"":`(${G})`} was below -5 (${K})! Original dice expression was ${t}.`);if(null!=H&&K!==H){const b=`_${G}TmpMod`,c=`_maxDpr${G.uppercaseFirst()}`;let d=!0;if(null!=a[b]&&a[b]!==K)if(a[c]>=y)d=!1;else return a[b]=K,a[c]=y,l=!1,"";d&&(a[c]=h(a[c]||0,y),a[b]=K),u.push({ability:G,mod:K,adjustedDpr:y})}},M=(d=I,a=J,b=K)=>`${d}d${a}${0===b?"":` ${0<b?"+":""} ${b}`}`;for(let a=0;!A(n(M()));){if(100<a)throw new Error(`Failed to find new DPR! Current formula is: ${M()}`);const b=(a=J,b=K)=>{let c=D,d=n(M(c,a,b)),e=!1;if(y<d){for(;1<c&&d>=z[0];)if(c-=1,d-=(a+1)/2,A(n(M(c,a,b)))){e=!0;break}}else for(;d<=z[1];)if(c+=1,d+=(a+1)/2,A(n(M(c,a,b)))){e=!0;break}return!!e&&(I=c,!0)},c=()=>{if(4===E||20===E)return;let a=E,c=n(M(void 0,a)),d=!1;if(y<c){for(;4<a&&c>=z[0];)if(a=Renderer.dice.getPreviousDice(a),c=n(M(void 0,a)),A(n(M(D,a,K)))){d=!0;break}else if(d=b(a),d)break;}else for(;20>a&&c<=z[1];)if(a=Renderer.dice.getNextDice(a),c=n(M(void 0,a)),A(n(M(D,a,K)))){d=!0;break}else if(d=b(a),d)break;return!!d&&(J=a,!0)},d=()=>{K+=(1-2*(a%2))*(a+1)};if(b())break;if(c())break;d(),a++}L();const N=M(void 0,void 0,K+v),O=e(n(N));return 0>=O?`1 ${w.replace(/^[^\w]+/," ")}`:`${e(n(N))}${r}${N}${w}`}),!!l&&void(s!==t&&q.push({prop:k,idxProp:r,entriesStrOriginal:s,entriesStr:t,reqAbilAdjust:u}))}),l}return!0};k("trait")&&k("action")&&k("reaction")&&k("legendary")&&k("variant")&&(p=!0)}q.forEach(b=>{a[b.prop][b.idxProp].entries=JSON.parse(b.entriesStr)});const r=b=>{const c=`_${b}TmpMod`;null!=a[c]&&(a[`${b}Old`]=a[b],a[b]=this._calcNewAbility(a,b,a[c])),delete a[c]};r("str"),r("dex")},_handleUpdateAbilityScoresSkillsSaves(a){const b=a=>`${0<=a?"+":""}${a}`;["str","dex","int","wis","con"].forEach(c=>{const d=`${c}Old`;if(null!=a[d]){const e=Parser.getAbilityModNumber(a[c])-Parser.getAbilityModNumber(a[d]);if(a.save&&null!=a.save[c]){const d=+a.save[c]+e;a.save[c]=b(d)}a.skill&&Object.keys(a.skill).forEach(d=>{const f=Parser.skillToAbilityAbv(d);if(f===c){const c=+a.skill[d]+e;a.skill[d]=b(c)}}),"wis"===c&&null!=a.passive&&(a.passive+=e)}})},_spells:null,_pInitSpellCache(){return this._spells?Promise.resolve():(this._spells={},DataUtil.loadJSON(`data/spells/spells-phb.json`).then(a=>{this.__initSpellCache(a)}))},__initSpellCache(a){a.spell.forEach(a=>{a.classes.fromClassList.forEach(b=>{let c=this._spells[b.source]=this._spells[b.source]||{};const d=b.name.toLowerCase();c=c[d]=c[d]||{},c=c[a.level]=c[a.level]||{},c[a.name]=1})})},_adjustSpellcasting(a,b,c){var d=Math.ceil,e=Math.round,f=Math.min,g=Math.max;const h=(a,b)=>{if(a<2*b-1)return 0;return 1===b?1===a?2:2===a?3:4:2===b?3===a?2:3:3===b?5===a?2:3:4===b?7===a?1:8===a?2:3:5===b?9===a?1:18>a?2:3:6===b?19<=a?2:1:7===b?20===a?2:1:8===b?1:9===b?1:void 0};if(a.spellcasting){const i=this._crToCasterLevel(b),j=this._crToCasterLevel(c),k=this._adjustSpellcasting_isWarlock(a);let l=null,n=null;a.spellcasting.forEach(a=>{let b=null;if(a.headerEntries){const c=JSON.stringify(a.headerEntries);let d=!1;const e=c.replace(/(an?) (\d+)[A-Za-z]+-level/i,(...a)=>{const b=+a[2],c=g(1,f(20,this._getScaledToRatio(b,i,j)));return d=b!==c,d?(null==l&&(l=b),null==n&&(n=c),`${Parser.getArticle(c)} ${Parser.spLevelToFull(c)}-level`):a[0]}),h=/(bard|cleric|druid|paladin|ranger|sorcerer|warlock|wizard) spell(?:s)?/i.exec(e);if(h)b=h[1];else{const a=/(bard|cleric|druid|paladin|ranger|sorcerer|warlock|wizard)(?:'s)? spell list/i.exec(e);a&&(b=a[1])}d&&(a.headerEntries=JSON.parse(e))}let c=null;if(n&&(c=f(9,d(n/2)),/paladin|ranger|warlock/i.exec(b)&&(c=f(5,n))),a.spells&&null!=n){const d=a.spells,i=/warlock/i.exec(b)&&1===Object.values(d).filter(a=>a.slots&&a.lower).length;if(d[0]){const a=d[0].spells.length,c=this._casterLevelAndClassToCantrips(l,b),e=this._casterLevelAndClassToCantrips(n,b),g=this._getScaledToRatio(a,c,e);if(a<g){const c=Object.keys((this._spells[SRC_PHB][b.toLowerCase()]||{})[0]).map(a=>a.toLowerCase());if(c.length){const b=[],e=f(g-a,c.length);for(let a=0;a<e;++a){const a=RollerUtil.roll(c.length,this._rng);b.push(c[a]),c.splice(a,1)}d[0].spells=d[0].spells.concat(b.map(a=>`{@spell ${a}}`))}}else for(const a=this._protectedCantrips.map(a=>`@spell ${a}`);d[0].spells.length>g;){const b=d[0].spells.filterIndex(b=>!~a.findIndex(a=>b.includes(a)));if(b.length){const a=RollerUtil.roll(b.length,this._rng);d[0].spells.splice(a,1)}else d[0].spells.pop()}}if(i){const a=Object.keys(d).find(a=>d[a].lower);if(c===+a)return;if(0===c)return void Object.keys(d).filter(a=>"0"!==a).forEach(a=>delete d[a]);const b=this._adjustSpellcasting_getWarlockNumSpellsKnown(n),e=this._spells[SRC_PHB].warlock;let f=[];for(let a=1;a<c+1;++a)f=f.concat(Object.keys(e[a]).map(a=>a.toSpellCase()));const g=[];for(let a=0;a<b;++a){const a=RollerUtil.roll(f.length,this._rng);g.push(f[a]),f.splice(a,1)}Object.keys(d).filter(a=>"0"!==a).forEach(a=>delete d[a]);const h=this._adjustSpellcasting_getWarlockNumSpellSlots(c);d[c]={slots:h,lower:1,spells:[`A selection of ${1===c?`{@filter 1st-level warlock spells|spells|level=${1}|class=warlock}.`:`{@filter 1st- to ${Parser.spLevelToFull(c)}-level warlock spells|spells|level=${[...Array(c)].map((a,b)=>b+1).join(";")}|class=warlock}.`}  Examples include: ${g.sort(SortUtil.ascSortLower).map(a=>`{@spell ${a}}`).joinConjunct(", "," and ")}`]}}else{let a=1;for(let j=1;10>j;++j){const i=d[j],k=h(l,j),m=h(n,j);if(i){if(i.slots){const b=this._getScaledToRatio(i.slots,k,m);a=b/m,i.slots=b,0>=b&&delete d[j]}}else if(j<=c){const c=g(1,e(m*a));if(b&&(this._spells[SRC_PHB][b.toLowerCase()]||{})[j]){const a=[],e=Object.keys(this._spells[SRC_PHB][b.toLowerCase()][j]).map(a=>a.toSpellCase()),g=f(5,e.length);for(let b=0;b<g;++b){const b=RollerUtil.roll(e.length,this._rng);a.push(e[b]),e.splice(b,1)}d[j]={slots:c,spells:[`A selection of {@filter ${Parser.spLevelToFull(j)}-level ${b} spells|spells|level=${j}|class=${b}}. Examples include: ${a.sort(SortUtil.ascSortLower).map(a=>`{@spell ${a}}`).joinConjunct(", "," and ")}`]}}else d[j]={slots:c,spells:[`A selection of {@filter ${Parser.spLevelToFull(j)}-level spells|spells|level=${j}}`]}}else delete d[j]}}}}),a.spellcasting.forEach(a=>{if(k&&a.daily&&a.daily["1e"]){const b=this._adjustSpellcasting_getWarlockNumArcanum(n),c=a.daily["1e"].length;if(a.daily["1e"].length===b)return;if(0===b)return delete a.daily["1e"];if(c>b){const c=a.daily["1e"].map(a=>{const b=/{@spell ([^|}]+)(?:\|([^|}]+))?[|}]/.exec(a);if(b){const c=b[1].toLowerCase(),d=(b[2]||SRC_PHB).toLowerCase(),e=Object.keys(this._spells).find(a=>a.toLowerCase()===d);if(e){const b=Object.keys(this._spells[e].warlock||{}).find(a=>Object.keys((this._spells[e].warlock||{})[a]).some(a=>a.toLowerCase()===c));if(b)return{original:a,level:+b}}}return{original:a,level:null}});for(let a=9;5<a;--a){for(const d=c.map(b=>b.level===a?c.indexOf(b):-1).filter(a=>~a);d.length&&c.length>b;)c.splice(d.pop(),1);if(c.length===b)break}a.daily["1e"]=c.map(a=>a.original)}else{for(let d=5+c;d<5+b;++d){const b=Object.keys(this._spells[SRC_PHB].warlock[d]),c=RollerUtil.roll(b.length,this._rng);a.daily["1e"].push(`{@spell ${b[c].toSpellCase()}}`)}a.daily["1e"].sort(SortUtil.ascSortLower)}}})}},_adjustSpellcasting_isWarlock(a){if(a.spellcasting)return a.spellcasting.some(a=>a.headerEntries&&/warlock spells?|warlock('s)? spell list/i.test(JSON.stringify(a.headerEntries)))},_adjustSpellcasting_getWarlockNumSpellsKnown(a){return 9>=a?a+1:10+Math.ceil((a-10)/2)},_adjustSpellcasting_getWarlockNumSpellSlots(a){return 1===a?1:11>a?2:17>a?3:4},_adjustSpellcasting_getWarlockNumArcanum(a){return 11>a?0:13>a?1:15>a?2:17>a?3:4}};