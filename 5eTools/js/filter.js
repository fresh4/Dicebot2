"use strict";class FilterUtil{static compress(a){return UrlUtil.pack(FilterUtil._compress_getBase(a))}static _compress_getBase(a){const b=typeof a;switch(b){case"boolean":return`b${+a}`;case"number":return`n${a}`;case"string":return`s${UrlUtil.pack(a)}`;default:throw new Error(`Unhandled type "${b}"`);}}static decompress(a){const[b,c]=[a.slice(0,1),a.slice(1)];switch(b){case"b":return!!+c;case"n":return+c;case"s":return c+"";default:throw new Error(`Unhandled type "${b}"`);}}}FilterUtil.SUB_HASH_PREFIX_LENGTH=4;class FilterBox{static async pGetStoredActiveSources(){const a=await StorageUtil.pGetForPage(FilterBox._STORAGE_KEY);if(a){const b=a.filters[FilterBox.SOURCE_HEADER];if(b){const a=b.state,c=[],d=[];return Object.entries(a).forEach(([a,b])=>{1===b?c.push(a):-1!==b&&d.push(a)}),c.length?c:d}}return null}static selectFirstVisible(a){if(History.lastLoadedId&&!History.initialLoad){const b=a[History.lastLoadedId],c=UrlUtil.autoEncodeHash(b),d=$("#listcontainer").find(`.list a[href="#${c.toLowerCase()}"]`);d.length||History._freshLoad()}else null!=History.lastLoadedId||History.initialLoad||History._freshLoad()}constructor(a){this._$wrpFormTop=a.$wrpFormTop,this._$btnReset=a.$btnReset,this._filters=a.filters,this._isCompact=a.isCompact,this._doSaveStateDebounced=MiscUtil.debounce(()=>this._pDoSaveState(),50),ProxyUtil.decorate(this),this.__meta={...FilterBox._DEFAULT_META},this._meta=this._getProxy(this.__meta,"meta"),this.__minisHidden={},this._minisHidden=this._getProxy(this.__minisHidden,"minisHidden"),this.__combineAs={},this._combineAs=this._getProxy(this.__combineAs,"combineAs"),this._$body=$(`body`),this._$overlay=null}registerMinisHiddenHook(a,b){this._addHook("minisHidden",a,b)}isMinisHidden(a){return!!this._minisHidden[a]}async pDoLoadState(){const a=await StorageUtil.pGetForPage(FilterBox._STORAGE_KEY);null!=a&&(this._setStateFromLoaded(a.box),this._filters.forEach(b=>b.setStateFromLoaded(a.filters)))}_setStateFromLoaded(a){Object.assign(this._meta,a.meta),Object.assign(this._minisHidden,a.minisHidden),Object.assign(this._combineAs,a.combineAs)}async _pDoSaveState(){const a={};this._filters.forEach(b=>Object.assign(a,b.getSaveableState()));const b={box:{meta:{...this.__meta},minisHidden:{...this.__minisHidden},combineAs:{...this.__combineAs}},filters:a};await StorageUtil.pSetForPage(FilterBox._STORAGE_KEY,b)}render(){if(this._$overlay)this._filters.map(a=>a.update());else{this._$overlay=this._render_$getOverlay();const a=$(`<div class="fltr__mini-view btn-group"/>`).insertAfter(this._$wrpFormTop),b=this._filters.map((b,c)=>b.$render({filterBox:this,isFirst:0===c,$wrpMini:a})),c=$(`<button class="btn btn-xs btn-default">Show All</button>`).click(()=>this.showAllFilters()),d=$(`<button class="btn btn-xs btn-default">Hide All</button>`).click(()=>this.hideAllFilters()),e=$(`<button class="btn btn-xs btn-default mr-3" title="Reset filters. SHIFT to reset everything.">Reset</button>`).click(a=>this.reset(a.shiftKey)),f=$(`<button class="btn btn-xs btn-default"><span class="glyphicon glyphicon-cog"/></button>`).click(()=>this._openSettingsModal()),g=$(`<div class="btn-group mr-3"></div>`),h=$(`<button class="btn btn-xs btn-default"><span class="glyphicon glyphicon-cog"/></button>`).click(()=>this._openCombineAsModal()),i=$(`<button class="btn btn-xs btn-default"/>`).appendTo(g).click(()=>this._meta.modeCombineFilters=FilterBox._COMBINE_MODES.getNext(this._meta.modeCombineFilters)),j=()=>{i.text("custom"===this._meta.modeCombineFilters?this._meta.modeCombineFilters.uppercaseFirst():this._meta.modeCombineFilters.toUpperCase()),"custom"===this._meta.modeCombineFilters?g.append(h):h.detach(),this._doSaveStateDebounced()};if(this._addHook("meta","modeCombineFilters",j),j(),$$`<div class="ui-modal__inner ui-modal__inner--large dropdown-menu">
			<div class="split mb-2 mt-2 flex-v-center">
				<h4 class="m-0">Filters</h4>
				<div class="flex-v-center">
					<div class="mr-2">Combine filters as...</div>
					${g}
					<div class="btn-group mr-2">
						${c}
						${d}
					</div>
					${e}
					${f}
				</div>
			</div>
			<hr class="full-width m-0 mb-2">
			
			<hr class="mt-1 mb-1">
			<div class="ui-modal__scroller smooth-scroll px-1">
				${b}
			</div>
			</div>`.click(a=>a.stopPropagation()).appendTo(this._$overlay),this._$btnReset.attr("title","Reset filters. SHIFT to reset everything.").click(a=>this.reset(a.shiftKey)),!this._isCompact){const b=$(`<button class="btn btn-default" title="Toggle Filter Summary Display"><span class="glyphicon glyphicon-resize-small"/></button>`).click(()=>{this._meta.isSummaryHidden=!this._meta.isSummaryHidden,this._doSaveStateDebounced()}).prependTo(this._$wrpFormTop),c=()=>{b.toggleClass("active",!!this._meta.isSummaryHidden),a.toggleClass("hidden",!!this._meta.isSummaryHidden)};this._addHook("meta","isSummaryHidden",c),c()}$(`<button class="btn btn-default ${this._isCompact?"px-2":""}">Filter</button>`).click(()=>this.show()).prependTo(this._$wrpFormTop)}}_render_$getOverlay(){const a=$(`<div class="modal__wrp modal__wrp--no-centre"/>`).hide().appendTo(this._$body);return a.click(()=>this.hide()),a}_openSettingsModal(){const a=UiUtil.getShow$Modal({title:"Settings"});UiUtil.$getAddModalRowHeader(a,"Hide summary for filter...",{helpText:"The summary is the small red and blue button panel which appear below the search bar."}),this._filters.forEach(b=>UiUtil.$getAddModalRowCb(a,b.header,this._minisHidden,b.header))}_openCombineAsModal(){const a=UiUtil.getShow$Modal({title:"Filter Combination Logic"}),b=$(`<button class="btn btn-xs btn-default">Reset</button>`).click(()=>{Object.keys(this._combineAs).forEach(a=>{this._combineAs[a]="and",c.forEach(a=>a.val("0"))})});UiUtil.$getAddModalRowHeader(a,"Combine filters as...",{$eleRhs:b});const c=this._filters.map(b=>UiUtil.$getAddModalRowSel(a,b.header,this._combineAs,b.header,["and","or"],{fnDisplay:a=>a.toUpperCase()}))}getValues(){const a={};return this._filters.forEach(b=>Object.assign(a,b.getValues())),a}addEventListener(a,b){this._$wrpFormTop[0].addEventListener(a,b)}_reset_meta(){Object.assign(this._meta,FilterBox._DEFAULT_META)}_reset_minisHidden(){Object.keys(this._minisHidden).forEach(a=>this._minisHidden[a]=!1)}_reset_combineAs(){Object.keys(this._combineAs).forEach(a=>this._combineAs[a]="and")}reset(a){this._filters.forEach(b=>b.reset(a)),a&&(this._reset_meta(),this._reset_minisHidden(),this._reset_combineAs()),this.render(),this.fireChangeEvent()}show(){this._$body.css("overflow","hidden"),this._$overlay.show()}hide(){this._$body.css("overflow",""),this._$overlay.hide(),this.fireChangeEvent()}showAllFilters(){this._filters.forEach(a=>a.show())}hideAllFilters(){this._filters.forEach(a=>a.hide())}setFromSubHashes(a){const b={};a.forEach(a=>{const c=UrlUtil.unpackSubHash(a,!0);if(1<Object.keys(c).length)throw new Error(`Multiple keys in subhash!`);const d=Object.keys(c)[0];c[d]={clean:c[d],raw:a},Object.assign(b,c)});const c={};this._filters.forEach(a=>{const b=a.getChildFilters();b.length?b.forEach(a=>c[a.header.toLowerCase()]=a):c[a.header.toLowerCase()]=a});const d=new Set,e=new Set,f={},g={};if(Object.entries(b).forEach(([a,b])=>{const h=a.substring(0,FilterUtil.SUB_HASH_PREFIX_LENGTH),i=a.substring(FilterUtil.SUB_HASH_PREFIX_LENGTH);if(FilterUtil.SUB_HASH_PREFIXES.has(h)&&c[i])(g[i]=g[i]||{})[h]=b.clean,d.add(i),e.add(b.raw);else if(Object.values(FilterBox._SUB_HASH_PREFIXES).includes(h))f[h]=b.clean,e.add(b.raw);else if(FilterUtil.SUB_HASH_PREFIXES.has(h))throw new Error(`Could not find filter with header ${i} for subhash ${b.raw}`)}),e.size){this._setFromSubHashState(c,f),Object.entries(g).forEach(([a,b])=>{const d=c[a];d.setFromSubHashState(b)}),Object.keys(c).filter(a=>!d.has(a)).forEach(a=>{const b=c[a];b.reset(!0)});const[a]=History._getHashParts(),h=[];return Object.values(b).filter(a=>!e.has(a.raw)).forEach(a=>h.push(a.raw)),History.setSuppressHistory(!0),window.history.replaceState({},document.title,`${location.origin}${location.pathname}${`#${a}${h.length?`${HASH_PART_SEP}${h.join(HASH_PART_SEP)}`:""}`}`),this.fireChangeEvent(),History.hashChange(),h}return a}_setFromSubHashState(a,b){let c=!1,d=!1,e=!1;Object.entries(b).forEach(([b,f])=>{const g=Parser._parse_bToA(FilterBox._SUB_HASH_PREFIXES,b);switch(g){case"meta":{c=!0;const a=f.map(a=>FilterUtil.decompress(a));Object.keys(FilterBox._DEFAULT_META).forEach((b,c)=>this._meta[b]=a[c]);break}case"minisHidden":{d=!0,Object.keys(this._minisHidden).forEach(a=>this._minisHidden[a]=!1),f.forEach(b=>{const[c,d]=b.split("="),e=a[c];if(!e)throw new Error(`Could not find filter with name "${c}"`);this._minisHidden[e.header]=!!+d});break}case"combineAs":{e=!0,Object.keys(this._combineAs).forEach(a=>this._combineAs[a]="and"),f.forEach(b=>{const[c,d]=b.split("="),e=a[c];if(!e)throw new Error(`Could not find filter with name "${c}"`);this._combineAs[e.header]=FilterBox._COMBINE_MODES[d]||FilterBox._COMBINE_MODES[0]});break}}}),c||this._reset_meta(),d||this._reset_minisHidden(),e||this._reset_combineAs()}getSubHashes(){const a=[],b=this._getSubHashes();return b&&a.push(b),a.push(...this._filters.map(a=>a.getSubHashes()).filter(Boolean)),a.flat()}_getSubHashes(){const a=[],b=Object.keys(FilterBox._DEFAULT_META).find(a=>this._meta[a]!==FilterBox._DEFAULT_META[a]);if(b){const a=Object.keys(FilterBox._DEFAULT_META).map(a=>FilterUtil.compress(this._meta[a]));return[UrlUtil.packSubHash(FilterBox._getSubhashPrefix("meta"),a)]}const c=Object.entries(this._minisHidden).filter(([a,b])=>!!b).map(([a])=>`${UrlUtil.pack(a)}=1`);c.length&&a.push(UrlUtil.packSubHash(FilterBox._getSubhashPrefix("minisHidden"),c));const d=Object.entries(this._combineAs).filter(([a,b])=>b!==FilterBox._COMBINE_MODES[0]).map(([a])=>`${UrlUtil.pack(a)}=${FilterBox._COMBINE_MODES.indexOf(v)}`);return d.length&&a.push(UrlUtil.packSubHash(FilterBox._getSubhashPrefix("combineAs"),d)),a.length?a:null}setFromValues(a){this._filters.forEach(b=>b.setFromValues(a))}toDisplay(a,...b){const c=(c,d=b)=>c.map((b,c)=>b.toDisplay(a,d[c])).every(a=>a),d=(c,d=b)=>{const e=c.map((b,c)=>a[b.header]&&a[b.header]._isActive?b.toDisplay(a,d[c]):null).filter(a=>null!=a);return 0===e.length||e.find(a=>a)};switch(this._meta.modeCombineFilters){case"and":return c(this._filters);case"or":return d(this._filters);case"custom":{const a=[],e=[],g=[],h=[];if(b.length!==this._filters.length)throw new Error(`Number of filters and number of values did not match!`);for(let c=0;c<this._filters.length;++c){const d=this._filters[c];this._combineAs[d.header]&&"and"!==this._combineAs[d.header]?(g.push(d),h.push(b[c])):(a.push(d),e.push(b[c]))}return c(a,e)&&d(g,h)}default:throw new Error(`Unhandled combining mode "${this._meta.modeCombineFilters}"`);}}fireChangeEvent(){this._doSaveStateDebounced();const a=new Event(FilterBox.EVNT_VALCHANGE);this._$wrpFormTop[0].dispatchEvent(a)}static _getSubhashPrefix(a){if(FilterBox._SUB_HASH_PREFIXES[a])return FilterBox._SUB_HASH_PREFIXES[a];throw new Error(`Unknown property "${a}"`)}}FilterBox.EVNT_VALCHANGE="valchange",FilterBox.SOURCE_HEADER="Source",FilterBox._PILL_STATES=["ignore","yes","no"],FilterBox._COMBINE_MODES=["and","or","custom"],FilterBox._STORAGE_KEY="filterBoxState",FilterBox._DEFAULT_META={modeCombineFilters:"and",isSummaryHidden:!1},FilterBox._SUB_HASH_BOX_META_PREFIX="fbmt",FilterBox._SUB_HASH_BOX_MINIS_HIDDEN_PREFIX="fbmh",FilterBox._SUB_HASH_BOX_COMBINE_AS_PREFIX="fbca",FilterBox._SUB_HASH_PREFIXES={meta:FilterBox._SUB_HASH_BOX_META_PREFIX,minisHidden:FilterBox._SUB_HASH_BOX_MINIS_HIDDEN_PREFIX,combineAs:FilterBox._SUB_HASH_BOX_COMBINE_AS_PREFIX};class FilterItem{constructor(a){this.item=a.item,this.changeFn=a.changeFn,this.group=a.group,this.nest=a.nest,this.nestHidden=a.nestHidden,this.isIgnoreRed=a.isIgnoreRed,this.userData=a.userData,this.$rendered=null}}class FilterBase{constructor(a){this.header=a.header,ProxyUtil.decorate(this),this.__meta={...FilterBase._DEFAULT_META},this._meta=this._getProxy(this.__meta,"meta")}show(){this._meta.isHidden=!1}hide(){this._meta.isHidden=!0}getBaseSaveableState(){return{meta:{...this.__meta}}}resetBase(){Object.assign(this._meta,MiscUtil.copy(FilterBase._DEFAULT_META))}getBaseSubHashes(){const a=Object.keys(FilterBase._DEFAULT_META).find(a=>this._meta[a]!==FilterBase._DEFAULT_META[a]);if(a){const a=Object.keys(FilterBase._DEFAULT_META).map(a=>FilterUtil.compress(this._meta[a]));return[UrlUtil.packSubHash(FilterBase.getSubHashPrefix("meta",this.header),a)]}return null}setBaseFromSubHashState(a){let b=!1;Object.entries(a).forEach(([a,c])=>{const d=FilterBase.getProp(a);if("meta"===d){b=!0;const a=c.map(a=>FilterUtil.decompress(a));Object.keys(FilterBase._DEFAULT_META).forEach((b,c)=>this._meta[b]=a[c])}}),b||this.resetBase()}setBaseStateFromLoaded(a){Object.assign(this._meta,a.meta)}static getSubHashPrefix(a,b){if(FilterBase._SUB_HASH_PREFIXES[a]){const c=FilterBase._SUB_HASH_PREFIXES[a];return`${c}${UrlUtil.pack(b)}`}throw new Error(`Unknown property "${a}"`)}static getProp(a){return Parser._parse_bToA(FilterBase._SUB_HASH_PREFIXES,a)}getChildFilters(){return[]}$render(){throw new Error(`Unimplemented!`)}getValues(){throw new Error(`Unimplemented!`)}reset(){throw new Error(`Unimplemented!`)}update(){throw new Error(`Unimplemented!`)}toDisplay(){throw new Error(`Unimplemented!`)}addItem(){throw new Error(`Unimplemented!`)}getSaveableState(){throw new Error(`Unimplemented!`)}setStateFromLoaded(){throw new Error(`Unimplemented!`)}getSubHashes(){throw new Error(`Unimplemented!`)}setFromSubHashState(){throw new Error(`Unimplemented!`)}setFromValues(){throw new Error(`Unimplemented!`)}}FilterBase._DEFAULT_META={isHidden:!1,combineBlue:"or",combineRed:"or"},FilterBase._SUB_HASH_STATE_PREFIX="flst",FilterBase._SUB_HASH_META_PREFIX="flmt",FilterBase._SUB_HASH_NESTS_HIDDEN_PREFIX="flnh",FilterBase._SUB_HASH_PREFIXES={state:FilterBase._SUB_HASH_STATE_PREFIX,meta:FilterBase._SUB_HASH_META_PREFIX,nestsHidden:FilterBase._SUB_HASH_NESTS_HIDDEN_PREFIX};class Filter extends FilterBase{static _getAsFilterItems(a){return a?a.map(a=>a instanceof FilterItem?a:new FilterItem({item:a})):null}static _validateItemNests(a,b){if(b){const c=a.find(a=>!b[a.nest]);if(c)throw new Error(`Did not have a nest: "${c.item}"`);const d=a.find(a=>!a.nest||!b[a.nest]);if(d)throw new Error(`Invalid nest: "${d.item}"`)}}constructor(a){super(a),this._items=Filter._getAsFilterItems(a.items||[]),this._nests=a.nests,this._displayFn=a.displayFn,this._selFn=a.selFn,this._deselFn=a.deselFn,this._itemSortFn=a.itemSortFn===void 0?SortUtil.ascSort:a.itemSortFn,this._groupFn=a.groupFn,this._minimalUi=a.minimalUi,this._umbrellaItems=Filter._getAsFilterItems(a.umbrellaItems),this._umbrellaExcludes=Filter._getAsFilterItems(a.umbrellaExcludes),Filter._validateItemNests(this._items,this._nests),this._filterBox=null,this.__state={},this._state=this._getProxy(this.__state,"state"),this._items.forEach(a=>this._defaultItemState(a)),this.__$wrpFilter=null,this.__$wrpPills=null,this.__$wrpMini=null,this.__$wrpNestHeadInner=null,this._updateNestSummary=null,this.__nestsHidden={},this._nestsHidden=this._getProxy(this.__nestsHidden,"nestsHidden"),this._isNestsDirty=!1,this._isItemsDirty=!1,this._pillGroupsMeta={}}getSaveableState(){return{[this.header]:{...this.getBaseSaveableState(),state:{...this.__state},nestsHidden:{...this.__nestsHidden}}}}setStateFromLoaded(a){if(a&&a[this.header]){const b=a[this.header];this.setBaseStateFromLoaded(b),Object.assign(this._state,b.state),Object.assign(this._nestsHidden,b.nestsHidden)}}getSubHashes(){const a=[],b=this.getBaseSubHashes();b&&a.push(...b);const c=Object.entries(this._state).filter(([a,b])=>{if(this._deselFn){const c=this._deselFn(a);return c&&2!==b||!c&&0!==b}if(this._selFn){const c=this._selFn(a);return c&&1!==b||!c&&0!==b}return 0!==b});if(c.length){const b=c.map(([a,b])=>`${UrlUtil.pack(a)}=${b}`);a.push(UrlUtil.packSubHash(FilterBase.getSubHashPrefix("state",this.header),b))}const d=Object.entries(this._nestsHidden).filter(([a,b])=>this._nests[a].isHidden!==b);if(d.length){const b=d.map(([a])=>`${UrlUtil.pack(a)}=1`);a.push(UrlUtil.packSubHash(FilterBase.getSubHashPrefix("nestsHidden",this.header),b))}return a.length?a:null}setFromSubHashState(a){this.setBaseFromSubHashState(a);let b=!1,c=!1;Object.entries(a).forEach(([a,d])=>{const e=FilterBase.getProp(a);switch(e){case"state":{b=!0,d.forEach(a=>{const[b,c]=a.split("="),d=Object.keys(this._state).find(a=>a.toLowerCase()===b);d&&(this._state[d]=+c)});break}case"nestsHidden":{c=!0,d.forEach(a=>{const[b,c]=a.split("="),d=Object.keys(this._nestsHidden).find(a=>a.toLowerCase()===b);d&&(this._nestsHidden[d]=!!+c)});break}}}),b||this.reset(),c||this._resetNestsHidden()}setFromValues(a){a[this.header]&&(Object.keys(this._state).forEach(a=>this._state[a]=0),Object.assign(this._state,a[this.header]))}_resetNestsHidden(){this._nests&&Object.entries(this._nests).forEach(([a,b])=>this._nestsHidden[a]=!!b.isHidden)}_defaultItemState(a){this._state[a.item]=this._deselFn&&this._deselFn(a.item)?2:this._selFn&&this._selFn(a.item)?1:0}_$getPill(a){const b=$(`<div class="fltr__pill">${this._displayFn?this._displayFn(a.item):a.item}</div>`).click(()=>{2<++this._state[a.item]&&(this._state[a.item]=0)}).contextmenu(b=>!!b.ctrlKey||void(b.preventDefault(),0>--this._state[a.item]&&(this._state[a.item]=2))),c=()=>{const c=FilterBox._PILL_STATES[this._state[a.item]];b.attr("state",c),a.changeFn&&a.changeFn(a.item,c)};return this._addHook("state",a.item,c),c(),b}_$getMini(a){const b=$(`<div class="fltr__mini-pill">
			${this._displayFn?this._displayFn(a.item):a.item}
		</div>`).attr("state",FilterBox._PILL_STATES[this._state[a.item]]).click(()=>{this._state[a.item]=0,this._filterBox.fireChangeEvent()}),c=()=>b.attr("state",FilterBox._PILL_STATES[this._state[a.item]]);this._addHook("state",a.item,c),c();const d=()=>b.toggleClass("hidden",this._filterBox.isMinisHidden(this.header));return this._filterBox.registerMinisHiddenHook(this.header,d),d(),this._deselFn&&this._deselFn(a.item)?b.addClass("fltr__mini-pill--default-desel"):this._selFn&&this._selFn(a.item)&&b.addClass("fltr__mini-pill--default-sel"),b}_doSetPillsAll(){Object.keys(this._state).forEach(a=>this._state[a]=1)}_doSetPillsClear(){Object.keys(this._state).forEach(a=>this._state[a]=0)}_doSetPillsNone(){Object.keys(this._state).forEach(a=>this._state[a]=2)}_doSetPinsDefault(){this.reset()}_$getHeaderControls(a){const b=$(`<button class="btn btn-default ${a.isMulti?"btn-xxs":"btn-xs"} fltr__h-btn--all">All</button>`).click(()=>this._doSetPillsAll()),c=$(`<button class="btn btn-default ${a.isMulti?"btn-xxs":"btn-xs"} fltr__h-btn--clear">Clear</button>`).click(()=>this._doSetPillsClear()),d=$(`<button class="btn btn-default ${a.isMulti?"btn-xxs":"btn-xs"} fltr__h-btn--none">None</button>`).click(()=>this._doSetPillsNone()),e=$(`<button class="btn btn-default ${a.isMulti?"btn-xxs":"btn-xs"}">Default</button>`).click(()=>this._doSetPinsDefault()),f=$$`<div class="btn-group">${b}${c}${d}${e}</div>`,g=$(`<div class="flex-v-center"/>`).hide(),h=$$`<button class="btn btn-default ${a.isMulti?"btn-xxs":"btn-xs"} fltr__h-btn-logic--blue fltr__h-btn-logic" title="Positive matches mode for this filter. AND requires all blues to match, OR requires at least one blue to match."/>`.click(()=>this._meta.combineBlue="or"===this._meta.combineBlue?"and":"or"),i=()=>h.text(this._meta.combineBlue.toUpperCase());this._addHook("meta","combineBlue",i),i();const j=$$`<button class="btn btn-default ${a.isMulti?"btn-xxs":"btn-xs"} fltr__h-btn-logic--red fltr__h-btn-logic" title="Negative match mode for this filter. AND requires all reds to match, OR requires at least one red to match."/>`.click(()=>this._meta.combineRed="or"===this._meta.combineRed?"and":"or"),k=()=>j.text(this._meta.combineRed.toUpperCase());this._addHook("meta","combineRed",k),k();const l=$(`<button class="btn btn-default ${a.isMulti?"btn-xxs":"btn-xs"} ml-2">Hide</button>`).click(()=>this._meta.isHidden=!this._meta.isHidden),m=()=>{l.toggleClass("active",this._meta.isHidden),f.toggle(!this._meta.isHidden),g.toggle(this._meta.isHidden).empty();const a=this.getValues()[this.header];$(`<span class="fltr__summary_item fltr__summary_item--include"/>`).attr("title",`${a._totals.yes} hidden "required" tags`).text(a._totals.yes).toggle(!!a._totals.yes).appendTo(g),$(`<span class="fltr__summary_item_spacer"/>`).toggle(!!(a._totals.yes&&a._totals.no)).appendTo(g),$(`<span class="fltr__summary_item fltr__summary_item--exclude"/>`).attr("title",`${a._totals.no} hidden "excluded" tags`).text(a._totals.no).toggle(!!a._totals.no).appendTo(g)};return this._addHook("meta","isHidden",m),m(),$$`
		<div class="flex-v-center">
			${f}
			${g}
			<span class="btn-group ml-2">
				${h}
				${j}
			</span>
			${l}
		</div>`}$render(a){this._filterBox=a.filterBox,this.__$wrpMini=a.$wrpMini;const b=this._$getHeaderControls(a);this.__$wrpPills=$$`<div class="fltr__wrp-pills ${this._groupFn?"fltr__wrp-subs":""}"/>`;const c=()=>this.__$wrpPills.toggle(!this._meta.isHidden);if(this._addHook("meta","isHidden",c),c(),this._nests){const a=$(`<div class="fltr__wrp-pills--sub"/>`).appendTo(this.__$wrpPills);this.__$wrpNestHeadInner=$(`<div class="flex flex-wrap"/>`).appendTo(a);const b=$(`<div class="fltr__summary_nest"/>`).appendTo(a);this._updateNestSummary=()=>{const a={high:0,low:0};this._items.filter(a=>this._state[a.item]&&this._nestsHidden[a.nest]).forEach(b=>{const c=1===this._state[b.item]?"high":"low";a[c]++}),b.empty(),a.high&&$(`<span class="fltr__summary_item fltr__summary_item--include">${a.high}</span>`).attr("title",`${a.high} hidden "required" tag${1===a.high?"":"s"}`).appendTo(b),a.high&&a.low&&$(`<span class="fltr__summary_item_spacer"/>`).appendTo(b),a.low&&$(`<span class="fltr__summary_item fltr__summary_item--exclude">${a.low}</span>`).attr("title",`${a.low} hidden "excluded" tag${1===a.low?"":"s"}`).appendTo(b)},this._doRenderNests()}return this._doRenderPills(),this._doRenderMiniPills(),this.__$wrpFilter=$$`<div>
			${a.isFirst?"":`<div class="fltr__dropdown-divider ${a.isMulti?"fltr__dropdown-divider--indented":""} mb-1"/>`}
			<div class="split fltr__h ${this._minimalUi?"fltr__minimal-hide":""} mb-1">
				<div class="ml-2">${a.isMulti?"\u2012":""} ${this.header}</div>
				${b}
			</div>
			${this.__$wrpPills}
		</div>`,this._doToggleDisplay(),this.__$wrpFilter}getValues(){const a=MiscUtil.copy(this._state);Object.keys(a).filter(a=>!this._items.some(b=>`${b.item}`===a)).forEach(b=>delete a[b]);const b={...a};return b._isActive=Object.values(a).some(Boolean),b._totals={yes:0,no:0,ignored:0},Object.values(a).forEach(a=>{const c=0===a?"ignored":1===a?"yes":"no";b._totals[c]++}),b._andOr={blue:this._meta.combineBlue,red:this._meta.combineRed},{[this.header]:b}}reset(a){a&&(this.resetBase(),this._resetNestsHidden()),Object.keys(this._state).forEach(a=>delete this._state[a]),this._items.forEach(a=>this._defaultItemState(a))}_doRenderPills(){this._itemSortFn&&this._items.sort(this._itemSortFn),this._items.forEach(a=>{if(!a.$rendered&&(a.$rendered=this._$getPill(a),a.nest)){const b=()=>a.$rendered.toggle(!this._nestsHidden[a.nest]);this._addHook("nestsHidden",a.nest,b),b()}if(this._groupFn){const b=this._groupFn(a);this._pillGroupsMeta[b]||(this._pillGroupsMeta[b]={$hrDivider:$(`<hr class="fltr__dropdown-divider--sub">`).appendTo(this.__$wrpPills),$wrpPills:$(`<div class="fltr__wrp-pills--sub"/>`).appendTo(this.__$wrpPills)},Object.entries(this._pillGroupsMeta).sort((c,a)=>SortUtil.ascSortLower(c[0],a[0])).forEach(([a,b],c)=>{b.$hrDivider.appendTo(this.__$wrpPills),0===c&&null==this._nests&&b.$hrDivider.hide(),b.$wrpPills.appendTo(this.__$wrpPills)}),this._nests&&(this._pillGroupsMeta[b].toggleDividerFromNestVisibility=()=>{const a=this._items.filter(a=>this._groupFn(a)===b),c=a.filter(a=>this._nestsHidden[a.nest]);this._pillGroupsMeta[b].$hrDivider.toggle(a.length!==c.length)},Object.keys(this._nests).forEach(a=>{const c=()=>this._pillGroupsMeta[b].toggleDividerFromNestVisibility();this._addHook("nestsHidden",a,c),c(),this._pillGroupsMeta[b].toggleDividerFromNestVisibility()}))),this._pillGroupsMeta[b].$wrpPills.append(a.$rendered)}else this.__$wrpPills.append(a.$rendered)})}_doRenderMiniPills(){this._items.forEach(a=>{(a.$mini=a.$mini||this._$getMini(a)).appendTo(this.__$wrpMini)})}_doToggleDisplay(){this.__$wrpFilter.toggleClass("fltr__no-items",!this._items.length)}_doRenderNests(){Object.entries(this._nests).sort((c,a)=>SortUtil.ascSort(c[0],a[0])).forEach(([a,b])=>{if(null==b._$btnNest){null==this._nestsHidden[a]&&(this._nestsHidden[a]=!!b.isHidden);const c=$(`<span>${a} [${this._nestsHidden[a]?"+":"\u2212"}]</span>`);b._$btnNest=$$`<div class="fltr__btn_nest">${c}</div>`.click(()=>this._nestsHidden[a]=!this._nestsHidden[a]);const d=()=>{c.text(`${a} [${this._nestsHidden[a]?"+":"\u2212"}]`);const d={high:0,low:0,total:0};this._items.filter(b=>b.nest===a).find(a=>{const b=1===this._state[a.item]?"high":this._state[a.item]?"low":"ignored";d[b]++,d.total++});const e=d.total===d.high,f=d.total===d.low;b._$btnNest.toggleClass("fltr__btn_nest--include-all",this._nestsHidden[a]&&e).toggleClass("fltr__btn_nest--exclude-all",this._nestsHidden[a]&&f).toggleClass("fltr__btn_nest--include",this._nestsHidden[a]&&!(e||f||!d.high||d.low)).toggleClass("fltr__btn_nest--exclude",this._nestsHidden[a]&&!(e||f||d.high||!d.low)).toggleClass("fltr__btn_nest--both",this._nestsHidden[a]&&!(e||f||!d.high||!d.low)),this._updateNestSummary()};this._items.filter(b=>b.nest===a).find(a=>{this._addHook("state",a.item,d)}),this._addHook("nestsHidden",a,d),d()}b._$btnNest.appendTo(this.__$wrpNestHeadInner)}),this._updateNestSummary()}update(){this._isNestsDirty&&(this._isNestsDirty=!1,this._doRenderNests()),this._isItemsDirty&&(this._isItemsDirty=!1,this._doRenderPills()),this._doRenderMiniPills(),this._doToggleDisplay()}addItem(a){null==a||(a instanceof Array?a.forEach(a=>this.addItem(a)):!this._items.find(b=>Filter._isItemsEqual(b,a))&&(a=a instanceof FilterItem?a:new FilterItem({item:a}),Filter._validateItemNests([a],this._nests),this._isItemsDirty=!0,this._items.push(a),null==this._state[a.item]&&this._defaultItemState(a)))}static _isItemsEqual(a,b){return(a instanceof FilterItem?a.item:a)===(b instanceof FilterItem?b.item:b)}removeItem(a){const b=this._items.findIndex(b=>Filter._isItemsEqual(b,a));if(~b){const a=this._items[b];this._isItemsDirty=!0,a.$rendered.detach(),a.$mini.detach(),this._items.splice(b,1)}}addNest(a,b){if(!this._nests)throw new Error(`Filter was not nested!`);this._nests[a]||(this._isNestsDirty=!0,this._nests[a]=b,this._groupFn&&Object.keys(this._pillGroupsMeta).forEach(b=>{const c=()=>this._pillGroupsMeta[b].toggleDividerFromNestVisibility();this._addHook("nestsHidden",a,c),c(),this._pillGroupsMeta[b].toggleDividerFromNestVisibility()}))}toDisplay(a,b){const c=a[this.header];if(!c)return!0;const d=c._totals;b instanceof Array||(b=[b]),b=b.map(a=>a instanceof FilterItem?a:new FilterItem({item:a}));const e=()=>{if(this._umbrellaItems)return!!b&&!(this._umbrellaExcludes&&this._umbrellaExcludes.some(a=>c[a.item]))&&this._umbrellaItems.some(a=>b.includes(a.item))&&(this._umbrellaItems.some(a=>0===c[a.item])||this._umbrellaItems.some(a=>1===c[a.item]))};let f=!1,g=!1;if("or"===c._andOr.blue)0===d.yes&&(g=!0),g=g||b.some(a=>1===c[a.item]||e());else{const a=b.filter(a=>1===c[a.item]).length;g=!d.yes||d.yes===a}if("or"===c._andOr.red)f=f||b.filter(a=>!a.isIgnoreRed).some(a=>2===c[a.item]);else{const a=b.filter(a=>!a.isIgnoreRed).filter(a=>2===c[a.item]).length;f=d.no&&d.no===a}return g&&!f}}class RangeFilter extends FilterBase{constructor(a){super(a),this._min=+(a.min||0),this._max=+(a.max||0),this._labels=a.isLabelled?[]:null,this._isAllowGreater=!!a.isAllowGreater,this._suffix=a.suffix,this._labelSortFn=a.labelSortFn||SortUtil.ascSort,this._filterBox=null,this.__state={min:this._min,max:this._max,curMin:this._min,curMax:this._max},this._state=this._getProxy(this.__state,"state"),this._isLabelsDirty=!1,this.__$wrpSlider=null,this.__$wrpMini=null,this._$btnsMini=[],this._$slider=null}getSaveableState(){return{[this.header]:{...this.getBaseSaveableState(),state:{...this.__state}}}}setStateFromLoaded(a){if(a&&a[this.header]){const b=a[this.header];this.setBaseStateFromLoaded(b),Object.assign(this._state,b.state)}}getSubHashes(){const a=[],b=this.getBaseSubHashes();b&&a.push(...b);const c=[this._state.min===this._state.curMin?null:`min=${this._state.curMin}`,this._state.max===this._state.curMax?null:`max=${this._state.curMax}`].filter(Boolean);return c.length&&a.push(UrlUtil.packSubHash(FilterBase.getSubHashPrefix("state",this.header),c)),a.length?a:null}setFromSubHashState(a){this.setBaseFromSubHashState(a);let b=!1;Object.entries(a).forEach(([a,c])=>{const d=FilterBase.getProp(a);"state"===d&&(b=!0,c.forEach(a=>{const[b,c]=a.split("=");if(c.startsWith("&")&&!this._labels)throw new Error(`Could not dereference label: "${c}"`);let d;if(c.startsWith("&")){const a=c.replace("&","");if(d=this._labels.findIndex(b=>b+""===a),!~d)throw new Error(`Could not find index for label "${a}"`)}else d=+c;switch(b){case"min":d<this._state.min&&(this._state.min=d),this._state.curMin=Math.max(this._state.min,d);break;case"max":d>this._state.max&&(this._state.max=d),this._state.curMax=Math.min(this._state.max,d);break;default:throw new Error(`Unknown prop "${b}"`);}}))}),b||this.reset()}setFromValues(a){var b=Math.max;if(a[this.header]){const c=a[this.header];this._state.curMin=null==c.min?this._state.min:b(this._state.min,c.min),this._state.curMax=null==c.max?this._state.max:b(this._state.max,c.max)}}_$getHeaderControls(){const a=$(`<button class="btn btn-default btn-xs">Reset</button>`).click(()=>this.reset()),b=$$`<div>${a}</div>`,c=$(`<div class="flex-v-center fltr__summary_item fltr__summary_item--include"/>`).hide(),d=$(`<button class="btn btn-default btn-xs ml-2 ${this._meta.isHidden?"active":""}">Hide</button>`).click(()=>this._meta.isHidden=!this._meta.isHidden),e=()=>{d.toggleClass("active",this._meta.isHidden),b.toggle(!this._meta.isHidden),c.toggle(this._meta.isHidden);const a=this.getValues()[this.header],e=!a.isMinVal&&!a.isMaxVal,f=!a.isMinVal||!a.isMaxVal;c.attr("title",e?`Hidden range`:f?`Hidden limit`:"").text(e?`${a.min}-${a.max}`:a.isMinVal?a.isMaxVal?"":`≤ ${a.max}`:`≥ ${a.min}`)};return this._addHook("meta","isHidden",e),e(),$$`
		<div class="flex-v-center">
			${b}
			${c}
			${d}
		</div>`}$render(a){this._filterBox=a.filterBox,this.__$wrpMini=a.$wrpMini;const b=a.isMulti?null:this._$getHeaderControls();this.__$wrpSlider=$$`<div class="fltr__wrp-pills fltr__wrp-pills--flex"/>`;const c=()=>this.__$wrpSlider.toggle(!this._meta.isHidden);this._addHook("meta","isHidden",c),c();const d=()=>{const a={};return this._labels?a.labels=this._labels.sort(this._labelSortFn):this._isAllowGreater&&(a.labels={last:`${this._state.max}+`}),this._suffix&&(a.suffix=this._suffix),a},e=d();this._$slider=$(`<div class="fltr__slider"/>`).appendTo(this.__$wrpSlider),this._$slider.slider({min:this._min,max:this._max,range:!0,values:[this._min,this._max]}).slider("pips",e).slider("float",e).slider().on("slidestop",()=>{const[a,b]=this._$slider.slider("values");this._state.curMin=a,this._state.curMax=b});const f=$(`<div class="fltr__mini-pill" state="ignore"/>`).click(()=>{this._state.curMin=this._state.min,this._filterBox.fireChangeEvent()}).appendTo(this.__$wrpMini),g=$(`<div class="fltr__mini-pill" state="ignore"/>`).click(()=>{this._state.curMax=this._state.max,this._filterBox.fireChangeEvent()}).appendTo(this.__$wrpMini),h=$(`<div class="fltr__mini-pill" state="ignore"/>`).click(()=>{this._state.curMin=this._state.min,this._state.curMax=this._state.max,this._filterBox.fireChangeEvent()}).appendTo(this.__$wrpMini);this._$btnsMini.push(f,g,h);const i=()=>{const a=this._filterBox.isMinisHidden(this.header);f.toggleClass("hidden",a),g.toggleClass("hidden",a),h.toggleClass("hidden",a)};this._filterBox.registerMinisHiddenHook(this.header,i),i();const j=()=>{this._state.curMin===this._state.curMax?(f.attr("state",FilterBox._PILL_STATES[0]),g.attr("state",FilterBox._PILL_STATES[0]),h.attr("state",FilterBox._PILL_STATES[1]).text(`${this.header} = ${this._labels?this._labels[this._state.curMin]:this._state.curMin}`)):(this._state.min===this._state.curMin?f.attr("state",FilterBox._PILL_STATES[0]):f.attr("state",FilterBox._PILL_STATES[1]).text(`${this.header} ≥ ${this._labels?this._labels[this._state.curMin]:this._state.curMin}`),this._state.max===this._state.curMax?g.attr("state",FilterBox._PILL_STATES[0]):g.attr("state",FilterBox._PILL_STATES[1]).text(`${this.header} ≤ ${this._labels?this._labels[this._state.curMax]:this._state.curMax}`),h.attr("state",FilterBox._PILL_STATES[0]))},k=()=>{setTimeout(()=>this._$slider.slider("values",[this._state.curMin,this._state.curMax]),5),j()},l=()=>{const a=d();this._$slider.slider("option",{min:this._state.min,max:this._state.max}).slider("pips",a).slider("float",a),j()};return this._addHook("state","min",l),this._addHook("state","max",l),this._addHook("state","curMin",k),this._addHook("state","curMax",k),k(),l(),a.isMulti?(this._$slider.addClass("grow"),this.__$wrpSlider.addClass("grow"),$$`<div class="flex">
				<div class="fltr__range-inline-label">${this.header}</div>
				${this.__$wrpSlider}
			</div>`):$$`<div class="flex-col">
				${a.isFirst?"":`<div class="fltr__dropdown-divider mb-1"/>`}
				<div class="split fltr__h ${this._minimalUi?"fltr__minimal-hide":""} mb-1">
					<div>${this.header}</div>
					${b}
				</div>
				${this.__$wrpSlider}
			</div>`}getValues(){const a={isMaxVal:this._state.max===this._state.curMax,isMinVal:this._state.min===this._state.curMin,max:this._state.curMax,min:this._state.curMin};return a._isActive=!(a.isMinVal&&a.isMaxVal),{[this.header]:a}}reset(a){a&&this.resetBase(),this._state.curMin=this._state.min,this._state.curMax=this._state.max}update(){this._$btnsMini.forEach(a=>this.__$wrpMini.append(a))}toDisplay(a,b){var c=Math.min,d=Math.max;const e=a[this.header];if(!e)return!0;if(null==b)return e.min===this._state.min&&e.max===this._state.max;if(this._labels){const a=this._labels.slice(e.min,e.max+1);return b instanceof Array?!!b.find(b=>a.includes(b)):a.includes(b)}else{const a=b instanceof Array?e.min<=c(...b):e.min<=b,f=b instanceof Array?e.max>=d(...b):e.max>=b;return this._isAllowGreater?a&&(f||e.max===this._state.max):a&&f}}addItem(a){if(this._labels){if(null==a)return;a instanceof Array?a.forEach(a=>this.addItem(a)):!this._labels.some(b=>b===a)&&(this._labels.push(a),this._isLabelsDirty=!0),this._addItem_addNumber(this._labels.length-1)}else this._addItem_addNumber(a)}_addItem_addNumber(a){if(!(null==a||isNaN(a))&&!(a>=this._state.min&&a<=this._state.max))if(null==this._state.min&&null==this._state.max)this._state.min=this._state.max=a;else{const b={...this.__state};a<b.min&&(this._state.min=a),a>b.max&&(this._state.max=a),b.curMin===b.min&&(this._state.curMin=this._state.min),b.curMax===b.max&&(this._state.curMax=this._state.max)}}}class MultiFilter extends FilterBase{constructor(a){super(a),this._filters=a.filters,this.__state={...MultiFilter._DETAULT_STATE,mode:a.mode||MultiFilter._DETAULT_STATE.mode},this._state=this._getProxy(this.__state,"state")}getChildFilters(){return[...this._filters,...this._filters.map(a=>a.getChildFilters())].flat()}getSaveableState(){const a={[this.header]:{...this.getBaseSaveableState(),state:{...this.__state}}};return this._filters.forEach(b=>Object.assign(a,b.getSaveableState())),a}setStateFromLoaded(a){if(a&&a[this.header]){const b=a[this.header];this.setBaseStateFromLoaded(b),Object.assign(this._state,b.state),this._filters.forEach(b=>b.setStateFromLoaded(a))}}getSubHashes(){const a=[],b=this.getBaseSubHashes();b&&a.push(...b);const c=Object.keys(MultiFilter._DETAULT_STATE).find(a=>this._state[a]!==MultiFilter._DETAULT_STATE[a]);if(c){const b=Object.keys(MultiFilter._DETAULT_STATE).map(a=>FilterUtil.compress(this._state[a]));a.push(UrlUtil.packSubHash(FilterBase.getSubHashPrefix("state",this.header),b))}return this._filters.map(a=>a.getSubHashes()).filter(Boolean).forEach(b=>a.push(...b)),a.length?a:null}setFromSubHashState(a){this.setBaseFromSubHashState(a);let b=!1;Object.entries(a).forEach(([a,c])=>{const d=FilterBase.getProp(a);if("state"===d){b=!0;const a=c.map(a=>FilterUtil.decompress(a));Object.keys(MultiFilter._DETAULT_STATE).forEach((b,c)=>this._state[b]=a[c])}}),b||this._reset()}setFromValues(a){this._filters.forEach(b=>b.setFromValues(a))}$render(a){const b=$(`<div class="fltr__group-comb-toggle text-muted"/>`).click(()=>this._state.mode="and"===this._state.mode?"or":"and"),c=()=>b.text(`(group ${this._state.mode.toUpperCase()})`);this._addHook("state","mode",c),c();const d=this._filters.map((b,c)=>b.$render({...a,isMulti:!0,isFirst:0===c})),e=$$`<div>${d}</div>`,f=$(`<div class="fltr__summary_item"/>`).hide(),g=$(`<button class="btn btn-default btn-xs ml-2">Reset All</button>`).click(()=>this._filters.forEach(a=>a.reset())),h=$(`<button class="btn btn-default btn-xs ml-2 ${this._meta.isHidden?"active":""}">Hide</button>`).click(()=>this._meta.isHidden=!this._meta.isHidden),i=$$`<div class="flex-v-center">
			${f}${g}${h}
		</div>`,j=()=>{h.toggleClass("active",this._meta.isHidden),e.toggle(!this._meta.isHidden),f.toggle(this._meta.isHidden);const a=this._filters.map(a=>a.getValues()[a.header]._isActive).filter(Boolean).length;a&&f.attr("title",`${a} hidden active filter${1===a?"":"s"}`).text(`(${a})`)};return this._addHook("meta","isHidden",j),j(),$$`<div class="flex-col">
			${a.isFirst?"":`<div class="fltr__dropdown-divider mb-1"/>`}
			<div class="split fltr__h ${this._minimalUi?"fltr__minimal-hide":""} mb-1">
				<div class="flex-v-center">
					<div class="mr-2">${this.header}</div>
					${b}
				</div>
				${i}
			</div>
			${e}
		</div>`}getValues(){const a={};return this._filters.forEach(b=>Object.assign(a,b.getValues())),a}_reset(){Object.assign(this._state,MultiFilter._DETAULT_STATE)}reset(a){a&&this.resetBase(),this._reset(),this._filters.forEach(b=>b.reset(a))}update(){this._filters.forEach(a=>a.update())}toDisplay(a,b){if(this._filters.length!==b.length)throw new Error("Number of filters and number of values did not match");const c=[];for(let d=this._filters.length-1;0<=d;--d){const e=this._filters[d];if(e instanceof RangeFilter)c.push(e.toDisplay(a,b[d]));else{const f=a[e.header]._totals;0===f.yes&&0===f.no?c.push(null):c.push(e.toDisplay(a,b[d]))}}const d=c.filter(a=>null!==a);return"or"===this._state.mode?!d.length||d.find(a=>a):d.filter(a=>a).length===d.length}addItem(){throw new Error(`Cannot add item to MultiFilter! Add the item to a child filter instead.`)}}MultiFilter._DETAULT_STATE={mode:"or"},(()=>{const a=Object.values(FilterBox._SUB_HASH_PREFIXES).filter(a=>a.length!==FilterUtil.SUB_HASH_PREFIX_LENGTH),b=Object.values(FilterBase._SUB_HASH_PREFIXES).filter(a=>a.length!==FilterUtil.SUB_HASH_PREFIX_LENGTH),c=a.concat(b);if(c.length)throw new Error(`Invalid prefixes! ${c.map(a=>`"${a}"`).join(", ")} ${1===c.length?`is`:`was`} not of length ${FilterUtil.SUB_HASH_PREFIX_LENGTH}`)})(),FilterUtil.SUB_HASH_PREFIXES=new Set([...Object.values(FilterBox._SUB_HASH_PREFIXES),...Object.values(FilterBase._SUB_HASH_PREFIXES)]);